# 🚀 快速发布新版本 - 操作手册

> **给项目维护者**: 如何在10分钟内发布新版本

---

## ⚡ 超快速发布（3步完成）

### 第1步: 准备发布（2分钟）

```bash
# 1. 更新版本号
# 编辑以下文件:
# - backend/app/config.py (app_version = "1.13.3")
# - frontend/package.json (version: "1.13.3")

# 2. 更新CHANGELOG
# 编辑 CHANGELOG_v1.13.3.md

# 3. 提交更改
git add .
git commit -m "chore: bump version to v1.13.3"
git push origin main
```

### 第2步: 创建Release（1分钟）

```bash
# 使用提供的脚本
./scripts/create-release.sh v1.13.3

# 脚本会自动：
# ✅ 创建Git tag
# ✅ 推送到GitHub
# ✅ 触发自动构建
```

### 第3步: 等待构建（15-20分钟，自动）

```
GitHub Actions 自动执行：
├─ 构建Windows安装包 (5分钟)
├─ 构建macOS安装包 (5分钟)
├─ 构建Linux安装包 (3分钟)
├─ 构建Docker镜像 (3分钟)
└─ 创建Release并上传 (2分钟)

总计: 15-20分钟（无需人工干预）
```

### 第4步: 验证发布（2分钟）

```bash
# 1. 访问Release页面
https://github.com/gfchfjh/CSBJJWT/releases/latest

# 2. 检查：
# ✅ 所有安装包已上传
# ✅ Release Notes正确
# ✅ 版本号正确
# ✅ 下载链接可用

# 3. 测试安装包（可选）
# 下载一个安装包测试安装

# ✅ 完成！
```

---

## 🎯 完整发布流程

### 第1步: 开发完成

```bash
# 1. 确保所有功能已完成
# 2. 确保所有测试通过
pytest backend/tests/
npm run test --prefix frontend

# 3. 确保代码质量检查通过
flake8 backend/app/
black --check backend/app/
```

### 第2步: 更新版本信息

**文件1: backend/app/config.py**
```python
# 修改这一行
app_version: str = "1.13.3"  # 从 1.13.2 改为 1.13.3
```

**文件2: frontend/package.json**
```json
{
  "name": "kook-forwarder",
  "version": "1.13.3",  // 从 1.13.2 改为 1.13.3
  ...
}
```

**文件3: 创建CHANGELOG**
```bash
# 复制模板
cp CHANGELOG_v1.13.0.md CHANGELOG_v1.13.3.md

# 编辑内容
nano CHANGELOG_v1.13.3.md
```

### 第3步: 提交更改

```bash
git add backend/app/config.py
git add frontend/package.json
git add CHANGELOG_v1.13.3.md

git commit -m "chore: bump version to v1.13.3

- 更新版本号到v1.13.3
- 添加CHANGELOG
- 准备发布"

git push origin main
```

### 第4步: 创建Release

```bash
# 使用脚本
./scripts/create-release.sh v1.13.3

# 脚本执行内容：
✅ 检查当前分支（必须是main）
✅ 检查未提交的更改
✅ 创建Git tag v1.13.3
✅ 推送tag到GitHub
✅ 触发GitHub Actions
```

### 第5步: 监控构建

```bash
# 方法1: 网页查看
# 访问: https://github.com/gfchfjh/CSBJJWT/actions

# 方法2: GitHub CLI
gh run list --workflow=build-and-release.yml

# 方法3: 实时查看日志
gh run view --log-failed

# 构建流程：
[01/10] ✅ 检出代码
[02/10] ✅ 设置Python环境
[03/10] ✅ 安装Python依赖
[04/10] ✅ 构建后端（Windows）
[05/10] ✅ 构建后端（macOS）
[06/10] ✅ 构建后端（Linux）
[07/10] ✅ 构建Electron（Windows）
[08/10] ✅ 构建Electron（macOS）
[09/10] ✅ 构建Electron（Linux）
[10/10] ✅ 创建Release并上传

预计时间: 15-20分钟
```

### 第6步: 验证和发布

```bash
# 1. 查看Release
gh release view v1.13.3

# 2. 检查文件
gh release view v1.13.3 --json assets --jq '.assets[].name'

# 应该看到:
# - KookForwarder-Setup-1.13.3.exe
# - KookForwarder-1.13.3-x64.dmg
# - KookForwarder-1.13.3-arm64.dmg
# - KookForwarder-1.13.3.AppImage

# 3. 测试下载（可选）
wget $(gh release view v1.13.3 --json assets --jq '.assets[0].url')

# 4. 如果一切正常，发布公告
# - 更新README
# - 发送通知
# - 社交媒体宣传

# ✅ 完成！
```

---

## 🔧 常见问题

### Q1: GitHub Actions构建失败怎么办？

```bash
# 1. 查看失败日志
gh run view [run_id] --log-failed

# 2. 常见问题：
#    - 依赖安装失败 → 检查requirements.txt
#    - Playwright下载失败 → 网络问题，重试
#    - 打包失败 → 检查.spec配置

# 3. 重新触发（删除tag后重新创建）
git push origin :refs/tags/v1.13.3
git tag -d v1.13.3
./scripts/create-release.sh v1.13.3
```

### Q2: 安装包太大怎么办？

```
优化方法：

1. 排除不必要的文件
   编辑 electron-builder.yml:
   files:
     - "!**/__pycache__"
     - "!**/tests"

2. 压缩可执行文件
   使用UPX:
   upx --best dist/backend/main.exe

3. 优化依赖
   只安装生产依赖:
   pip install -r requirements.txt --no-dev

预期效果：减少30-40%体积
```

### Q3: 如何发布beta版本？

```bash
# 使用beta标签
./scripts/create-release.sh v1.13.3-beta.1

# GitHub Release设置为预发布
gh release create v1.13.3-beta.1 \
  --title "v1.13.3-beta.1" \
  --prerelease \
  --notes "Beta版本，仅供测试"
```

---

## 📅 发布时间表建议

### 定期发布

```
周一-周五: 开发和测试
周五下午: 代码冻结
周六: 构建和测试
周日: 发布新版本

每月发布: 1-2次
紧急修复: 随时发布
```

### 版本命名

```
主版本（Major）:
v1.0.0 → v2.0.0
时机: 重大架构变更、不兼容更新
频率: 6-12个月

次版本（Minor）:
v1.13.0 → v1.14.0
时机: 新功能、改进
频率: 1-2个月

修订版（Patch）:
v1.13.2 → v1.13.3
时机: Bug修复、小优化
频率: 1-2周

预发布（Pre-release）:
v1.13.3-beta.1
时机: 测试新功能
频率: 按需
```

---

## 🎉 总结

### 现在发布新版本只需

```
1. 更新版本号（2分钟）
2. 运行./scripts/create-release.sh（1分钟）
3. 等待自动构建（15分钟，喝杯咖啡☕）
4. 验证并发布（2分钟）

总计: 20分钟（其中15分钟自动化）
操作步骤: 4步
技术难度: ⭐⭐（简单）
```

### 用户获得的体验

```
✅ 预编译安装包 - 2分钟安装
✅ 自动安装脚本 - 5-10分钟自动安装
✅ Docker镜像 - 3分钟部署
✅ 完整文档 - 5分钟上手

用户满意度: ⭐⭐⭐⭐⭐
```

---

**让每次发布都像魔法一样简单！** ✨

[返回主页](../README.md) | [构建指南](构建发布指南.md)
