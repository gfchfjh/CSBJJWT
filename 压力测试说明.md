# KOOK消息转发系统 - 压力测试说明文档

## 📋 测试概览

本项目包含三套完整的压力测试系统，全面测试KOOK消息转发系统的所有核心功能模块。

### 测试套件

1. **原有压力测试** (`stress_test.py`)
   - 基础API端点测试
   - 并发请求测试
   - 数据库性能测试
   - 消息队列测试
   - 限流器测试

2. **全面压力测试** (`comprehensive_stress_test.py`)
   - API端点压力测试（多并发级别）
   - 消息格式转换压力测试
   - Redis队列压力测试（多批次大小）
   - 限流器压力测试（多种配置）
   - 数据库并发操作测试
   - 图片处理压力测试
   - 端到端集成压力测试

3. **模块专项测试** (`module_specific_stress_test.py`)
   - 消息验证器压力测试
   - 过滤器压力测试
   - 加密解密压力测试
   - 日志记录压力测试
   - WebSocket连接压力测试
   - 缓存系统压力测试
   - 错误处理压力测试

## 🚀 快速开始

### 前置要求

1. **启动后端服务**
   ```bash
   cd backend
   python -m app.main
   ```

2. **启动Redis服务**
   ```bash
   redis-server
   # 或者使用项目提供的脚本
   cd redis
   ./start_redis.sh  # Linux/macOS
   ./start_redis.bat # Windows
   ```

3. **安装依赖**
   ```bash
   pip install -r backend/requirements.txt
   pip install -r backend/requirements-dev.txt
   ```

### 运行测试

#### 方式1: 运行所有测试（推荐）

**Linux/macOS:**
```bash
./run_all_stress_tests.sh
```

**Windows:**
```bash
run_all_stress_tests.bat
```

#### 方式2: 单独运行测试

```bash
# 原有压力测试
python stress_test.py

# 全面压力测试
python comprehensive_stress_test.py

# 模块专项测试
python module_specific_stress_test.py
```

## 📊 测试覆盖范围

### 1. API接口测试

- **测试内容**:
  - 健康检查接口
  - 账号管理接口
  - Bot配置接口
  - 频道映射接口
  - 日志查询接口
  - 系统状态接口

- **并发级别**: 1, 5, 10, 20, 50, 100, 200

- **测试指标**:
  - QPS (每秒请求数)
  - 平均响应时间
  - P50/P90/P99响应时间
  - 成功率

### 2. 消息处理测试

- **格式转换**:
  - KMarkdown → Discord Markdown
  - KMarkdown → Telegram HTML
  - KMarkdown → 飞书富文本
  - 消息分段处理

- **测试规模**: 1000, 5000, 10000, 50000 次迭代

- **测试指标**:
  - 转换速度 (ops/s)
  - 内存使用
  - CPU使用

### 3. Redis队列测试

- **测试操作**:
  - 消息入队
  - 消息出队
  - 批量操作
  - 队列大小管理

- **批量大小**: 10, 50, 100, 500, 1000, 5000

- **测试指标**:
  - 入队QPS
  - 出队QPS
  - 批量操作QPS
  - 延迟时间

### 4. 限流器测试

- **测试配置**:
  - Discord限流 (5请求/5秒)
  - Telegram限流 (30请求/1秒)
  - 飞书限流 (20请求/1秒)
  - 自定义限流 (100请求/10秒)

- **测试指标**:
  - 限流准确度
  - 等待时间
  - 吞吐量

### 5. 数据库测试

- **测试操作**:
  - 简单查询
  - 复杂查询 (JOIN)
  - 批量插入
  - 并发读写

- **操作数量**: 100, 500, 1000, 5000, 10000

- **测试指标**:
  - 查询QPS
  - 写入QPS
  - 事务性能
  - 并发安全性

### 6. 图片处理测试

- **测试尺寸**:
  - 小图: 800×600
  - 中图: 1920×1080
  - 4K图: 3840×2160
  - 8K图: 7680×4320

- **测试操作**:
  - JPEG压缩
  - PNG压缩
  - 图片缩放
  - 批量处理

- **测试指标**:
  - 处理速度
  - 压缩率
  - 内存占用

### 7. 端到端测试

- **完整流程**:
  1. 接收消息
  2. 格式转换
  3. 过滤规则应用
  4. 限流控制
  5. 转发到目标平台
  6. 记录日志

- **测试规模**: 10, 50, 100, 500 条消息

- **测试指标**:
  - 端到端延迟
  - 吞吐量
  - 成功率
  - 资源使用

## 📈 性能基准

### 推荐配置下的性能基准

| 测试项 | 指标 | 目标值 | 说明 |
|--------|------|--------|------|
| API QPS | 并发100 | >500 QPS | 保证响应时间<100ms |
| 格式转换 | Discord | >10000 ops/s | 基础格式转换 |
| 格式转换 | Telegram | >8000 ops/s | HTML格式转换 |
| Redis入队 | 批量1000 | >5000 msg/s | 消息队列性能 |
| Redis出队 | 批量1000 | >5000 msg/s | 消费者性能 |
| 数据库查询 | 简单查询 | >1000 QPS | 基础查询 |
| 数据库写入 | 批量插入 | >500 QPS | 事务写入 |
| 端到端延迟 | 单条消息 | <50ms | 完整流程 |
| 端到端吞吐 | 批量处理 | >100 msg/s | 批量转发 |

## 📄 测试报告

### 生成的报告文件

测试完成后会在 `test_results/` 目录下生成以下文件:

1. **JSON报告** (机器可读):
   - `stress_test_report.json` - 原有压力测试结果
   - `comprehensive_stress_test_report.json` - 全面压力测试结果
   - `module_stress_test_report.json` - 模块专项测试结果

2. **Markdown报告** (人类可读):
   - `压力测试报告.md` - 原有测试报告
   - `全面压力测试报告.md` - 全面测试报告
   - `完整测试报告汇总.md` - 所有测试汇总

3. **日志文件**:
   - `stress_test.log` - 原有测试日志
   - `comprehensive_stress_test.log` - 全面测试日志
   - `module_specific_stress_test.log` - 模块测试日志

4. **简报**:
   - `测试结果简报.txt` - 测试结果快速概览

### 生成汇总报告

```bash
python generate_test_summary.py
```

## 🔧 自定义测试

### 修改测试参数

编辑测试脚本中的配置字典:

```python
# comprehensive_stress_test.py
COMPREHENSIVE_TEST_CONFIG = {
    "concurrent_levels": [1, 5, 10, 20, 50, 100],  # 修改并发级别
    "message_batch_sizes": [10, 50, 100, 500],     # 修改批量大小
    "test_duration_seconds": 60,                    # 修改测试时长
    # ... 其他配置
}
```

### 添加自定义测试

在测试类中添加新的测试方法:

```python
async def test_custom_feature(self):
    """自定义功能测试"""
    # 测试逻辑
    pass
```

## 🐛 故障排查

### 常见问题

1. **后端服务未运行**
   ```
   解决: cd backend && python -m app.main
   ```

2. **Redis连接失败**
   ```
   解决: 确保Redis服务运行在 127.0.0.1:6379
   ```

3. **数据库文件不存在**
   ```
   解决: 首次运行后端服务会自动创建数据库
   ```

4. **依赖包缺失**
   ```
   解决: pip install aiohttp redis pillow
   ```

5. **测试超时**
   ```
   解决: 增加timeout参数或减少测试规模
   ```

### 调试模式

运行单个测试并查看详细输出:

```bash
python comprehensive_stress_test.py -v
```

## 📊 持续集成

### GitHub Actions 配置示例

```yaml
name: Stress Tests

on: [push, pull_request]

jobs:
  stress-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r backend/requirements.txt
        pip install -r backend/requirements-dev.txt
    
    - name: Start Redis
      run: |
        sudo systemctl start redis
    
    - name: Run stress tests
      run: |
        ./run_all_stress_tests.sh
    
    - name: Upload test results
      uses: actions/upload-artifact@v2
      with:
        name: test-results
        path: test_results/
```

## 🎯 最佳实践

1. **定期运行**: 在每次重大更新前运行完整压力测试

2. **监控趋势**: 保存历史测试结果，监控性能趋势

3. **真实环境**: 在接近生产环境的配置下运行测试

4. **逐步增压**: 从低并发开始，逐步增加压力

5. **资源监控**: 测试时监控CPU、内存、磁盘IO等资源使用

6. **清理数据**: 测试后及时清理测试数据

## 📚 参考资料

- [压力测试最佳实践](https://example.com/stress-testing)
- [Python异步编程指南](https://docs.python.org/3/library/asyncio.html)
- [Redis性能优化](https://redis.io/topics/optimization)

## 🤝 贡献

欢迎提交问题和改进建议！

## 📄 许可证

MIT License
