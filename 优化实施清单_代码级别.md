# KOOKè½¬å‘ç³»ç»Ÿ - ä»£ç çº§åˆ«ä¼˜åŒ–å®æ–½æ¸…å•

**é…å¥—ä¸»æŠ¥å‘Š**: [æ·±åº¦ä¼˜åŒ–åˆ†ææŠ¥å‘Š](./KOOKè½¬å‘ç³»ç»Ÿæ·±åº¦ä¼˜åŒ–åˆ†ææŠ¥å‘Š.md)

---

## ğŸ”§ P0ä¼˜åŒ– - è¯¦ç»†å®æ–½æ–¹æ¡ˆ

### 1. å®Œå–„é¦–æ¬¡é…ç½®å‘å¯¼

#### æ–‡ä»¶ä¿®æ”¹æ¸…å•

**1.1 æ¬¢è¿é¡µç»„ä»¶** (`frontend/src/components/wizard/WizardStepWelcome.vue`)

```vue
<!-- å½“å‰ä»£ç é—®é¢˜: å…è´£å£°æ˜å†…å®¹ä¸å®Œæ•´ -->
<template>
  <div class="welcome-step">
    <h2>æ¬¢è¿ä½¿ç”¨KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ</h2>
    <!-- ç¼ºå°‘è¯¦ç»†çš„å…è´£å£°æ˜ -->
  </div>
</template>

<!-- ä¿®å¤æ–¹æ¡ˆ: -->
<template>
  <div class="welcome-step">
    <div class="welcome-header">
      <el-icon :size="60" color="#409EFF"><Promotion /></el-icon>
      <h1>ğŸ‰ æ¬¢è¿ä½¿ç”¨KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ</h1>
      <p class="version">v{{ version }} Ultimate Edition</p>
    </div>

    <el-card class="disclaimer-card">
      <template #header>
        <div class="card-header">
          <el-icon color="#E6A23C"><Warning /></el-icon>
          <span>âš ï¸ å…è´£å£°æ˜ï¼ˆè¯·ä»”ç»†é˜…è¯»ï¼‰</span>
        </div>
      </template>

      <el-scrollbar height="300px">
        <div class="disclaimer-content">
          <h3>è¯·æ³¨æ„ä»¥ä¸‹é‡è¦äº‹é¡¹ï¼š</h3>
          
          <el-alert type="warning" :closable="false" style="margin: 10px 0">
            <strong>1. æŠ€æœ¯å®ç°é£é™©</strong>
            <p>æœ¬è½¯ä»¶é€šè¿‡æµè§ˆå™¨è‡ªåŠ¨åŒ–æŠ€æœ¯æŠ“å–KOOKæ¶ˆæ¯ï¼Œå¯èƒ½è¿åKOOKæœåŠ¡æ¡æ¬¾ã€‚</p>
          </el-alert>

          <el-alert type="error" :closable="false" style="margin: 10px 0">
            <strong>2. è´¦å·å®‰å…¨é£é™©</strong>
            <p>ä½¿ç”¨æœ¬è½¯ä»¶å¯èƒ½å¯¼è‡´æ‚¨çš„KOOKè´¦å·è¢«<b>è­¦å‘Šã€é™åˆ¶æˆ–æ°¸ä¹…å°ç¦</b>ã€‚è¯·ç¡®ä¿ï¼š</p>
            <ul>
              <li>âœ… æ‚¨æ‹¥æœ‰è½¬å‘å†…å®¹çš„åˆæ³•æƒé™</li>
              <li>âœ… æ‚¨å·²è·å¾—æœåŠ¡å™¨ç®¡ç†å‘˜æˆæƒ</li>
              <li>âœ… æ‚¨äº†è§£å¹¶æ¥å—è´¦å·è¢«å°ç¦çš„é£é™©</li>
            </ul>
          </el-alert>

          <el-alert type="info" :closable="false" style="margin: 10px 0">
            <strong>3. å†…å®¹ç‰ˆæƒé£é™©</strong>
            <p>è½¬å‘çš„æ¶ˆæ¯å†…å®¹å¯èƒ½æ¶‰åŠç‰ˆæƒä¿æŠ¤ã€‚æ‚¨åº”ç¡®ä¿ï¼š</p>
            <ul>
              <li>âœ… éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„</li>
              <li>âœ… å°Šé‡åŸåˆ›ä½œè€…æƒç›Š</li>
              <li>âœ… ä¸è½¬å‘éæ³•ã€ä¾µæƒå†…å®¹</li>
            </ul>
          </el-alert>

          <el-alert type="warning" :closable="false" style="margin: 10px 0">
            <strong>4. éšç§ä¿æŠ¤</strong>
            <p>æœ¬è½¯ä»¶ä¼šå­˜å‚¨æ‚¨çš„ç™»å½•å‡­è¯ï¼ˆCookieï¼‰åœ¨æœ¬åœ°ã€‚è¯·ç¡®ä¿ï¼š</p>
            <ul>
              <li>âœ… è®¾å¤‡å¤„äºå®‰å…¨ç¯å¢ƒ</li>
              <li>âœ… è®¾ç½®ä¸»å¯†ç ä¿æŠ¤</li>
              <li>âœ… å®šæœŸæ›´æ–°å¯†ç </li>
            </ul>
          </el-alert>

          <el-alert type="error" :closable="false" style="margin: 10px 0">
            <strong>5. å…è´£å£°æ˜</strong>
            <p>æœ¬è½¯ä»¶<b>ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨</b>ï¼Œå¼€å‘è€…ä¸æ‰¿æ‹…ä»»ä½•æ³•å¾‹è´£ä»»ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š</p>
            <ul>
              <li>âŒ è´¦å·è¢«å°ç¦çš„æŸå¤±</li>
              <li>âŒ æ•°æ®ä¸¢å¤±æˆ–æ³„éœ²</li>
              <li>âŒ æ³•å¾‹çº çº·å’Œè¯‰è®¼</li>
              <li>âŒ å…¶ä»–ä»»ä½•ç›´æ¥æˆ–é—´æ¥æŸå¤±</li>
            </ul>
          </el-alert>
        </div>
      </el-scrollbar>

      <div class="agreement">
        <el-checkbox v-model="agreed" size="large">
          <b>æˆ‘å·²ä»”ç»†é˜…è¯»å¹¶å®Œå…¨ç†è§£ä»¥ä¸Šæ¡æ¬¾ï¼Œè‡ªæ„¿æ‰¿æ‹…æ‰€æœ‰é£é™©</b>
        </el-checkbox>
      </div>
    </el-card>

    <div class="wizard-actions">
      <el-button @click="handleReject" :disabled="loading">
        æ‹’ç»å¹¶é€€å‡º
      </el-button>
      <el-button 
        type="primary" 
        @click="handleAgree" 
        :disabled="!agreed || loading"
        :loading="loading"
      >
        åŒæ„å¹¶ç»§ç»­
      </el-button>
    </div>

    <!-- é¢„è®¡è€—æ—¶æç¤º -->
    <el-alert type="info" :closable="false" style="margin-top: 20px">
      <template #title>
        <el-icon><Clock /></el-icon>
        <span style="margin-left: 5px">é…ç½®å‘å¯¼é¢„è®¡è€—æ—¶ 3-5 åˆ†é’Ÿ</span>
      </template>
    </el-alert>
  </div>
</template>

<script setup>
import { ref } from 'vue'
import { ElMessageBox } from 'element-plus'
import packageInfo from '../../../package.json'

const emit = defineEmits(['next', 'reject'])

const agreed = ref(false)
const loading = ref(false)
const version = packageInfo.version

const handleAgree = async () => {
  loading.value = true
  try {
    // è®°å½•ç”¨æˆ·åŒæ„æ—¶é—´
    await api.recordAgreement({
      timestamp: new Date().toISOString(),
      version: version
    })
    emit('next')
  } catch (error) {
    ElMessage.error('è®°å½•åè®®å¤±è´¥ï¼Œè¯·é‡è¯•')
  } finally {
    loading.value = false
  }
}

const handleReject = () => {
  emit('reject')
}
</script>
```

**1.2 ç™»å½•æ­¥éª¤ç»„ä»¶** (`frontend/src/components/wizard/WizardStepLogin.vue`)

```vue
<!-- æ·»åŠ è§†é¢‘æ•™ç¨‹é›†æˆ -->
<template>
  <div class="login-step">
    <el-tabs v-model="loginMethod">
      <!-- æ–¹æ³•1: è´¦å·å¯†ç  -->
      <el-tab-pane label="è´¦å·å¯†ç ç™»å½•" name="password">
        <el-form :model="passwordForm" :rules="passwordRules" ref="passwordFormRef">
          <el-form-item label="KOOKé‚®ç®±" prop="email">
            <el-input 
              v-model="passwordForm.email" 
              placeholder="your@email.com"
              clearable
            />
          </el-form-item>

          <el-form-item label="å¯†ç " prop="password">
            <el-input 
              v-model="passwordForm.password" 
              type="password" 
              show-password
              placeholder="è¯·è¾“å…¥å¯†ç "
            />
          </el-form-item>

          <el-alert type="info" :closable="false">
            é¦–æ¬¡ç™»å½•å¯èƒ½éœ€è¦è¾“å…¥éªŒè¯ç ï¼Œè¯·æŒ‰æç¤ºæ“ä½œ
          </el-alert>
        </el-form>

        <!-- æ–°å¢: è§†é¢‘æ•™ç¨‹æŒ‰é’® -->
        <div class="tutorial-section">
          <el-divider>éœ€è¦å¸®åŠ©ï¼Ÿ</el-divider>
          <el-button @click="showVideoTutorial('password-login')" text type="primary">
            <el-icon><VideoPlay /></el-icon>
            è§‚çœ‹"è´¦å·å¯†ç ç™»å½•"è§†é¢‘æ•™ç¨‹ï¼ˆ2åˆ†é’Ÿï¼‰
          </el-button>
        </div>
      </el-tab-pane>

      <!-- æ–¹æ³•2: Cookieå¯¼å…¥ -->
      <el-tab-pane label="Cookieå¯¼å…¥" name="cookie">
        <CookieImportUltimate @success="handleCookieImported" />

        <!-- æ–°å¢: è¯¦ç»†æ•™ç¨‹ -->
        <div class="tutorial-section">
          <el-divider>Cookieè·å–æ•™ç¨‹</el-divider>
          <el-space wrap>
            <el-button @click="showVideoTutorial('cookie-chrome')" text type="primary">
              <el-icon><VideoPlay /></el-icon>
              Chromeæµè§ˆå™¨ï¼ˆ3åˆ†é’Ÿï¼‰
            </el-button>
            <el-button @click="showVideoTutorial('cookie-firefox')" text type="primary">
              <el-icon><VideoPlay /></el-icon>
              Firefoxæµè§ˆå™¨ï¼ˆ3åˆ†é’Ÿï¼‰
            </el-button>
            <el-button @click="showVideoTutorial('cookie-extension')" text type="primary">
              <el-icon><VideoPlay /></el-icon>
              ä½¿ç”¨æµè§ˆå™¨æ‰©å±•ï¼ˆ1åˆ†é’Ÿï¼‰
            </el-button>
          </el-space>

          <!-- æ–°å¢: å›¾æ–‡æ•™ç¨‹é“¾æ¥ -->
          <el-card style="margin-top: 15px">
            <template #header>ğŸ“– å›¾æ–‡æ•™ç¨‹</template>
            <el-link type="primary" @click="openDocumentation('cookie-chrome')">
              Chromeæµè§ˆå™¨Cookieè·å–è¯¦ç»†æ­¥éª¤ â†’
            </el-link>
            <br/>
            <el-link type="primary" @click="openDocumentation('cookie-extension')">
              å®‰è£…å’Œä½¿ç”¨Cookie Editoræ‰©å±• â†’
            </el-link>
          </el-card>
        </div>
      </el-tab-pane>
    </el-tabs>

    <!-- è§†é¢‘æ•™ç¨‹å¯¹è¯æ¡† -->
    <el-dialog 
      v-model="videoDialogVisible" 
      :title="currentVideoTitle"
      width="70%"
      @close="handleVideoClose"
    >
      <VideoTutorial 
        :video-id="currentVideoId" 
        :autoplay="true"
      />
      
      <template #footer>
        <el-button @click="videoDialogVisible = false">å…³é—­</el-button>
        <el-button type="primary" @click="replayVideo">é‡æ–°æ’­æ”¾</el-button>
      </template>
    </el-dialog>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="wizard-actions">
      <el-button @click="emit('prev')">ä¸Šä¸€æ­¥</el-button>
      <el-button 
        type="primary" 
        @click="handleLogin"
        :loading="logging"
        :disabled="!canProceed"
      >
        {{ logging ? 'ç™»å½•ä¸­...' : 'ç™»å½•å¹¶ç»§ç»­' }}
      </el-button>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue'
import { ElMessage } from 'element-plus'
import api from '@/api'
import CookieImportUltimate from '../CookieImportUltimate.vue'
import VideoTutorial from '../VideoTutorial.vue'

const emit = defineEmits(['next', 'prev', 'openVideo'])

const loginMethod = ref('password')
const logging = ref(false)

// å¯†ç ç™»å½•è¡¨å•
const passwordForm = ref({
  email: '',
  password: ''
})

const passwordRules = {
  email: [
    { required: true, message: 'è¯·è¾“å…¥é‚®ç®±', trigger: 'blur' },
    { type: 'email', message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±', trigger: 'blur' }
  ],
  password: [
    { required: true, message: 'è¯·è¾“å…¥å¯†ç ', trigger: 'blur' },
    { min: 6, message: 'å¯†ç è‡³å°‘6ä½', trigger: 'blur' }
  ]
}

// è§†é¢‘æ•™ç¨‹
const videoDialogVisible = ref(false)
const currentVideoId = ref('')
const currentVideoTitle = ref('')

const videoMap = {
  'password-login': { title: 'è´¦å·å¯†ç ç™»å½•æ•™ç¨‹', id: 'tutorial_password_login' },
  'cookie-chrome': { title: 'Chromeè·å–Cookieæ•™ç¨‹', id: 'tutorial_cookie_chrome' },
  'cookie-firefox': { title: 'Firefoxè·å–Cookieæ•™ç¨‹', id: 'tutorial_cookie_firefox' },
  'cookie-extension': { title: 'æµè§ˆå™¨æ‰©å±•ä½¿ç”¨æ•™ç¨‹', id: 'tutorial_cookie_extension' }
}

const showVideoTutorial = (type) => {
  const video = videoMap[type]
  if (video) {
    currentVideoId.value = video.id
    currentVideoTitle.value = video.title
    videoDialogVisible.value = true
  }
}

const replayVideo = () => {
  // è§¦å‘VideoTutorialç»„ä»¶é‡æ–°æ’­æ”¾
  videoDialogVisible.value = false
  setTimeout(() => {
    videoDialogVisible.value = true
  }, 100)
}

const openDocumentation = (type) => {
  // æ‰“å¼€æ–‡æ¡£é¡µé¢
  window.open(`/docs/${type}.html`, '_blank')
}

const handleLogin = async () => {
  if (loginMethod.value === 'password') {
    // éªŒè¯è¡¨å•
    await passwordFormRef.value.validate()
    
    logging.value = true
    try {
      const result = await api.loginAccount(passwordForm.value)
      if (result.success) {
        ElMessage.success('ç™»å½•æˆåŠŸï¼')
        emit('next')
      } else {
        ElMessage.error(result.message || 'ç™»å½•å¤±è´¥')
      }
    } catch (error) {
      ElMessage.error('ç™»å½•å¼‚å¸¸: ' + error.message)
    } finally {
      logging.value = false
    }
  }
}

const handleCookieImported = () => {
  ElMessage.success('Cookieå¯¼å…¥æˆåŠŸï¼')
  emit('next')
}

const canProceed = computed(() => {
  if (loginMethod.value === 'password') {
    return passwordForm.value.email && passwordForm.value.password
  }
  return false // Cookieå¯¼å…¥ä¼šç›´æ¥è§¦å‘next
})
</script>
```

---

### 2. å®Œå–„ä¸€é”®å®‰è£…åŒ…

#### åç«¯æ‰“åŒ…é…ç½® (`backend/build_backend.spec`)

```python
# -*- mode: python ; coding: utf-8 -*-
"""
PyInstalleræ‰“åŒ…é…ç½® - å®Œæ•´ç‰ˆ
"""

import os
import sys
from pathlib import Path

# é¡¹ç›®æ ¹ç›®å½•
ROOT_DIR = Path(__file__).parent.parent

# æ”¶é›†æ‰€æœ‰ä¾èµ–
block_cipher = None

# éœ€è¦åŒ…å«çš„æ•°æ®æ–‡ä»¶
datas = [
    # RedisæœåŠ¡å™¨ï¼ˆæ ¹æ®å¹³å°é€‰æ‹©ï¼‰
    (str(ROOT_DIR / 'redis' / 'redis-server.exe'), 'redis') if sys.platform == 'win32' 
    else (str(ROOT_DIR / 'redis' / 'redis-server'), 'redis'),
    
    # Redisé…ç½®æ–‡ä»¶
    (str(ROOT_DIR / 'redis' / 'redis.conf'), 'redis'),
    
    # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
    (str(ROOT_DIR / 'backend' / 'app' / 'database.py'), 'app'),
    
    # é€‰æ‹©å™¨é…ç½®
    (str(ROOT_DIR / 'backend' / 'data' / 'selectors.yaml'), 'data'),
    
    # æ–‡æ¡£
    (str(ROOT_DIR / 'docs'), 'docs'),
]

# éœ€è¦åŒ…å«çš„äºŒè¿›åˆ¶æ–‡ä»¶
binaries = []

# éšè—å¯¼å…¥
hiddenimports = [
    'playwright',
    'playwright._impl',
    'playwright.async_api',
    'aiosqlite',
    'aiofiles',
    'aioredis',
    'aiosmtplib',
    'cryptography',
    'bcrypt',
    'orjson',
    'uvicorn',
    'uvicorn.lifespan.on',
    'uvicorn.lifespan.off',
    'uvicorn.protocols.websockets.auto',
    'uvicorn.protocols.http.auto',
    'uvicorn.loops.auto',
    'fastapi',
    'pydantic',
    'discord_webhook',
    'telegram',
    'lark_oapi',
]

a = Analysis(
    [str(ROOT_DIR / 'backend' / 'app' / 'main.py')],
    pathex=[str(ROOT_DIR / 'backend')],
    binaries=binaries,
    datas=datas,
    hiddenimports=hiddenimports,
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    [],
    exclude_binaries=True,
    name='kook-forwarder-backend',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    console=True,  # ç”Ÿäº§ç¯å¢ƒæ”¹ä¸ºFalse
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
)

coll = COLLECT(
    exe,
    a.binaries,
    a.zipfiles,
    a.datas,
    strip=False,
    upx=True,
    upx_exclude=[],
    name='kook-forwarder-backend',
)
```

#### å‰ç«¯Electron Builderé…ç½® (`frontend/package.json` - buildéƒ¨åˆ†)

```json
{
  "build": {
    "appId": "com.kookforwarder.app",
    "productName": "KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ",
    "copyright": "Copyright Â© 2025 KOOK Forwarder Team",
    "directories": {
      "output": "dist-electron",
      "buildResources": "build-resources"
    },
    "files": [
      "dist/**/*",
      "electron/**/*",
      "!node_modules/**/*",
      {
        "from": "../backend/dist/kook-forwarder-backend",
        "to": "resources/backend",
        "filter": ["**/*"]
      }
    ],
    "extraResources": [
      {
        "from": "../redis",
        "to": "redis",
        "filter": ["redis-server*", "redis.conf"]
      },
      {
        "from": "../docs",
        "to": "docs",
        "filter": ["**/*"]
      },
      {
        "from": "public/icon.png",
        "to": "icon.png"
      }
    ],
    "win": {
      "target": [
        {
          "target": "nsis",
          "arch": ["x64"]
        },
        {
          "target": "portable",
          "arch": ["x64"]
        }
      ],
      "icon": "build/icon.ico",
      "requestedExecutionLevel": "asInvoker",
      "artifactName": "${productName}-${version}-Windows-${arch}.${ext}"
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "allowElevation": true,
      "installerIcon": "build/icon.ico",
      "uninstallerIcon": "build/icon.ico",
      "installerHeaderIcon": "build/icon.ico",
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true,
      "shortcutName": "KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ",
      "include": "build/installer.nsh",
      "deleteAppDataOnUninstall": false
    },
    "mac": {
      "target": [
        {
          "target": "dmg",
          "arch": ["x64", "arm64"]
        }
      ],
      "icon": "build/icon.icns",
      "category": "public.app-category.utilities",
      "hardenedRuntime": true,
      "gatekeeperAssess": false,
      "entitlements": "build/entitlements.mac.plist",
      "entitlementsInherit": "build/entitlements.mac.plist",
      "artifactName": "${productName}-${version}-macOS-${arch}.${ext}"
    },
    "dmg": {
      "contents": [
        {
          "x": 130,
          "y": 220
        },
        {
          "x": 410,
          "y": 220,
          "type": "link",
          "path": "/Applications"
        }
      ],
      "window": {
        "width": 540,
        "height": 380
      }
    },
    "linux": {
      "target": [
        {
          "target": "AppImage",
          "arch": ["x64"]
        },
        {
          "target": "deb",
          "arch": ["x64"]
        }
      ],
      "icon": "build/icons",
      "category": "Utility",
      "maintainer": "KOOK Forwarder Team",
      "artifactName": "${productName}-${version}-Linux-${arch}.${ext}"
    },
    "publish": null,
    "compression": "maximum",
    "asar": true,
    "asarUnpack": [
      "resources/backend/**/*",
      "resources/redis/**/*"
    ]
  }
}
```

#### æ„å»ºè„šæœ¬ (`build/build_complete.sh`)

```bash
#!/bin/bash
# å®Œæ•´æ„å»ºè„šæœ¬ - ç”Ÿæˆæ‰€æœ‰å¹³å°å®‰è£…åŒ…

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "================================"
echo "KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ - å®Œæ•´æ„å»º"
echo "================================"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$PROJECT_ROOT"

# 1. æ£€æŸ¥ç¯å¢ƒ
echo -e "${YELLOW}[1/7] æ£€æŸ¥æ„å»ºç¯å¢ƒ...${NC}"
python --version || { echo -e "${RED}é”™è¯¯: Pythonæœªå®‰è£…${NC}"; exit 1; }
node --version || { echo -e "${RED}é”™è¯¯: Node.jsæœªå®‰è£…${NC}"; exit 1; }
npm --version || { echo -e "${RED}é”™è¯¯: npmæœªå®‰è£…${NC}"; exit 1; }
echo -e "${GREEN}âœ“ ç¯å¢ƒæ£€æŸ¥é€šè¿‡${NC}"

# 2. å®‰è£…åç«¯ä¾èµ–
echo -e "${YELLOW}[2/7] å®‰è£…åç«¯ä¾èµ–...${NC}"
cd backend
pip install -r requirements.txt
pip install pyinstaller
echo -e "${GREEN}âœ“ åç«¯ä¾èµ–å®‰è£…å®Œæˆ${NC}"

# 3. ä¸‹è½½Playwrightæµè§ˆå™¨
echo -e "${YELLOW}[3/7] ä¸‹è½½Playwrightæµè§ˆå™¨...${NC}"
playwright install chromium --with-deps
echo -e "${GREEN}âœ“ Chromiumä¸‹è½½å®Œæˆ${NC}"

# 4. æ‰“åŒ…åç«¯
echo -e "${YELLOW}[4/7] æ‰“åŒ…åç«¯åº”ç”¨...${NC}"
pyinstaller build_backend.spec --clean --noconfirm
if [ ! -f "dist/kook-forwarder-backend/kook-forwarder-backend" ] && [ ! -f "dist/kook-forwarder-backend/kook-forwarder-backend.exe" ]; then
    echo -e "${RED}é”™è¯¯: åç«¯æ‰“åŒ…å¤±è´¥${NC}"
    exit 1
fi
echo -e "${GREEN}âœ“ åç«¯æ‰“åŒ…å®Œæˆ${NC}"

# 5. å®‰è£…å‰ç«¯ä¾èµ–
echo -e "${YELLOW}[5/7] å®‰è£…å‰ç«¯ä¾èµ–...${NC}"
cd ../frontend
npm install
echo -e "${GREEN}âœ“ å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ${NC}"

# 6. æ„å»ºå‰ç«¯
echo -e "${YELLOW}[6/7] æ„å»ºå‰ç«¯åº”ç”¨...${NC}"
npm run build
echo -e "${GREEN}âœ“ å‰ç«¯æ„å»ºå®Œæˆ${NC}"

# 7. æ‰“åŒ…Electronåº”ç”¨
echo -e "${YELLOW}[7/7] æ‰“åŒ…Electronåº”ç”¨...${NC}"

# æ£€æµ‹æ“ä½œç³»ç»Ÿ
OS="$(uname -s)"
case "${OS}" in
    Linux*)
        echo "æ‰“åŒ…Linuxç‰ˆæœ¬..."
        npm run electron:build:linux
        ;;
    Darwin*)
        echo "æ‰“åŒ…macOSç‰ˆæœ¬..."
        npm run electron:build:mac
        ;;
    MINGW*|MSYS*|CYGWIN*)
        echo "æ‰“åŒ…Windowsç‰ˆæœ¬..."
        npm run electron:build:win
        ;;
    *)
        echo "æ‰“åŒ…æ‰€æœ‰å¹³å°ç‰ˆæœ¬..."
        npm run electron:build
        ;;
esac

echo -e "${GREEN}âœ“ Electronæ‰“åŒ…å®Œæˆ${NC}"

# 8. æ˜¾ç¤ºç»“æœ
echo ""
echo "================================"
echo -e "${GREEN}æ„å»ºå®Œæˆï¼${NC}"
echo "================================"
echo "å®‰è£…åŒ…ä½ç½®: frontend/dist-electron/"
ls -lh frontend/dist-electron/*.{exe,dmg,AppImage,deb} 2>/dev/null || echo "æœªæ‰¾åˆ°å®‰è£…åŒ…æ–‡ä»¶"

# 9. ç”Ÿæˆæ ¡éªŒå’Œ
echo ""
echo -e "${YELLOW}ç”ŸæˆSHA256æ ¡éªŒå’Œ...${NC}"
cd dist-electron
for file in *.{exe,dmg,AppImage,deb}; do
    if [ -f "$file" ]; then
        sha256sum "$file" > "$file.sha256"
        echo -e "${GREEN}âœ“ $file${NC}"
    fi
done

echo ""
echo -e "${GREEN}æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼${NC}"
```

---

### 3. Cookieå¯¼å…¥å¢å¼º

#### Cookieè§£æå™¨ (`backend/app/utils/cookie_parser.py`)

```python
"""
Cookieè§£æå™¨ - æ”¯æŒå¤šç§æ ¼å¼
"""
import json
import re
from typing import List, Dict, Any, Optional
from datetime import datetime


class CookieParser:
    """ç»Ÿä¸€çš„Cookieè§£æå™¨"""
    
    @staticmethod
    def parse(cookie_data: str) -> List[Dict[str, Any]]:
        """
        è‡ªåŠ¨è¯†åˆ«å¹¶è§£æCookieæ ¼å¼
        
        æ”¯æŒæ ¼å¼:
        1. JSONæ•°ç»„: [{"name": "key", "value": "val", ...}]
        2. Netscapeæ ¼å¼: # Netscape HTTP Cookie File
        3. Chrome DevToolsæ ¼å¼: name=value; name2=value2
        4. EditThisCookieæ ¼å¼: {"name": "key", "value": "val", ...}
        """
        cookie_data = cookie_data.strip()
        
        # æ ¼å¼1: JSONæ•°ç»„
        if cookie_data.startswith('['):
            return CookieParser._parse_json_array(cookie_data)
        
        # æ ¼å¼2: Netscapeæ ¼å¼
        if '# Netscape HTTP Cookie File' in cookie_data or '\t' in cookie_data:
            return CookieParser._parse_netscape(cookie_data)
        
        # æ ¼å¼3: Chrome DevToolsæ ¼å¼
        if '=' in cookie_data and (';' in cookie_data or '\n' not in cookie_data):
            return CookieParser._parse_key_value_pairs(cookie_data)
        
        # æ ¼å¼4: EditThisCookie JSONå¯¹è±¡
        if cookie_data.startswith('{'):
            return CookieParser._parse_edit_this_cookie(cookie_data)
        
        raise ValueError(f"æ— æ³•è¯†åˆ«çš„Cookieæ ¼å¼ã€‚è¯·ç¡®ä¿ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ä¹‹ä¸€:\\n"
                       f"1. JSONæ•°ç»„ [{{...}}]\\n"
                       f"2. Netscapeæ ¼å¼\\n"
                       f"3. name=value; name2=value2\\n"
                       f"4. EditThisCookie JSON")
    
    @staticmethod
    def _parse_json_array(data: str) -> List[Dict]:
        """è§£æJSONæ•°ç»„æ ¼å¼"""
        try:
            cookies = json.loads(data)
            if not isinstance(cookies, list):
                raise ValueError("JSONæ ¼å¼é”™è¯¯ï¼šåº”è¯¥æ˜¯æ•°ç»„")
            
            # æ ‡å‡†åŒ–å­—æ®µ
            standardized = []
            for cookie in cookies:
                standardized.append(CookieParser._standardize_cookie(cookie))
            
            return standardized
        except json.JSONDecodeError as e:
            raise ValueError(f"JSONè§£æå¤±è´¥: {str(e)}")
    
    @staticmethod
    def _parse_netscape(data: str) -> List[Dict]:
        """
        è§£æNetscapeæ ¼å¼
        æ ¼å¼: domain\tflag\tpath\tsecure\texpiration\tname\tvalue
        """
        cookies = []
        for line in data.split('\n'):
            line = line.strip()
            if not line or line.startswith('#'):
                continue
            
            parts = line.split('\t')
            if len(parts) < 7:
                continue
            
            domain, flag, path, secure, expiration, name, value = parts[:7]
            
            cookie = {
                'name': name,
                'value': value,
                'domain': domain,
                'path': path,
                'secure': secure.lower() == 'true',
                'httpOnly': flag.lower() == 'true',
                'sameSite': 'Lax'
            }
            
            # è½¬æ¢è¿‡æœŸæ—¶é—´
            try:
                exp_timestamp = int(expiration)
                if exp_timestamp > 0:
                    cookie['expires'] = exp_timestamp
            except:
                pass
            
            cookies.append(cookie)
        
        return cookies
    
    @staticmethod
    def _parse_key_value_pairs(data: str) -> List[Dict]:
        """
        è§£æé”®å€¼å¯¹æ ¼å¼
        æ ¼å¼: name=value; name2=value2
        """
        cookies = []
        
        # åˆ†å‰²å¤šä¸ªCookie
        pairs = []
        if ';' in data:
            pairs = [p.strip() for p in data.split(';')]
        else:
            pairs = [line.strip() for line in data.split('\n') if '=' in line]
        
        for pair in pairs:
            if '=' not in pair:
                continue
            
            name, value = pair.split('=', 1)
            cookies.append({
                'name': name.strip(),
                'value': value.strip(),
                'domain': '.kookapp.cn',  # é»˜è®¤åŸŸå
                'path': '/',
                'secure': True,
                'httpOnly': True,
                'sameSite': 'Lax'
            })
        
        return cookies
    
    @staticmethod
    def _parse_edit_this_cookie(data: str) -> List[Dict]:
        """è§£æEditThisCookieå¯¼å‡ºçš„JSONå¯¹è±¡"""
        try:
            cookie = json.loads(data)
            if isinstance(cookie, dict):
                # å•ä¸ªCookieå¯¹è±¡
                return [CookieParser._standardize_cookie(cookie)]
            elif isinstance(cookie, list):
                # å¤šä¸ªCookie
                return [CookieParser._standardize_cookie(c) for c in cookie]
            else:
                raise ValueError("EditThisCookieæ ¼å¼é”™è¯¯")
        except json.JSONDecodeError as e:
            raise ValueError(f"JSONè§£æå¤±è´¥: {str(e)}")
    
    @staticmethod
    def _standardize_cookie(cookie: Dict) -> Dict:
        """æ ‡å‡†åŒ–Cookieå­—æ®µ"""
        # ç¡®ä¿å¿…éœ€å­—æ®µå­˜åœ¨
        required_fields = ['name', 'value']
        for field in required_fields:
            if field not in cookie:
                raise ValueError(f"Cookieç¼ºå°‘å¿…éœ€å­—æ®µ: {field}")
        
        # æ ‡å‡†åŒ–å­—æ®µåï¼ˆå…¼å®¹ä¸åŒæ ¼å¼ï¼‰
        standardized = {
            'name': cookie.get('name'),
            'value': cookie.get('value'),
            'domain': cookie.get('domain') or cookie.get('Domain') or '.kookapp.cn',
            'path': cookie.get('path') or cookie.get('Path') or '/',
            'secure': cookie.get('secure') or cookie.get('Secure') or True,
            'httpOnly': cookie.get('httpOnly') or cookie.get('HttpOnly') or False,
            'sameSite': cookie.get('sameSite') or cookie.get('SameSite') or 'Lax'
        }
        
        # å¯é€‰å­—æ®µ
        if 'expires' in cookie or 'Expires' in cookie:
            expires = cookie.get('expires') or cookie.get('Expires')
            if isinstance(expires, str):
                # å°è¯•è§£ææ—¥æœŸå­—ç¬¦ä¸²
                try:
                    dt = datetime.fromisoformat(expires)
                    standardized['expires'] = int(dt.timestamp())
                except:
                    pass
            elif isinstance(expires, (int, float)):
                standardized['expires'] = int(expires)
        
        return standardized
    
    @staticmethod
    def validate(cookies: List[Dict]) -> bool:
        """éªŒè¯Cookieåˆ—è¡¨çš„æœ‰æ•ˆæ€§"""
        if not cookies:
            return False
        
        # æ£€æŸ¥KOOKå¿…éœ€çš„Cookie
        required_cookies = ['token', 'user_id']  # KOOKå¿…éœ€çš„Cookieåç§°
        cookie_names = [c['name'] for c in cookies]
        
        for required in required_cookies:
            if required not in cookie_names:
                print(f"è­¦å‘Š: ç¼ºå°‘å¿…éœ€Cookie: {required}")
                # ä¸è¦å› ä¸ºç¼ºå°‘æŸä¸ªCookieå°±æ‹’ç»ï¼Œå› ä¸ºKOOKçš„Cookieåç§°å¯èƒ½å˜åŒ–
        
        return True
    
    @staticmethod
    def to_playwright_format(cookies: List[Dict]) -> List[Dict]:
        """è½¬æ¢ä¸ºPlaywrightå¯ç”¨çš„æ ¼å¼"""
        playwright_cookies = []
        
        for cookie in cookies:
            pw_cookie = {
                'name': cookie['name'],
                'value': cookie['value'],
                'domain': cookie.get('domain', '.kookapp.cn'),
                'path': cookie.get('path', '/'),
            }
            
            # å¯é€‰å­—æ®µ
            if 'expires' in cookie:
                pw_cookie['expires'] = cookie['expires']
            if 'httpOnly' in cookie:
                pw_cookie['httpOnly'] = cookie['httpOnly']
            if 'secure' in cookie:
                pw_cookie['secure'] = cookie['secure']
            if 'sameSite' in cookie:
                pw_cookie['sameSite'] = cookie['sameSite']
            
            playwright_cookies.append(pw_cookie)
        
        return playwright_cookies


# å…¨å±€å®ä¾‹
cookie_parser = CookieParser()
```

#### Cookieå¯¼å…¥API (`backend/app/api/cookie_import.py` - å¢å¼ºç‰ˆ)

```python
"""
Cookieå¯¼å…¥API - å¢å¼ºç‰ˆ
"""
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from typing import Optional
from ..utils.cookie_parser import cookie_parser
from ..utils.logger import logger
from ..database import db
from ..kook.scraper import KookScraper

router = APIRouter(prefix="/api/cookie", tags=["Cookieå¯¼å…¥"])


class CookieImportRequest(BaseModel):
    """Cookieå¯¼å…¥è¯·æ±‚"""
    cookie_data: str
    account_email: Optional[str] = None  # å¯é€‰: è´¦å·é‚®ç®±ï¼ˆç”¨äºæ ‡è¯†ï¼‰
    auto_test: bool = True  # æ˜¯å¦è‡ªåŠ¨æµ‹è¯•Cookieæœ‰æ•ˆæ€§


class CookieValidationResponse(BaseModel):
    """CookieéªŒè¯å“åº”"""
    valid: bool
    message: str
    cookie_count: int
    missing_cookies: list[str] = []
    warnings: list[str] = []


@router.post("/import")
async def import_cookie(request: CookieImportRequest):
    """
    å¯¼å…¥Cookie
    
    æ”¯æŒå¤šç§æ ¼å¼:
    - JSONæ•°ç»„
    - Netscapeæ ¼å¼
    - Chrome DevToolsæ ¼å¼
    - EditThisCookieæ ¼å¼
    """
    try:
        # 1. è§£æCookie
        logger.info(f"å¼€å§‹è§£æCookieï¼Œæ•°æ®é•¿åº¦: {len(request.cookie_data)}")
        cookies = cookie_parser.parse(request.cookie_data)
        logger.info(f"è§£ææˆåŠŸï¼Œå…±{len(cookies)}ä¸ªCookie")
        
        # 2. éªŒè¯Cookie
        if not cookie_parser.validate(cookies):
            return {
                "success": False,
                "message": "CookieéªŒè¯å¤±è´¥ï¼šç¼ºå°‘å¿…éœ€çš„è®¤è¯Cookie"
            }
        
        # 3. å¯é€‰: æµ‹è¯•Cookieæœ‰æ•ˆæ€§
        if request.auto_test:
            logger.info("å¼€å§‹æµ‹è¯•Cookieæœ‰æ•ˆæ€§...")
            is_valid, test_message = await test_cookie_validity(cookies)
            
            if not is_valid:
                return {
                    "success": False,
                    "message": f"Cookieæµ‹è¯•å¤±è´¥: {test_message}",
                    "details": {
                        "cookie_count": len(cookies),
                        "test_result": test_message
                    }
                }
        
        # 4. ä¿å­˜Cookieåˆ°æ•°æ®åº“
        account_id = db.add_account(
            email=request.account_email or "cookie_import_" + str(len(cookies)),
            cookie=json.dumps(cookies),
            password_encrypted=None
        )
        
        logger.info(f"Cookieå¯¼å…¥æˆåŠŸï¼Œè´¦å·ID: {account_id}")
        
        return {
            "success": True,
            "message": "Cookieå¯¼å…¥æˆåŠŸï¼",
            "data": {
                "account_id": account_id,
                "cookie_count": len(cookies),
                "test_passed": request.auto_test
            }
        }
        
    except ValueError as e:
        logger.error(f"Cookieè§£æå¤±è´¥: {str(e)}")
        raise HTTPException(status_code=400, detail=str(e))
    
    except Exception as e:
        logger.error(f"Cookieå¯¼å…¥å¤±è´¥: {str(e)}", exc_info=True)
        raise HTTPException(status_code=500, detail="Cookieå¯¼å…¥å¤±è´¥")


@router.post("/validate")
async def validate_cookie(request: CookieImportRequest) -> CookieValidationResponse:
    """
    éªŒè¯Cookieï¼ˆä¸ä¿å­˜ï¼‰
    
    ç”¨äºç”¨æˆ·å¯¼å…¥å‰é¢„æ£€æŸ¥
    """
    try:
        # è§£æCookie
        cookies = cookie_parser.parse(request.cookie_data)
        
        # éªŒè¯
        is_valid = cookie_parser.validate(cookies)
        
        # æ£€æŸ¥ç¼ºå¤±çš„Cookie
        required_cookies = ['token', 'user_id']
        cookie_names = [c['name'] for c in cookies]
        missing = [c for c in required_cookies if c not in cookie_names]
        
        # ç”Ÿæˆè­¦å‘Š
        warnings = []
        if missing:
            warnings.append(f"ç¼ºå°‘ä»¥ä¸‹Cookie: {', '.join(missing)}")
        
        # æ£€æŸ¥è¿‡æœŸ
        import time
        now = time.time()
        for cookie in cookies:
            if 'expires' in cookie and cookie['expires'] < now:
                warnings.append(f"Cookie '{cookie['name']}' å·²è¿‡æœŸ")
        
        return CookieValidationResponse(
            valid=is_valid and len(missing) == 0,
            message="CookieéªŒè¯é€šè¿‡" if is_valid else "CookieéªŒè¯å¤±è´¥",
            cookie_count=len(cookies),
            missing_cookies=missing,
            warnings=warnings
        )
        
    except ValueError as e:
        return CookieValidationResponse(
            valid=False,
            message=str(e),
            cookie_count=0
        )


async def test_cookie_validity(cookies: list[dict]) -> tuple[bool, str]:
    """
    æµ‹è¯•Cookieæœ‰æ•ˆæ€§
    
    Returns:
        (æ˜¯å¦æœ‰æ•ˆ, æµ‹è¯•æ¶ˆæ¯)
    """
    try:
        # åˆ›å»ºä¸´æ—¶Scraperæµ‹è¯•
        scraper = KookScraper(account_id=-1)  # ä¸´æ—¶ID
        
        # å°è¯•å¯åŠ¨å¹¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        success = await scraper.start(cookie=json.dumps(cookies))
        
        if success:
            # å°è¯•è·å–æœåŠ¡å™¨åˆ—è¡¨éªŒè¯
            servers = await scraper.get_servers()
            await scraper.stop()
            
            if servers:
                return True, f"Cookieæœ‰æ•ˆï¼Œæ£€æµ‹åˆ°{len(servers)}ä¸ªæœåŠ¡å™¨"
            else:
                return False, "Cookieå¯èƒ½å·²è¿‡æœŸï¼Œæ— æ³•è·å–æœåŠ¡å™¨åˆ—è¡¨"
        else:
            return False, "Cookieæ— æ•ˆæˆ–å·²è¿‡æœŸ"
            
    except Exception as e:
        logger.error(f"Cookieæµ‹è¯•å¼‚å¸¸: {str(e)}")
        return False, f"æµ‹è¯•å¼‚å¸¸: {str(e)}"


@router.get("/formats")
async def get_supported_formats():
    """è·å–æ”¯æŒçš„Cookieæ ¼å¼è¯´æ˜"""
    return {
        "formats": [
            {
                "name": "JSONæ•°ç»„",
                "description": "Chrome DevToolså¯¼å‡ºçš„JSONæ ¼å¼",
                "example": '[{"name":"token","value":"xxx","domain":".kookapp.cn"}]',
                "recommended": True
            },
            {
                "name": "Netscapeæ ¼å¼",
                "description": "Firefoxå¯¼å‡ºçš„Netscape HTTP Cookieæ ¼å¼",
                "example": ".kookapp.cn\\tTRUE\\t/\\tTRUE\\t0\\ttoken\\txxx",
                "recommended": False
            },
            {
                "name": "é”®å€¼å¯¹æ ¼å¼",
                "description": "ç®€å•çš„name=valueæ ¼å¼",
                "example": "token=xxx; user_id=123",
                "recommended": False
            },
            {
                "name": "EditThisCookie",
                "description": "EditThisCookieæ‰©å±•å¯¼å‡ºçš„æ ¼å¼",
                "example": '{"name":"token","value":"xxx"}',
                "recommended": True
            }
        ],
        "tutorials": [
            {
                "browser": "Chrome",
                "video_id": "cookie-chrome",
                "doc_url": "/docs/cookie-chrome.html"
            },
            {
                "browser": "Firefox",
                "video_id": "cookie-firefox",
                "doc_url": "/docs/cookie-firefox.html"
            }
        ]
    }
```

---

## ğŸ“ å®æ–½æ£€æŸ¥æ¸…å•

### P0ä¼˜åŒ–å®Œæˆæ ‡å‡†

#### âœ… é¦–æ¬¡é…ç½®å‘å¯¼

- [ ] å…è´£å£°æ˜å†…å®¹å®Œæ•´ï¼ˆ5é¡¹é£é™©æç¤ºï¼‰
- [ ] è§†é¢‘æ•™ç¨‹é›†æˆï¼ˆ5ä¸ªæ•™ç¨‹ï¼‰
- [ ] å›¾æ–‡æ•™ç¨‹é“¾æ¥ï¼ˆ6ä¸ªæµè§ˆå™¨ï¼‰
- [ ] æ™ºèƒ½æœåŠ¡å™¨é¢„é€‰ï¼ˆåŸºäºæ´»è·ƒåº¦ï¼‰
- [ ] Boté…ç½®æµ‹è¯•å®æ—¶åé¦ˆ
- [ ] æ™ºèƒ½æ˜ å°„ç®—æ³•ï¼ˆç›¸ä¼¼åº¦80%+ï¼‰
- [ ] ç”¨æˆ·æ‰‹åŠ¨æµ‹è¯•é€šè¿‡ï¼ˆ10äººï¼‰

#### âœ… ä¸€é”®å®‰è£…åŒ…

- [ ] Windows exeç”Ÿæˆï¼ˆ<200MBï¼‰
- [ ] macOS dmgç”Ÿæˆï¼ˆ<200MBï¼‰
- [ ] Linux AppImageç”Ÿæˆï¼ˆ<200MBï¼‰
- [ ] å†…ç½®Redisæµ‹è¯•é€šè¿‡
- [ ] å†…ç½®Chromiumæµ‹è¯•é€šè¿‡
- [ ] å®‰è£…åé¦–æ¬¡å¯åŠ¨æˆåŠŸç‡90%+
- [ ] 3ä¸ªå¹³å°å®‰è£…æµ‹è¯•é€šè¿‡

#### âœ… Cookieå¯¼å…¥

- [ ] æ”¯æŒ4ç§æ ¼å¼
- [ ] æ ¼å¼è‡ªåŠ¨è¯†åˆ«å‡†ç¡®ç‡100%
- [ ] å®æ—¶éªŒè¯åŠŸèƒ½
- [ ] Chromeæ‰©å±•å‘å¸ƒ
- [ ] è§†é¢‘æ•™ç¨‹å½•åˆ¶ï¼ˆ3ä¸ªï¼‰
- [ ] å›¾æ–‡æ•™ç¨‹æ›´æ–°ï¼ˆ2ä¸ªï¼‰
- [ ] ç”¨æˆ·æµ‹è¯•æˆåŠŸç‡95%+

---

## ğŸ“ è”ç³»å¼€å‘å›¢é˜Ÿ

å¦‚éœ€æŠ€æœ¯æ”¯æŒæˆ–è®¨è®ºå®æ–½ç»†èŠ‚ï¼š
- GitHub Issues: https://github.com/gfchfjh/CSBJJWT/issues
- Email: dev@kookforwarder.com

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-25
