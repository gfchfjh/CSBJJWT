# KOOK消息转发系统 v1.11.0 - 测试指南

> **版本**: v1.11.0  
> **测试日期**: 2025-10-20  
> **预计测试时间**: 30分钟  

---

## 🎯 测试目标

验证v1.11.0新增的3个核心功能：
1. Cookie自动重新登录机制
2. 转发失败详细诊断系统
3. 频道映射模板功能

---

## 🧪 测试准备

### 环境要求

- ✅ 已安装v1.11.0版本
- ✅ 后端服务运行正常
- ✅ 前端应用可访问
- ✅ 至少有1个KOOK账号
- ✅ 至少配置1个目标平台Bot

### 准备工作

```bash
# 1. 确认版本
# 查看 package.json 或 config.py 中的版本号应为 1.11.0

# 2. 启动服务
./start.sh  # Linux/macOS
# 或
start.bat  # Windows

# 3. 访问前端
# 浏览器打开: http://localhost:5173
# 或 Electron应用
```

---

## 📋 测试清单

### 测试1: Cookie自动重新登录 ⭐⭐⭐

#### 测试步骤

1. **添加测试账号**
   ```
   - 访问"账号管理"页面
   - 点击"添加账号"
   - 使用账号密码登录（重要：必须是密码登录）
   - 等待账号状态变为"在线"
   ```

2. **模拟Cookie过期**
   ```
   方式A（推荐）：
   - 直接在数据库中清空Cookie字段
   - 执行SQL: UPDATE accounts SET cookie = NULL WHERE id = 1;
   
   方式B：
   - 等待Cookie自然过期（可能需要几小时）
   
   方式C（开发测试）：
   - 修改KOOK网站密码，使Cookie失效
   ```

3. **观察自动重新登录**
   ```
   - 等待约1-2分钟（心跳检测周期）
   - 观察系统日志
   - 应该看到类似以下日志：
   
   🔍 检测到连接异常，检查是否需要重新登录...
   ❌ 检测到Cookie已过期或登录失效
   🔑 正在使用存储的凭据自动重新登录: user@example.com
   ✅ 自动重新登录成功
   📝 已更新Cookie到数据库
   ```

4. **验证结果**
   ```
   - 账号状态应恢复为"在线"
   - 数据库中Cookie字段已更新
   - 消息可以正常转发
   ```

#### 预期结果

- ✅ 自动检测到Cookie失效
- ✅ 自动使用存储密码重新登录
- ✅ 账号状态自动恢复为"在线"
- ✅ 无需用户手动操作

#### 如果测试失败

**检查项**:
1. 账号是否使用密码登录（Cookie登录无法自动重登）
2. 数据库中是否有 `password_encrypted` 字段
3. 主密码是否正确（用于解密密码）
4. 查看详细日志：`data/logs/app.log`

---

### 测试2: 转发失败详细诊断 ⭐⭐⭐

#### 测试步骤

**场景A: API限流错误**

1. **制造限流场景**
   ```
   - 在短时间内发送大量消息（>30条/分钟）
   - 或手动修改限流配置为极低值（测试用）
   ```

2. **观察诊断结果**
   ```
   - 查看系统日志
   - 应该看到详细的诊断报告：
   
   ❌ 错误诊断报告
   ==================================================
   错误类型: RateLimitException
   匹配规则: rate_limit
   
   💡 解决方案:
   目标平台API限流，请等待或配置多个Webhook/Bot以提升吞吐量
   
   📋 建议步骤:
     1. 等待限流时间结束（通常1-5分钟）
     2. 配置多个Webhook/Bot实现负载均衡
     3. 降低消息发送频率
     4. 检查是否有过多的频道映射
   
   🔧 系统将尝试自动修复
   ==================================================
   
   🔧 尝试自动修复策略: wait_and_retry
   ⏰ API限流，等待60秒后重试
   ```

3. **验证自动修复**
   ```
   - 等待60秒
   - 消息应该自动重新发送
   - 日志显示"重试成功"
   ```

**场景B: Webhook无效错误**

1. **配置无效Webhook**
   ```
   - 访问"机器人配置"页面
   - 添加一个错误的Discord Webhook URL
   - 例如: https://discord.com/api/webhooks/invalid
   ```

2. **尝试转发消息**
   ```
   - 配置频道映射使用这个无效Webhook
   - 发送测试消息
   ```

3. **观察诊断结果**
   ```
   - 查看日志应显示：
   
   ❌ 错误诊断报告
   ==================================================
   匹配规则: webhook_invalid
   
   💡 解决方案:
   Webhook URL无效或已被删除
   
   📋 建议步骤:
     1. 重新创建Discord Webhook
     2. 检查Webhook URL是否完整
     3. 确认Webhook未被删除或禁用
     4. 在Bot配置页重新配置Webhook
   
   ⚠️ 无法自动修复，需要人工介入
   ==================================================
   ```

**场景C: 网络超时错误**

1. **模拟网络超时**
   ```
   - 方式1: 暂时断开网络连接
   - 方式2: 使用iptables阻止出站连接（Linux）
   - 方式3: 修改hosts文件使域名无法解析
   ```

2. **观察诊断和自动修复**
   ```
   - 应该看到网络超时诊断
   - 系统自动等待30秒后重试
   - 网络恢复后消息自动发送成功
   ```

#### 预期结果

- ✅ 每种错误都有详细的诊断报告
- ✅ 显示错误类型、解决方案、建议步骤
- ✅ 可自动修复的错误会自动处理
- ✅ 不可自动修复的提供详细指导

#### 如果测试失败

**检查项**:
1. 确认`error_diagnosis.py`文件已添加
2. 确认`worker.py`已集成诊断代码
3. 查看详细日志验证诊断是否触发
4. 检查诊断规则是否正确匹配

---

### 测试3: 频道映射模板 ⭐⭐⭐

#### 测试步骤

1. **准备测试环境**
   ```
   - 确保至少配置了1个Bot（Discord/Telegram/飞书任意）
   - 访问"频道映射"页面
   - 如有现有映射，建议先导出备份
   ```

2. **打开模板对话框**
   ```
   - 点击"使用模板"按钮
   - 应该弹出模板选择对话框
   - 显示3个模板卡片：
     * 游戏公告模板
     * 社区管理模板
     * 跨平台镜像模板
   ```

3. **选择模板**
   ```
   - 点击"游戏公告模板"卡片
   - 卡片应该高亮显示（蓝色边框）
   - 底部显示"已选择：游戏公告模板"
   ```

4. **应用模板**
   ```
   - 点击"应用模板"按钮
   - 弹出二次确认对话框：
     "确定要应用「游戏公告模板」吗？这将替换当前所有映射配置。"
   - 点击"确定"
   ```

5. **验证结果**
   ```
   - 显示成功消息："模板应用成功！共创建 X 条映射"
   - 映射列表自动刷新
   - 检查生成的映射：
     * 如果有Discord Bot → 应该有4条Discord映射
     * 如果有Telegram Bot → 应该有4条Telegram映射
     * 如果有飞书Bot → 应该有4条飞书映射
   - 验证映射内容：
     * KOOK频道名称正确（📢 公告频道、🎉 活动频道等）
     * 目标频道ID正确（announcements、events等）
     * 目标Bot已自动分配
   ```

6. **测试其他模板**
   ```
   - 重复步骤2-5，测试"社区管理模板"
   - 重复步骤2-5，测试"跨平台镜像模板"
   ```

#### 预期结果

- ✅ 模板对话框正常显示
- ✅ 卡片选择交互流畅
- ✅ 应用模板后生成正确数量的映射
- ✅ 映射配置正确（频道名、ID、平台）
- ✅ 自动分配已配置的Bot
- ✅ 配置时间<30秒

#### UI检查项

- ✅ 模板卡片悬停效果（上移+阴影）
- ✅ 选中状态显示（蓝色边框）
- ✅ 响应式布局（3列对齐）
- ✅ 图标和文字清晰易读
- ✅ 二次确认对话框防误操作

#### 如果测试失败

**检查项**:
1. 确认`Mapping.vue`已更新
2. 确认有至少1个配置的Bot
3. 检查浏览器控制台是否有错误
4. 验证API调用是否成功（Network标签）

---

## 🧪 自动化测试

### 运行单元测试

```bash
# 后端测试
cd backend
pytest tests/test_v1_11_0_features.py -v

# 预期输出
test_diagnose_rate_limit_error PASSED          [  7%]
test_diagnose_invalid_token_error PASSED       [ 14%]
test_diagnose_network_timeout_error PASSED     [ 21%]
test_diagnose_message_too_long_error PASSED    [ 28%]
test_diagnose_channel_not_found_error PASSED   [ 35%]
test_diagnose_image_upload_failed_error PASSED [ 42%]
test_diagnose_unknown_error PASSED             [ 50%]
test_format_diagnosis_message PASSED           [ 57%]
test_get_auto_fix_strategy PASSED              [ 64%]
test_log_diagnosis PASSED                      [ 71%]
test_get_recent_diagnostics PASSED             [ 78%]
test_get_statistics PASSED                     [ 85%]
test_max_history_limit PASSED                  [ 92%]

======================== 13 passed in 0.5s ========================
```

### 运行集成测试

```bash
# 错误诊断集成测试
cd backend
pytest tests/test_worker_e2e.py::test_error_diagnosis_integration -v

# 前端E2E测试（如有）
cd frontend
npm run test:e2e
```

---

## 📊 测试报告模板

### 测试执行记录

| 测试项 | 状态 | 执行人 | 备注 |
|--------|------|--------|------|
| Cookie自动重新登录 | ⬜ 待测试 | | |
| API限流诊断 | ⬜ 待测试 | | |
| Token无效诊断 | ⬜ 待测试 | | |
| 网络超时诊断 | ⬜ 待测试 | | |
| 游戏公告模板 | ⬜ 待测试 | | |
| 社区管理模板 | ⬜ 待测试 | | |
| 跨平台镜像模板 | ⬜ 待测试 | | |
| 单元测试 | ⬜ 待测试 | | |

### 问题记录

| 序号 | 问题描述 | 严重程度 | 状态 | 解决方案 |
|------|---------|---------|------|---------|
| 1 | | | | |
| 2 | | | | |

---

## ✅ 测试完成标准

所有测试项通过以下标准才算完成：

### Cookie自动重新登录

- ✅ Cookie过期能自动检测
- ✅ 自动重新登录成功率 ≥ 95%
- ✅ 重新登录耗时 < 15秒
- ✅ Cookie成功更新到数据库
- ✅ 账号状态恢复为"在线"

### 错误诊断系统

- ✅ 所有11种错误规则正确匹配
- ✅ 诊断报告格式清晰易读
- ✅ 自动修复策略正确触发
- ✅ 自动修复成功率 ≥ 70%
- ✅ 诊断日志正常记录

### 模板功能

- ✅ 3个模板UI正常显示
- ✅ 模板选择交互流畅
- ✅ 应用模板生成正确映射
- ✅ 映射数量正确（4-12条）
- ✅ 配置完成时间 < 30秒

### 性能指标

- ✅ 内存增加 < 10MB
- ✅ CPU占用增加 < 5%
- ✅ 响应时间无明显变化
- ✅ 无内存泄漏

---

## 🔍 常见测试问题

### Q1: 自动重新登录没有触发？

**可能原因**:
1. 账号是用Cookie登录的（需要密码登录）
2. 数据库中没有存储密码
3. Cookie实际未过期

**解决方案**:
- 删除账号，重新使用密码登录
- 检查数据库 `accounts` 表的 `password_encrypted` 字段

### Q2: 错误诊断不显示？

**可能原因**:
1. `error_diagnosis.py` 文件未添加
2. `worker.py` 未集成诊断代码
3. 日志级别设置过高

**解决方案**:
- 检查文件是否存在
- 设置日志级别为DEBUG: `LOG_LEVEL=DEBUG`

### Q3: 模板功能找不到？

**可能原因**:
1. `Mapping.vue` 未更新
2. 浏览器缓存未刷新
3. 前端未重新构建

**解决方案**:
- 硬刷新浏览器（Ctrl+F5）
- 重新构建前端: `npm run build`
- 清除浏览器缓存

---

## 📝 测试报告提交

测试完成后，请提交测试报告到：

- 📧 邮件: 项目邮箱
- 📝 GitHub Issue: 使用"Test Report"标签
- 💬 内部讨论: 团队沟通渠道

### 报告格式

```markdown
# v1.11.0测试报告

## 测试环境
- 操作系统: Windows 11 / macOS 13 / Ubuntu 22.04
- Python版本: 3.11.x
- Node.js版本: 18.x
- 测试日期: YYYY-MM-DD

## 测试结果
- Cookie自动重新登录: ✅ 通过 / ❌ 失败
- 错误诊断系统: ✅ 通过 / ❌ 失败  
- 模板功能: ✅ 通过 / ❌ 失败

## 发现问题
1. [问题描述]
2. [问题描述]

## 改进建议
1. [建议内容]
2. [建议内容]
```

---

## 🎉 测试完成

所有测试通过后，v1.11.0即可正式发布！

**预期测试结果**:
- ✅ 功能完整性: 100%
- ✅ 稳定性: 优秀
- ✅ 用户体验: 显著提升
- ✅ 性能影响: 可忽略

**建议测试人员**: 2-3人  
**建议测试时间**: 每人30-60分钟  
**建议测试环境**: Windows + macOS + Linux 各1台  

---

<div align="center>

**祝测试顺利！** 🚀

如有任何问题，请随时联系开发团队。

</div>
