# 🚀 快速开始 - KOOK消息转发系统

**版本**: v1.1.0 (增强版)  
**更新日期**: 2025-10-15

---

## 📦 完善后的新特性

✅ **附件文件下载** - 支持最大50MB文件  
✅ **完整过滤规则** - 关键词、用户、类型多维度过滤  
✅ **智能DOM选择器** - 多选择器容错，自动适配  
✅ **图床Token验证** - 安全的图片访问控制  
✅ **自动清理任务** - 定期清理旧图片和附件  
✅ **一键启动脚本** - Windows/Linux/macOS全平台支持  
✅ **完整打包系统** - Redis配置和启动脚本  

---

## 🎯 10分钟快速上手

### 第1步：下载Redis（必需）⭐⭐⭐⭐⭐

**Windows用户**:
```powershell
# 1. 访问 https://github.com/tporadowski/redis/releases
# 2. 下载 Redis-x64-xxx.zip
# 3. 解压后复制以下文件到 redis/ 目录：
#    - redis-server.exe
#    - redis-cli.exe
```

**macOS用户**:
```bash
# 使用Homebrew安装
brew install redis

# 复制到项目目录
cp /usr/local/bin/redis-server redis/
cp /usr/local/bin/redis-cli redis/
```

**Linux用户**:
```bash
# Ubuntu/Debian
sudo apt-get install redis-server

# 复制到项目目录
sudo cp /usr/bin/redis-server redis/
sudo cp /usr/bin/redis-cli redis/
```

**验证安装**:
```bash
# 检查文件是否存在
ls redis/redis-server*
```

---

### 第2步：安装依赖

**后端依赖**:
```bash
cd backend
pip install -r requirements.txt
playwright install chromium
```

**前端依赖**:
```bash
cd frontend
npm install
```

---

### 第3步：一键启动 🚀

**Windows**:
```bash
# 双击运行或命令行执行
start.bat
```

**Linux/macOS**:
```bash
# 赋予执行权限（首次需要）
chmod +x start.sh

# 启动
./start.sh
```

**启动成功后会看到**:
```
========================================
✅ 所有服务已启动！

📝 访问地址: http://localhost:5173
📊 后端API: http://localhost:9527
🖼️  图床服务: http://localhost:9528

按任意键打开浏览器...
========================================
```

---

### 第4步：首次配置

1. **浏览器自动打开** → http://localhost:5173

2. **配置向导**（3步完成）:
   ```
   第1步: 欢迎页 → 点击"开始配置"
   第2步: 登录KOOK → 选择Cookie导入（推荐）
   第3步: 配置机器人 → 添加Discord/Telegram/飞书
   第4步: 完成 → 进入主界面
   ```

3. **获取KOOK Cookie**:
   - 在浏览器登录 https://www.kookapp.cn
   - 按F12打开开发者工具
   - Application → Cookies → 复制所有Cookie
   - 粘贴到配置向导

4. **配置Discord Webhook**:
   - 进入Discord服务器设置
   - 集成 → Webhooks → 新建Webhook
   - 复制URL → 粘贴到配置页

5. **启动服务**:
   - 点击右上角"启动服务"按钮
   - 观察实时日志确认消息转发

---

## 🎨 新功能使用指南

### 1. 过滤规则（新功能！）

**进入**: 侧边栏 → 过滤规则

**功能**:
- ✅ 关键词黑名单 - 屏蔽广告消息
- ✅ 关键词白名单 - 仅转发重要通知
- ✅ 用户黑名单 - 屏蔽刷屏用户
- ✅ 用户白名单 - 仅转发官方账号
- ✅ 消息类型 - 选择转发文本/图片/文件
- ✅ @全体成员 - 仅转发重要公告

**示例**:
```
黑名单关键词: 广告, 代练, 外挂
白名单关键词: 官方公告, 版本更新, 重要通知
黑名单用户: 广告机器人
白名单用户: 官方管理员
```

---

### 2. 附件下载（新功能！）

**自动功能** - 无需配置

**支持**:
- ✅ 最大50MB文件
- ✅ PDF、Word、Excel等文档
- ✅ 压缩包（zip、rar）
- ✅ 自动防盗链处理
- ✅ 7天自动清理

**查看下载的文件**:
```
位置: ~/Documents/KookForwarder/data/attachments/
```

---

### 3. 图床服务（增强！）

**新增特性**:
- ✅ Token验证 - 每个图片URL附带安全Token
- ✅ 2小时有效期 - Token自动过期
- ✅ 自动清理 - 每天清理7天前的旧图
- ✅ 空间管理 - 超过10GB自动清理

**访问统计**:
```
进入: http://localhost:9528/stats

返回:
{
  "total_images": 1234,
  "total_size_mb": 567.89,
  "total_size_gb": 0.55,
  "active_tokens": 42
}
```

---

## 🔧 常见问题

### Q1: Redis启动失败？

**Windows**:
```bash
# 检查端口是否被占用
netstat -ano | findstr 6379

# 如果被占用，修改redis.conf中的端口
# port 6379 → port 6380
```

**Linux/macOS**:
```bash
# 检查端口
lsof -i:6379

# 查看错误日志
tail -f redis/redis.log
```

---

### Q2: KOOK账号显示"离线"？

**可能原因**:
1. Cookie已过期 → 重新登录
2. DOM选择器不匹配 → 查看调试截图

**调试步骤**:
```bash
# 1. 查看后端日志
tail -f ~/Documents/KookForwarder/data/logs/app.log

# 2. 查看调试截图
ls debug_*.png

# 3. 如果有截图，说明DOM选择器不匹配
#    需要在scraper.py中调整选择器
```

---

### Q3: 图片转发失败？

**解决方案**:
1. 检查图床服务是否启动
   ```bash
   curl http://localhost:9528/health
   ```

2. 查看图片策略设置
   ```
   进入: 设置 → 图片处理
   策略: 智能模式（推荐）
   ```

3. 检查存储空间
   ```
   位置: ~/Documents/KookForwarder/data/images/
   最大: 10GB（可在设置中调整）
   ```

---

### Q4: 过滤规则不生效？

**检查步骤**:
1. 确认规则已启用
   ```
   进入: 过滤规则 → 查看规则状态
   确保: ☑️ 启用
   ```

2. 查看过滤日志
   ```bash
   # 搜索日志中的"被过滤"
   grep "被过滤" ~/Documents/KookForwarder/data/logs/app.log
   ```

3. 规则优先级
   ```
   黑名单 > 白名单
   用户过滤 > 关键词过滤
   ```

---

## 📊 性能优化建议

### 1. 限制监听频道数量
```
建议: ≤ 10个频道
原因: 避免消息队列积压
```

### 2. 定期清理数据
```bash
# 手动清理图片（7天前）
curl -X POST "http://localhost:9528/cleanup?days=7"

# 手动清理日志
rm -rf ~/Documents/KookForwarder/data/logs/*.log.old
```

### 3. 调整Redis内存
```conf
# 编辑 redis/redis.conf
maxmemory 512mb  # 从256mb增加到512mb
```

---

## 🐛 遇到问题？

### 1. 查看日志
```bash
# 后端日志
tail -f ~/Documents/KookForwarder/data/logs/app.log

# Redis日志（如果配置了）
tail -f redis/redis.log
```

### 2. 查看调试截图
```bash
# 列出所有调试截图
ls -lh debug_*.png

# 打开查看（macOS）
open debug_servers_page.png

# 打开查看（Linux）
xdg-open debug_servers_page.png
```

### 3. 重置配置
```bash
# 备份当前配置
cp ~/Documents/KookForwarder/data/config.db ~/config.db.backup

# 删除数据库（重新开始）
rm ~/Documents/KookForwarder/data/config.db

# 重启应用，会自动创建新数据库
```

---

## 📚 进阶文档

- 📘 `代码完成度评估报告.md` - 详细技术评估
- 📙 `功能完成检查清单.md` - 功能对照表
- 📗 `代码完善总结.md` - 本次改进总结
- 📕 `下一步行动指南.md` - 真实环境验证指南
- 📔 `docs/用户手册.md` - 完整用户手册
- 📖 `redis/README.md` - Redis安装详解

---

## 🎉 享受使用！

如果一切正常，你现在应该：
- ✅ 看到KOOK消息实时转发到Discord/Telegram/飞书
- ✅ 过滤规则自动过滤广告等垃圾消息
- ✅ 图片和附件正常下载和转发
- ✅ 所有服务稳定运行

**下一步**:
1. 配置更多频道映射
2. 调整过滤规则
3. 监控转发状态
4. 定期备份配置

---

**祝你使用愉快！** 🚀

有问题欢迎查看文档或提Issue！
