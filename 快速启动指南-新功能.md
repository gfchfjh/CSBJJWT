# KOOK消息转发系统 v1.1.0 - 快速启动指南

## 🎉 新功能介绍

本版本新增了以下重要功能：

### 1. 📸 图片转发功能
- 自动下载并转发图片消息
- 支持图片压缩（节省空间）
- 内置图床服务（带Token安全验证）
- 三种处理策略可选

### 2. 🎯 首次配置向导
- 全新的4步配置流程
- 图形化引导，降低配置难度
- 自动检测首次启动

### 3. 🔧 完整的过滤规则
- 关键词黑/白名单
- 用户黑/白名单
- 消息类型过滤
- 数据持久化

### 4. 📦 打包配置
- 完整的打包脚本
- 支持Windows/macOS/Linux
- 一键打包命令

---

## 🚀 快速启动（开发模式）

### 步骤1: 安装依赖

```bash
# 后端依赖
cd backend
pip install -r requirements.txt
playwright install chromium

# 前端依赖
cd ../frontend
npm install

cd ..
```

### 步骤2: 启动Redis

```bash
# Linux/macOS
redis-server

# Windows
# 下载Redis for Windows并启动
redis-server.exe
```

### 步骤3: 启动后端服务

```bash
cd backend
python -m app.main
```

后端将在 **http://localhost:9527** 运行

**新增**: 图床服务在 **http://localhost:9528** 运行

### 步骤4: 启动前端

```bash
cd frontend
npm run dev
```

前端将在 **http://localhost:5173** 运行

### 步骤5: 首次配置

1. 浏览器打开 http://localhost:5173
2. **自动跳转到配置向导**（首次启动）
3. 按照向导步骤完成配置：
   - 欢迎页 → 添加KOOK账号 → 配置机器人 → 完成
4. 进入主界面

---

## 🎯 新功能使用指南

### 1. 使用首次配置向导

#### 自动启动
首次打开应用会自动跳转到配置向导（`/wizard`）

#### 手动访问
```
http://localhost:5173/wizard
```

#### 跳过向导
如果想跳过向导，点击"跳过向导"按钮，或在浏览器控制台执行：
```javascript
localStorage.setItem('wizard_completed', 'true')
```

#### 重新配置
如果想重新运行向导：
```javascript
localStorage.removeItem('wizard_completed')
// 然后刷新页面
```

---

### 2. 配置图片转发

#### 修改图片处理策略

编辑 `backend/app/config.py` 或创建 `.env` 文件：

```python
# .env 文件
image_strategy=smart        # 智能模式（推荐）
# image_strategy=direct     # 仅直传
# image_strategy=imgbed     # 仅图床

image_max_size_mb=10.0      # 单图最大10MB
image_compression_quality=85 # 压缩质量85%
image_cleanup_days=7        # 7天后清理旧图
```

#### 查看图床状态

访问图床健康检查接口：
```
http://localhost:9528/health
```

返回示例：
```json
{
  "status": "ok",
  "storage_size_gb": 0.5,
  "storage_path": "/Users/xxx/Documents/KookForwarder/data/images"
}
```

#### 手动清理旧图片

在Python后端控制台：
```python
from app.processors.image import image_processor
await image_processor.cleanup_old_images(days=7)
```

---

### 3. 使用过滤规则

#### 访问过滤规则页面

```
主界面 → 侧边栏 → 过滤规则
```

#### 配置关键词过滤

1. **黑名单**：输入关键词，按回车添加
   - 例如：广告、代练、外挂
   - 包含这些词的消息不会转发

2. **白名单**：输入关键词，按回车添加
   - 例如：官方公告、版本更新
   - 仅转发包含这些词的消息（如果白名单为空则不限制）

3. **启用过滤**：切换开关

#### 配置用户过滤

1. **添加用户**：点击"添加用户"按钮
   - 输入用户ID或用户名
   - 选择添加到黑名单或白名单

2. **黑名单**：不转发列表中用户的消息
3. **白名单**：仅转发列表中用户的消息

#### 配置消息类型

勾选要转发的消息类型：
- ✅ 文本消息
- ✅ 图片消息
- ✅ 文件附件
- ✅ 链接消息
- ☐ 表情反应
- ☐ @提及

#### 特殊选项

- **仅转发@全体成员的消息**：适用于只关注重要公告的场景

#### 保存规则

配置完成后，点击"保存规则"按钮，规则会持久化到数据库。

---

### 4. API使用

#### 获取过滤规则

```bash
curl http://localhost:9527/api/system/filter-rules
```

#### 保存过滤规则

```bash
curl -X POST http://localhost:9527/api/system/filter-rules \
  -H "Content-Type: application/json" \
  -d '{
    "scope": "global",
    "keyword_blacklist": ["广告", "代练"],
    "keyword_filter_enabled": true,
    "message_types": ["text", "image"]
  }'
```

#### 图片处理示例

```python
from app.processors.image import image_processor

# 下载并处理图片
result = await image_processor.process_image(
    url="https://example.com/image.jpg",
    strategy="smart",  # 智能模式
    cookies={"token": "xxx"},
    referer="https://www.kookapp.cn"
)

# result 可能是：
# - 原始URL（直传成功）
# - 本地图床URL（直传失败，使用图床）
# - 包含两者的字典（智能模式）
```

---

## 📦 打包应用（生产环境）

### Linux/macOS

```bash
# 赋予执行权限
chmod +x build/build_all.sh

# 执行打包
./build/build_all.sh
```

### Windows

```cmd
build\build_all.bat
```

### 输出产物

打包完成后，安装包位于：

```
frontend/dist-electron/
├── KOOK消息转发系统_v1.1.0_Windows_x64.exe      # Windows
├── KOOK消息转发系统_v1.1.0_macOS.dmg             # macOS
└── KOOK消息转发系统_v1.1.0_Linux_x64.AppImage    # Linux
```

---

## 🐛 常见问题

### Q1: 首次启动没有跳转到向导？

**A**: 检查localStorage：
```javascript
// 浏览器控制台
console.log(localStorage.getItem('wizard_completed'))
// 如果是 'true'，说明已完成向导

// 清除状态重新运行
localStorage.removeItem('wizard_completed')
location.reload()
```

### Q2: 图片转发失败？

**A**: 检查以下几点：
1. 图床服务是否启动（http://localhost:9528/health）
2. 存储目录是否有写入权限
3. 查看后端日志中的错误信息
4. 尝试切换图片策略（smart → direct → imgbed）

### Q3: 过滤规则不生效？

**A**: 
1. 确认已点击"保存规则"
2. 检查是否启用了过滤开关
3. 重启服务使规则生效
4. 查看后端日志中的过滤原因

### Q4: 打包失败？

**A**:
1. 确认已安装所有依赖
   ```bash
   # 检查PyInstaller
   pip show pyinstaller
   
   # 检查electron-builder
   npm list electron-builder
   ```

2. 检查Python和Node.js版本
   ```bash
   python --version  # 需要 3.11+
   node --version    # 需要 16+
   ```

3. 查看打包日志中的详细错误

---

## 📊 性能监控

### 图片存储监控

访问图床健康检查：
```bash
curl http://localhost:9528/health
```

### 系统状态

访问系统状态接口：
```bash
curl http://localhost:9527/api/system/status
```

返回示例：
```json
{
  "service_running": true,
  "redis_connected": true,
  "queue_size": 5,
  "active_scrapers": 1
}
```

---

## 🔧 配置文件说明

### backend/.env

```env
# API服务
API_HOST=127.0.0.1
API_PORT=9527

# Redis
REDIS_HOST=127.0.0.1
REDIS_PORT=6379

# 图片处理
IMAGE_SERVER_PORT=9528
IMAGE_MAX_SIZE_MB=10.0
IMAGE_COMPRESSION_QUALITY=85
IMAGE_CLEANUP_DAYS=7
IMAGE_STORAGE_MAX_GB=10.0
IMAGE_STRATEGY=smart

# 日志
LOG_LEVEL=INFO
LOG_RETENTION_DAYS=3
```

---

## 🎓 进阶用法

### 自定义图片处理

```python
from app.processors.image import image_processor

# 修改压缩质量
image_processor.compress_image(
    image_data=data,
    max_size_mb=5.0,    # 最大5MB
    quality=75          # 质量75%
)

# 生成永久URL（不过期）
url = image_processor.generate_url(
    filepath="/path/to/image.jpg",
    expire_hours=8760  # 1年 = 365*24
)
```

### 编程方式添加过滤规则

```python
from app.processors.filter import message_filter

# 添加规则
rules = {
    "scope": "global",
    "keyword_blacklist": ["spam", "ad"],
    "keyword_filter_enabled": True,
    "user_blacklist": [
        {"id": "123", "name": "spammer"}
    ],
    "user_filter_enabled": True,
    "message_types": ["text", "image"]
}

# 保存
success = message_filter.save_rules(rules)
```

---

## 📚 相关文档

- [完成度评估报告](/workspace/KOOK消息转发系统完成度评估报告.md)
- [代码改进总结](/workspace/代码改进总结.md)
- [README](README.md)
- [开发指南](docs/开发指南.md)

---

## 🙏 反馈与支持

如有问题或建议：

- **GitHub Issues**: https://github.com/yourusername/kook-forwarder/issues
- **Email**: your.email@example.com

---

<div align="center">

**版本**: v1.1.0  
**更新日期**: 2025-10-12  
**新增功能**: 图片转发 + 配置向导 + 过滤规则 + 打包配置

Made with ❤️ by KOOK Forwarder Team

</div>
