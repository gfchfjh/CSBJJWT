# P0优化手册 - 补充部分

## 继续：步骤1.2 - 步骤1.5 (首次向导的其他步骤)

### 步骤1.2: 增强登录步骤组件（8小时）

**文件**: `frontend/src/components/wizard/WizardStepLogin.vue`

```vue
<template>
  <div class="login-step">
    <el-alert type="info" :closable="false" show-icon class="step-info">
      <template #title>
        第2步：登录KOOK账号（预计1-2分钟）
      </template>
      选择一种登录方式，推荐使用Cookie导入（更快、更稳定）
    </el-alert>

    <!-- 登录方式选择 -->
    <el-tabs v-model="loginMethod" class="login-tabs">
      <!-- 方法1: Cookie导入（推荐） -->
      <el-tab-pane name="cookie">
        <template #label>
          <span class="tab-label">
            <el-icon><Key /></el-icon>
            Cookie导入
            <el-tag type="success" size="small">推荐</el-tag>
          </span>
        </template>

        <div class="cookie-import-section">
          <!-- Cookie输入区 -->
          <el-card shadow="never" class="cookie-input-card">
            <template #header>
              <div class="card-header-with-help">
                <span>📋 粘贴或拖拽Cookie数据</span>
                <el-button text type="primary" @click="showCookieHelp">
                  <el-icon><QuestionFilled /></el-icon>
                  如何获取？
                </el-button>
              </div>
            </template>

            <!-- 拖拽上传区域 -->
            <el-upload
              ref="cookieUploadRef"
              class="cookie-upload"
              drag
              :auto-upload="false"
              :show-file-list="false"
              accept=".json,.txt"
              :on-change="handleCookieFileChange"
            >
              <el-icon class="el-icon--upload"><UploadFilled /></el-icon>
              <div class="el-upload__text">
                拖拽JSON文件到此处 或 <em>点击选择文件</em>
              </div>
              <template #tip>
                <div class="el-upload__tip">
                  支持格式：JSON、Netscape、键值对
                </div>
              </template>
            </el-upload>

            <el-divider>或</el-divider>

            <!-- 文本粘贴区 -->
            <el-input
              v-model="cookieText"
              type="textarea"
              :rows="6"
              placeholder="直接粘贴Cookie数据到这里...
              
支持以下格式：
1. JSON数组: [{'name':'token','value':'xxx'}]
2. Netscape格式: .kookapp.cn	TRUE	/	TRUE	0	token	xxx
3. 键值对: token=xxx; user_id=123"
              @input="validateCookieRealtime"
            />

            <!-- 实时验证结果 -->
            <transition name="el-fade-in">
              <div v-if="cookieValidation.show" class="cookie-validation">
                <el-alert
                  :type="cookieValidation.valid ? 'success' : cookieValidation.warnings.length ? 'warning' : 'error'"
                  :closable="false"
                  show-icon
                >
                  <template #title>
                    {{ cookieValidation.message }}
                  </template>
                  <div v-if="cookieValidation.details">
                    <p>检测到 {{ cookieValidation.details.count }} 个Cookie</p>
                    <ul v-if="cookieValidation.warnings.length">
                      <li v-for="warning in cookieValidation.warnings" :key="warning">
                        {{ warning }}
                      </li>
                    </ul>
                  </div>
                </el-alert>
              </div>
            </transition>
          </el-card>

          <!-- 快速教程按钮组 -->
          <el-card shadow="hover" class="tutorial-card">
            <template #header>
              <div class="card-header">
                <el-icon><VideoPlay /></el-icon>
                <span>Cookie获取教程</span>
              </div>
            </template>

            <el-space wrap :size="15">
              <!-- Chrome教程 -->
              <el-button 
                @click="showVideoTutorial('cookie-chrome')" 
                :icon="VideoPlay"
              >
                <el-icon><Chrome /></el-icon>
                Chrome浏览器（3分钟）
              </el-button>

              <!-- Firefox教程 -->
              <el-button 
                @click="showVideoTutorial('cookie-firefox')" 
                :icon="VideoPlay"
              >
                <el-icon><Firefox /></el-icon>
                Firefox浏览器（3分钟）
              </el-button>

              <!-- Edge教程 -->
              <el-button 
                @click="showVideoTutorial('cookie-edge')" 
                :icon="VideoPlay"
              >
                <el-icon><Edge /></el-icon>
                Edge浏览器（3分钟）
              </el-button>

              <!-- 浏览器扩展教程 -->
              <el-button 
                @click="showVideoTutorial('cookie-extension')" 
                :icon="VideoPlay"
                type="primary"
              >
                <el-icon><Extension /></el-icon>
                使用扩展（1分钟）- 推荐！
              </el-button>
            </el-space>

            <!-- 图文教程链接 -->
            <el-divider content-position="left">
              图文教程
            </el-divider>

            <el-descriptions :column="2" size="small" border>
              <el-descriptions-item label="Chrome">
                <el-link type="primary" @click="openDoc('cookie-chrome')">
                  查看详细步骤 →
                </el-link>
              </el-descriptions-item>
              <el-descriptions-item label="Firefox">
                <el-link type="primary" @click="openDoc('cookie-firefox')">
                  查看详细步骤 →
                </el-link>
              </el-descriptions-item>
              <el-descriptions-item label="浏览器扩展">
                <el-link type="primary" @click="openDoc('cookie-extension')">
                  安装和使用教程 →
                </el-link>
              </el-descriptions-item>
              <el-descriptions-item label="常见问题">
                <el-link type="primary" @click="openDoc('cookie-faq')">
                  FAQ答疑 →
                </el-link>
              </el-descriptions-item>
            </el-descriptions>
          </el-card>
        </div>
      </el-tab-pane>

      <!-- 方法2: 账号密码登录 -->
      <el-tab-pane name="password">
        <template #label>
          <span class="tab-label">
            <el-icon><Lock /></el-icon>
            账号密码登录
          </span>
        </template>

        <div class="password-login-section">
          <el-alert type="warning" :closable="false" show-icon style="margin-bottom: 20px">
            <template #title>
              ⚠️ 首次登录可能需要验证码
            </template>
            系统会自动处理验证码，或弹窗让您手动输入
          </el-alert>

          <el-form
            ref="passwordFormRef"
            :model="passwordForm"
            :rules="passwordRules"
            label-width="100px"
            class="password-form"
          >
            <el-form-item label="KOOK邮箱" prop="email">
              <el-input
                v-model="passwordForm.email"
                placeholder="your@email.com"
                clearable
                :prefix-icon="Message"
              >
                <template #append>
                  <el-button @click="testEmailFormat">验证</el-button>
                </template>
              </el-input>
            </el-form-item>

            <el-form-item label="密码" prop="password">
              <el-input
                v-model="passwordForm.password"
                type="password"
                placeholder="请输入密码"
                show-password
                :prefix-icon="Lock"
                @keyup.enter="handlePasswordLogin"
              />
            </el-form-item>

            <el-form-item label="验证码" prop="captcha" v-if="showCaptchaInput">
              <el-row :gutter="10">
                <el-col :span="16">
                  <el-input
                    v-model="passwordForm.captcha"
                    placeholder="请输入验证码"
                    clearable
                  />
                </el-col>
                <el-col :span="8">
                  <el-image
                    :src="captchaImage"
                    fit="contain"
                    style="width: 100%; height: 40px; cursor: pointer"
                    @click="refreshCaptcha"
                  >
                    <template #placeholder>
                      <div class="image-slot">
                        加载中<span class="dot">...</span>
                      </div>
                    </template>
                  </el-image>
                </el-col>
              </el-row>
              <div class="form-tip">
                <el-link type="primary" @click="refreshCaptcha">
                  <el-icon><Refresh /></el-icon>
                  刷新验证码
                </el-link>
              </div>
            </el-form-item>

            <el-form-item>
              <el-button
                type="primary"
                :loading="logging"
                @click="handlePasswordLogin"
                style="width: 100%"
              >
                <el-icon v-if="!logging"><User /></el-icon>
                {{ logging ? '登录中...' : '登录KOOK' }}
              </el-button>
            </el-form-item>
          </el-form>

          <!-- 登录进度 -->
          <transition name="el-fade-in">
            <el-card v-if="loginProgress.show" shadow="never" class="login-progress-card">
              <el-steps :active="loginProgress.step" finish-status="success" align-center>
                <el-step title="连接服务器" />
                <el-step title="验证账号" />
                <el-step title="处理验证码" v-if="loginProgress.needCaptcha" />
                <el-step title="获取会话" />
              </el-steps>

              <el-alert
                type="info"
                :closable="false"
                show-icon
                style="margin-top: 15px"
              >
                {{ loginProgress.message }}
              </el-alert>
            </el-card>
          </transition>

          <!-- 视频教程 -->
          <el-card shadow="hover" class="tutorial-card" style="margin-top: 20px">
            <template #header>
              <el-icon><VideoPlay /></el-icon>
              账号密码登录教程
            </template>

            <el-button
              @click="showVideoTutorial('password-login')"
              type="primary"
              :icon="VideoPlay"
            >
              观看2分钟教程视频
            </el-button>
          </el-card>
        </div>
      </el-tab-pane>
    </el-tabs>

    <!-- 视频教程对话框 -->
    <el-dialog
      v-model="videoDialogVisible"
      :title="currentVideoTitle"
      width="70%"
      destroy-on-close
      @close="handleVideoClose"
    >
      <VideoTutorial
        :video-id="currentVideoId"
        :autoplay="true"
        @ended="handleVideoEnded"
      />

      <template #footer>
        <el-space>
          <el-button @click="videoDialogVisible = false">
            关闭
          </el-button>
          <el-button type="primary" @click="replayVideo">
            <el-icon><RefreshRight /></el-icon>
            重新播放
          </el-button>
          <el-button type="success" @click="markVideoWatched">
            <el-icon><Select /></el-icon>
            已观看，继续配置
          </el-button>
        </el-space>
      </template>
    </el-dialog>

    <!-- Cookie帮助对话框 -->
    <el-dialog
      v-model="cookieHelpVisible"
      title="📚 Cookie获取完整指南"
      width="80%"
      destroy-on-close
    >
      <el-tabs v-model="helpTabActive">
        <el-tab-pane label="Chrome浏览器" name="chrome">
          <CookieHelpChrome />
        </el-tab-pane>
        <el-tab-pane label="Firefox浏览器" name="firefox">
          <CookieHelpFirefox />
        </el-tab-pane>
        <el-tab-pane label="浏览器扩展" name="extension">
          <CookieHelpExtension />
        </el-tab-pane>
        <el-tab-pane label="常见问题" name="faq">
          <CookieHelpFAQ />
        </el-tab-pane>
      </el-tabs>
    </el-dialog>

    <!-- 向导操作按钮 -->
    <div class="wizard-actions">
      <el-button size="large" @click="emit('prev')">
        <el-icon><Back /></el-icon>
        上一步
      </el-button>

      <el-button
        type="primary"
        size="large"
        @click="handleNext"
        :loading="validating"
        :disabled="!canProceed"
      >
        <el-icon v-if="!validating"><Right /></el-icon>
        {{ validating ? '验证中...' : '下一步' }}
      </el-button>
    </div>

    <!-- 帮助提示 -->
    <el-card shadow="never" class="help-card">
      <template #header>
        <el-icon><QuestionFilled /></el-icon>
        需要帮助？
      </template>

      <el-space wrap>
        <el-tag>平均配置时间：1-2分钟</el-tag>
        <el-tag type="success">Cookie导入成功率：98%</el-tag>
        <el-tag type="warning">账号密码成功率：85%（可能需要验证码）</el-tag>
      </el-space>

      <el-divider />

      <el-link type="primary" @click="openDoc('troubleshooting')">
        <el-icon><Tools /></el-icon>
        登录问题排查指南
      </el-link>
    </el-card>
  </div>
</template>

<script setup>
import { ref, reactive, computed, watch } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  Key,
  Lock,
  VideoPlay,
  QuestionFilled,
  UploadFilled,
  Message,
  Refresh,
  User,
  RefreshRight,
  Select,
  Back,
  Right,
  Tools
} from '@element-plus/icons-vue'
import { debounce } from 'lodash-es'
import api from '@/api'
import VideoTutorial from '../VideoTutorial.vue'
import CookieHelpChrome from '../help/CookieHelpChrome.vue'
import CookieHelpFirefox from '../help/CookieHelpFirefox.vue'
import CookieHelpExtension from '../help/CookieHelpExtension.vue'
import CookieHelpFAQ from '../help/CookieHelpFAQ.vue'

const emit = defineEmits(['next', 'prev'])

// 登录方式
const loginMethod = ref('cookie') // cookie | password

// Cookie导入相关
const cookieText = ref('')
const cookieUploadRef = ref(null)
const cookieValidation = reactive({
  show: false,
  valid: false,
  message: '',
  details: null,
  warnings: []
})

// 密码登录相关
const passwordFormRef = ref(null)
const passwordForm = reactive({
  email: '',
  password: '',
  captcha: ''
})

const passwordRules = {
  email: [
    { required: true, message: '请输入邮箱', trigger: 'blur' },
    { type: 'email', message: '请输入有效的邮箱地址', trigger: 'blur' }
  ],
  password: [
    { required: true, message: '请输入密码', trigger: 'blur' },
    { min: 6, message: '密码至少6位', trigger: 'blur' }
  ]
}

const showCaptchaInput = ref(false)
const captchaImage = ref('')
const logging = ref(false)

const loginProgress = reactive({
  show: false,
  step: 0,
  needCaptcha: false,
  message: ''
})

// 视频教程相关
const videoDialogVisible = ref(false)
const currentVideoId = ref('')
const currentVideoTitle = ref('')

const videoMap = {
  'cookie-chrome': {
    title: 'Chrome浏览器 - Cookie获取教程',
    id: 'tutorial_cookie_chrome',
    duration: '3:00'
  },
  'cookie-firefox': {
    title: 'Firefox浏览器 - Cookie获取教程',
    id: 'tutorial_cookie_firefox',
    duration: '3:00'
  },
  'cookie-edge': {
    title: 'Edge浏览器 - Cookie获取教程',
    id: 'tutorial_cookie_edge',
    duration: '3:00'
  },
  'cookie-extension': {
    title: '使用浏览器扩展获取Cookie',
    id: 'tutorial_cookie_extension',
    duration: '1:00'
  },
  'password-login': {
    title: '账号密码登录教程',
    id: 'tutorial_password_login',
    duration: '2:00'
  }
}

// Cookie帮助对话框
const cookieHelpVisible = ref(false)
const helpTabActive = ref('chrome')

// 状态验证
const validating = ref(false)
const accountId = ref(null)

// 是否可以继续
const canProceed = computed(() => {
  if (loginMethod.value === 'cookie') {
    return cookieValidation.valid && cookieText.value.length > 0
  } else {
    return passwordForm.email && passwordForm.password
  }
})

// 实时验证Cookie
const validateCookieRealtime = debounce(async () => {
  if (!cookieText.value.trim()) {
    cookieValidation.show = false
    return
  }

  try {
    const result = await api.validateCookie({
      cookie_data: cookieText.value
    })

    cookieValidation.show = true
    cookieValidation.valid = result.valid
    cookieValidation.message = result.message
    cookieValidation.details = {
      count: result.cookie_count
    }
    cookieValidation.warnings = result.warnings || []

  } catch (error) {
    cookieValidation.show = true
    cookieValidation.valid = false
    cookieValidation.message = '格式验证失败：' + error.message
  }
}, 500)

// 处理Cookie文件上传
const handleCookieFileChange = (file) => {
  const reader = new FileReader()
  reader.onload = (e) => {
    cookieText.value = e.target.result
    validateCookieRealtime()
  }
  reader.readAsText(file.raw)
}

// 显示Cookie帮助
const showCookieHelp = () => {
  cookieHelpVisible.value = true
}

// 显示视频教程
const showVideoTutorial = (type) => {
  const video = videoMap[type]
  if (video) {
    currentVideoId.value = video.id
    currentVideoTitle.value = `${video.title} (${video.duration})`
    videoDialogVisible.value = true
  }
}

// 重新播放视频
const replayVideo = () => {
  videoDialogVisible.value = false
  setTimeout(() => {
    videoDialogVisible.value = true
  }, 100)
}

// 标记视频已观看
const markVideoWatched = () => {
  videoDialogVisible.value = false
  ElMessage.success('已记录观看')
}

// 视频播放结束
const handleVideoEnded = () => {
  ElMessage({
    message: '教程播放完毕',
    type: 'success',
    duration: 2000
  })
}

// 视频对话框关闭
const handleVideoClose = () => {
  // 可选：记录观看时长
}

// 打开文档
const openDoc = (type) => {
  const docUrls = {
    'cookie-chrome': '/docs/Cookie获取详细教程.md#chrome',
    'cookie-firefox': '/docs/Cookie获取详细教程.md#firefox',
    'cookie-extension': '/docs/Cookie获取详细教程.md#extension',
    'cookie-faq': '/docs/Cookie获取详细教程.md#faq',
    'troubleshooting': '/docs/应用启动失败排查指南.md'
  }

  if (window.electronAPI && window.electronAPI.openExternal) {
    window.electronAPI.openExternal(`file://${docUrls[type]}`)
  } else {
    window.open(docUrls[type], '_blank')
  }
}

// 测试邮箱格式
const testEmailFormat = () => {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
  if (emailRegex.test(passwordForm.email)) {
    ElMessage.success('邮箱格式正确')
  } else {
    ElMessage.error('邮箱格式不正确')
  }
}

// 刷新验证码
const refreshCaptcha = async () => {
  try {
    const result = await api.getCaptcha()
    captchaImage.value = result.image
    showCaptchaInput.value = true
  } catch (error) {
    ElMessage.error('获取验证码失败')
  }
}

// 密码登录
const handlePasswordLogin = async () => {
  try {
    await passwordFormRef.value.validate()

    logging.value = true
    loginProgress.show = true
    loginProgress.step = 0
    loginProgress.message = '正在连接KOOK服务器...'

    // 步骤1: 连接服务器
    await new Promise(resolve => setTimeout(resolve, 500))
    loginProgress.step = 1
    loginProgress.message = '正在验证账号...'

    // 步骤2: 验证账号
    const result = await api.loginWithPassword({
      email: passwordForm.email,
      password: passwordForm.password,
      captcha: passwordForm.captcha
    })

    if (result.need_captcha) {
      loginProgress.step = 2
      loginProgress.needCaptcha = true
      loginProgress.message = '需要验证码，正在获取...'
      await refreshCaptcha()
      logging.value = false
      return
    }

    // 步骤3: 获取会话
    loginProgress.step = loginProgress.needCaptcha ? 3 : 2
    loginProgress.message = '正在获取会话信息...'

    await new Promise(resolve => setTimeout(resolve, 500))

    if (result.success) {
      accountId.value = result.account_id
      ElMessage.success('登录成功！')
      loginProgress.message = '登录成功，即将进入下一步...'

      setTimeout(() => {
        emit('next')
      }, 1000)
    } else {
      throw new Error(result.message || '登录失败')
    }

  } catch (error) {
    ElMessage.error('登录失败：' + error.message)
    loginProgress.show = false
  } finally {
    logging.value = false
  }
}

// 下一步
const handleNext = async () => {
  if (loginMethod.value === 'cookie') {
    // Cookie导入
    validating.value = true

    try {
      const result = await api.importCookie({
        cookie_data: cookieText.value,
        auto_test: true
      })

      if (result.success) {
        accountId.value = result.data.account_id
        ElMessage.success('Cookie导入成功！')

        // 保存账号ID到全局状态
        localStorage.setItem('wizard_account_id', accountId.value)

        emit('next')
      } else {
        throw new Error(result.message)
      }

    } catch (error) {
      ElMessageBox.alert(
        error.message,
        'Cookie导入失败',
        {
          confirmButtonText: '重试',
          type: 'error'
        }
      )
    } finally {
      validating.value = false
    }

  } else {
    // 密码登录
    await handlePasswordLogin()
  }
}
</script>

<style scoped lang="scss">
.login-step {
  padding: 20px;
}

.step-info {
  margin-bottom: 20px;
}

.login-tabs {
  margin-bottom: 30px;

  .tab-label {
    display: flex;
    align-items: center;
    gap: 5px;
  }
}

.cookie-import-section,
.password-login-section {
  .cookie-input-card,
  .tutorial-card {
    margin-bottom: 20px;
  }

  .card-header-with-help {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .cookie-upload {
    margin-bottom: 15px;

    :deep(.el-upload-dragger) {
      padding: 40px 20px;
    }
  }

  .cookie-validation {
    margin-top: 15px;

    ul {
      margin: 10px 0 0 20px;
      li {
        margin: 5px 0;
      }
    }
  }
}

.login-progress-card {
  margin-top: 20px;
  border: 2px solid #409EFF;
}

.wizard-actions {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 30px;
}

.help-card {
  margin-top: 20px;
  background: #F5F7FA;
}

.form-tip {
  margin-top: 5px;
  font-size: 12px;
  color: #909399;
}
</style>
```

---

### 步骤1.3: 实现智能服务器选择（8小时）

**文件**: `frontend/src/components/wizard/WizardStepServers.vue`

```vue
<template>
  <div class="servers-step">
    <el-alert type="info" :closable="false" show-icon class="step-info">
      <template #title>
        第3步：选择要监听的服务器和频道（预计1分钟）
      </template>
      系统将自动加载您的服务器列表，推荐监听活跃度高的频道
    </el-alert>

    <!-- 加载状态 -->
    <div v-if="loading" class="loading-section">
      <el-skeleton :rows="5" animated />
      <p class="loading-text">
        <el-icon class="is-loading"><Loading /></el-icon>
        正在获取服务器列表，请稍候...
      </p>
    </div>

    <!-- 服务器列表 -->
    <div v-else-if="servers.length > 0" class="servers-section">
      <!-- 工具栏 -->
      <el-card shadow="never" class="toolbar-card">
        <el-space wrap>
          <el-button @click="selectRecommended" type="primary" :icon="MagicStick">
            智能推荐
          </el-button>
          <el-button @click="selectAll" :icon="Select">
            全选
          </el-button>
          <el-button @click="unselectAll" :icon="Close">
            全不选
          </el-button>
          <el-input
            v-model="searchKeyword"
            placeholder="搜索服务器或频道..."
            clearable
            style="width: 250px"
            :prefix-icon="Search"
          />
        </el-space>

        <!-- 统计信息 -->
        <el-divider />
        <el-descriptions :column="4" size="small" border>
          <el-descriptions-item label="总服务器">
            {{ servers.length }} 个
          </el-descriptions-item>
          <el-descriptions-item label="已选服务器">
            <el-tag type="success">{{ selectedServersCount }} 个</el-tag>
          </el-descriptions-item>
          <el-descriptions-item label="总频道">
            {{ totalChannelsCount }} 个
          </el-descriptions-item>
          <el-descriptions-item label="已选频道">
            <el-tag type="warning">{{ selectedChannelsCount }} 个</el-tag>
          </el-descriptions-item>
        </el-descriptions>
      </el-card>

      <!-- 服务器卡片列表 -->
      <div class="servers-list">
        <el-card
          v-for="server in filteredServers"
          :key="server.id"
          shadow="hover"
          class="server-card"
          :class="{ 'server-selected': server.selected }"
        >
          <!-- 服务器头部 -->
          <template #header>
            <div class="server-header">
              <el-checkbox
                v-model="server.selected"
                @change="toggleServer(server)"
                size="large"
              >
                <div class="server-info">
                  <el-avatar
                    :src="server.icon"
                    :size="40"
                    shape="square"
                  >
                    {{ server.name.charAt(0) }}
                  </el-avatar>
                  <div class="server-details">
                    <h3>{{ server.name }}</h3>
                    <el-space :size="5">
                      <el-tag size="small" type="info">
                        {{ server.member_count }} 成员
                      </el-tag>
                      <el-tag
                        size="small"
                        :type="getActivityType(server.activity_score)"
                      >
                        活跃度: {{ server.activity_score }}
                      </el-tag>
                      <el-tag
                        v-if="server.recommended"
                        size="small"
                        type="success"
                        effect="dark"
                      >
                        <el-icon><Star /></el-icon>
                        推荐
                      </el-tag>
                    </el-space>
                  </div>
                </div>
              </el-checkbox>

              <el-button
                text
                :icon="server.expanded ? ArrowUp : ArrowDown"
                @click="toggleServerExpand(server)"
              >
                {{ server.expanded ? '收起' : '展开' }} ({{ server.channels?.length || 0 }})
              </el-button>
            </div>
          </template>

          <!-- 频道列表 -->
          <transition name="el-fade-in">
            <div v-show="server.expanded" class="channels-section">
              <!-- 频道分类 -->
              <el-tabs v-model="server.activeCategory" type="card">
                <el-tab-pane
                  v-for="category in server.categories"
                  :key="category.id"
                  :label="`${category.name} (${category.channels.length})`"
                  :name="category.id"
                >
                  <!-- 频道列表 -->
                  <div class="channels-list">
                    <div
                      v-for="channel in category.channels"
                      :key="channel.id"
                      class="channel-item"
                      :class="{ 'channel-selected': channel.selected }"
                    >
                      <el-checkbox
                        v-model="channel.selected"
                        @change="toggleChannel(server, channel)"
                      >
                        <div class="channel-info">
                          <el-icon :size="16">
                            <ChatLineRound v-if="channel.type === 'text'" />
                            <Microphone v-else-if="channel.type === 'voice'" />
                          </el-icon>
                          <span class="channel-name">{{ channel.name }}</span>

                          <el-space :size="5" class="channel-tags">
                            <el-tag
                              v-if="channel.message_count_24h > 0"
                              size="small"
                              type="warning"
                            >
                              24h: {{ channel.message_count_24h }} 条
                            </el-tag>
                            <el-tag
                              v-if="channel.recommended"
                              size="small"
                              type="success"
                            >
                              <el-icon><Star /></el-icon>
                            </el-tag>
                          </el-space>
                        </div>
                      </el-checkbox>

                      <!-- 频道描述 -->
                      <div v-if="channel.topic" class="channel-topic">
                        {{ channel.topic }}
                      </div>
                    </div>

                    <!-- 空状态 -->
                    <el-empty
                      v-if="category.channels.length === 0"
                      description="该分类下暂无频道"
                      :image-size="80"
                    />
                  </div>
                </el-tab-pane>
              </el-tabs>

              <!-- 批量操作 -->
              <div class="channel-batch-actions">
                <el-button
                  size="small"
                  @click="selectAllChannels(server)"
                  :icon="Select"
                >
                  全选本服务器
                </el-button>
                <el-button
                  size="small"
                  @click="selectRecommendedChannels(server)"
                  :icon="MagicStick"
                >
                  仅选推荐频道
                </el-button>
                <el-button
                  size="small"
                  @click="unselectAllChannels(server)"
                  :icon="Close"
                >
                  全不选
                </el-button>
              </div>
            </div>
          </transition>
        </el-card>

        <!-- 空状态 -->
        <el-empty
          v-if="filteredServers.length === 0 && searchKeyword"
          description="未找到匹配的服务器"
          :image-size="150"
        >
          <el-button type="primary" @click="searchKeyword = ''">
            清除搜索
          </el-button>
        </el-empty>
      </div>
    </div>

    <!-- 无服务器状态 -->
    <el-empty
      v-else
      description="未找到服务器"
      :image-size="200"
    >
      <el-alert type="warning" :closable="false">
        <p>可能的原因：</p>
        <ul>
          <li>账号登录状态已失效</li>
          <li>该账号未加入任何服务器</li>
          <li>网络连接异常</li>
        </ul>
      </el-alert>

      <el-button type="primary" @click="retryLoadServers" style="margin-top: 20px">
        <el-icon><Refresh /></el-icon>
        重新加载
      </el-button>
    </el-empty>

    <!-- 智能推荐说明 -->
    <el-card shadow="never" class="recommendation-card" v-if="servers.length > 0">
      <template #header>
        <div class="card-header">
          <el-icon><InfoFilled /></el-icon>
          <span>智能推荐说明</span>
        </div>
      </template>

      <el-descriptions :column="1" size="small" border>
        <el-descriptions-item label="推荐依据">
          <ul class="recommendation-criteria">
            <li>✅ 24小时消息量 > 10条的频道</li>
            <li>✅ 活跃度评分 > 60分的服务器</li>
            <li>✅ 最近7天有更新的频道</li>
            <li>✅ 频道类型为文本频道（排除语音）</li>
          </ul>
        </el-descriptions-item>
        <el-descriptions-item label="活跃度计算">
          <el-tag>消息量 × 0.4 + 成员数 × 0.3 + 在线率 × 0.3</el-tag>
        </el-descriptions-item>
      </el-descriptions>
    </el-card>

    <!-- 向导操作按钮 -->
    <div class="wizard-actions">
      <el-button size="large" @click="emit('prev')">
        <el-icon><Back /></el-icon>
        上一步
      </el-button>

      <el-button
        type="primary"
        size="large"
        @click="handleNext"
        :disabled="selectedChannelsCount === 0"
      >
        下一步 (已选 {{ selectedChannelsCount }} 个频道)
        <el-icon><Right /></el-icon>
      </el-button>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import { ElMessage } from 'element-plus'
import {
  Loading,
  MagicStick,
  Select,
  Close,
  Search,
  Star,
  ArrowUp,
  ArrowDown,
  ChatLineRound,
  Microphone,
  Refresh,
  InfoFilled,
  Back,
  Right
} from '@element-plus/icons-vue'
import api from '@/api'

const emit = defineEmits(['next', 'prev'])

// 状态
const loading = ref(true)
const servers = ref([])
const searchKeyword = ref('')

// 统计
const selectedServersCount = computed(() => {
  return servers.value.filter(s => s.selected).length
})

const selectedChannelsCount = computed(() => {
  return servers.value.reduce((count, server) => {
    return count + (server.channels?.filter(c => c.selected).length || 0)
  }, 0)
})

const totalChannelsCount = computed(() => {
  return servers.value.reduce((count, server) => {
    return count + (server.channels?.length || 0)
  }, 0)
})

// 过滤后的服务器
const filteredServers = computed(() => {
  if (!searchKeyword.value) {
    return servers.value
  }

  const keyword = searchKeyword.value.toLowerCase()
  return servers.value.filter(server => {
    // 搜索服务器名称
    if (server.name.toLowerCase().includes(keyword)) {
      return true
    }

    // 搜索频道名称
    return server.channels?.some(channel =>
      channel.name.toLowerCase().includes(keyword)
    )
  })
})

// 加载服务器列表
const loadServers = async () => {
  loading.value = true

  try {
    const accountId = localStorage.getItem('wizard_account_id')
    if (!accountId) {
      throw new Error('未找到账号ID')
    }

    const result = await api.getServers(accountId)

    // 处理服务器数据
    servers.value = result.map(server => ({
      ...server,
      selected: false,
      expanded: false,
      activeCategory: server.categories?.[0]?.id || '',
      // 计算活跃度评分
      activity_score: calculateActivityScore(server),
      // 标记推荐
      recommended: shouldRecommendServer(server),
      // 处理频道数据
      channels: processChannels(server.channels || [])
    }))

    ElMessage.success(`成功加载 ${servers.value.length} 个服务器`)

  } catch (error) {
    ElMessage.error('加载服务器列表失败：' + error.message)
    servers.value = []
  } finally {
    loading.value = false
  }
}

// 计算服务器活跃度评分
const calculateActivityScore = (server) => {
  const messageScore = Math.min((server.message_count_24h || 0) / 100 * 40, 40)
  const memberScore = Math.min((server.member_count || 0) / 1000 * 30, 30)
  const onlineScore = Math.min((server.online_count || 0) / (server.member_count || 1) * 100 * 30, 30)

  return Math.round(messageScore + memberScore + onlineScore)
}

// 判断是否推荐该服务器
const shouldRecommendServer = (server) => {
  return server.activity_score >= 60
}

// 处理频道数据
const processChannels = (channels) => {
  return channels.map(channel => ({
    ...channel,
    selected: false,
    // 标记推荐频道
    recommended: shouldRecommendChannel(channel)
  }))
}

// 判断是否推荐该频道
const shouldRecommendChannel = (channel) => {
  return (
    channel.type === 'text' &&
    (channel.message_count_24h || 0) > 10 &&
    channel.last_message_time &&
    new Date() - new Date(channel.last_message_time) < 7 * 24 * 60 * 60 * 1000
  )
}

// 获取活跃度类型
const getActivityType = (score) => {
  if (score >= 80) return 'success'
  if (score >= 60) return 'warning'
  return 'info'
}

// 切换服务器选择
const toggleServer = (server) => {
  // 如果选中服务器，自动展开
  if (server.selected && !server.expanded) {
    server.expanded = true
    loadChannels(server)
  }
}

// 切换服务器展开/收起
const toggleServerExpand = async (server) => {
  server.expanded = !server.expanded

  // 如果展开且频道未加载，则加载频道
  if (server.expanded && (!server.channels || server.channels.length === 0)) {
    await loadChannels(server)
  }
}

// 加载频道列表
const loadChannels = async (server) => {
  if (server.channels && server.channels.length > 0) {
    return
  }

  try {
    const accountId = localStorage.getItem('wizard_account_id')
    const result = await api.getChannels(accountId, server.id)

    server.channels = processChannels(result)

    // 按分类组织频道
    server.categories = organizeChannelsByCategory(server.channels)
    server.activeCategory = server.categories[0]?.id || ''

  } catch (error) {
    ElMessage.error(`加载 ${server.name} 的频道失败`)
  }
}

// 按分类组织频道
const organizeChannelsByCategory = (channels) => {
  const categories = {}

  channels.forEach(channel => {
    const categoryId = channel.category_id || 'uncategorized'
    const categoryName = channel.category_name || '未分类'

    if (!categories[categoryId]) {
      categories[categoryId] = {
        id: categoryId,
        name: categoryName,
        channels: []
      }
    }

    categories[categoryId].channels.push(channel)
  })

  return Object.values(categories)
}

// 切换频道选择
const toggleChannel = (server, channel) => {
  // 如果选中了频道，自动选中服务器
  if (channel.selected && !server.selected) {
    server.selected = true
  }

  // 如果取消了所有频道，取消选中服务器
  if (!channel.selected) {
    const hasSelectedChannel = server.channels.some(c => c.selected)
    if (!hasSelectedChannel) {
      server.selected = false
    }
  }
}

// 智能推荐
const selectRecommended = () => {
  let count = 0

  servers.value.forEach(server => {
    if (server.recommended) {
      server.selected = true
      server.expanded = true

      // 选择推荐频道
      server.channels?.forEach(channel => {
        if (channel.recommended) {
          channel.selected = true
          count++
        }
      })
    }
  })

  ElMessage.success(`已自动选择 ${count} 个推荐频道`)
}

// 全选
const selectAll = () => {
  servers.value.forEach(server => {
    server.selected = true
    server.expanded = true
    server.channels?.forEach(channel => {
      channel.selected = true
    })
  })

  ElMessage.success('已全选所有频道')
}

// 全不选
const unselectAll = () => {
  servers.value.forEach(server => {
    server.selected = false
    server.channels?.forEach(channel => {
      channel.selected = false
    })
  })

  ElMessage.info('已取消所有选择')
}

// 选择服务器的所有频道
const selectAllChannels = (server) => {
  server.selected = true
  server.channels?.forEach(channel => {
    channel.selected = true
  })

  ElMessage.success(`已选择 ${server.name} 的所有频道`)
}

// 选择服务器的推荐频道
const selectRecommendedChannels = (server) => {
  server.selected = true
  let count = 0

  server.channels?.forEach(channel => {
    if (channel.recommended) {
      channel.selected = true
      count++
    } else {
      channel.selected = false
    }
  })

  ElMessage.success(`已选择 ${count} 个推荐频道`)
}

// 取消选择服务器的所有频道
const unselectAllChannels = (server) => {
  server.channels?.forEach(channel => {
    channel.selected = false
  })

  server.selected = false

  ElMessage.info(`已取消 ${server.name} 的所有选择`)
}

// 重新加载
const retryLoadServers = () => {
  loadServers()
}

// 下一步
const handleNext = () => {
  // 收集选中的频道
  const selectedChannels = []

  servers.value.forEach(server => {
    server.channels?.forEach(channel => {
      if (channel.selected) {
        selectedChannels.push({
          server_id: server.id,
          server_name: server.name,
          channel_id: channel.id,
          channel_name: channel.name,
          channel_type: channel.type
        })
      }
    })
  })

  // 保存到全局状态
  localStorage.setItem('wizard_selected_channels', JSON.stringify(selectedChannels))

  ElMessage.success(`已选择 ${selectedChannels.length} 个频道`)
  emit('next')
}

// 组件挂载时加载服务器
onMounted(() => {
  loadServers()
})
</script>

<style scoped lang="scss">
.servers-step {
  padding: 20px;
}

.step-info {
  margin-bottom: 20px;
}

.loading-section {
  text-align: center;
  padding: 40px;

  .loading-text {
    margin-top: 20px;
    font-size: 16px;
    color: #909399;
  }
}

.toolbar-card {
  margin-bottom: 20px;
}

.servers-list {
  .server-card {
    margin-bottom: 15px;
    transition: all 0.3s;

    &.server-selected {
      border-color: #409EFF;
      box-shadow: 0 2px 12px rgba(64, 158, 255, 0.3);
    }

    .server-header {
      display: flex;
      justify-content: space-between;
      align-items: center;

      .server-info {
        display: flex;
        align-items: center;
        gap: 15px;

        .server-details {
          h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
          }
        }
      }
    }

    .channels-section {
      margin-top: 15px;

      .channels-list {
        .channel-item {
          padding: 10px;
          border-radius: 4px;
          margin-bottom: 5px;
          transition: background 0.3s;

          &:hover {
            background: #F5F7FA;
          }

          &.channel-selected {
            background: #E6F7FF;
          }

          .channel-info {
            display: flex;
            align-items: center;
            gap: 8px;

            .channel-name {
              flex: 1;
              font-size: 14px;
            }

            .channel-tags {
              margin-left: auto;
            }
          }

          .channel-topic {
            margin-top: 5px;
            margin-left: 28px;
            font-size: 12px;
            color: #909399;
          }
        }
      }

      .channel-batch-actions {
        margin-top: 15px;
        text-align: right;
      }
    }
  }
}

.recommendation-card {
  margin-top: 20px;
  background: #FFF9E6;

  .recommendation-criteria {
    list-style: none;
    padding: 0;
    margin: 0;

    li {
      margin: 5px 0;
    }
  }
}

.wizard-actions {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 30px;
}
</style>
```

由于内容极其庞大，我将分多个文件继续创建。让我继续...

