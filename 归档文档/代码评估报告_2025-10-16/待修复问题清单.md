# KOOK消息转发系统 - 待修复问题清单

**优先级说明**:
- 🔴 **P0-致命**: 阻塞发布，必须立即修复
- 🟠 **P1-严重**: 影响核心功能，高优先级
- 🟡 **P2-一般**: 影响体验，中优先级
- 🟢 **P3-轻微**: 优化建议，低优先级

---

## 🔴 P0 - 致命问题（必须修复）

### Issue #1: 使用eval()存在安全风险
**文件**: `backend/app/processors/filter.py`  
**位置**: 第50行  
**问题**:
```python
rule_value = eval(row['rule_value'])  # 不安全！
```

**风险**: 
- 可执行任意代码
- SQL注入风险
- 数据库被篡改

**修复方案**:
```python
import json
rule_value = json.loads(row['rule_value'])
```

**预计工作量**: 5分钟  
**影响范围**: 过滤规则加载

---

### Issue #2: 缺少应用图标文件
**位置**: `build/` 目录  
**问题**: 
- 缺少 `icon.ico` (Windows)
- 缺少 `icon.icns` (macOS)
- 缺少 `icon.png` (Linux)

**影响**: 
- 无法打包完整安装程序
- 应用显示默认图标

**修复方案**:
1. 设计应用图标（或使用临时图标）
2. 生成多种格式：
   ```bash
   # 使用在线工具或ImageMagick
   convert icon.png -resize 256x256 icon.ico
   png2icns icon.icns icon.png
   ```

**预计工作量**: 1-2小时（含设计）  
**影响范围**: 打包流程

---

### Issue #3: 打包未经实际测试
**位置**: `build/build_all_complete.py`  
**问题**: 
- 打包脚本存在但未验证
- 可能存在路径错误
- 依赖可能缺失

**修复方案**:
1. 在Windows上实际运行打包脚本
2. 在macOS上实际运行打包脚本
3. 在Linux上实际运行打包脚本
4. 记录遇到的问题并修复
5. 编写打包文档

**预计工作量**: 4-8小时  
**影响范围**: 部署流程

---

## 🟠 P1 - 严重问题（高优先级）

### Issue #4: 数据库使用同步操作
**文件**: `backend/app/database.py`  
**位置**: 整个文件  
**问题**:
```python
# 在异步环境中使用同步sqlite3
conn = sqlite3.connect(self.db_path)  # 阻塞！
```

**风险**:
- 阻塞事件循环
- 高并发下性能差
- 可能导致超时

**修复方案**:
```python
# 替换为aiosqlite
import aiosqlite

class Database:
    async def get_connection(self):
        return await aiosqlite.connect(self.db_path)
    
    async def get_accounts(self):
        async with self.get_connection() as conn:
            async with conn.execute("SELECT * FROM accounts") as cursor:
                rows = await cursor.fetchall()
                return rows
```

**修改文件**:
- `backend/app/database.py`（全部方法改为async）
- 所有调用`db.*`的地方添加`await`

**预计工作量**: 4-6小时  
**影响范围**: 所有数据库操作

---

### Issue #5: 无限循环无最大重连次数
**文件**: `backend/app/kook/scraper.py`  
**位置**: 第91-98行  
**问题**:
```python
while self.is_running:
    await asyncio.sleep(10)
    try:
        await self.page.evaluate('() => console.log("heartbeat")')
    except:
        await self._reconnect()  # 无限重连！
```

**风险**:
- 账号被封禁后持续重连
- 浪费资源
- 日志爆炸

**修复方案**:
```python
class KookScraper:
    def __init__(self, account_id: int):
        # ...
        self.reconnect_count = 0
        self.max_reconnect = 5
    
    async def start(self, ...):
        while self.is_running:
            await asyncio.sleep(10)
            try:
                await self.page.evaluate('() => console.log("heartbeat")')
            except:
                if self.reconnect_count >= self.max_reconnect:
                    logger.error(f"达到最大重连次数({self.max_reconnect})，停止抓取器")
                    self.is_running = False
                    db.update_account_status(self.account_id, 'offline')
                    break
                
                self.reconnect_count += 1
                await self._reconnect()
```

**预计工作量**: 30分钟  
**影响范围**: 消息抓取稳定性

---

### Issue #6: Cookie格式无验证
**文件**: `backend/app/kook/scraper.py`  
**位置**: 第56-62行  
**问题**:
```python
if cookie:
    cookies = json.loads(cookie)  # 无格式验证
    await self.context.add_cookies(cookies)
```

**风险**:
- 错误格式导致崩溃
- 用户体验差

**修复方案**:
```python
def validate_cookies(cookie_str: str) -> bool:
    """验证Cookie格式"""
    try:
        cookies = json.loads(cookie_str)
        
        # 检查是否为列表
        if not isinstance(cookies, list):
            return False
        
        # 检查每个Cookie必需字段
        for cookie in cookies:
            if not isinstance(cookie, dict):
                return False
            if 'name' not in cookie or 'value' not in cookie:
                return False
        
        return True
    except:
        return False

# 使用
if cookie:
    if not validate_cookies(cookie):
        logger.error("Cookie格式错误")
        return False
    cookies = json.loads(cookie)
    await self.context.add_cookies(cookies)
```

**预计工作量**: 30分钟  
**影响范围**: 账号登录流程

---

### Issue #7: 消息去重Set无限增长
**文件**: `backend/app/queue/worker.py`  
**位置**: 第23行  
**问题**:
```python
self.processed_messages = set()  # 内存泄漏！
```

**风险**:
- 长时间运行内存爆炸
- 可能导致OOM

**修复方案**:
```python
from collections import OrderedDict

class LRUCache:
    """简单的LRU缓存"""
    def __init__(self, max_size=10000):
        self.cache = OrderedDict()
        self.max_size = max_size
    
    def add(self, key):
        if key in self.cache:
            self.cache.move_to_end(key)
        else:
            self.cache[key] = True
            if len(self.cache) > self.max_size:
                self.cache.popitem(last=False)
    
    def __contains__(self, key):
        return key in self.cache

class MessageWorker:
    def __init__(self):
        self.is_running = False
        self.processed_messages = LRUCache(max_size=10000)  # 最多保留1万条
```

**预计工作量**: 30分钟  
**影响范围**: 内存使用

---

## 🟡 P2 - 一般问题（中优先级）

### Issue #8: 图片处理串行导致慢
**文件**: `backend/app/queue/worker.py`  
**位置**: 第128-150行  
**问题**:
```python
for url in image_urls:
    result = await image_processor.process_image(...)  # 串行处理
```

**影响**:
- 多图片消息延迟高
- 资源利用率低

**修复方案**:
```python
# 并行处理图片
tasks = [
    image_processor.process_image(
        url=url,
        strategy='smart',
        cookies=None,
        referer='https://www.kookapp.cn'
    )
    for url in image_urls
]

results = await asyncio.gather(*tasks, return_exceptions=True)

processed_images = []
for i, result in enumerate(results):
    if isinstance(result, Exception):
        logger.error(f"图片处理失败: {image_urls[i]}, {result}")
    elif result:
        processed_images.append(result)
```

**预计工作量**: 1小时  
**影响范围**: 图片转发性能

---

### Issue #9: 异常处理过于宽泛
**文件**: 多个文件  
**问题**:
```python
except Exception as e:  # 捕获所有异常
    logger.error(f"错误: {str(e)}")
```

**影响**:
- 难以定位问题
- 隐藏真实错误

**修复方案**:
```python
# 细化异常类型
try:
    # ...
except ConnectionError as e:
    logger.error(f"连接错误: {e}")
    # 重试逻辑
except TimeoutError as e:
    logger.error(f"超时: {e}")
    # 超时处理
except json.JSONDecodeError as e:
    logger.error(f"JSON解析错误: {e}")
    # 格式错误处理
except Exception as e:
    logger.error(f"未知错误: {e}", exc_info=True)
    # 兜底处理
```

**预计工作量**: 2-3小时（全局搜索替换）  
**影响范围**: 错误诊断

---

### Issue #10: API无认证保护
**文件**: `backend/app/main.py`  
**位置**: 第100-107行  
**问题**:
```python
# CORS允许所有来源
allow_origins=["*"]
```

**风险**:
- API可被任意访问
- 虽然监听127.0.0.1，但不够安全

**修复方案**:
```python
# 1. 添加API Token认证
from fastapi import Header, HTTPException

API_TOKEN = "your-secret-token"  # 应从配置读取

async def verify_token(x_api_token: str = Header(...)):
    if x_api_token != API_TOKEN:
        raise HTTPException(status_code=401, detail="Invalid API Token")

# 2. 在路由上使用
@app.post("/api/accounts", dependencies=[Depends(verify_token)])
async def add_account(...):
    pass

# 3. 限制CORS来源
allow_origins=["http://localhost:5173"]  # 仅开发环境
```

**预计工作量**: 2小时  
**影响范围**: API安全

---

### Issue #11: 缺少启动密码界面
**位置**: `frontend/src/views/`  
**问题**: 
- 配置中有`require_password`选项
- 但前端无密码输入界面

**修复方案**:
1. 创建 `frontend/src/views/Login.vue`
2. 启动时检查配置
3. 显示密码输入对话框
4. 验证后进入主界面

**预计工作量**: 2-3小时  
**影响范围**: 安全性

---

## 🟢 P3 - 轻微问题（低优先级）

### Issue #12: 硬编码选择器易失效
**文件**: `backend/app/kook/scraper.py`  
**位置**: 第305-309, 531-577行  
**问题**:
```python
captcha_selectors = [
    'input[name="captcha"]',  # KOOK页面改版后可能失效
    ...
]
```

**建议**:
- 将选择器提取到配置文件
- 支持热更新

**预计工作量**: 1小时

---

### Issue #13: 日志文件无大小限制
**文件**: `backend/app/utils/logger.py`  
**问题**: 
- 日志可能无限增长
- 磁盘空间风险

**修复方案**:
```python
from loguru import logger

logger.add(
    "logs/app.log",
    rotation="100 MB",  # 100MB轮转
    retention="10 days",  # 保留10天
    compression="zip"  # 压缩旧日志
)
```

**预计工作量**: 15分钟

---

### Issue #14: 前端无加载状态
**位置**: 多个Vue组件  
**问题**:
- 数据加载时无Loading提示
- 用户体验差

**修复方案**:
```vue
<template>
  <el-loading :loading="loading">
    <!-- 内容 -->
  </el-loading>
</template>

<script setup>
const loading = ref(false)

async function fetchData() {
  loading.value = true
  try {
    await api.getData()
  } finally {
    loading.value = false
  }
}
</script>
```

**预计工作量**: 1-2小时（所有组件）

---

### Issue #15: 缺少Electron自动更新
**位置**: `frontend/electron/main.js`  
**建议**: 
- 集成`electron-updater`
- 自动检查更新
- 后台下载安装

**预计工作量**: 3-4小时

---

## 📋 修复优先级排序

### 第1天（必须完成）
1. ✅ Issue #1: 修复eval()安全问题（5分钟）
2. ✅ Issue #5: 添加最大重连次数（30分钟）
3. ✅ Issue #6: Cookie格式验证（30分钟）
4. ✅ Issue #7: LRU缓存去重（30分钟）
5. ✅ Issue #2: 准备应用图标（2小时）

**预计总时间**: 4小时

---

### 第2-3天（打包测试）
6. ✅ Issue #3: 实际打包测试（8小时）
   - Windows打包（3小时）
   - macOS打包（3小时）
   - Linux打包（2小时）

---

### 第4-5天（性能优化）
7. ✅ Issue #4: 异步数据库（6小时）
8. ✅ Issue #8: 图片并行处理（1小时）
9. ✅ Issue #9: 细化异常处理（3小时）

**预计总时间**: 10小时

---

### 第6-7天（安全加固）
10. ✅ Issue #10: API认证（2小时）
11. ✅ Issue #11: 启动密码界面（3小时）
12. ✅ Issue #13: 日志轮转（15分钟）

**预计总时间**: 5.25小时

---

### 后续版本（可延后）
13. Issue #12: 配置化选择器（1小时）
14. Issue #14: 加载状态优化（2小时）
15. Issue #15: 自动更新（4小时）

---

## 🎯 发布里程碑

### v0.9-beta (修复P0问题后)
- ✅ Issue #1, #2
- ✅ Issue #5, #6, #7
- **预计**: 3天内完成

### v1.0-rc (完成打包测试后)
- ✅ Issue #3
- **预计**: 1周内完成

### v1.0 (修复P1问题后)
- ✅ Issue #4, #8, #9, #10, #11
- **预计**: 2周内完成

### v1.1 (优化改进)
- ✅ Issue #12, #13, #14, #15
- **预计**: 1个月内完成

---

## 📝 修复模板

### 创建分支
```bash
git checkout -b fix/issue-1-eval-security
```

### 提交信息格式
```
fix: 修复eval()安全问题 (Issue #1)

- 将eval()替换为json.loads()
- 添加JSON格式验证
- 更新相关测试

Closes #1
```

### Pull Request模板
```markdown
## 问题描述
- Issue #1: 使用eval()存在安全风险

## 修复方案
- 替换为json.loads()
- 添加异常处理

## 测试
- [x] 手动测试通过
- [ ] 单元测试通过（待添加）

## 影响范围
- 过滤规则加载模块
```

---

**建议**: 
1. 按优先级顺序修复
2. 每个Issue创建独立分支
3. 修复后立即测试
4. 合并前代码审查

---

*问题清单 | 配合《代码完成度评估报告.md》使用*
