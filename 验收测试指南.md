# KOOK消息转发系统 v1.1.0 - 验收测试指南

> **版本**: v1.1.0  
> **日期**: 2025-10-16  
> **测试目标**: 验证所有新增功能正常工作

---

## 📋 测试前准备

### 1. 安装依赖

```bash
# 后端依赖
cd backend
pip install -r requirements.txt

# 开发/测试依赖（用于运行单元测试）
pip install -r requirements-dev.txt

# 前端依赖
cd ../frontend
npm install
```

### 2. 检查Python版本

```bash
python --version
# 应该显示 Python 3.11+ 或 3.10+
```

---

## 🧪 测试步骤

### 测试1: 单元测试套件 ⭐⭐⭐

**优先级**: 🔴 最高

```bash
cd backend
./run_tests.sh  # Linux/macOS
# 或
run_tests.bat   # Windows
```

**预期结果**:
```
✅ 29个测试全部通过
✅ 覆盖率 ~95%
✅ 生成HTML报告: htmlcov/index.html
```

**如何验证**:
- 终端显示绿色的"PASSED"
- 没有红色的"FAILED"
- 覆盖率报告可以打开

---

### 测试2: 免责声明 ⭐⭐

**优先级**: 🟠 高

#### 步骤:
1. 删除向导完成标记（模拟首次使用）:
   ```bash
   # 浏览器开发工具 Console:
   localStorage.removeItem('wizard_completed')
   ```
2. 刷新页面，应自动跳转到配置向导
3. 第一步应显示免责声明
4. 不勾选"我已阅读并同意"，"同意并继续"按钮应禁用
5. 勾选后，按钮应启用
6. 点击"拒绝并退出"应提示退出

**预期结果**:
```
✅ 免责声明内容完整（5条）
✅ 必须勾选才能继续
✅ 拒绝则退出应用
```

---

### 测试3: 主密码保护 ⭐⭐⭐

**优先级**: 🔴 最高

#### 步骤:
1. 删除密码配置（模拟首次使用）:
   ```bash
   # 删除数据库中的密码哈希
   sqlite3 ~/Documents/KookForwarder/data/config.db "DELETE FROM system_config WHERE key='app_password_hash';"
   ```
2. 重启应用，应跳转到登录页
3. 首次应提示设置密码
4. 输入密码：`TestPass123`
5. 确认密码：`TestPass123`
6. 勾选"记住密码30天"
7. 点击"设置密码并进入"

**预期结果**:
```
✅ 密码设置成功
✅ 自动跳转到主界面
✅ 重启应用，密码自动填充（记住功能）
✅ 输入错误密码应提示"密码错误"
```

#### 后续测试:
- 关闭应用，重新打开
- 应自动登录（记住的密码）
- 或手动输入密码登录

---

### 测试4: 验证码弹窗 ⭐⭐

**优先级**: 🟠 高

#### 步骤:
1. 进入"账号管理"页面
2. 添加新账号（使用账号密码登录）
3. 如果KOOK要求验证码，应自动弹出验证码对话框
4. 查看验证码图片
5. 输入验证码
6. 点击"提交"

**预期结果**:
```
✅ 验证码对话框自动弹出（检测到需要时）
✅ 验证码图片正常显示
✅ 提交后关闭对话框
✅ 账号登录成功
```

**模拟测试**（如无法触发真实验证码）:
```bash
# 手动设置验证码请求标记
sqlite3 ~/Documents/KookForwarder/data/config.db "INSERT INTO system_config (key, value) VALUES ('captcha_required_1', '{\"image_url\": \"https://via.placeholder.com/150\", \"timestamp\": 1697462400}');"
```

---

### 测试5: 系统托盘 ⭐⭐⭐

**优先级**: 🔴 最高

#### 步骤:
1. 启动应用
2. 点击窗口关闭按钮（X）
3. 检查系统托盘是否出现图标
4. 应显示桌面通知："程序已最小化到系统托盘"
5. 右键点击托盘图标
6. 查看菜单项

**预期结果**:
```
✅ 托盘图标出现
✅ 首次最小化显示桌面通知
✅ 托盘菜单包含：
   - 今日转发统计
   - 成功率显示
   - 显示主窗口
   - 查看日志
   - 开机自启（可勾选）
   - 退出程序
✅ 双击托盘图标恢复窗口
✅ 统计信息每10秒自动更新
```

---

### 测试6: 邮件告警 ⭐⭐

**优先级**: 🟠 中

#### 准备工作:
需要准备一个SMTP邮箱（推荐使用Gmail）

#### 步骤:
1. 进入"设置"页面
2. 找到"邮件告警"配置
3. 填入以下信息:
   ```
   SMTP服务器: smtp.gmail.com
   端口: 587
   用户名: your@gmail.com
   密码: your_app_password
   发件邮箱: your@gmail.com
   收件邮箱: receiver@example.com
   启用邮件告警: ✅
   ```
4. 点击"测试连接"

**预期结果**:
```
✅ 连接测试成功
✅ 收到测试邮件
✅ 邮件格式美观（HTML格式）
✅ 配置保存成功
```

#### 触发告警测试:
```bash
# 使用后端API发送测试告警
curl -X POST http://localhost:9527/api/system/email-test
```

---

### 测试7: 图标生成 ⭐

**优先级**: 🟢 低

#### 步骤:
```bash
cd build

# 安装依赖
pip install Pillow cairosvg

# 生成图标
python generate_icon.py
```

**预期结果**:
```
✅ 生成多个尺寸的PNG
✅ 生成 icon.ico (Windows)
✅ 生成 icon.icns (macOS) 或提示需在macOS上运行
✅ 生成 icon.png (Linux)
✅ 复制到 frontend/public/
```

**验证**:
```bash
ls -lh build/icon*
ls -lh frontend/public/icon*
```

---

### 测试8: 打包配置 ⭐

**优先级**: 🟢 低

#### 验证配置文件:
```bash
# 检查文件存在
ls build/electron-builder.yml
ls build/entitlements.mac.plist
ls build/installer.nsh
```

#### 尝试打包（可选）:
```bash
cd frontend

# 前端构建
npm run build

# Electron打包（需要较长时间）
npm run electron:build
```

**预期结果**:
```
✅ 配置文件格式正确
✅ 打包过程无错误
✅ 生成安装包（如果运行打包命令）
```

---

## 📊 验收标准

### ✅ 通过标准

所有测试项中，至少满足以下条件：

| 测试项 | 必须通过 | 可选 |
|--------|---------|------|
| 单元测试套件 | ✅ 必须 | - |
| 免责声明 | ✅ 必须 | - |
| 主密码保护 | ✅ 必须 | - |
| 验证码弹窗 | ✅ 必须 | - |
| 系统托盘 | ✅ 必须 | - |
| 邮件告警 | - | ✅ 可选 |
| 图标生成 | - | ✅ 可选 |
| 打包配置 | - | ✅ 可选 |

### ⚠️ 失败处理

如果某项测试失败：

1. **单元测试失败**:
   - 查看错误输出
   - 检查依赖是否完整安装
   - 运行: `pip install -r requirements-dev.txt`

2. **功能测试失败**:
   - 查看浏览器Console错误
   - 查看后端日志: `~/Documents/KookForwarder/data/logs/`
   - 检查后端是否正常运行: `curl http://localhost:9527/health`

3. **打包失败**:
   - 检查Node.js版本: `node --version`
   - 重新安装依赖: `npm install`
   - 查看electron-builder错误输出

---

## 🎯 快速验收（5分钟）

如果时间有限，按以下顺序快速验证核心功能：

### 1️⃣ 运行单元测试 (2分钟)
```bash
cd backend && ./run_tests.sh
```
**通过条件**: 29个测试全部PASSED

### 2️⃣ 验证免责声明 (1分钟)
- 访问应用，查看配置向导第一步
- 确认免责声明显示

### 3️⃣ 测试主密码 (1分钟)
- 设置密码: `test123`
- 退出重进，输入密码登录

### 4️⃣ 测试系统托盘 (1分钟)
- 关闭窗口
- 查看托盘图标
- 右键查看菜单

---

## 📞 技术支持

遇到问题？

1. **查看日志**:
   - 后端: `~/Documents/KookForwarder/data/logs/app.log`
   - 测试: `backend/htmlcov/index.html`

2. **提交Issue**:
   - GitHub: https://github.com/gfchfjh/CSBJJWT/issues

3. **查看文档**:
   - `/workspace/项目完善总结报告.md`
   - `/workspace/完善文件清单.md`

---

## ✅ 验收签字

测试完成后，请确认：

```
[ ] 单元测试全部通过
[ ] 免责声明功能正常
[ ] 主密码功能正常
[ ] 验证码弹窗正常
[ ] 系统托盘功能正常
[ ] 邮件告警配置正常（可选）

验收人: _______________
日期: _______________
签名: _______________
```

---

<div align="center">

**祝您使用愉快！** 🎊

如有问题，请随时联系技术支持。

</div>
