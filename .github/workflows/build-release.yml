name: Build and Release All Platforms

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm install --legacy-peer-deps

      - name: Install Backend Dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Build Windows Installer
        run: |
          cd frontend
          npm run build
          npm run electron:build:win

      - name: List build artifacts
        run: |
          dir frontend\dist-electron\*.exe
        shell: cmd

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: frontend/dist-electron/*.exe
          retention-days: 7

  build-macos:
    name: Build macOS DMG
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install PyInstaller
        run: pip3 install pyinstaller

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm install --legacy-peer-deps

      - name: Install Backend Dependencies
        run: |
          cd backend
          pip3 install -r requirements.txt

      - name: Build macOS DMG
        run: |
          cd frontend
          npm run build
          npm run electron:build:mac

      - name: List build artifacts
        run: |
          ls -lh frontend/dist-electron/*.dmg || echo "DMG not found, checking all files:"
          ls -lh frontend/dist-electron/

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: |
            frontend/dist-electron/*.dmg
            frontend/dist-electron/mac/*.app
          retention-days: 7

  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm install --legacy-peer-deps

      - name: Install Backend Dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Build Linux AppImage
        run: |
          cd frontend
          npm run build
          npm run electron:build:linux

      - name: List build artifacts
        run: |
          ls -lh frontend/dist-electron/*.AppImage

      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-installer
          path: frontend/dist-electron/*.AppImage
          retention-days: 7

  create-release:
    name: Create Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List downloaded artifacts
        run: |
          echo "=== All downloaded artifacts ==="
          find . -type f -name "*.exe" -o -name "*.dmg" -o -name "*.AppImage" -o -name "*.app"

      - name: Calculate checksums
        run: |
          echo "=== Generating MD5 checksums ==="
          cd artifacts
          find . -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.AppImage" \) -exec md5sum {} \; > ../checksums.txt
          cd ..
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*
            checksums.txt
          body: |
            # KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ ${{ github.ref_name }}
            
            ## ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½
            
            ### Windows
            - **KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ Setup.exe** - NSISå®‰è£…ç¨‹åº
            
            ### macOS
            - **KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ.dmg** - DMGç£ç›˜æ˜ åƒ
            
            ### Linux
            - **KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ.AppImage** - AppImageé€šç”¨æ ¼å¼
            
            ## âœ… å®Œæ•´ç‰ˆæœ¬è¯´æ˜
            
            è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ­£å¼å‘å¸ƒç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰å¹³å°çš„å®‰è£…åŒ…ã€‚
            
            ### æ–°ç‰¹æ€§
            - âœ… å…¨æ–°3æ­¥é…ç½®å‘å¯¼
            - âœ… å®Œç¾UIç•Œé¢ä¼˜åŒ–
            - âœ… è¯¦ç»†å›¾æ–‡æ•™ç¨‹æ–‡æ¡£
            - âœ… å›¾ç‰‡å¤„ç†ç­–ç•¥ä¼˜åŒ–
            - âœ… ç³»ç»Ÿæ€§èƒ½æå‡
            
            ### ç³»ç»Ÿè¦æ±‚
            - **Windows**: Windows 10 (1809+) / Windows 11
            - **macOS**: macOS 10.15 Catalinaæˆ–æ›´é«˜
            - **Linux**: Ubuntu 18.04+ / Debian 10+ / Fedora 30+ / Arch Linux
            
            ### å®‰è£…æ–¹æ³•
            
            **Windows**: 
            1. ä¸‹è½½ Setup.exe
            2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
            3. æŒ‰ç…§å‘å¯¼å®Œæˆå®‰è£…
            
            **macOS**:
            1. ä¸‹è½½ .dmg æ–‡ä»¶
            2. åŒå‡»æ‰“å¼€DMG
            3. æ‹–æ‹½åˆ°Applicationsæ–‡ä»¶å¤¹
            
            **Linux**:
            1. ä¸‹è½½ .AppImage æ–‡ä»¶
            2. æ·»åŠ å¯æ‰§è¡Œæƒé™: `chmod +x *.AppImage`
            3. åŒå‡»è¿è¡Œ
            
            ## ğŸ“š æ–‡æ¡£
            
            - [ç”¨æˆ·æ‰‹å†Œ](docs/USER_MANUAL.md)
            - [Cookieè·å–æ•™ç¨‹](docs/tutorials/å¦‚ä½•è·å–KOOK_Cookie.md)
            - [Discordé…ç½®æ•™ç¨‹](docs/tutorials/å¦‚ä½•åˆ›å»ºDiscord_Webhook.md)
            - [Telegramé…ç½®æ•™ç¨‹](docs/tutorials/å¦‚ä½•åˆ›å»ºTelegram_Bot.md)
            - [é£ä¹¦é…ç½®æ•™ç¨‹](docs/tutorials/å¦‚ä½•é…ç½®é£ä¹¦è‡ªå»ºåº”ç”¨.md)
            
            ## ğŸ”’ æ–‡ä»¶æ ¡éªŒ
            
            è¯·ä½¿ç”¨MD5æ ¡éªŒå’ŒéªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ï¼ˆè§checksums.txtï¼‰
            
            ---
            
            **å®Œæ•´æ›´æ–°æ—¥å¿—**: [CHANGELOG.md](CHANGELOG.md)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
