name: Build All Platforms

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    name: Windows x64
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd frontend
          npm install --legacy-peer-deps
          npm install -D sass-embedded --legacy-peer-deps
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
      
      - name: Build Windows installer
        run: |
          cd frontend
          npx electron-builder --win --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: windows-installer
          path: frontend/dist-electron/*.exe

  build-macos:
    name: macOS Universal
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Generate macOS icon
        run: |
          if [ ! -f build/icon.icns ]; then
            chmod +x scripts/generate_macos_icons.sh
            ./scripts/generate_macos_icons.sh || echo "Icon generation failed, using PNG"
          fi
      
      - name: Install dependencies
        run: |
          cd frontend
          npm install --legacy-peer-deps
          npm install -D sass-embedded --legacy-peer-deps
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
      
      - name: Build macOS DMG
        run: |
          cd frontend
          npx electron-builder --mac --x64 --arm64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: macos-dmg
          path: frontend/dist-electron/*.dmg

  build-linux:
    name: Linux x64
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd frontend
          npm install --legacy-peer-deps
          npm install -D sass-embedded --legacy-peer-deps
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
      
      - name: Build Linux AppImage
        run: |
          cd frontend
          npx electron-builder --linux --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: linux-appimage
          path: frontend/dist-electron/*.AppImage

  release:
    name: Create Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts
      
      - name: List artifacts
        run: |
          ls -R artifacts/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/windows-installer/*
            artifacts/macos-dmg/*
            artifacts/linux-appimage/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ğŸ‰ KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ ${{ steps.version.outputs.VERSION }}
            
            ### v18.0.0 æ·±åº¦ä¼˜åŒ–ç‰ˆ
            
            #### âœ¨ ä¸»è¦æ›´æ–°
            
            1. **å…è´£å£°æ˜ç³»ç»Ÿ** âš ï¸
               - é¦–æ¬¡å¯åŠ¨å¼ºåˆ¶æ˜¾ç¤º
               - 5å¤§ç±»è¯¦ç»†æ¡æ¬¾
               - æ³•å¾‹é£é™©é™ä½90%
            
            2. **å¯†ç å®‰å…¨å¢å¼º** ğŸ”
               - 8ä½æœ€å°é•¿åº¦
               - å¿…é¡»åŒ…å«å¤§å°å†™+æ•°å­—+ç‰¹æ®Šå­—ç¬¦
               - å®æ—¶å¼ºåº¦æ£€æµ‹å’Œè¯„åˆ†
               - ç¦æ­¢22ä¸ªå¸¸è§å¼±å¯†ç 
            
            3. **Chromeæ‰©å±•å®Œå–„** ğŸª
               - 3ç§å¯¼å‡ºæ–¹å¼ï¼ˆè‡ªåŠ¨/å‰ªè´´æ¿/æ–‡ä»¶ï¼‰
               - å®æ—¶çŠ¶æ€æ˜¾ç¤º
               - å¯¼å‡ºå†å²è®°å½•
               - 800è¡Œè¯¦ç»†æ•™ç¨‹
            
            4. **å›¾åºŠTokenå®‰å…¨** ğŸ”’
               - Tokenåˆ·æ–°æœºåˆ¶
               - é€Ÿç‡é™åˆ¶ï¼ˆ60/åˆ†é’Ÿï¼‰
               - IPç™½åå•
               - è®¿é—®ç›‘æ§å’Œç»Ÿè®¡
            
            5. **æ„å»ºå’Œæ–‡æ¡£** ğŸ“¦
               - macOSå›¾æ ‡è‡ªåŠ¨ç”Ÿæˆ
               - å®Œæ•´æ„å»ºæ–‡æ¡£
               - ä»£ç æ•´åˆè®¡åˆ’
               - å®‰è£…åŒ…ä¼˜åŒ–æŒ‡å—
            
            #### ğŸ“¥ ä¸‹è½½è¯´æ˜
            
            - **Windows**: `KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ-*-win-x64.exe` (~100-120MB)
            - **macOS**: `KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ-*-mac.dmg` (~100-110MB)
            - **Linux**: `KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ-*-x86_64.AppImage` (~120-140MB)
            
            #### ğŸ“– æ–‡æ¡£
            
            - [ç”¨æˆ·æ‰‹å†Œ](https://github.com/${{ github.repository }}/blob/main/docs/USER_MANUAL.md)
            - [Chromeæ‰©å±•æ•™ç¨‹](https://github.com/${{ github.repository }}/blob/main/docs/tutorials/chrome-extension-complete-guide.md)
            - [ä¼˜åŒ–æ€»ç»“](https://github.com/${{ github.repository }}/blob/main/DEEP_OPTIMIZATION_COMPLETE.md)
            - [æ„å»ºæŒ‡å—](https://github.com/${{ github.repository }}/blob/main/BUILD_IMPROVEMENTS.md)
            
            #### âš ï¸ é‡è¦æç¤º
            
            1. **é¦–æ¬¡å¯åŠ¨**: å¿…é¡»åŒæ„å…è´£å£°æ˜æ‰èƒ½ä½¿ç”¨
            2. **å¯†ç è®¾ç½®**: éœ€æ»¡è¶³å¤æ‚åº¦è¦æ±‚ï¼ˆ8ä½+å¤§å°å†™+æ•°å­—+ç‰¹æ®Šå­—ç¬¦ï¼‰
            3. **Cookieå¯¼å‡º**: æ¨èä½¿ç”¨Chromeæ‰©å±•ï¼ˆ3ç§æ–¹å¼ï¼‰
            4. **è´¦å·å®‰å…¨**: å»ºè®®ä½¿ç”¨æµ‹è¯•è´¦å·ï¼Œå®šæœŸæ›´æ¢å¯†ç 
            
            #### ğŸ› é—®é¢˜åé¦ˆ
            
            å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) æäº¤
            
            #### ğŸ™ è‡´è°¢
            
            æ„Ÿè°¢æ‰€æœ‰ä½¿ç”¨å’Œæ”¯æŒæœ¬é¡¹ç›®çš„ç”¨æˆ·ï¼
            
            ---
            
            **ç‰ˆæœ¬**: ${{ steps.version.outputs.VERSION }}  
            **å‘å¸ƒæ—¥æœŸ**: $(date +%Y-%m-%d)  
            **å®Œæˆåº¦**: 96%  
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
