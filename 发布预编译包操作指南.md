# 📦 发布预编译安装包 - 操作指南

**当前日期**: 2025-10-23  
**项目版本**: v1.13.2  
**项目仓库**: https://github.com/gfchfjh/CSBJJWT

---

## 🎯 当前状态

### 环境信息
```
✅ Git仓库: https://github.com/gfchfjh/CSBJJWT
✅ 当前分支: cursor/bc-44adfe38-dc88-4514-8738-32de4908fbfa-fcee
✅ 当前版本: v1.13.2
✅ 已存在Tag: v1.13.0, v1.13.1, v1.13.2, v1.9.1
✅ 构建配置: 100%完成
```

### 未跟踪文件
```
- 一键安装验证总结.md (我刚创建的检查报告)
- 项目一键安装检查报告.md (我刚创建的检查报告)
```

---

## ⚠️ 重要提示

**当前在Cursor临时分支上**，不建议直接从此分支发布。

**建议的操作流程**：
1. 先切换到 `main` 分支
2. 确保代码最新
3. 运行发布脚本

---

## 🚀 推荐方案：使用发布脚本

### 方案A: 标准发布流程（推荐）

```bash
# 步骤1: 切换到main分支
git checkout main

# 步骤2: 拉取最新代码
git pull origin main

# 步骤3: 运行发布脚本
chmod +x release_package.sh
./release_package.sh

# 脚本会引导您完成：
# - 检查Git状态
# - 确认版本号（当前是v1.13.2）
# - 创建Git Tag
# - 推送到GitHub
# - 触发GitHub Actions自动构建
```

**预计耗时**：
- 运行脚本：2分钟
- GitHub Actions构建：15-20分钟

**构建产物**：
- ✅ Windows: `KookForwarder-Setup-1.13.2.exe` (~450MB)
- ✅ macOS: `KookForwarder-1.13.2.dmg` (~480MB)
- ✅ Linux: `KookForwarder-1.13.2.AppImage` (~420MB)

---

### 方案B: 手动触发GitHub Actions（替代方案）

如果不想创建新的tag，可以手动触发：

```bash
# 访问GitHub Actions页面
https://github.com/gfchfjh/CSBJJWT/actions/workflows/build-and-release.yml

# 点击 "Run workflow" 按钮
# 输入版本号：v1.13.2
# 点击 "Run workflow" 确认
```

---

### 方案C: 创建新版本发布（推荐新版本）

如果要发布新版本（比如v1.13.3）：

```bash
# 步骤1: 切换到main分支
git checkout main
git pull origin main

# 步骤2: 更新版本号
# 编辑 frontend/package.json，将 "version": "1.13.2" 改为 "1.13.3"

# 步骤3: 提交更改
git add frontend/package.json
git commit -m "chore: bump version to v1.13.3"
git push origin main

# 步骤4: 运行发布脚本
./release_package.sh
# 输入新版本号：1.13.3
```

---

## 📋 发布脚本详细说明

`release_package.sh` 脚本会自动执行：

### 步骤1: 检查Git仓库 ✅
- 验证是否为Git仓库
- 检查是否有未提交的更改
- 提示用户确认

### 步骤2: 版本管理 ✅
- 读取当前版本（frontend/package.json）
- 允许用户输入新版本号
- 可选：自动更新package.json并提交

### 步骤3: Tag管理 ✅
- 检查Tag是否已存在
- 如果存在，询问是否覆盖
- 创建新Tag（格式：v1.13.2）

### 步骤4: 显示发布清单 ✅
```
版本信息：
  版本号: v1.13.2
  当前分支: main
  最后提交: xxx

构建内容：
  ✅ Windows 安装包 (.exe, ~450MB)
  ✅ macOS 安装包 (.dmg, ~480MB)
  ✅ Linux 安装包 (.AppImage, ~420MB)
  ✅ Docker 镜像

构建方式：
  GitHub Actions 自动构建（15-20分钟）

发布位置：
  https://github.com/gfchfjh/CSBJJWT/releases/tag/v1.13.2
```

### 步骤5: 推送到GitHub ✅
- 推送代码到远程分支
- 推送Tag到远程仓库
- 自动触发GitHub Actions

### 步骤6: 显示后续操作 ✅
- 构建进度链接
- 发布页面链接
- 验证和测试步骤

---

## 🔧 GitHub Actions构建流程

Tag推送后，GitHub Actions会自动执行：

### Job 1: 构建后端 (3个平台并行)
```
✅ Ubuntu: Python后端 + Chromium
✅ Windows: Python后端 + Chromium  
✅ macOS: Python后端 + Chromium

使用PyInstaller打包
包含所有依赖（Python、Playwright、Redis）
```

### Job 2: 构建Windows安装包
```
✅ 下载Windows后端
✅ 安装前端依赖
✅ 构建Electron应用
✅ 使用electron-builder打包
✅ 生成.exe安装程序
```

### Job 3: 构建macOS安装包
```
✅ 下载macOS后端
✅ 安装前端依赖
✅ 构建Electron应用
✅ 使用electron-builder打包
✅ 生成.dmg磁盘镜像
```

### Job 4: 构建Linux安装包
```
✅ 下载Linux后端
✅ 安装前端依赖
✅ 构建Electron应用
✅ 使用electron-builder打包
✅ 生成.AppImage文件
```

### Job 5: 创建Release
```
✅ 收集所有构建产物
✅ 创建GitHub Release
✅ 上传所有安装包
✅ 添加Release Notes
```

**总耗时**: 15-20分钟

---

## 📊 当前可选方案对比

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| **方案A: 标准发布** | 全自动、安全、可追溯 | 需要切换分支 | ⭐⭐⭐⭐⭐ |
| **方案B: 手动触发** | 不创建新tag | 需要手动操作 | ⭐⭐⭐ |
| **方案C: 新版本** | 正式发布新版本 | 需要更新版本号 | ⭐⭐⭐⭐⭐ |

---

## ✅ 推荐操作步骤（方案A）

### 如果v1.13.2的tag已经存在且想重新构建：

```bash
# 1. 切换到main分支
cd /workspace
git checkout main
git pull origin main

# 2. 删除旧tag（本地和远程）
git tag -d v1.13.2
git push origin :refs/tags/v1.13.2

# 3. 运行发布脚本
chmod +x release_package.sh
./release_package.sh

# 4. 按提示操作：
#    - 当前版本：v1.13.2
#    - 新版本号：留空（使用当前版本）
#    - 确认创建发布：输入 y

# 5. 等待构建完成（15-20分钟）
#    访问: https://github.com/gfchfjh/CSBJJWT/actions

# 6. 下载安装包
#    访问: https://github.com/gfchfjh/CSBJJWT/releases/tag/v1.13.2
```

### 如果想发布新版本v1.13.3：

```bash
# 1. 切换到main分支
cd /workspace
git checkout main
git pull origin main

# 2. 运行发布脚本
chmod +x release_package.sh
./release_package.sh

# 3. 按提示操作：
#    - 当前版本：v1.13.2
#    - 新版本号：1.13.3
#    - 更新package.json：输入 y
#    - 确认创建发布：输入 y

# 4. 等待构建完成（15-20分钟）
#    访问: https://github.com/gfchfjh/CSBJJWT/actions

# 5. 下载安装包
#    访问: https://github.com/gfchfjh/CSBJJWT/releases/tag/v1.13.3
```

---

## 🔍 验证发布成功

### 1. 检查GitHub Actions构建状态

访问: https://github.com/gfchfjh/CSBJJWT/actions

✅ 所有workflow应该显示绿色勾号  
✅ 构建时间约15-20分钟  
✅ 没有红色失败标记

### 2. 检查GitHub Release

访问: https://github.com/gfchfjh/CSBJJWT/releases/tag/v1.13.2

✅ 应该看到3个安装包：
- `KookForwarder-Setup-1.13.2.exe` (~450MB)
- `KookForwarder-1.13.2.dmg` (~480MB)
- `KookForwarder-1.13.2.AppImage` (~420MB)

### 3. 下载并测试安装包

```bash
# Windows测试
# 1. 下载.exe文件
# 2. 双击安装
# 3. 启动应用
# 4. 完成配置向导
# 5. 测试基本功能

# macOS测试
# 1. 下载.dmg文件
# 2. 拖拽安装
# 3. 右键打开（首次）
# 4. 完成配置向导
# 5. 测试基本功能

# Linux测试
# 1. 下载.AppImage文件
# 2. chmod +x KookForwarder-1.13.2.AppImage
# 3. ./KookForwarder-1.13.2.AppImage
# 4. 完成配置向导
# 5. 测试基本功能
```

---

## 📝 发布后的操作

### 1. 更新文档

```bash
# 更新README.md中的下载链接
# 将所有v1.13.1替换为v1.13.2

# 更新CHANGELOG.md
# 添加v1.13.2的更新日志
```

### 2. 推广发布

- 在项目主页更新"最新版本"标签
- 在社交媒体发布更新公告
- 通知用户升级

### 3. 监控反馈

- 关注GitHub Issues
- 查看用户反馈
- 修复发现的问题

---

## ❓ 常见问题

### Q1: 如果构建失败怎么办？

**A**: 查看GitHub Actions日志
```bash
# 访问失败的workflow
https://github.com/gfchfjh/CSBJJWT/actions

# 点击失败的job
# 查看错误日志
# 根据错误信息修复问题
# 删除tag后重新发布
```

### Q2: 如何取消发布？

**A**: 删除tag
```bash
# 删除本地tag
git tag -d v1.13.2

# 删除远程tag
git push origin :refs/tags/v1.13.2

# 取消GitHub Actions（如果正在运行）
# 访问Actions页面，点击Cancel
```

### Q3: 如何重新发布同一版本？

**A**: 删除旧tag后重新创建
```bash
# 1. 删除tag
git tag -d v1.13.2
git push origin :refs/tags/v1.13.2

# 2. 删除GitHub Release（手动）
# 访问 https://github.com/gfchfjh/CSBJJWT/releases
# 删除对应的Release

# 3. 重新运行发布脚本
./release_package.sh
```

---

## 🎯 快速命令参考

```bash
# === 标准发布流程 ===
git checkout main
git pull origin main
./release_package.sh

# === 删除tag ===
git tag -d v1.13.2
git push origin :refs/tags/v1.13.2

# === 查看所有tag ===
git tag -l

# === 查看最新tag ===
git describe --tags --abbrev=0

# === 手动创建tag ===
git tag -a v1.13.2 -m "Release v1.13.2"
git push origin v1.13.2

# === 查看tag详情 ===
git show v1.13.2
```

---

## 📚 相关文档

- [GitHub Actions配置](.github/workflows/build-and-release.yml)
- [构建脚本](build_installer.sh)
- [PyInstaller配置](build/build_backend.spec)
- [Electron配置](frontend/package.json)
- [本地构建指南](LOCAL_BUILD_GUIDE.md)
- [构建工具文档](BUILD_TOOLS_README.md)

---

## 💡 建议

### 立即执行（如果确认要发布v1.13.2）：

```bash
# 最简单的方式
cd /workspace
git checkout main
./release_package.sh
# 按提示操作，留空使用当前版本v1.13.2
```

### 或者发布新版本v1.13.3：

```bash
cd /workspace
git checkout main
./release_package.sh
# 输入新版本号：1.13.3
```

---

**总结**：发布预编译包的所有准备工作已100%完成，只需运行发布脚本即可！

**预计总耗时**：
- 运行脚本：2分钟
- GitHub Actions构建：15-20分钟
- 总计：~20分钟

---

**创建时间**: 2025-10-23  
**文档版本**: v1.0
