# KOOK消息转发系统 - 开发指南

**版本**: v1.12.0+ (S+级完善版)  
**更新日期**: 2025-10-21

**v1.12.0+ 新增内容**:
- ✅ Chromium自动打包 - 打包脚本自动集成浏览器
- ✅ Cookie多格式解析器 - 新增`backend/app/utils/cookie_parser.py`
- ✅ 增强构建脚本 - `build/build_all_enhanced.py`
- ✅ 新功能测试 - `test_new_features.py`  

## 目录

- [开发环境搭建](#开发环境搭建)
- [项目结构说明](#项目结构说明)
- [后端开发](#后端开发)
- [前端开发](#前端开发)
- [调试技巧](#调试技巧)
- [打包发布](#打包发布)

---

## 开发环境搭建

### 1. 环境要求

- Python 3.11+
- Node.js 18+
- Redis 6.0+
- Git

### 2. 克隆项目

```bash
git clone https://github.com/yourusername/kook-forwarder.git
cd kook-forwarder
```

### 3. 后端环境

```bash
cd backend

# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# macOS/Linux
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 安装Playwright浏览器
playwright install chromium
```

### 4. 前端环境

```bash
cd frontend

# 安装依赖
npm install

# 或使用yarn
yarn install
```

### 5. Redis服务

**Windows:**
```bash
# 使用Docker
docker run -d -p 6379:6379 redis

# 或下载Windows版Redis
# https://github.com/tporadowski/redis/releases
```

**macOS:**
```bash
brew install redis
redis-server
```

**Linux:**
```bash
sudo apt install redis-server
sudo systemctl start redis
```

---

## 项目结构说明

```
KookForwarder/
│
├─ backend/                    # Python后端
│  ├─ app/
│  │  ├─ __init__.py
│  │  ├─ main.py              # FastAPI主应用
│  │  ├─ config.py            # 配置管理
│  │  ├─ database.py          # 数据库操作
│  │  │
│  │  ├─ kook/                # KOOK抓取模块
│  │  │  ├─ __init__.py
│  │  │  └─ scraper.py        # Playwright消息抓取
│  │  │
│  │  ├─ queue/               # 消息队列
│  │  │  ├─ __init__.py
│  │  │  ├─ redis_client.py   # Redis客户端
│  │  │  └─ worker.py         # 消息处理Worker
│  │  │
│  │  ├─ forwarders/          # 平台转发器
│  │  │  ├─ __init__.py
│  │  │  ├─ discord.py        # Discord转发
│  │  │  ├─ telegram.py       # Telegram转发
│  │  │  └─ feishu.py         # 飞书转发
│  │  │
│  │  ├─ processors/          # 消息处理
│  │  │  ├─ __init__.py
│  │  │  ├─ formatter.py      # 格式转换
│  │  │  └─ filter.py         # 过滤规则
│  │  │
│  │  ├─ utils/               # 工具模块
│  │  │  ├─ __init__.py
│  │  │  ├─ crypto.py         # 加密工具
│  │  │  ├─ logger.py         # 日志工具
│  │  │  └─ rate_limiter.py   # 限流器
│  │  │
│  │  └─ api/                 # API路由
│  │     ├─ __init__.py
│  │     ├─ accounts.py       # 账号管理API
│  │     ├─ bots.py           # Bot配置API
│  │     ├─ mappings.py       # 频道映射API
│  │     ├─ logs.py           # 日志API
│  │     └─ system.py         # 系统API
│  │
│  ├─ requirements.txt        # Python依赖
│  └─ .env.example           # 环境变量示例
│
├─ frontend/                  # Electron前端
│  ├─ src/
│  │  ├─ main.js             # Vue主入口
│  │  ├─ App.vue             # 根组件
│  │  ├─ style.css           # 全局样式
│  │  │
│  │  ├─ router/             # 路由配置
│  │  │  └─ index.js
│  │  │
│  │  ├─ store/              # Pinia状态管理
│  │  │  ├─ system.js        # 系统状态
│  │  │  └─ accounts.js      # 账号状态
│  │  │
│  │  ├─ api/                # API调用
│  │  │  └─ index.js
│  │  │
│  │  ├─ views/              # 页面组件
│  │  │  ├─ Layout.vue       # 主布局
│  │  │  ├─ Home.vue         # 首页
│  │  │  ├─ Accounts.vue     # 账号管理
│  │  │  ├─ Bots.vue         # 机器人配置
│  │  │  ├─ Mapping.vue      # 频道映射
│  │  │  ├─ Filter.vue       # 过滤规则
│  │  │  ├─ Logs.vue         # 实时日志
│  │  │  └─ Settings.vue     # 系统设置
│  │  │
│  │  └─ components/         # 通用组件
│  │     └─ BotList.vue
│  │
│  ├─ electron/              # Electron主进程
│  │  └─ main.js
│  │
│  ├─ public/                # 静态资源
│  ├─ index.html            # HTML模板
│  ├─ vite.config.js        # Vite配置
│  └─ package.json          # Node依赖
│
├─ docs/                     # 文档
│  ├─ CHANGELOG.md          # 更新日志
│  └─ 开发指南.md            # 本文件
│
├─ build/                    # 打包配置
├─ .gitignore
└─ README.md
```

---

## 后端开发

### 启动开发服务器

```bash
cd backend
python -m app.main
```

服务将在 `http://localhost:9527` 启动。

### API文档

启动后访问：
- Swagger UI: `http://localhost:9527/docs`
- ReDoc: `http://localhost:9527/redoc`

### 添加新的转发平台

1. 在 `backend/app/forwarders/` 创建新文件，如 `wecom.py`

```python
class WeComForwarder:
    async def send_message(self, webhook_url: str, content: str):
        # 实现企业微信转发逻辑
        pass
```

2. 在 `backend/app/queue/worker.py` 的 `forward_to_target()` 添加处理逻辑

3. 在前端添加对应的配置界面

### 数据库操作

```python
from app.database import db

# 添加账号
account_id = db.add_account(
    email="user@example.com",
    password_encrypted="...",
    cookie="{...}"
)

# 查询账号
accounts = db.get_accounts()

# 更新状态
db.update_account_status(account_id, 'online')
```

### 测试

```bash
# 运行单元测试
pytest tests/

# 代码覆盖率
pytest --cov=app tests/
```

---

## 前端开发

### 启动开发服务器

```bash
cd frontend
npm run dev
```

访问 `http://localhost:5173`

### Electron开发模式

```bash
npm run electron:dev
```

### 添加新页面

1. 在 `src/views/` 创建组件，如 `NewFeature.vue`

```vue
<template>
  <div class="new-feature">
    <el-card>
      <template #header>
        <span>新功能</span>
      </template>
      <!-- 内容 -->
    </el-card>
  </div>
</template>

<script setup>
// 逻辑
</script>

<style scoped>
/* 样式 */
</style>
```

2. 在 `src/router/index.js` 添加路由

```javascript
{
  path: '/new-feature',
  name: 'NewFeature',
  component: () => import('../views/NewFeature.vue'),
  meta: { title: '新功能' }
}
```

3. 在 `src/views/Layout.vue` 添加菜单项

### API调用

```javascript
import api from '@/api'

// 在组件中使用
const fetchData = async () => {
  try {
    const data = await api.getAccounts()
    // 处理数据
  } catch (error) {
    console.error('请求失败:', error)
  }
}
```

### 状态管理

```javascript
// 定义store: src/store/mystore.js
import { defineStore } from 'pinia'

export const useMyStore = defineStore('mystore', {
  state: () => ({
    data: []
  }),
  actions: {
    async fetchData() {
      this.data = await api.getData()
    }
  }
})

// 在组件中使用
import { useMyStore } from '@/store/mystore'
const myStore = useMyStore()
```

---

## 调试技巧

### 后端调试

1. **使用日志**

```python
from app.utils.logger import logger

logger.debug("调试信息")
logger.info("普通信息")
logger.warning("警告信息")
logger.error("错误信息")
```

2. **使用pdb调试器**

```python
import pdb; pdb.set_trace()
```

3. **查看Redis数据**

```bash
redis-cli
> KEYS *
> GET key_name
> LRANGE kook_messages 0 -1
```

### 前端调试

1. **使用Vue DevTools**
   - Chrome扩展: Vue.js devtools
   - 查看组件树、状态、事件

2. **控制台调试**

```javascript
console.log('调试信息:', data)
console.table(array)
console.dir(object)
```

3. **网络请求调试**
   - 打开浏览器开发者工具
   - 切换到Network标签
   - 查看API请求和响应

---

## 打包发布

### v1.12.0 新增：完整打包配置 🎉

#### 方式一：使用PyInstaller配置文件（推荐）⭐

**后端打包**:

```bash
# 1. 安装PyInstaller
pip install pyinstaller

# 2. 使用spec配置文件（v1.12.0新增）
pyinstaller backend/build_backend.spec

# 输出
dist/KookForwarder-Backend.exe  # Windows (~80-120MB)
dist/KookForwarder-Backend      # Linux/macOS (~70-110MB)
```

**配置文件**: `backend/build_backend.spec`
- ✅ 自动打包Redis可执行文件
- ✅ 自动打包选择器配置
- ✅ 自动打包文档文件
- ✅ 50+隐藏导入配置
- ✅ 排除不需要的模块
- ✅ UPX压缩支持

**详细指南**: 查看 `backend/build_instructions.md`

#### 方式二：手动打包（传统方式）

```bash
cd backend

# Windows
pyinstaller --onefile \
    --name KookForwarder-Backend \
    --icon ../build/icon.ico \
    --add-data "redis/redis-server.exe;redis" \
    --add-data "data/selectors.yaml;data" \
    --hidden-import playwright \
    --hidden-import fastapi \
    app/main.py

# Linux/macOS
pyinstaller --onefile \
    --name KookForwarder-Backend \
    --icon ../build/icon.icns \
    --add-data "redis/redis-server:redis" \
    --add-data "data/selectors.yaml:data" \
    --hidden-import playwright \
    --hidden-import fastapi \
    app/main.py
```

### 打包前端

```bash
cd frontend

# 1. 构建Vue应用
npm run build

# 2. 打包Electron应用
# Windows
npm run electron:build -- --win

# macOS
npm run electron:build -- --mac

# Linux
npm run electron:build -- --linux

# 输出在 dist-electron/ 目录
```

**打包配置**: `build/electron-builder.yml`
- ✅ Windows NSIS安装程序
- ✅ macOS DMG磁盘镜像
- ✅ Linux AppImage/DEB

### 完整打包流程（v1.12.0）

**步骤1: 准备图标文件**（v1.12.0新增）

```bash
# 方法1: 快速生成占位图标
python build/placeholder_icon_generator.py

# 方法2: 使用在线工具
# - 访问 https://www.icoconverter.com（生成ICO）
# - 访问 https://cloudconvert.com（生成ICNS）

# 方法3: 雇佣设计师（¥100-500）
```

**详细指南**: 查看 `build/ICON_REQUIREMENTS.md`

**步骤2: 更新版本号**

```bash
# backend/app/config.py
app_version: str = "1.12.0"

# frontend/package.json
"version": "1.12.0"

# build/electron-builder.yml
# 版本号自动从package.json读取
```

**步骤3: 打包后端**

```bash
# 使用新的spec配置（推荐）
pyinstaller backend/build_backend.spec

# 或使用构建脚本
./backend/build_windows.bat  # Windows
./backend/build_unix.sh      # Linux/macOS
```

**步骤4: 打包前端**

```bash
cd frontend
npm run build
npm run electron:build
```

**步骤5: 测试安装包**

```bash
# 安装并测试
# Windows: 运行 dist-electron/KookForwarder_v1.12.0_Windows_x64.exe
# macOS: 打开 dist-electron/KookForwarder_v1.12.0_macOS.dmg
# Linux: 运行 dist-electron/KookForwarder_v1.12.0_Linux_x64.AppImage

# 验证功能
- ✅ 应用正常启动
- ✅ 后端API可访问
- ✅ Redis自动启动
- ✅ 配置向导正常
- ✅ 所有功能正常
```

**步骤6: 发布到GitHub**

```bash
# 创建Tag
git tag v1.12.0
git push origin v1.12.0

# GitHub Actions会自动：
# 1. 运行测试
# 2. 构建三平台安装包
# 3. 创建GitHub Release
# 4. 上传安装包

# 或手动创建Release
gh release create v1.12.0 \
    --title "v1.12.0 - 完善版" \
    --notes-file CHANGELOG.md \
    dist-electron/*.exe \
    dist-electron/*.dmg \
    dist-electron/*.AppImage
```

---

## 代码规范

### Python代码规范

遵循PEP 8规范：

```python
# 导入顺序：标准库 → 第三方库 → 本地模块
import os
import sys

from fastapi import FastAPI
from pydantic import BaseModel

from .config import settings

# 函数命名：小写+下划线
def process_message(message):
    pass

# 类命名：驼峰命名
class MessageProcessor:
    pass

# 常量：大写+下划线
MAX_RETRY_COUNT = 3
```

### JavaScript/Vue代码规范

遵循Vue官方风格指南：

```javascript
// 组件命名：PascalCase
export default {
  name: 'MyComponent'
}

// 变量命名：camelCase
const userName = 'John'

// 常量：UPPER_CASE
const MAX_COUNT = 100

// Vue组合式API推荐写法
<script setup>
import { ref, computed, onMounted } from 'vue'

const count = ref(0)
const doubleCount = computed(() => count.value * 2)

onMounted(() => {
  console.log('组件已挂载')
})
</script>
```

---

## 提交规范

使用Conventional Commits规范：

```bash
# 新功能
git commit -m "feat: 添加企业微信转发支持"

# Bug修复
git commit -m "fix: 修复消息重复发送问题"

# 文档更新
git commit -m "docs: 更新开发指南"

# 代码重构
git commit -m "refactor: 重构消息处理逻辑"

# 性能优化
git commit -m "perf: 优化数据库查询性能"

# 测试相关
git commit -m "test: 添加单元测试"

# 构建相关
git commit -m "build: 更新依赖版本"
```

---

## 常见问题

### Q: 如何添加新的API端点？

1. 在 `backend/app/api/` 创建或编辑路由文件
2. 使用FastAPI装饰器定义路由
3. 在 `backend/app/main.py` 注册路由
4. 在前端 `src/api/index.js` 添加API调用方法

### Q: 如何修改数据库结构？

1. 修改 `backend/app/database.py` 中的 `init_database()` 方法
2. 删除现有数据库文件 `data/config.db`
3. 重启后端服务，会自动创建新表

### Q: 如何添加新的配置项？

1. 在 `backend/app/config.py` 的 `Settings` 类添加字段
2. 在 `.env.example` 添加示例值
3. 更新文档说明

---

## 贡献流程

1. Fork项目
2. 创建特性分支
3. 编写代码和测试
4. 提交代码（遵循提交规范）
5. 推送到Fork仓库
6. 创建Pull Request

---

## 资源链接

- [FastAPI文档](https://fastapi.tiangolo.com/)
- [Vue 3文档](https://vuejs.org/)
- [Element Plus文档](https://element-plus.org/)
- [Playwright文档](https://playwright.dev/)
- [Electron文档](https://www.electronjs.org/)
- [Pinia文档](https://pinia.vuejs.org/)

---

如有问题，欢迎提Issue或联系开发团队！
