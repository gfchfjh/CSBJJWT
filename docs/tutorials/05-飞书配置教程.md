# 📘 飞书应用配置教程

> 10分钟创建自建应用，实现KOOK到飞书的消息转发

---

## 🎯 什么是飞书自建应用？

飞书自建应用是企业内部使用的机器人，可以发送消息、接收事件等。

**特点**：
- ✅ 官方支持，功能强大
- ✅ 支持消息卡片（美观）
- ✅ 可发送图片、文件
- ✅ 企业级稳定性

**限制**：
- ⚠️ 配置相对复杂（需要企业管理员权限）
- ⚠️ 需要飞书企业账号

---

## 🚀 创建飞书自建应用

### 前置条件

- ✅ 您是飞书企业管理员
- ✅ 已创建目标群组
- ✅ 有开发者权限

---

### 步骤1：访问开放平台

1. 访问 [飞书开放平台](https://open.feishu.cn)
2. 登录您的飞书账号
3. 选择企业（如果有多个）

![开放平台](../images/feishu-platform.png)

---

### 步骤2：创建应用

1. 点击「创建企业自建应用」
2. 填写应用信息：
   - **应用名称**：KOOK消息转发Bot
   - **应用描述**：用于转发KOOK消息
   - **应用图标**：上传一个图标（可选）
3. 点击「创建」

![创建应用](../images/feishu-create-app.png)

---

### 步骤3：获取凭证

创建成功后，进入应用详情页：

1. 点击「凭证与基础信息」
2. 复制 **App ID**（例如：`cli_a1b2c3d4e5f6g7h8`）
3. 复制 **App Secret**（例如：`abcdefghijklmnopqrstuvwxyz123456`）

![获取凭证](../images/feishu-credentials.png)

⚠️ **重要**：App Secret是密钥，请妥善保管！

---

### 步骤4：开启机器人能力

1. 点击「添加应用能力」
2. 选择「机器人」
3. 点击「添加」

![开启机器人](../images/feishu-enable-bot.png)

---

### 步骤5：配置权限

1. 点击「权限管理」
2. 搜索并开启以下权限：
   - ✅ 获取与发送单聊、群组消息（`im:message`）
   - ✅ 以应用身份发消息（`im:message:send_as_bot`）
   - ✅ 获取群组信息（`im:chat`）
   - ✅ 获取用户信息（`contact:user.base`）

3. 点击「保存」

![配置权限](../images/feishu-permissions.png)

---

### 步骤6：发布应用

1. 点击「版本管理与发布」
2. 点击「创建版本」
3. 填写版本信息：
   - 版本号：1.0.0
   - 更新说明：初始版本
4. 提交审核
5. 审核通过后，点击「发布」

![发布应用](../images/feishu-publish.png)

⚠️ **注意**：企业自建应用通常无需审核，直接发布即可

---

### 步骤7：添加Bot到群组

1. 打开目标飞书群组
2. 点击群组设置
3. 选择「群机器人」
4. 点击「添加机器人」
5. 搜索您的应用名称
6. 点击「添加」

![添加到群组](../images/feishu-add-to-group.png)

---

### 步骤8：获取群组ID

#### 方法A：使用转发系统自动获取（推荐）✅

1. 在转发系统中填入App ID和App Secret
2. 点击「🔍 获取群组列表」
3. 选择目标群组
4. Chat ID自动填入

#### 方法B：手动获取

1. 在群组中发送消息：`@你的Bot 你好`
2. 使用API查询：
   ```bash
   curl -X POST https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal \
     -H "Content-Type: application/json" \
     -d '{"app_id":"YOUR_APP_ID","app_secret":"YOUR_APP_SECRET"}'
   ```
3. 获取 tenant_access_token
4. 查询群组列表获取Chat ID

---

### 步骤9：在转发系统中配置

1. 打开转发系统
2. 进入「🤖 机器人」页面
3. 点击「➕ 添加配置」
4. 选择平台：飞书
5. 填入：
   - **应用名称**：KOOK消息转发Bot（备注用）
   - **App ID**：cli_xxxxxxxx
   - **App Secret**：xxxxxxxx
   - **Chat ID**：oc_xxxxxxxx
6. 点击「🧪 测试连接」

![转发系统配置](../images/feishu-system-config.png)

✅ **测试成功？恭喜，配置完成！**

---

## 🎨 高级功能

### 消息卡片

飞书支持丰富的消息卡片格式。

**示例**：

![消息卡片](../images/feishu-card.png)

**配置方法**：
1. 编辑飞书Bot配置
2. 启用「使用消息卡片」
3. 自定义卡片模板

**卡片模板示例**：
```json
{
  "header": {
    "title": {
      "content": "来自KOOK的消息",
      "tag": "plain_text"
    }
  },
  "elements": [
    {
      "tag": "div",
      "text": {
        "content": "消息内容",
        "tag": "plain_text"
      }
    }
  ]
}
```

---

### At所有人

可以在消息中@所有人。

**配置方法**：
1. 编辑Bot配置
2. 在消息模板中添加：`<at user_id="all">所有人</at>`

⚠️ **注意**：频繁@所有人可能被群成员投诉

---

### 图片处理

**飞书图片限制**：
- 最大10MB
- 支持格式：jpg, png, gif, bmp

**转发系统自动处理**：
- 自动上传到飞书服务器
- 大图片自动压缩
- 返回image_key插入消息

---

## 🔧 限流说明

飞书API限制：

- 每秒最多20条消息
- 每个应用每天最多100万次调用

**转发系统自动处理**：
- 检测限流自动排队
- 不会超过限制
- 不影响正常使用

---

## ❓ 常见问题

### Q1: 创建应用失败？

**可能原因**：
- 不是企业管理员
- 企业未开通开发者权限

**解决方法**：
1. 联系企业管理员开通权限
2. 或使用管理员账号创建

---

### Q2: 权限配置失败？

**可能原因**：
- 企业限制了某些权限
- 应用状态不正确

**解决方法**：
1. 联系管理员解除限制
2. 确保应用已发布

---

### Q3: Bot无法发送消息？

**检查清单**：
- ✅ Bot已添加到群组？
- ✅ 权限已正确配置？
- ✅ 应用已发布？
- ✅ App Secret正确？

**排查步骤**：
1. 在群组中@Bot，看是否有响应
2. 查看飞书开放平台的「事件订阅」
3. 检查API调用日志

---

### Q4: Chat ID格式是什么？

飞书Chat ID格式：
- 群组：`oc_xxxxxxxxxxxxxxxx`（以oc_开头）
- 私聊：`ou_xxxxxxxxxxxxxxxx`（以ou_开头）

**注意**：必须完整复制，包含前缀！

---

### Q5: 如何修改Bot信息？

1. 进入应用详情页
2. 点击「机器人」→「编辑」
3. 修改名称、头像、描述
4. 保存更改

---

## 🔒 安全提示

### 保护App Secret

⚠️ **App Secret是应用密钥！**

**安全措施**：
- ✅ 仅在安全环境下使用
- ✅ 不要分享给他人
- ✅ 定期重新生成Secret
- ❌ 不要截图包含Secret的页面
- ❌ 不要提交到代码仓库

### 审计日志

飞书开放平台提供审计日志：
- 查看所有API调用
- 监控异常访问
- 及时发现安全问题

**查看方法**：
- 应用详情 → 应用日志 → API调用日志

---

## 🎯 最佳实践

### 1. 应用命名

清晰的命名有助于管理：
- ✅ KOOK消息转发-公告Bot
- ✅ KOOK-活动通知
- ❌ Bot1, Bot2（不推荐）

### 2. 权限最小化

只申请必要的权限：
- ✅ 发送消息
- ✅ 读取群组信息
- ❌ 读取所有消息（不需要）
- ❌ 管理员权限（不需要）

### 3. 监控调用量

定期检查API调用量：
- 避免超过限制
- 优化调用策略

---

## 📚 延伸阅读

- [飞书开放平台文档](https://open.feishu.cn/document)
- [频道映射配置详解](06-频道映射详解.md)
- [过滤规则使用技巧](07-过滤规则使用技巧.md)

---

## ✅ 配置完成检查清单

- [ ] 自建应用已创建
- [ ] App ID和Secret已复制
- [ ] 机器人能力已开启
- [ ] 权限已正确配置
- [ ] 应用已发布
- [ ] Bot已添加到群组
- [ ] Chat ID已获取
- [ ] 在转发系统中配置完成
- [ ] 测试连接成功
- [ ] 在飞书中看到转发的消息

全部完成？🎉 恭喜！您已掌握飞书配置！

---

**文档版本**: v9.0.0  
**最后更新**: 2025-10-26  
**预计阅读时间**: 12分钟
