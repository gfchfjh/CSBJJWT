# 如何配置飞书自建应用

本教程将详细介绍如何在飞书开放平台创建自建应用，用于接收KOOK消息转发。

---

## 📋 目录

1. [什么是飞书自建应用](#什么是飞书自建应用)
2. [创建应用详细步骤](#创建应用详细步骤)
3. [配置机器人权限](#配置机器人权限)
4. [获取群组信息](#获取群组信息)
5. [常见问题](#常见问题)

---

## 什么是飞书自建应用

**飞书自建应用** 是飞书开放平台提供的应用类型，允许开发者创建自定义机器人。

### 特点
- ✅ **功能丰富**：支持消息卡片、交互按钮
- ✅ **企业级**：稳定可靠
- ✅ **免费**：基础功能完全免费
- ✅ **易于管理**：统一的管理后台

### 适用场景
- ✅ 企业内部通知
- ✅ 游戏公告转发
- ✅ 系统监控告警

---

## 创建应用详细步骤

### 步骤1：访问飞书开放平台

1. 打开浏览器，访问 [飞书开放平台](https://open.feishu.cn/)
2. 点击右上角"登录"按钮
3. 使用飞书账号扫码登录

> **提示**：如果没有飞书账号，需要先下载飞书App注册

> **截图说明**：
> - [ ] 截图：飞书开放平台首页
> - [ ] 截图：登录页面
> - [ ] 截图：扫码登录界面

---

### 步骤2：进入开发者后台

1. 登录成功后，点击右上角的 **"开发者后台"**
2. 或直接访问：[https://open.feishu.cn/app](https://open.feishu.cn/app)

> **截图说明**：
> - [ ] 截图：开发者后台入口
> - [ ] 截图：应用管理页面

---

### 步骤3：创建应用

1. 在开发者后台，点击 **"创建应用"** 按钮
2. 选择 **"自建应用"**（不是"企业自建应用"）
3. 填写应用信息：

#### 基本信息
- **应用名称**：`KOOK消息转发Bot`（必填）
- **应用简介**：`用于转发KOOK消息到飞书群组`（必填）
- **应用分类**：选择"效率工具"或"通讯协作"（可选）
- **应用描述**：详细说明应用用途（可选）

#### 应用图标
- 上传应用图标（PNG格式，推荐512x512像素）
- 如果没有，可以先跳过，后续再上传

4. 点击 **"创建"** 按钮

> **截图说明**：
> - [ ] 截图：创建应用按钮
> - [ ] 截图：选择自建应用
> - [ ] 截图：应用信息填写页面
> - [ ] 截图：创建成功提示

---

### 步骤4：获取App ID和App Secret

应用创建成功后，会自动跳转到应用详情页。

1. 在左侧菜单中，点击 **"凭证与基础信息"**
2. 找到以下关键信息：

#### App ID（应用ID）
- 格式：`cli_xxxxxxxxxxxxxxxxx`
- 点击"复制"按钮

#### App Secret（应用密钥）
- 格式：随机字符串
- 点击"复制"按钮

> **安全提示**：
> - ⚠️ App Secret是敏感信息，请勿泄露
> - ⚠️ 泄露后需要重新生成
> - ✅ 妥善保管在密码管理器中

> **截图说明**：
> - [ ] 截图：凭证与基础信息页面
> - [ ] 截图：App ID（部分打码）
> - [ ] 截图：App Secret（完全打码）
> - [ ] 截图：复制按钮位置（用红框标注）

---

## 配置机器人权限

### 步骤5：启用机器人能力

1. 在左侧菜单中，点击 **"应用功能"** → **"机器人"**
2. 点击 **"启用机器人"** 按钮
3. 系统会提示"启用成功"

> **截图说明**：
> - [ ] 截图：应用功能菜单
> - [ ] 截图：机器人页面
> - [ ] 截图：启用机器人按钮

---

### 步骤6：添加权限

1. 在机器人页面，找到 **"权限管理"** 部分
2. 点击 **"添加权限"** 按钮
3. 搜索并添加以下权限：

#### 必需权限（发送消息）
- ✅ **发送消息** (`im:message`)
- ✅ **以应用身份发消息** (`im:message:send_as_bot`)
- ✅ **获取与发送单聊、群组消息** (`im:message.group_at_msg:readonly`)

#### 可选权限（增强功能）
- ☐ 上传图片 (`im:resource`)
- ☐ 获取群组信息 (`im:chat`)
- ☐ 读取用户信息 (`contact:user.base:readonly`)

4. 点击 **"确定"** 保存权限配置

> **重要**：添加权限后需要发布应用才能生效

> **截图说明**：
> - [ ] 截图：权限管理部分
> - [ ] 截图：添加权限按钮
> - [ ] 截图：权限搜索界面
> - [ ] 截图：已添加的权限列表

---

### 步骤7：配置机器人基本信息

1. 在机器人页面，设置以下信息：

#### 机器人头像
- 上传头像图片（PNG格式，推荐256x256像素）

#### 机器人名称
- 填写：`KOOK转发`（显示在消息中）

#### 机器人描述
- 填写：`自动转发KOOK消息到飞书群组`

#### 消息卡片请求网址（可选）
- 如果需要交互功能，填写回调URL
- 基础转发功能不需要

2. 点击 **"保存"** 按钮

> **截图说明**：
> - [ ] 截图：机器人基本信息表单
> - [ ] 截图：头像上传界面

---

### 步骤8：发布应用

1. 在左侧菜单中，点击 **"版本管理与发布"**
2. 点击 **"创建版本"** 按钮
3. 填写版本信息：
   - **版本号**：`1.0.0`
   - **版本说明**：`初始版本，支持消息转发`
4. 点击 **"保存"** 按钮
5. 点击 **"申请发布"** 按钮

#### 发布范围
- 选择 **"仅当前企业内可用"**（推荐）
- 或选择 **"所有人可用"**（需要审核）

6. 等待发布完成（通常几秒钟）

> **提示**：企业内应用无需审核，立即发布

> **截图说明**：
> - [ ] 截图：版本管理页面
> - [ ] 截图：创建版本按钮
> - [ ] 截图：版本信息填写
> - [ ] 截图：申请发布按钮
> - [ ] 截图：发布成功提示

---

## 获取群组信息

### 步骤9：将机器人添加到群组

1. 打开飞书App
2. 进入目标群组
3. 点击群组设置（右上角"..."）
4. 选择 **"群机器人"**
5. 点击 **"添加机器人"**
6. 搜索您创建的机器人名称
7. 点击"添加"

> **权限**：需要群组管理员权限才能添加机器人

> **截图说明**：
> - [ ] 截图：群组设置入口
> - [ ] 截图：群机器人选项
> - [ ] 截图：添加机器人按钮
> - [ ] 截图：机器人搜索界面
> - [ ] 截图：添加成功提示

---

### 步骤10：获取群组ID（可选）

如果需要指定特定群组发送消息：

#### 方法1：使用API
1. 调用飞书API：`https://open.feishu.cn/open-apis/im/v1/chats`
2. 使用App ID和App Secret获取access_token
3. 查询机器人加入的所有群组列表

#### 方法2：通过转发系统自动获取（推荐）
1. 在转发系统中填入App ID和App Secret
2. 系统会自动列出所有可用群组
3. 选择目标群组

> **提示**：基础功能只需App ID和App Secret，无需手动获取群组ID

---

## 测试机器人

### 在转发系统中测试

1. 打开KOOK消息转发系统
2. 进入"机器人配置" → "飞书"
3. 填写应用信息：
   - **应用名称**：`游戏公告飞书Bot`（备注用）
   - **App ID**：`cli_xxxxxxxxxxxxxxxxx`
   - **App Secret**：`your_app_secret_here`
   - **群组Webhook**：留空（可选）
4. 点击 **"🧪 测试连接"** 按钮

**预期结果**：
- ✅ 系统显示：`测试成功！已发送测试消息到目标平台`
- ✅ 飞书群组中收到一条消息卡片

**测试消息示例**：
```
━━━━━━━━━━━━━━━━
🧪 测试消息
━━━━━━━━━━━━━━━━

这是一条测试消息，来自KOOK消息转发系统。
如果您看到这条消息，说明飞书应用配置成功！

⏰ 时间：2025-10-31 12:34:56
🤖 应用：KOOK转发
━━━━━━━━━━━━━━━━
```

> **截图说明**：
> - [ ] 截图：转发系统的配置界面
> - [ ] 截图：测试连接按钮
> - [ ] 截图：测试成功提示
> - [ ] 截图：飞书群组中的测试消息

---

## 常见问题

### ❓ 1. 找不到"创建应用"按钮

**解决方法**：
1. 确保已登录飞书开放平台
2. 确保在"开发者后台"页面，而非首页
3. 检查账号是否有创建应用的权限

---

### ❓ 2. 应用创建失败

**可能原因**：
1. 应用名称已存在
2. 应用名称包含敏感词
3. 网络连接问题

**解决方法**：
- 更换应用名称
- 检查网络连接
- 稍后重试

---

### ❓ 3. App Secret泄露了怎么办？

**解决方法**：
1. 进入应用详情页
2. 点击"凭证与基础信息"
3. 找到App Secret部分
4. 点击"重新生成"按钮
5. 旧Secret立即失效
6. 在转发系统中更新新Secret

> **截图说明**：
> - [ ] 截图：重新生成Secret按钮

---

### ❓ 4. 测试时提示"invalid app_id"

**可能原因**：
1. App ID复制错误
2. App ID包含多余空格
3. 使用了错误的App ID

**解决方法**：
- 重新复制App ID，确保完整
- 检查App ID格式（必须以 `cli_` 开头）
- 确认复制的是正确应用的App ID

---

### ❓ 5. 测试时提示"app access token invalid"

**可能原因**：
1. App Secret错误
2. App Secret已过期
3. 应用未发布

**解决方法**：
- 检查App Secret是否正确
- 确保应用已成功发布
- 重新生成App Secret

---

### ❓ 6. 机器人发送消息失败

**可能原因**：
1. 权限不足
2. 机器人未添加到群组
3. 群组设置了消息审核

**解决方法**：
1. 检查应用权限，确保有"发送消息"权限
2. 确认机器人已添加到目标群组
3. 联系群组管理员检查设置

---

### ❓ 7. 消息卡片显示不正常

**可能原因**：
1. 卡片JSON格式错误
2. 使用了不支持的卡片元素
3. 飞书版本过旧

**解决方法**：
- 使用[飞书卡片搭建工具](https://open.feishu.cn/tool/cardbuilder)测试
- 更新飞书App到最新版本
- 简化卡片格式

---

### ❓ 8. 如何自定义消息卡片？

**方法**：
1. 访问[飞书卡片搭建工具](https://open.feishu.cn/tool/cardbuilder)
2. 使用可视化编辑器设计卡片
3. 导出JSON配置
4. 在转发系统中使用自定义模板

> **转发系统支持**：
> - 提供默认卡片模板
> - 支持自定义模板上传
> - 支持动态变量替换

---

### ❓ 9. 能否同时向多个群组发送？

**答案**：
- ✅ **可以**！一个应用可以加入多个群组
- 需要为每个群组获取Chat ID

**操作方法**：
1. 将机器人添加到多个群组
2. 获取每个群组的Chat ID
3. 在转发系统中配置多个目标

---

### ❓ 10. 消息发送频率限制

**飞书限制**：
- 每个应用：**每秒最多20条消息**
- 向同一群组：**每分钟最多100条消息**
- 超限会返回 `429 Too Many Requests`

**转发系统的处理**：
- ✅ 自动限流
- ✅ 排队机制
- ✅ 智能重试

---

## 🎉 总结

### 创建流程总结

| 步骤 | 操作 | 时间 |
|------|------|------|
| 1-2 | 登录开放平台 | 30秒 |
| 3 | 创建应用 | 1分钟 |
| 4 | 获取凭证 | 10秒 |
| 5-7 | 配置机器人 | 2分钟 |
| 8 | 发布应用 | 1分钟 |
| 9 | 添加到群组 | 30秒 |
| **总计** | **约5分钟** | |

### 关键要点
1. ✅ App ID和App Secret是关键凭证
2. ✅ 必须启用机器人能力
3. ✅ 添加"发送消息"权限
4. ✅ 应用需要发布才能使用
5. ✅ 机器人需添加到群组

### 下一步
- ✅ 在转发系统中添加应用
- ✅ 配置频道映射
- ✅ 启动转发服务

---

## 📞 需要帮助？

如果按照教程操作仍有问题：
1. 查看系统的 **FAQ** 页面
2. 查看 **视频教程**（更直观）
3. 访问 [飞书开放平台文档](https://open.feishu.cn/document/)

---

## 🔗 相关教程

- [Discord Webhook创建教程](./如何创建Discord_Webhook.md)
- [Telegram Bot创建教程](./如何创建Telegram_Bot.md)
- [频道映射配置教程](./频道映射配置详解.md)

---

**最后更新时间**：2025-10-31  
**适用版本**：v18.0.0+  
**飞书开放平台API版本**：v3
