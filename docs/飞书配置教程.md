# 飞书配置教程

本教程将手把手教你如何配置飞书机器人，实现KOOK消息转发到飞书群组。

---

## 📋 前置准备

1. **飞书账号** - 需要有管理权限的飞书账号
2. **飞书群组** - 创建或加入一个飞书群组
3. **10-15分钟** - 完成整个配置流程

---

## 🎯 配置步骤

### 第一步：创建飞书自建应用

1. **访问飞书开放平台**
   - 打开浏览器访问：https://open.feishu.cn/
   - 使用飞书账号登录

2. **创建应用**
   - 点击右上角「创建企业自建应用」
   - 填写应用信息：
     - 应用名称：`KOOK消息转发Bot`（可自定义）
     - 应用描述：`用于转发KOOK平台消息`
     - 上传应用图标（可选）
   - 点击「确定创建」

3. **获取凭证**
   - 创建成功后，进入应用详情页
   - 在「凭证与基础信息」页面找到：
     - **App ID**：例如 `cli_a1b2c3d4e5f6g7h8`
     - **App Secret**：点击「查看」获取，例如 `ABCdefGHIjklMNOpqrs`
   - ⚠️ **请妥善保管这两个信息，不要泄露！**

---

### 第二步：配置机器人权限

1. **开启机器人能力**
   - 在应用详情页，点击左侧菜单「功能」→「机器人」
   - 点击「启用机器人」
   - 填写机器人信息：
     - 机器人名称：`KOOK转发助手`（可自定义）
     - 机器人描述：`转发KOOK平台消息到飞书`
     - 上传机器人头像（可选）

2. **添加权限范围**
   - 点击左侧菜单「权限管理」
   - 搜索并开启以下权限：

   **必需权限**：
   - ✅ `im:message` - 获取与发送单聊、群组消息
   - ✅ `im:message:send_as_bot` - 以应用的身份发消息
   - ✅ `im:chat` - 获取群组信息

   **可选权限**（增强功能）：
   - ✅ `im:file` - 上传文件到飞书云盘
   - ✅ `im:image` - 上传图片到飞书云盘

3. **保存权限配置**
   - 点击页面底部「保存」按钮
   - 系统会提示权限已更新

---

### 第三步：添加机器人到群组

1. **在飞书中创建或打开群组**
   - 打开飞书客户端
   - 创建新群组或打开现有群组

2. **添加机器人**
   - 点击群组右上角「设置」图标
   - 选择「群机器人」→「添加机器人」
   - 搜索你的机器人名称（例如：`KOOK转发助手`）
   - 点击「添加」

3. **测试机器人**
   - 在群组中@机器人，发送一条测试消息
   - 如果机器人能收到消息，说明添加成功

---

### 第四步：获取群组ID

有两种方法获取群组ID（Chat ID）：

#### 方法一：通过飞书开放平台（推荐）

1. **获取临时token**
   - 访问：https://open.feishu.cn/document/ukTMukTMukTM/uADN14CM0UjLwQTN
   - 使用你的 App ID 和 App Secret 获取 tenant_access_token

2. **获取群聊列表**
   ```bash
   # 使用API获取群组列表（需要替换YOUR_TOKEN）
   curl -X GET \
     'https://open.feishu.cn/open-apis/im/v1/chats?page_size=20' \
     -H 'Authorization: Bearer YOUR_TOKEN'
   ```

3. **找到目标群组的 chat_id**
   - 在返回结果中找到你的群组名称
   - 复制对应的 `chat_id`，格式类似：`oc_a1b2c3d4e5f6g7h8`

#### 方法二：在本系统中自动获取（简单）

1. **在系统中配置应用**
   - 先在「机器人配置」页面填入 App ID 和 App Secret
   - 暂时不填 Chat ID

2. **使用自动获取功能**
   - 点击「自动获取Chat ID」按钮
   - 系统会显示所有可用的群组列表
   - 选择目标群组，Chat ID会自动填入

---

### 第五步：在系统中配置

1. **打开KOOK消息转发系统**
   - 进入「机器人配置」页面
   - 选择「飞书」标签

2. **填写配置信息**
   ```
   Bot名称：游戏公告飞书Bot（自定义，仅用于标识）
   App ID：cli_a1b2c3d4e5f6g7h8（第一步获取）
   App Secret：ABCdefGHIjklMNOpqrs（第一步获取）
   Chat ID：oc_a1b2c3d4e5f6g7h8（第四步获取）
   ```

3. **测试连接**
   - 点击「测试连接」按钮
   - 如果配置正确，飞书群组会收到测试消息：
     ```
     ✅ KOOK消息转发系统测试消息
     
     如果您看到这条消息，说明飞书配置成功！
     ```

4. **保存配置**
   - 测试成功后，点击「保存」按钮
   - 飞书机器人配置完成！

---

## 🎨 高级功能

### 消息卡片

飞书支持发送美观的消息卡片，系统会自动将KOOK消息转换为飞书卡片格式：

- **富文本支持**：粗体、斜体、链接等
- **图片展示**：图片直接显示在卡片中
- **发送者信息**：显示KOOK消息的原始发送者

### 文件转发

飞书支持接收各种类型的文件：

- **文档**：PDF、Word、Excel、PPT等
- **图片**：JPG、PNG、GIF等（最大10MB）
- **压缩包**：ZIP、RAR等（最大50MB）
- **视频**：MP4等（最大50MB）

---

## ❓ 常见问题

### Q1: 创建应用时提示"权限不足"？

**A**: 你的飞书账号需要管理员权限才能创建自建应用。解决方法：
- 联系你的飞书管理员开通权限
- 或者使用飞书个人版（免费）创建应用

### Q2: 机器人发送消息失败，提示"权限不足"？

**A**: 请检查以下几点：
1. 是否在「权限管理」中开启了必需的权限？
2. 修改权限后是否点击了「保存」？
3. 机器人是否已添加到目标群组？
4. Chat ID是否填写正确？

### Q3: 如何让机器人在多个群组中工作？

**A**: 有两种方法：
1. **同一个Bot多个群组**：
   - 将机器人添加到多个群组
   - 在系统中为每个群组创建不同的映射关系
   - 每个映射使用不同的 Chat ID

2. **创建多个Bot**：
   - 在飞书开放平台创建多个应用
   - 在系统中添加多个飞书Bot配置
   - 为不同用途创建专门的Bot

### Q4: 群组消息太多，如何减少噪音？

**A**: 可以使用系统的过滤功能：
- 在「过滤规则」中设置关键词白名单/黑名单
- 仅转发特定用户的消息
- 仅转发@全体成员的消息

### Q5: 飞书消息格式不理想？

**A**: 系统会自动将KMarkdown格式转换为飞书格式，但不同平台的渲染效果可能略有差异。如果遇到格式问题：
1. 检查KOOK原始消息是否包含特殊格式
2. 在系统设置中调整消息格式转换选项
3. 联系开发者反馈具体问题

### Q6: 获取不到Chat ID？

**A**: 确保：
1. 机器人已经添加到目标群组
2. App ID 和 App Secret 正确无误
3. 网络连接正常
4. 尝试使用本系统的「自动获取」功能

---

## 🔒 安全建议

1. **保护凭证**
   - App ID 和 App Secret 相当于密码，不要分享给他人
   - 不要在公开场合（如GitHub、论坛）泄露这些信息

2. **权限最小化**
   - 只开启必需的权限
   - 不使用的权限应该关闭

3. **定期检查**
   - 定期检查机器人的活动日志
   - 发现异常立即更新 App Secret

4. **备份配置**
   - 在系统设置中定期备份配置
   - 记录 App ID 和 App Secret（加密保存）

---

## 📚 相关资源

- [飞书开放平台文档](https://open.feishu.cn/document/home/index)
- [飞书机器人开发指南](https://open.feishu.cn/document/ukTMukTMukTM/uQjN3QjL0YzN04CN2cDN)
- [飞书消息卡片搭建工具](https://open.feishu.cn/tool/cardbuilder)
- [KOOK消息转发系统文档](../README.md)

---

## 🎉 配置完成

恭喜！你已经成功配置了飞书机器人。现在可以：

1. **设置频道映射**
   - 进入「频道映射」页面
   - 将KOOK频道映射到飞书群组

2. **启动服务**
   - 确保KOOK账号已登录
   - 点击「启动服务」开始转发消息

3. **监控日志**
   - 在「实时日志」页面查看转发状态
   - 检查消息是否成功发送到飞书

---

**需要帮助？**

- 📧 提交Issue：[GitHub Issues](https://github.com/gfchfjh/CSBJJWT/issues)
- 📖 查看完整文档：[用户手册](用户手册.md)
- 💬 加入讨论：[KOOK服务器](#)

---

**最后更新**: 2025-10-16  
**文档版本**: v1.7.0  
**更新日期**: 2025-10-19
