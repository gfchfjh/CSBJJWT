# KOOK消息转发系统 - 系统架构设计

**当前版本：** v1.14.0  
**最后更新：** 2025-10-23

## 🆕 v1.14.0 架构更新

**新增构建工具链层**：
- ✅ 自动化构建工具（`build/verify_build.py`, `build/create_platform_icons.py`, 等）
- ✅ 完整文档体系（[BUILD_INDEX.md](../BUILD_INDEX.md)）
- ✅ 多平台构建支持（Windows/macOS/Linux完整指南）

**详细说明：** 查看 [LOCAL_BUILD_GUIDE.md](../LOCAL_BUILD_GUIDE.md)

---

## 📐 系统架构图

```
┌───────────────────────────────────────────────────────────────────────┐
│                        前端层 (Electron Desktop App)                   │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │
│  │   Vue 3页面      │  │   Pinia状态管理  │  │   Element Plus   │   │
│  │  - 配置向导      │  │  - 系统状态      │  │  - UI组件        │   │
│  │  - 账号管理      │  │  - 用户配置      │  │  - 表单验证      │   │
│  │  - Bot配置       │  │  - 实时数据      │  │  - 主题切换      │   │
│  │  - 频道映射      │  └──────────────────┘  └──────────────────┘   │
│  │  - 日志监控      │                                                │
│  │  - 系统设置      │  ┌──────────────────┐  ┌──────────────────┐   │
│  └──────────────────┘  │   Axios HTTP     │  │   ECharts图表    │   │
│                        │  - API调用       │  │  - 统计图表      │   │
│                        │  - 拦截器        │  │  - 实时监控      │   │
│                        └──────────────────┘  └──────────────────┘   │
└────────────────────────────┬──────────────────────────────────────────┘
                            │
                            │ HTTP/WebSocket (Port 5173 → 9527)
                            │
┌────────────────────────────┴──────────────────────────────────────────┐
│                    后端层 (FastAPI Application)                        │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │              API路由层 (15个Router模块)                          │ │
│  │  ├─ /api/accounts      - 账号管理                               │ │
│  │  ├─ /api/bots          - Bot配置                                │ │
│  │  ├─ /api/mappings      - 频道映射                               │ │
│  │  ├─ /api/logs          - 日志查询                               │ │
│  │  ├─ /api/system        - 系统控制                               │ │
│  │  ├─ /ws                - WebSocket实时推送                      │ │
│  │  ├─ /api/backup        - 配置备份                               │ │
│  │  ├─ /api/auth          - 认证管理                               │ │
│  │  ├─ /api/health        - 健康检查                               │ │
│  │  ├─ /api/updates       - 更新检查                               │ │
│  │  ├─ /api/selectors     - 选择器配置                             │ │
│  │  ├─ /api/smart-mapping - 智能映射                               │ │
│  │  ├─ /api/password-reset- 密码重置                               │ │
│  │  ├─ /api/audit         - 审计日志                               │ │
│  │  └─ /api/cache         - 缓存管理 (v1.8.0)                      │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                        │
│  ┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐ │
│  │  KOOK抓取模块    │   │  消息处理模块    │   │   转发器模块     │ │
│  │                  │   │                  │   │                  │ │
│  │ ┌──────────────┐ │   │ ┌──────────────┐ │   │ ┌──────────────┐ │ │
│  │ │ Playwright   │ │   │ │ 格式转换器   │ │   │ │ Discord      │ │ │
│  │ │ - Chromium   │ │   │ │ - KMarkdown │ │   │ │ - Webhook池  │ │ │
│  │ │ - WebSocket  │ │   │ │ - Markdown   │ │   │ │ - 限流保护   │ │ │
│  │ │ - Cookie管理 │ │   │ │ - HTML       │ │   │ │ - 错误重试   │ │ │
│  │ └──────────────┘ │   │ └──────────────┘ │   │ └──────────────┘ │ │
│  │                  │   │                  │   │                  │ │
│  │ ┌──────────────┐ │   │ ┌──────────────┐ │   │ ┌──────────────┐ │ │
│  │ │ 登录管理     │ │   │ │ 图片处理器   │ │   │ │ Telegram     │ │ │
│  │ │ - 账号密码   │ │   │ │ - 多进程池   │ │   │ │ - Bot池      │ │ │
│  │ │ - Cookie导入 │ │   │ │ - 智能压缩   │ │   │ │ - HTML格式   │ │ │
│  │ │ - 验证码识别 │ │   │ │ - 防盗链     │ │   │ │ - 文件上传   │ │ │
│  │ └──────────────┘ │   │ └──────────────┘ │   │ └──────────────┘ │ │
│  │                  │   │                  │   │                  │ │
│  │ ┌──────────────┐ │   │ ┌──────────────┐ │   │ ┌──────────────┐ │ │
│  │ │ 多账号管理   │ │   │ │ 消息过滤器   │ │   │ │ 飞书         │ │ │
│  │ │ - 浏览器共享 │ │   │ │ - 关键词     │ │   │ │ - 应用池     │ │ │
│  │ │ - 状态监控   │ │   │ │ - 用户       │ │   │ │ - 消息卡片   │ │ │
│  │ │ - 自动重连   │ │   │ │ - 类型       │ │   │ │ - 云存储     │ │ │
│  │ └──────────────┘ │   │ └──────────────┘ │   │ └──────────────┘ │ │
│  └──────────────────┘   └──────────────────┘   └──────────────────┘ │
│                                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                      消息队列层 (Redis)                          │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │ │
│  │  │ 消息队列     │  │ Worker       │  │ 重试Worker   │          │ │
│  │  │ - 入队/出队  │  │ - 异步处理   │  │ - 失败重试   │          │ │
│  │  │ - 持久化     │  │ - 并发处理   │  │ - 指数退避   │          │ │
│  │  │ - LRU去重    │  │ - 限流控制   │  │ - 最大3次    │          │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │ │
│  │                                                                  │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │ │
│  │  │ 缓存管理器   │  │ Pipeline批量 │  │ Pub/Sub推送  │          │ │
│  │  │ - LRU缓存    │  │ - 减少往返   │  │ - 实时通知   │          │ │
│  │  │ - TTL过期    │  │ - 批量操作   │  │ - 订阅模式   │          │ │
│  │  │ - 热点数据   │  │ - 事务支持   │  │ - WebSocket  │          │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                    数据持久层 (SQLite)                           │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │ │
│  │  │ accounts     │  │ bot_configs  │  │ channel_     │          │ │
│  │  │ 账号表       │  │ Bot配置表    │  │ mappings     │          │ │
│  │  │ - email      │  │ - platform   │  │ 频道映射表   │          │ │
│  │  │ - cookie     │  │ - config     │  │ - 源频道     │          │ │
│  │  │ - status     │  │ - status     │  │ - 目标频道   │          │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │ │
│  │                                                                  │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │ │
│  │  │ message_logs │  │ failed_      │  │ filter_rules │          │ │
│  │  │ 消息日志表   │  │ messages     │  │ 过滤规则表   │          │ │
│  │  │ - 转发记录   │  │ 失败队列     │  │ - 关键词     │          │ │
│  │  │ - 状态       │  │ - 重试次数   │  │ - 用户       │          │ │
│  │  │ - 延迟       │  │ - 最后重试   │  │ - 消息类型   │          │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │ │
│  │                                                                  │ │
│  │  ┌──────────────┐  ┌──────────────┐                            │ │
│  │  │ system_config│  │ audit_logs   │                            │ │
│  │  │ 系统配置表   │  │ 审计日志表   │                            │ │
│  │  │ - 键值对     │  │ - 操作记录   │                            │ │
│  │  │ - 主密码哈希 │  │ - 用户追踪   │                            │ │
│  │  └──────────────┘  └──────────────┘                            │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                    工具模块层 (23个工具类)                       │ │
│  │  ├─ logger.py          - 日志管理 (Loguru)                      │ │
│  │  ├─ crypto.py          - 加密工具 (AES-256)                     │ │
│  │  ├─ auth.py            - 认证管理 (JWT Token)                   │ │
│  │  ├─ rate_limiter.py    - 限流器 (令牌桶算法)                    │ │
│  │  ├─ captcha_solver.py  - 验证码识别 (2Captcha/ddddocr)         │ │
│  │  ├─ email_sender.py    - 邮件发送 (SMTP)                        │ │
│  │  ├─ health.py          - 健康检查                               │ │
│  │  ├─ scheduler.py       - 定时任务 (APScheduler)                │ │
│  │  ├─ update_checker.py  - 更新检查 (GitHub API)                 │ │
│  │  ├─ selector_manager.py- 选择器管理 (YAML配置)                 │ │
│  │  ├─ audit_logger.py    - 审计日志                               │ │
│  │  ├─ password_manager.py- 密码管理 (SHA-256)                    │ │
│  │  ├─ error_handler.py   - 错误处理 (统一异常)                    │ │
│  │  ├─ error_codes.py     - 错误码映射                             │ │
│  │  ├─ error_solutions.py - 错误解决方案                           │ │
│  │  ├─ redis_manager.py   - Redis管理 (v1.4.0)                    │ │
│  │  ├─ redis_manager_enhanced.py - 增强Redis管理 (v1.8.1)         │ │
│  │  ├─ cache.py           - 缓存管理器 (v1.8.0, 450行)            │ │
│  │  └─ platform_api_client.py - 平台API客户端                      │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                    图床服务器 (Port 9528)                        │ │
│  │  - 本地HTTP文件服务                                              │ │
│  │  - Token访问控制                                                 │ │
│  │  - 自动清理过期图片                                              │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 外部服务交互
                                    ▼
┌────────────────────────────────────────────────────────────────────────┐
│                            外部服务层                                   │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │
│  │ KOOK平台         │  │ Discord平台      │  │ Telegram平台     │   │
│  │ - WebSocket消息  │  │ - Webhook API    │  │ - Bot API        │   │
│  │ - 防盗链资源     │  │ - Embed卡片      │  │ - HTML消息       │   │
│  │ - 服务器/频道    │  │ - 文件上传       │  │ - 文件上传       │   │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘   │
│                                                                        │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │
│  │ 飞书开放平台     │  │ 2Captcha平台     │  │ GitHub API       │   │
│  │ - 消息卡片       │  │ - 验证码识别     │  │ - 版本检查       │   │
│  │ - 云存储         │  │ - 余额查询       │  │ - Release信息    │   │
│  │ - 应用API        │  │ - 自动识别       │  │ - 自动更新       │   │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘   │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 消息转发流程图

```
┌─────────────┐
│ KOOK用户    │
│ 发送消息    │
└──────┬──────┘
       │
       ▼
┌──────────────────────────────────────────────────┐
│ 1. KOOK平台处理                                  │
│    - 消息广播到WebSocket                         │
│    - 发送到所有连接的客户端                      │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│ 2. Playwright捕获 (backend/app/kook/scraper.py) │
│    - 监听WebSocket帧                             │
│    - 解析JSON消息                                │
│    - 提取消息元数据                              │
│      ├─ message_id: 消息ID                       │
│      ├─ content: 消息内容 (KMarkdown)           │
│      ├─ message_type: 类型 (text/image/file)    │
│      ├─ sender: 发送者信息                       │
│      ├─ attachments: 附件列表                    │
│      ├─ image_urls: 图片URL列表                  │
│      ├─ mentions: @提及列表                      │
│      ├─ quote: 引用消息                          │
│      └─ cookies: Cookie字典 (用于下载资源)      │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│ 3. 消息入队 (backend/app/queue/redis_client.py) │
│    - JSON序列化消息                              │
│    - 推送到Redis队列 (LPUSH)                    │
│    - 异步非阻塞处理                              │
│    - 避免阻塞WebSocket监听                       │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│ 4. Worker消费消息 (backend/app/queue/worker.py) │
│    - BLPOP阻塞出队 (超时5秒)                    │
│    - 反序列化JSON                                │
│    - 调用process_message()处理                   │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│ 5. 消息去重检查                                  │
│    - 检查message_id是否在LRU缓存中               │
│    - 缓存大小: 10,000条                          │
│    - 命中 → 丢弃消息 (已处理过)                  │
│    - 未命中 → 继续处理                           │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│ 6. 应用过滤规则 (backend/app/processors/filter)│
│    A. 关键词过滤                                 │
│       - 黑名单: 包含则丢弃                       │
│       - 白名单: 不包含则丢弃                     │
│    B. 用户过滤                                   │
│       - 黑名单用户: 直接丢弃                     │
│       - 白名单用户: 仅允许这些用户               │
│    C. 消息类型过滤                               │
│       - 检查是否允许该类型                       │
│    → 不通过 → 记录日志 → 结束                   │
│    → 通过 → 继续处理                             │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│ 7. 格式转换 (backend/app/processors/formatter)  │
│    根据目标平台转换格式:                         │
│    A. Discord: KMarkdown → Markdown              │
│       - **粗体** → **粗体**                      │
│       - *斜体* → *斜体*                          │
│       - `代码` → `代码`                          │
│       - (emj)表情(emj) → 😊 (emoji)              │
│    B. Telegram: KMarkdown → HTML                 │
│       - **粗体** → <b>粗体</b>                   │
│       - *斜体* → <i>斜体</i>                     │
│       - `代码` → <code>代码</code>               │
│    C. 飞书: KMarkdown → 富文本                   │
│       - 保持Markdown格式                         │
│    D. 智能分段 (超长消息)                        │
│       - Discord: 2000字符/条                     │
│       - Telegram: 4096字符/条                    │
│       - 优先级: 段落 → 句子 → 子句 → 单词       │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│ 8. 图片/附件处理 (backend/app/processors/image) │
│    A. 下载图片 (如果有image_urls)                │
│       - 带Cookie请求 (防盗链)                    │
│       - 使用多进程池并发下载 (v1.8.1)           │
│       - ProcessPoolExecutor (8核并行)           │
│    B. 智能压缩                                   │
│       - 4级压缩策略:                             │
│         Level 1: < 1MB → 不压缩                  │

│    C. 上传到目标平台                             │
│       策略1 (智能模式, 默认):                    │
│         ├─ 尝试直接上传到Discord/Telegram/飞书  │
│         ├─ 成功 → 使用平台URL                    │
│         └─ 失败 → 回退到图床                     │
│       策略2 (仅直传):                            │
│         └─ 直接上传到目标平台                    │
│       策略3 (仅图床):                            │
│         ├─ 上传到本地图床 (Port 9528)           │
│         └─ 生成带Token的URL                      │
│    D. 下载附件 (如果有file_attachments)          │
│       - 最大50MB                                 │
│       - 带Cookie下载                             │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│ 9. 查询频道映射 (database.py)                    │
│    - 根据kook_channel_id查询                     │
│    - 获取所有enabled=1的映射                     │
│    - 一个源频道可映射到多个目标                  │
│    - 每个映射包含:                               │
│      ├─ target_platform: 目标平台                │
│      ├─ target_bot_id: 使用的Bot                 │
│      └─ target_channel_id: 目标频道              │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│ 10. 遍历所有映射目标                             │
│     对每个映射执行:                              │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│ 11. 应用限流控制 (utils/rate_limiter.py)        │
│     使用令牌桶算法:                              │
│     - Discord: 5条/5秒                           │
│     - Telegram: 30条/秒                          │
│     - 飞书: 20条/秒                              │
│     超限时:                                      │
│     - 自动等待 (await limiter.acquire())         │
│     - 消息排队不丢失                             │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│ 12. 调用转发器发送                               │
│     A. Discord (forwarders/discord.py)           │
│        - 使用Webhook池 (3-10个, v1.8.0)         │
│        - 轮询负载均衡                            │
│        - 伪装发送者 (username + avatar)          │
│        - 支持Embed卡片                           │
│        - 分段发送 (如需要)                       │
│     B. Telegram (forwarders/telegram.py)         │
│        - 使用Bot池 (2-5个, v1.8.0)              │
│        - HTML格式消息                            │
│        - 文件直接上传                            │
│        - 显示原始发送者信息                      │
│     C. 飞书 (forwarders/feishu.py)               │
│        - 使用应用池 (2-5个, v1.8.0)             │
│        - 消息卡片格式                            │
│        - 图片上传到飞书云存储                    │
│        - 支持富文本                              │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│ 13. 记录转发结果                                 │
│     A. 成功                                      │
│        - 写入message_logs表                      │
│          ├─ status: 'success'                    │
│          ├─ latency_ms: 响应时间                 │
│          └─ created_at: 时间戳                   │
│        - 更新统计信息                            │
│     B. 失败                                      │
│        - 写入message_logs表                      │
│          ├─ status: 'failed'                     │
│          ├─ error_message: 错误信息              │
│          └─ created_at: 时间戳                   │
│        - 写入failed_messages表                   │
│          ├─ message_log_id: 关联日志ID           │
│          ├─ retry_count: 0                       │
│          └─ last_retry: NULL                     │
│        - 等待重试Worker处理                      │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│ 14. WebSocket实时推送 (api/websocket.py)        │
│     - 构建推送消息:                              │
│       {                                          │
│         "type": "log",                           │
│         "data": {                                │
│           "message_id": "...",                   │
│           "status": "success/failed",            │
│           "content": "消息内容",                 │
│           "latency_ms": 1200,                    │
│           "platform": "discord",                 │
│           "timestamp": "..."                     │
│         }                                        │
│       }                                          │
│     - 推送到所有连接的前端客户端                 │
│     - 前端实时更新日志列表                       │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│ 15. 前端显示 (frontend/src/views/Logs.vue)      │
│     - 接收WebSocket消息                          │
│     - 更新日志列表                               │
│     - 显示状态图标:                              │
│       ✅ 成功: 绿色                              │
│       ❌ 失败: 红色                              │
│       ⏳ 处理中: 黄色                            │
│     - 显示详细信息:                              │
│       - 消息内容                                 │
│       - 发送者                                   │
│       - 目标平台                                 │
│       - 响应时间                                 │
│       - 错误信息 (如失败)                        │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
               ┌───────────────┐
               │  转发完成      │
               └───────────────┘

┌─────────────────────────────────────────────────┐
│ 失败重试流程 (queue/retry_worker.py)            │
│ 1. 定期扫描failed_messages表 (每60秒)           │
│ 2. 筛选retry_count < 3的记录                    │
│ 3. 计算下次重试时间 (指数退避):                 │
│    - 第1次: 立即                                │
│    - 第2次: 30秒后                              │
│    - 第3次: 90秒后                              │
│ 4. 重新入队到Redis                              │
│ 5. 更新retry_count和last_retry                 │
│ 6. 如果3次全部失败:                             │
│    - 标记为permanently_failed                   │
│    - 发送告警邮件 (如配置)                      │
│    - 记录审计日志                               │
└─────────────────────────────────────────────────┘
```

---

## 🔧 核心模块设计

### 1. KOOK抓取模块

**文件**: `backend/app/kook/scraper.py` (1,318行)

**职责**:
- 使用Playwright控制Chromium浏览器
- 登录KOOK网页版 (Cookie或账号密码)
- 监听WebSocket消息
- 解析消息内容和元数据
- 管理多个账号 (浏览器共享上下文, v1.8.1)
- 断线自动重连

**关键类**:
```python
class KookScraper:
    def __init__(self, account_id: int)
    async def start(cookie, email, password, sync_history_minutes)
    async def stop()
    async def get_servers() -> List[Server]
    async def get_channels(server_id) -> List[Channel]
    async def sync_history_messages(minutes) -> int
```

---

### 2. 消息处理模块

#### 2.1 格式转换器
**文件**: `backend/app/processors/formatter.py` (650行)

**职责**:
- KMarkdown转Markdown
- KMarkdown转Telegram HTML
- KMarkdown转飞书富文本
- 智能消息分段 (5级策略)
- @提及格式化
- 引用消息格式化
- 表情转换 (100+表情映射)

**关键方法**:
```python
class MessageFormatter:
    @staticmethod
    def kmarkdown_to_discord(text: str) -> str
    @staticmethod
    def kmarkdown_to_telegram_html(text: str) -> str
    @staticmethod
    def split_long_message(text: str, max_length: int) -> List[str]
```

#### 2.2 图片处理器
**文件**: `backend/app/processors/image.py`

**职责**:
- 下载KOOK图片 (防盗链)
- 4级智能压缩
- PNG转JPEG
- 多进程处理池 (v1.8.1)
- 上传到目标平台或图床

**关键方法**:
```python
class ImageProcessor:
    async def download_image(url: str, cookies: dict) -> bytes
    def compress_image(image_data: bytes) -> bytes
    async def upload_to_discord(image_data: bytes, webhook_url: str) -> str
    async def process_images_batch(urls: List[str]) -> List[bytes]  # v1.8.1
```

---

### 3. 转发器模块

#### 3.1 转发器池化 (v1.8.0)
**文件**: `backend/app/forwarders/pools.py` (550行)

**职责**:
- Webhook/Bot池管理
- 负载均衡 (轮询)
- 健康检查
- 自动移除失效实例

**性能提升**:

---

### 4. 消息队列模块

#### 4.1 Redis队列
**文件**: `backend/app/queue/redis_client.py`

**职责**:
- 异步消息入队/出队
- 持久化存储
- 阻塞/非阻塞模式

#### 4.2 Worker
**文件**: `backend/app/queue/worker.py` (622行)

**职责**:
- 消费Redis队列
- 消息去重 (LRU缓存10,000条)
- 完整处理流程协调
- 错误处理和重试

---

### 5. 数据库模块

**文件**: `backend/app/database.py` (364行)

**表设计**:
- `accounts`: 账号表 (2个索引)
- `bot_configs`: Bot配置表
- `channel_mappings`: 频道映射表 (3个索引, v1.7.2+3个复合索引)
- `filter_rules`: 过滤规则表
- `message_logs`: 消息日志表 (6个索引, v1.7.2+2个复合索引)
- `failed_messages`: 失败消息队列
- `system_config`: 系统配置表
- `audit_logs`: 审计日志表

**性能优化** (v1.7.2):
- 11个索引（原8个 + 3个复合索引）

---

## 🚀 性能优化 (v1.8.0/v1.8.1)

### 1. 转发器池化
- **原理**: 多个Webhook/Bot轮询使用
- **实现**: DiscordWebhookPool, TelegramBotPool, FeishuAppPool

### 2. Redis缓存层
- **原理**: LRU缓存热点数据查询
- **实现**: CacheManager with Redis
- **效果**: API响应速度显著提升

### 3. 多进程图片处理
- **原理**: ProcessPoolExecutor多核并行
- **实现**: process_images_batch()

### 4. 浏览器共享上下文
- **原理**: 多账号共享Browser实例
- **实现**: ScraperManager with shared_browser

---

## 📊 监控和可观测性

### 健康检查
- `/health`: 基础健康检查
- `/api/health/check`: 详细组件状态
  - Redis连接
  - 数据库连接
  - Worker状态
  - 抓取器状态

### 实时监控
- WebSocket实时日志推送
- ECharts统计图表
- 队列大小监控
- 转发成功率监控

### 日志系统
- Loguru日志库
- 分级日志 (DEBUG/INFO/WARNING/ERROR)
- 日志脱敏 (v1.7.2, 8种规则)
- 日志轮转 (保留3天)

---

## 🔐 安全设计

### 认证授权
- 主密码保护 (SHA-256)
- API Token认证
- 30天记住密码

### 数据加密
- AES-256加密敏感信息
- Cookie加密存储
- 密码哈希存储

### 审计日志
- 所有关键操作记录
- 用户行为追踪
- 时间戳和IP记录

---

## 📈 扩展性设计

### 插件机制 (预留)
- 插件接口定义
- 热插拔支持
- 配置隔离

### 平台扩展 (预留)
- Matrix
- Slack
- 企业微信
- 钉钉

### 水平扩展
- Redis集群支持
- 多Worker实例
- 负载均衡

---

**文档版本**: v1.2  
**最后更新**: 2025-10-20  
**对应代码版本**: v1.11.0  
