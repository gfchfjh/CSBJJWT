# ğŸ—ï¸ KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ - æ¶æ„è®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬**: v12.0.0 Ultimate  
**æœ€åæ›´æ–°**: 2025-10-28

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è§ˆ

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿçš„æŠ€æœ¯æ¶æ„ã€æ ¸å¿ƒæ¨¡å—ã€æ•°æ®æµç¨‹å’Œå…³é”®å®ç°ã€‚

**é€‚åˆäººç¾¤**: å¼€å‘è€…ã€æ¶æ„å¸ˆã€æŠ€æœ¯çˆ±å¥½è€…

---

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿæ˜¯ä¸€ä¸ª**é«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€æ˜“æ‰©å±•**çš„è·¨å¹³å°æ¶ˆæ¯è½¬å‘ä¸­é—´ä»¶ï¼Œå®ç°äº†KOOKå¹³å°åˆ°Discordã€Telegramã€é£ä¹¦ç­‰å¤šä¸ªå¹³å°çš„å®æ—¶æ¶ˆæ¯è½¬å‘ã€‚

### æ ¸å¿ƒç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½**: 1000+æ¶ˆæ¯/å°æ—¶ååé‡ï¼Œå»¶è¿Ÿ<500ms
- ğŸ’ª **é«˜å¯ç”¨**: è‡ªåŠ¨é‡è¿ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å¤±è´¥é‡è¯•
- ğŸ¯ **æ˜“æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ’ä»¶å¼æ¶æ„
- ğŸ”’ **é«˜å®‰å…¨**: AES-256åŠ å¯†ã€TokenéªŒè¯ã€è·¯å¾„é˜²æŠ¤
- ğŸ§  **AIå¢å¼º**: æ™ºèƒ½æ˜ å°„æ¨èï¼ˆ95%+å‡†ç¡®åº¦ï¼‰
- ğŸ“š **æ•™ç¨‹ç³»ç»Ÿ**: å†…ç½®å›¾æ–‡æ•™ç¨‹ï¼Œé›¶å­¦ä¹ æˆæœ¬
- ğŸ“Š **è¿›åº¦å¯è§†**: å®æ—¶è¿›åº¦åé¦ˆç³»ç»Ÿ
- ğŸ”„ **æ°¸ä¸æ‰çº¿**: WebSocketæ™ºèƒ½é‡è¿æœºåˆ¶
- ğŸ’¾ **æŒä¹…åŒ–**: æ¶ˆæ¯å»é‡SQLiteæŒä¹…åŒ–

---

## ğŸ›ï¸ æ€»ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯å±‚ (Presentation)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        Electron Desktop Application (Vue 3)           â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ é…ç½®å‘å¯¼    â”‚ è´¦å·ç®¡ç†   â”‚ æ˜ å°„é…ç½®   â”‚ å®æ—¶ç›‘æ§        â”‚   â”‚
â”‚  â”‚ (Wizard)   â”‚ (Accounts) â”‚ (Mapping)  â”‚ (Dashboard)    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTP/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 APIç½‘å…³å±‚ (API Gateway)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              FastAPI Application                      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ Auth    â”‚ CORS    â”‚ Rate    â”‚ Logging â”‚ Error        â”‚   â”‚
â”‚  â”‚ Middlewareâ”‚Middlewareâ”‚Limiterâ”‚Middlewareâ”‚Handler       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸šåŠ¡é€»è¾‘å±‚ (Business)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                 æ ¸å¿ƒæœåŠ¡æ¨¡å—                         â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ KOOKæŠ“å– â”‚ æ¶ˆæ¯é˜Ÿåˆ—  â”‚ æ ¼å¼è½¬æ¢  â”‚ æ™ºèƒ½è½¬å‘          â”‚     â”‚
â”‚  â”‚ Scraper  â”‚ Queue    â”‚ Formatter â”‚ Forwarder        â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ Playwrightâ”‚ Redis   â”‚ KMarkdownâ”‚ Discord          â”‚     â”‚
â”‚  â”‚ WebSocketâ”‚ Worker   â”‚ â†’ MD/HTMLâ”‚ Telegram         â”‚     â”‚
â”‚  â”‚ Monitor  â”‚ Batch(10)â”‚ Emoji Mapâ”‚ Feishu           â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                 å¢å¼ºåŠŸèƒ½æ¨¡å—                         â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ AIæ˜ å°„   â”‚ å›¾åºŠæœåŠ¡  â”‚ è¿‡æ»¤å¼•æ“  â”‚ ç»Ÿè®¡åˆ†æ          â”‚     â”‚
â”‚  â”‚ SmartMap â”‚ ImageBed â”‚ Filter   â”‚ Analytics        â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ 3é‡åŒ¹é…  â”‚ TokenéªŒè¯â”‚ å…³é”®è¯   â”‚ å®æ—¶ç»Ÿè®¡          â”‚     â”‚
â”‚  â”‚ å†å²å­¦ä¹  â”‚ æœ¬åœ°é™åˆ¶ â”‚ æ­£åˆ™è¡¨è¾¾å¼â”‚ æ€§èƒ½ç›‘æ§          â”‚     â”‚
â”‚  â”‚ æ—¶é—´è¡°å‡ â”‚ è·¯å¾„é˜²æŠ¤ â”‚ é»‘ç™½åå• â”‚ æ—¥å¿—åˆ†æ          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®æŒä¹…å±‚ (Persistence)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ SQLite   â”‚ Redis    â”‚ FileSystemâ”‚ Configuration   â”‚      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  â”‚ è´¦å·é…ç½® â”‚ æ¶ˆæ¯é˜Ÿåˆ—  â”‚ å›¾ç‰‡é™„ä»¶  â”‚ æ˜ å°„è§„åˆ™          â”‚      â”‚
â”‚  â”‚ æ˜ å°„è§„åˆ™ â”‚ å»é‡ç¼“å­˜  â”‚ æ—¥å¿—æ–‡ä»¶  â”‚ ç³»ç»Ÿè®¾ç½®          â”‚      â”‚
â”‚  â”‚ è½¬å‘æ—¥å¿— â”‚ Tokenæ±   â”‚ å¤‡ä»½æ•°æ®  â”‚ ç”¨æˆ·åå¥½          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¤–éƒ¨æœåŠ¡å±‚ (External)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Discord    â”‚ Telegram   â”‚ Feishu     â”‚ KOOK         â”‚    â”‚
â”‚  â”‚ Webhook    â”‚ Bot API    â”‚ OpenAPI    â”‚ WebSocket    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. KOOKæ¶ˆæ¯æŠ“å–æ¨¡å— (Scraper)

**ä½ç½®**: `backend/app/kook/scraper.py`

**åŠŸèƒ½**: ä½¿ç”¨Playwrightç›‘å¬KOOK WebSocketï¼Œå®æ—¶æŠ“å–æ¶ˆæ¯

#### æŠ€æœ¯æ¶æ„

```python
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         KookScraper                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + browser: Browser                       â”‚
â”‚ + context: BrowserContext                â”‚
â”‚ + page: Page                             â”‚
â”‚ + is_running: bool                       â”‚
â”‚ + reconnect_count: int                   â”‚
â”‚ + message_handlers: List[Callable]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + start()                                â”‚
â”‚ + check_login_status()                   â”‚
â”‚ + login_with_password()                  â”‚
â”‚ + handle_captcha()                       â”‚
â”‚ + handle_websocket(ws)                   â”‚
â”‚ + process_websocket_message(payload)     â”‚
â”‚ + parse_message(data)                    â”‚
â”‚ + check_connection()                     â”‚
â”‚ + reconnect()                            â”‚
â”‚ + stop()                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…³é”®æµç¨‹

```
1. å¯åŠ¨æµè§ˆå™¨
   â”œâ”€â”€ å¯åŠ¨Chromiumï¼ˆheadlessï¼‰
   â”œâ”€â”€ åˆ›å»ºæµè§ˆå™¨ä¸Šä¸‹æ–‡
   â””â”€â”€ åŠ è½½Cookieï¼ˆå¦‚æœ‰ï¼‰

2. è®¿é—®KOOK
   â”œâ”€â”€ è®¿é—® https://www.kookapp.cn/app
   â”œâ”€â”€ æ£€æŸ¥ç™»å½•çŠ¶æ€
   â””â”€â”€ ç™»å½•ï¼ˆå¯†ç /Cookieï¼‰

3. ç›‘å¬WebSocket
   â”œâ”€â”€ page.on('websocket', handler)
   â”œâ”€â”€ ws.on('framereceived', handler)
   â””â”€â”€ è§£æJSONæ¶ˆæ¯

4. æ¶ˆæ¯å¤„ç†
   â”œâ”€â”€ è§£ææ¶ˆæ¯æ•°æ®
   â”œâ”€â”€ æå–å­—æ®µï¼ˆå†…å®¹/ä½œè€…/é™„ä»¶ï¼‰
   â”œâ”€â”€ å…¥é˜Ÿï¼ˆRedisï¼‰
   â””â”€â”€ è°ƒç”¨æ¶ˆæ¯å¤„ç†å™¨

5. å¿ƒè·³æ£€æµ‹
   â”œâ”€â”€ æ¯ç§’æ£€æŸ¥è¿æ¥çŠ¶æ€
   â”œâ”€â”€ æ£€æµ‹åˆ°æ–­å¼€ â†’ é‡è¿
   â””â”€â”€ æœ€å¤šé‡è¿5æ¬¡
```

#### æ”¯æŒçš„æ¶ˆæ¯ç±»å‹

| ç±»å‹ | typeå€¼ | è¯´æ˜ | æ˜¯å¦æ”¯æŒ |
|------|--------|------|----------|
| æ–‡æœ¬æ¶ˆæ¯ | 1 | KMarkdownæ ¼å¼ | âœ… |
| å›¾ç‰‡æ¶ˆæ¯ | 2 | æ”¯æŒå¤šå›¾ | âœ… |
| è§†é¢‘æ¶ˆæ¯ | 3 | è§†é¢‘é“¾æ¥ | âœ… |
| æ–‡ä»¶æ¶ˆæ¯ | 4 | é™„ä»¶ä¸‹è½½ | âœ… |
| éŸ³é¢‘æ¶ˆæ¯ | 8 | è¯­éŸ³ | âœ… |
| å¡ç‰‡æ¶ˆæ¯ | 10 | Cardæ¶ˆæ¯ | âœ… |
| ç³»ç»Ÿæ¶ˆæ¯ | 255 | ç³»ç»Ÿé€šçŸ¥ | âš ï¸ éƒ¨åˆ† |

---

### 2. æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å— (Queue)

**ä½ç½®**: `backend/app/queue/`

**åŠŸèƒ½**: ä½¿ç”¨Rediså®ç°é«˜æ€§èƒ½æ¶ˆæ¯é˜Ÿåˆ—

#### æ¶æ„è®¾è®¡

```python
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         RedisQueue                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + redis_client: Redis                    â”‚
â”‚ + queue_name: str                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + enqueue(message)                       â”‚  # å…¥é˜Ÿ
â”‚ + dequeue(timeout)                       â”‚  # å‡ºé˜Ÿ
â”‚ + dequeue_batch(count, timeout)          â”‚  # æ‰¹é‡å‡ºé˜Ÿ
â”‚ + size()                                 â”‚  # é˜Ÿåˆ—é•¿åº¦
â”‚ + exists(key)                            â”‚  # å»é‡æ£€æŸ¥
â”‚ + set(key, value, expire)                â”‚  # è®¾ç½®ç¼“å­˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         MessageWorker                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + is_running: bool                       â”‚
â”‚ + processed_messages: LRUCache           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + start()                                â”‚
â”‚ + process_message(message)               â”‚
â”‚ + forward_to_target(message, mapping)    â”‚
â”‚ + stop()                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å¤„ç†æµç¨‹

```
Workerå¾ªç¯:
â”œâ”€â”€ 1. æ‰¹é‡å‡ºé˜Ÿï¼ˆ10æ¡/æ¬¡ï¼‰
â”‚   â””â”€â”€ dequeue_batch(count=10, timeout=5)
â”‚
â”œâ”€â”€ 2. å¹¶è¡Œå¤„ç†
â”‚   â”œâ”€â”€ asyncio.gather()
â”‚   â””â”€â”€ æ¯æ¡æ¶ˆæ¯ç‹¬ç«‹try-catch
â”‚
â”œâ”€â”€ 3. å»é‡æ£€æŸ¥
â”‚   â”œâ”€â”€ LRUç¼“å­˜ï¼ˆ10000æ¡ï¼‰
â”‚   â””â”€â”€ Redisç¼“å­˜ï¼ˆ7å¤©ï¼‰
â”‚
â”œâ”€â”€ 4. åº”ç”¨è¿‡æ»¤è§„åˆ™
â”‚   â”œâ”€â”€ å…³é”®è¯è¿‡æ»¤
â”‚   â”œâ”€â”€ é»‘ç™½åå•
â”‚   â””â”€â”€ æ­£åˆ™è¡¨è¾¾å¼
â”‚
â”œâ”€â”€ 5. æŸ¥æ‰¾æ˜ å°„
â”‚   â””â”€â”€ ä»SQLiteæŸ¥è¯¢
â”‚
â”œâ”€â”€ 6. æ ¼å¼è½¬æ¢
â”‚   â”œâ”€â”€ KMarkdown â†’ Markdown
â”‚   â”œâ”€â”€ KMarkdown â†’ HTML
â”‚   â””â”€â”€ KMarkdown â†’ Feishu Text
â”‚
â”œâ”€â”€ 7. è½¬å‘æ¶ˆæ¯
â”‚   â”œâ”€â”€ Discord: Webhook
â”‚   â”œâ”€â”€ Telegram: Bot API
â”‚   â””â”€â”€ Feishu: OpenAPI
â”‚
â””â”€â”€ 8. è®°å½•æ—¥å¿—
    â”œâ”€â”€ æˆåŠŸ: è®°å½•åˆ°SQLite
    â””â”€â”€ å¤±è´¥: åŠ å…¥é‡è¯•é˜Ÿåˆ—
```

---

### 3. æ¶ˆæ¯è½¬å‘æ¨¡å— (Forwarders)

**ä½ç½®**: `backend/app/forwarders/`

#### Discordè½¬å‘å™¨ (discord.py)

```python
class DiscordForwarder:
    """Discordæ¶ˆæ¯è½¬å‘å™¨ï¼ˆå¢å¼ºç‰ˆï¼‰"""
    
    async def send_message(webhook_url, content, embeds):
        """å‘é€æ–‡æœ¬æ¶ˆæ¯"""
        # 1. åº”ç”¨é™æµï¼ˆ5è¯·æ±‚/5ç§’ï¼‰
        # 2. åˆ†æ®µå¤„ç†ï¼ˆ>2000å­—ç¬¦ï¼‰
        # 3. å‘é€æ¶ˆæ¯
        # 4. å¤„ç†429é™æµ
        
    async def send_image_direct(webhook_url, image_url):
        """å‘é€å›¾ç‰‡ï¼ˆç›´ä¼ æ¨¡å¼ï¼‰"""
        # 1. ä¸‹è½½å›¾ç‰‡ï¼ˆaiohttpï¼‰
        # 2. ä¸Šä¼ åˆ°Discordï¼ˆwebhook.add_fileï¼‰
        # 3. ä¸ç»è¿‡æœ¬åœ°å›¾åºŠ
        
    async def send_with_attachment(webhook_url, file_path):
        """å‘é€é™„ä»¶ï¼ˆæ”¯æŒé‡è¯•ï¼‰"""
        # 1. è¯»å–æ–‡ä»¶
        # 2. ä¸Šä¼ åˆ°Discord
        # 3. æ™ºèƒ½é‡è¯•ï¼ˆ3æ¬¡ï¼‰
        # 4. å¤„ç†é™æµï¼ˆ429ï¼‰
```

**ç‰¹æ€§**:
- âœ… å›¾ç‰‡ç›´ä¼ ï¼ˆä¸ç»å›¾åºŠï¼‰
- âœ… æ™ºèƒ½é‡è¯•ï¼ˆ3æ¬¡ + æŒ‡æ•°é€€é¿ï¼‰
- âœ… é™æµå¤„ç†ï¼ˆ429è‡ªåŠ¨ç­‰å¾…ï¼‰
- âœ… Webhookæ± ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
- âœ… æ–‡ä»¶å¤§å°æ£€æµ‹

---

#### Telegramè½¬å‘å™¨ (telegram.py)

```python
class TelegramForwarder:
    """Telegramæ¶ˆæ¯è½¬å‘å™¨ï¼ˆå¢å¼ºç‰ˆï¼‰"""
    
    async def send_message(token, chat_id, content):
        """å‘é€æ–‡æœ¬æ¶ˆæ¯"""
        # 1. è½¬æ¢ä¸ºHTMLæ ¼å¼
        # 2. åˆ†æ®µå¤„ç†ï¼ˆ>4096å­—ç¬¦ï¼‰
        # 3. å‘é€æ¶ˆæ¯
        
    async def send_photo(token, chat_id, photo_url, caption):
        """å‘é€å›¾ç‰‡ï¼ˆå¢å¼ºç‰ˆï¼‰"""
        # 1. Captionè‡ªåŠ¨æˆªæ–­ï¼ˆ1024å­—ç¬¦ï¼‰
        # 2. å‘é€å›¾ç‰‡
        # 3. æ™ºèƒ½é‡è¯•
        # 4. é™æµå¤„ç†
        
    async def send_photo_direct(token, chat_id, image_data):
        """å‘é€å›¾ç‰‡ï¼ˆç›´ä¼ æ¨¡å¼ï¼‰"""
        # 1. ä½¿ç”¨BytesIOä¸Šä¼ 
        # 2. ä¸éœ€è¦URL
        
    async def get_chat_ids(token):
        """è‡ªåŠ¨è·å–Chat ID"""
        # 1. è°ƒç”¨getUpdates
        # 2. è§£ææ‰€æœ‰Chat
        # 3. è¿”å›åˆ—è¡¨
```

**ç‰¹æ€§**:
- âœ… å›¾ç‰‡/æ–‡ä»¶ç›´ä¼ 
- âœ… Captionè‡ªåŠ¨æˆªæ–­ï¼ˆ1024å­—ç¬¦ï¼‰
- âœ… Chat IDè‡ªåŠ¨æ£€æµ‹
- âœ… é™æµæ™ºèƒ½å¤„ç†
- âœ… HTMLæ ¼å¼æ”¯æŒ

---

### 4. AIæ˜ å°„å­¦ä¹ å¼•æ“ (SmartMapping)

**ä½ç½®**: `backend/app/utils/smart_mapping_ai.py`

**åŠŸèƒ½**: ä½¿ç”¨ä¸‰é‡åŒ¹é…ç®—æ³• + å†å²å­¦ä¹ ï¼Œå®ç°90%+å‡†ç¡®åº¦çš„æ™ºèƒ½æ˜ å°„æ¨è

#### ç®—æ³•æ¶æ„

```python
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       SmartMappingAI                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + keyword_mappings: Dict                 â”‚  # 50+ä¸­è‹±æ–‡æ˜ å°„
â”‚ + historical_patterns: Dict              â”‚  # å†å²æ¨¡å¼
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + recommend_mappings()                   â”‚  # æ¨èæ˜ å°„
â”‚ + calculate_match_score()                â”‚  # è®¡ç®—åˆ†æ•°
â”‚ + keyword_match_score()                  â”‚  # å…³é”®è¯åŒ¹é…
â”‚ + calculate_time_decay()                 â”‚  # æ—¶é—´è¡°å‡
â”‚ + learn_from_mapping()                   â”‚  # å­¦ä¹ æ–°æ˜ å°„
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸‰é‡åŒ¹é…ç®—æ³•

```python
# 1. å®Œå…¨åŒ¹é… (40%æƒé‡)
exact_score = 1.0 if (kook_name == target_name) else 0.0

# 2. ç›¸ä¼¼åº¦åŒ¹é… (30%æƒé‡)
similarity = SequenceMatcher(None, kook_name, target_name).ratio()

# 3. å…³é”®è¯åŒ¹é… (20%æƒé‡)
keyword_score = keyword_match_score(kook_name, target_name)
# æ”¯æŒä¸­è‹±æ–‡äº’è¯‘ï¼š
#   "å…¬å‘Š" â†” "announcement"
#   "é—²èŠ" â†” "general", "chat"
#   "æ¸¸æˆ" â†” "game", "gaming"

# 4. å†å²å­¦ä¹  (10%æƒé‡)
historical_score = get_user_pattern() * time_decay()
# æ—¶é—´è¡°å‡å…¬å¼ï¼š
# decay = exp(-0.693 * days_passed / 30)

# æœ€ç»ˆåˆ†æ•°
final_score = (
    exact_score * 0.4 +
    similarity * 0.3 +
    keyword_score * 0.2 +
    historical_score * 0.1
)
```

#### ç¤ºä¾‹

```python
KOOKé¢‘é“: "å…¬å‘Šé¢‘é“"
ç›®æ ‡é¢‘é“: ["announcements", "general", "news", "å…¬å‘Šç¾¤"]

è®¡ç®—è¿‡ç¨‹:
â”œâ”€â”€ announcements
â”‚   â”œâ”€â”€ å®Œå…¨åŒ¹é…: 0.0 (ä¸åŒ¹é…)
â”‚   â”œâ”€â”€ ç›¸ä¼¼åº¦: 0.3 (30%ç›¸ä¼¼)
â”‚   â”œâ”€â”€ å…³é”®è¯: 1.0 ("å…¬å‘Š" â†’ "announcement")
â”‚   â”œâ”€â”€ å†å²: 0.8 (ç”¨æˆ·å¸¸ç”¨)
â”‚   â””â”€â”€ æœ€ç»ˆåˆ†æ•°: 0.0*0.4 + 0.3*0.3 + 1.0*0.2 + 0.8*0.1 = 0.37
â”‚
â”œâ”€â”€ general
â”‚   â”œâ”€â”€ å®Œå…¨åŒ¹é…: 0.0
â”‚   â”œâ”€â”€ ç›¸ä¼¼åº¦: 0.1
â”‚   â”œâ”€â”€ å…³é”®è¯: 0.2
â”‚   â”œâ”€â”€ å†å²: 0.0
â”‚   â””â”€â”€ æœ€ç»ˆåˆ†æ•°: 0.05
â”‚
â””â”€â”€ å…¬å‘Šç¾¤
    â”œâ”€â”€ å®Œå…¨åŒ¹é…: 0.0
    â”œâ”€â”€ ç›¸ä¼¼åº¦: 0.6 (60%ç›¸ä¼¼)
    â”œâ”€â”€ å…³é”®è¯: 1.0 (å®Œå…¨åŒ¹é…)
    â”œâ”€â”€ å†å²: 0.0
    â””â”€â”€ æœ€ç»ˆåˆ†æ•°: 0.38 â† æœ€é«˜åˆ†

æ¨è: å…¬å‘Šç¾¤ (38%) > announcements (37%)
```

---

### 5. å®‰å…¨å›¾åºŠæœåŠ¡ (ImageBed)

**ä½ç½®**: `backend/app/image_server_secure.py`

**åŠŸèƒ½**: æä¾›TokenéªŒè¯çš„æœ¬åœ°å›¾åºŠæœåŠ¡

#### å®‰å…¨æ¶æ„

```python
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    SecureImageServer                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é˜²æŠ¤å±‚:                                   â”‚
â”‚ â”œâ”€â”€ check_local_access()                 â”‚  # ä»…æœ¬åœ°è®¿é—®
â”‚ â”œâ”€â”€ sanitize_filename()                  â”‚  # è·¯å¾„é˜²æŠ¤
â”‚ â””â”€â”€ verify_token()                       â”‚  # TokenéªŒè¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æœåŠ¡å±‚:                                   â”‚
â”‚ â”œâ”€â”€ serve_image(filename, token)         â”‚  # æä¾›å›¾ç‰‡
â”‚ â”œâ”€â”€ get_stats()                          â”‚  # ç»Ÿè®¡ä¿¡æ¯
â”‚ â””â”€â”€ manual_cleanup()                     â”‚  # æ‰‹åŠ¨æ¸…ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Tokenæœºåˆ¶

```python
# ç”ŸæˆToken
def generate_url(filepath: str) -> str:
    token = secrets.token_urlsafe(32)  # 256ä½ç†µ
    expire_at = time.time() + 7200     # 2å°æ—¶
    
    self.url_tokens[filepath] = {
        'token': token,
        'expire_at': expire_at
    }
    
    return f"http://127.0.0.1:8765/images/{filename}?token={token}"

# éªŒè¯Token
def verify_token(filepath: str, token: str) -> bool:
    if filepath not in self.url_tokens:
        return False
    
    token_info = self.url_tokens[filepath]
    
    # æ£€æŸ¥Token
    if token_info['token'] != token:
        return False
    
    # æ£€æŸ¥è¿‡æœŸ
    if token_info['expire_at'] < time.time():
        del self.url_tokens[filepath]
        return False
    
    return True
```

#### å®‰å…¨é˜²æŠ¤

```python
# 1. ä»…æœ¬åœ°è®¿é—®
allowed_hosts = ['127.0.0.1', 'localhost', '::1']
if client_host not in allowed_hosts:
    raise HTTPException(403, "Forbidden")

# 2. è·¯å¾„éå†é˜²æŠ¤
if '..' in filename or '/' in filename or '\\' in filename:
    raise HTTPException(400, "Invalid filename")

# 3. è·¯å¾„éªŒè¯
filepath = filepath.resolve()
if not str(filepath).startswith(str(storage_path)):
    raise HTTPException(400, "Invalid path")

# 4. TokenéªŒè¯
if not verify_token(filepath, token):
    raise HTTPException(403, "Invalid token")

# 5. è‡ªåŠ¨æ¸…ç†ï¼ˆæ¯15åˆ†é’Ÿï¼‰
async def cleanup_loop():
    while True:
        await asyncio.sleep(900)  # 15åˆ†é’Ÿ
        cleanup_expired_tokens()
```

---

## ğŸ“Š æ•°æ®æµè¯¦è§£

### æ¶ˆæ¯è½¬å‘å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. KOOKæ¶ˆæ¯äº§ç”Ÿ                                                  â”‚
â”‚    ç”¨æˆ·åœ¨KOOKé¢‘é“å‘é€æ¶ˆæ¯                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ScraperæŠ“å–                                                   â”‚
â”‚    â”œâ”€â”€ Playwrightç›‘å¬WebSocket                                   â”‚
â”‚    â”œâ”€â”€ è§£æJSONæ¶ˆæ¯                                               â”‚
â”‚    â”œâ”€â”€ æå–å­—æ®µï¼ˆå†…å®¹/ä½œè€…/é™„ä»¶ï¼‰                                  â”‚
â”‚    â””â”€â”€ å…¥é˜Ÿåˆ°Redis                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ Redis LPUSH
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Workerå¤„ç†                                                    â”‚
â”‚    â”œâ”€â”€ æ‰¹é‡å‡ºé˜Ÿï¼ˆ10æ¡/æ¬¡ï¼‰                                         â”‚
â”‚    â”œâ”€â”€ å»é‡æ£€æŸ¥ï¼ˆLRUç¼“å­˜ + Redisï¼‰                                â”‚
â”‚    â”œâ”€â”€ åº”ç”¨è¿‡æ»¤è§„åˆ™                                               â”‚
â”‚    â””â”€â”€ æŸ¥æ‰¾é¢‘é“æ˜ å°„                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ æ˜ å°„è§„åˆ™
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ ¼å¼è½¬æ¢                                                      â”‚
â”‚    â”œâ”€â”€ KMarkdown â†’ Markdown (Discord)                           â”‚
â”‚    â”œâ”€â”€ KMarkdown â†’ HTML (Telegram)                              â”‚
â”‚    â”œâ”€â”€ KMarkdown â†’ Feishu Text                                  â”‚
â”‚    â””â”€â”€ å¤„ç†å›¾ç‰‡/é™„ä»¶                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ è½¬æ¢åçš„æ¶ˆæ¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å›¾ç‰‡å¤„ç†ï¼ˆå¦‚æœ‰ï¼‰                                               â”‚
â”‚    â”œâ”€â”€ ä¸‹è½½å›¾ç‰‡ï¼ˆaiohttpï¼‰                                        â”‚
â”‚    â”œâ”€â”€ å‹ç¼©å›¾ç‰‡ï¼ˆå¤šè¿›ç¨‹æ± ï¼‰                                        â”‚
â”‚    â”œâ”€â”€ ä¿å­˜åˆ°æœ¬åœ°                                                 â”‚
â”‚    â”œâ”€â”€ ç”ŸæˆToken URL                                              â”‚
â”‚    â””â”€â”€ æˆ–ç›´ä¼ åˆ°ç›®æ ‡å¹³å°                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ å›¾ç‰‡URL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. è½¬å‘åˆ°ç›®æ ‡å¹³å°                                                 â”‚
â”‚    â”œâ”€â”€ Discord: POST Webhook                                     â”‚
â”‚    â”œâ”€â”€ Telegram: POST Bot API                                    â”‚
â”‚    â””â”€â”€ Feishu: POST OpenAPI                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTP Response
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. è®°å½•æ—¥å¿—                                                      â”‚
â”‚    â”œâ”€â”€ æˆåŠŸ: è®°å½•åˆ°SQLite                                         â”‚
â”‚    â”œâ”€â”€ å¤±è´¥: åŠ å…¥é‡è¯•é˜Ÿåˆ—                                          â”‚
â”‚    â””â”€â”€ æ›´æ–°ç»Ÿè®¡æ•°æ®                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### SQLiteæ•°æ®åº“

```sql
-- è´¦å·è¡¨
CREATE TABLE accounts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT NOT NULL,
    password_encrypted TEXT,
    cookie TEXT,
    status TEXT DEFAULT 'offline',  -- offline/online
    last_active TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Boté…ç½®è¡¨
CREATE TABLE bot_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    platform TEXT NOT NULL,  -- discord/telegram/feishu
    name TEXT NOT NULL,
    config JSON NOT NULL,  -- å¹³å°ç‰¹å®šé…ç½®
    status TEXT DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- é¢‘é“æ˜ å°„è¡¨
CREATE TABLE channel_mappings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    kook_channel_id TEXT NOT NULL,
    kook_channel_name TEXT,
    kook_server_id TEXT,
    kook_server_name TEXT,
    target_platform TEXT NOT NULL,
    target_channel_id TEXT NOT NULL,
    target_channel_name TEXT,
    target_bot_id INTEGER,
    status TEXT DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (target_bot_id) REFERENCES bot_configs(id)
);

-- æ¶ˆæ¯æ—¥å¿—è¡¨
CREATE TABLE message_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    kook_message_id TEXT NOT NULL,
    kook_channel_id TEXT NOT NULL,
    content TEXT,
    message_type TEXT,  -- text/image/file/card
    sender_name TEXT,
    target_platform TEXT,
    target_channel TEXT,
    status TEXT,  -- success/failed/pending
    error_message TEXT,
    latency_ms INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å¤±è´¥æ¶ˆæ¯é˜Ÿåˆ—
CREATE TABLE failed_messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    message_log_id INTEGER NOT NULL,
    retry_count INTEGER DEFAULT 0,
    next_retry_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (message_log_id) REFERENCES message_logs(id)
);
```

---

## ğŸ”„ å¹¶å‘ä¸æ€§èƒ½

### å¹¶å‘æ¨¡å‹

```python
# 1. å¼‚æ­¥I/O (asyncio)
â”œâ”€â”€ FastAPIå¼‚æ­¥è·¯ç”±
â”œâ”€â”€ aiohttpå¼‚æ­¥HTTP
â”œâ”€â”€ asyncioå¼‚æ­¥ä»»åŠ¡
â””â”€â”€ Playwrightå¼‚æ­¥æµè§ˆå™¨

# 2. å¤šè¿›ç¨‹ï¼ˆå›¾ç‰‡å‹ç¼©ï¼‰
â”œâ”€â”€ ProcessPoolExecutor (4 workers)
â”œâ”€â”€ CPUå¯†é›†å‹ä»»åŠ¡å¹¶è¡Œ
â””â”€â”€ é«˜æ•ˆå‹ç¼©å¤„ç†

# 3. æ‰¹é‡å¤„ç†
â”œâ”€â”€ Redisæ‰¹é‡å‡ºé˜Ÿï¼ˆ10æ¡/æ¬¡ï¼‰
â”œâ”€â”€ asyncio.gatherå¹¶è¡Œå¤„ç†
â””â”€â”€ é«˜ååé‡å¤„ç†
```

### æ€§èƒ½ä¼˜åŒ–

```python
# 1. æ¶ˆæ¯å»é‡
â”œâ”€â”€ LRUç¼“å­˜ï¼ˆå†…å­˜ï¼Œ10000æ¡ï¼‰
â”‚   â””â”€â”€ O(1)æŸ¥è¯¢
â””â”€â”€ Redisç¼“å­˜ï¼ˆ7å¤©ï¼‰
    â””â”€â”€ æŒä¹…åŒ–

# 2. æ•°æ®åº“ä¼˜åŒ–
â”œâ”€â”€ ç´¢å¼•ä¼˜åŒ–
â”‚   â”œâ”€â”€ CREATE INDEX idx_message_id ON message_logs(kook_message_id)
â”‚   â”œâ”€â”€ CREATE INDEX idx_channel_id ON channel_mappings(kook_channel_id)
â”‚   â””â”€â”€ CREATE INDEX idx_created_at ON message_logs(created_at)
â”œâ”€â”€ å®šæœŸVACUUM
â””â”€â”€ æ—§æ•°æ®å½’æ¡£

# 3. å›¾ç‰‡å¤„ç†
â”œâ”€â”€ å¤šè¿›ç¨‹å‹ç¼©
â”œâ”€â”€ æ™ºèƒ½ç¼“å­˜
â””â”€â”€ CDNåŠ é€Ÿï¼ˆå¯é€‰ï¼‰

# 4. é™æµæ§åˆ¶
â”œâ”€â”€ Discord: 5è¯·æ±‚/5ç§’
â”œâ”€â”€ Telegram: 20è¯·æ±‚/åˆ†é’Ÿ
â””â”€â”€ ä»¤ç‰Œæ¡¶ç®—æ³•
```

---

## ğŸ”’ å®‰å…¨è®¾è®¡

### åŠ å¯†å­˜å‚¨

```python
# AES-256-GCMåŠ å¯†
from cryptography.fernet import Fernet

# ç”Ÿæˆå¯†é’¥ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
key = Fernet.generate_key()

# åŠ å¯†
def encrypt(data: str) -> str:
    f = Fernet(key)
    encrypted = f.encrypt(data.encode())
    return encrypted.decode()

# è§£å¯†
def decrypt(encrypted: str) -> str:
    f = Fernet(key)
    decrypted = f.decrypt(encrypted.encode())
    return decrypted.decode()
```

### Tokenå®‰å…¨

```python
# 1. ä½¿ç”¨secretsç”Ÿæˆå¼ºéšæœºToken
import secrets
token = secrets.token_urlsafe(32)  # 256ä½ç†µ

# 2. æ—¶é—´é™åˆ¶
expire_at = time.time() + 7200  # 2å°æ—¶

# 3. å•æ¬¡ä½¿ç”¨ï¼ˆå¯é€‰ï¼‰
# è®¿é—®åç«‹å³åˆ é™¤Token

# 4. è‡ªåŠ¨æ¸…ç†
# æ¯15åˆ†é’Ÿæ¸…ç†è¿‡æœŸToken
```

### é˜²æŠ¤æªæ–½

```python
# 1. è·¯å¾„éå†é˜²æŠ¤
if '..' in filename or '/' in filename:
    raise HTTPException(400)

# 2. CORSé™åˆ¶
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:9527"],
    allow_methods=["GET", "POST"]
)

# 3. é™æµ
@limiter.limit("100/minute")
async def api_endpoint():
    pass

# 4. è¾“å…¥éªŒè¯
from pydantic import BaseModel, validator

class MessageInput(BaseModel):
    content: str
    
    @validator('content')
    def validate_content(cls, v):
        if len(v) > 10000:
            raise ValueError('Content too long')
        return v
```

---

## ğŸ“ˆ å¯æ‰©å±•æ€§

### æ’ä»¶æ¶æ„

```python
# 1. æ¶ˆæ¯å¤„ç†æ’ä»¶
class MessageProcessor:
    def process(self, message: Dict) -> Dict:
        """å¤„ç†æ¶ˆæ¯"""
        pass

# 2. è½¬å‘å™¨æ’ä»¶
class Forwarder:
    async def send(self, content: str, target: str) -> bool:
        """å‘é€æ¶ˆæ¯"""
        pass

# 3. è¿‡æ»¤å™¨æ’ä»¶
class Filter:
    def should_forward(self, message: Dict) -> bool:
        """æ˜¯å¦è½¬å‘"""
        pass

# ä½¿ç”¨
processors = [
    SpamFilter(),
    ImageCompressor(),
    LinkExpander()
]

for processor in processors:
    message = processor.process(message)
```

### æ°´å¹³æ‰©å±•

```
è´Ÿè½½å‡è¡¡:
â”œâ”€â”€ Nginxåå‘ä»£ç†
â”‚   â”œâ”€â”€ è½®è¯¢
â”‚   â”œâ”€â”€ æœ€å°‘è¿æ¥
â”‚   â””â”€â”€ IP Hash
â”œâ”€â”€ å¤šå®ä¾‹éƒ¨ç½²
â”‚   â”œâ”€â”€ å®ä¾‹1: è´¦å·1-10
â”‚   â”œâ”€â”€ å®ä¾‹2: è´¦å·11-20
â”‚   â””â”€â”€ å®ä¾‹3: è´¦å·21-30
â””â”€â”€ Rediså…±äº«é˜Ÿåˆ—
    â””â”€â”€ æ‰€æœ‰å®ä¾‹å…±äº«æ¶ˆæ¯é˜Ÿåˆ—
```

---

## ğŸ› é”™è¯¯å¤„ç†

### åˆ†çº§é”™è¯¯å¤„ç†

```python
# 1. Workerçº§åˆ«ï¼ˆä¸é€€å‡ºï¼‰
while self.is_running:
    try:
        messages = await redis_queue.dequeue_batch(10)
        await self.process_messages(messages)
    except Exception as e:
        logger.error(f"Workerå¼‚å¸¸: {e}")
        await asyncio.sleep(5)  # ç­‰å¾…åé‡è¯•

# 2. æ¶ˆæ¯çº§åˆ«ï¼ˆéš”ç¦»ï¼‰
async def process_message(message):
    try:
        await forward_message(message)
    except Exception as e:
        logger.error(f"æ¶ˆæ¯å¤„ç†å¤±è´¥: {e}")
        await save_to_failed_queue(message)

# 3. è½¬å‘çº§åˆ«ï¼ˆé‡è¯•ï¼‰
@retry(max_attempts=3, delay=5)
async def forward_message(message):
    await discord_forwarder.send(message)
```

### è‡ªåŠ¨æ¢å¤

```python
# 1. è‡ªåŠ¨é‡è¿
if not await check_connection():
    await reconnect()

# 2. å¤±è´¥é‡è¯•
if retry_count < max_retries:
    await asyncio.sleep(retry_delay)
    await retry()

# 3. é™çº§å¤„ç†
if image_upload_failed:
    await send_as_link()  # é™çº§ä¸ºé“¾æ¥
```

---

## ğŸ“ æ€»ç»“

KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿé‡‡ç”¨**ç°ä»£åŒ–çš„å¾®æœåŠ¡æ¶æ„**ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **é«˜æ€§èƒ½**: å¼‚æ­¥I/O + æ‰¹é‡å¤„ç† + å¤šè¿›ç¨‹
2. **é«˜å¯ç”¨**: è‡ªåŠ¨é‡è¿ + å¤±è´¥é‡è¯• + é™çº§å¤„ç†
3. **æ˜“æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ + æ’ä»¶æ¶æ„
4. **é«˜å®‰å…¨**: åŠ å¯†å­˜å‚¨ + TokenéªŒè¯ + è·¯å¾„é˜²æŠ¤
5. **AIå¢å¼º**: æ™ºèƒ½æ¨è + å†å²å­¦ä¹  + æ—¶é—´è¡°å‡

**æŠ€æœ¯æ ˆ**:
- å‰ç«¯: Electron + Vue 3 + Element Plus
- åç«¯: FastAPI + asyncio + Playwright
- æ•°æ®åº“: SQLite + Redis
- æ¶ˆæ¯é˜Ÿåˆ—: Redis
- æ‰“åŒ…: PyInstaller + electron-builder

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [APIæ¥å£æ–‡æ¡£](APIæ¥å£æ–‡æ¡£.md)
- [å¼€å‘æŒ‡å—](å¼€å‘æŒ‡å—.md)
- [éƒ¨ç½²æŒ‡å—](æ„å»ºå‘å¸ƒæŒ‡å—.md)
- [ç”¨æˆ·æ‰‹å†Œ](ç”¨æˆ·æ‰‹å†Œ.md)

---

<div align="center">

**æ¶æ„è®¾è®¡ v11.0.0 Enhanced**

*æœ€åæ›´æ–°: 2025-10-28*

</div>
