# 🏗️ KOOK消息转发系统 - 构建和发布指南

> **面向开发者**：如何构建预编译安装包并发布到GitHub Releases

**最新版本：** v16.0.0 Electron桌面应用版  
**最后更新：** 2025-10-30  
**新特性**: Electron构建成功 | AppImage打包 | 125MB桌面应用

**重要**: 请参考以下新文档获取最新构建信息：
- 📄 [ELECTRON_BUILD_GUIDE.md](../ELECTRON_BUILD_GUIDE.md) - Electron构建完整指南
- 📄 [ELECTRON_BUILD_SUCCESS.md](../ELECTRON_BUILD_SUCCESS.md) - 构建成功报告
- 📄 [QUICK_START.md](../QUICK_START.md) - 快速开始指南

---

## 🆕 v16.0.0 Electron构建

**Electron桌面应用构建成功！** v16.0.0成功生成125MB AppImage。

### 🚀 快速构建（v16.0.0推荐方式）

```bash
# Electron桌面应用构建
cd /workspace
pip3 install pyinstaller
cd frontend
npm install --legacy-peer-deps
npm run build
npm run electron:build:linux  # Linux AppImage
# npm run electron:build:win   # Windows .exe
# npm run electron:build:mac   # macOS .dmg

# 构建产物:
# frontend/dist-electron/KOOK消息转发系统-16.0.0.AppImage (125MB)

# 或使用自动化脚本
python scripts/build_electron_app.py
```

**💡 提示**：新的打包脚本自动处理所有依赖，无需手动下载任何组件。

---

## 📋 前提条件

### 1. 开发环境

**必需软件**：
- Python 3.11+
- Node.js 18+
- Git
- GitHub CLI (`gh`)

**可选软件**：
- Docker Desktop（用于构建Docker镜像）
- 代码签名证书（macOS/Windows）

### 2. 系统要求

| 构建目标 | 推荐构建环境 | 说明 |
|---------|-------------|------|

| macOS .dmg | macOS 10.15+ | 需要在macOS上构建 |
| Linux .AppImage | Ubuntu 20.04+ | 可以在Linux上构建 |
| Docker镜像 | 任何系统 | Docker支持跨平台 |

### 3. GitHub权限

- ✅ 项目Write权限
- ✅ 可以创建Release
- ✅ 已登录GitHub CLI

---

## 🚀 快速发布流程

### 一键发布（使用GitHub Actions）

```bash
# 1. 更新版本号（在需要的文件中）
# - backend/app/config.py (app_version)
# - frontend/package.json (version)

# 2. 提交所有更改
git add .
git commit -m "Release v9.04.0"
git push

# 3. 创建Release tag并推送
./scripts/create-release.sh v9.04.0

# 4. 等待15-20分钟
# GitHub Actions会自动：
# - 构建Windows/macOS/Linux安装包
# - 构建Docker镜像并推送
# - 创建GitHub Release
# - 上传所有安装包

# 5. 完成！
# 访问: https://github.com/gfchfjh/CSBJJWT/releases
```

---

## 🔨 手动构建流程

### 步骤1: 准备环境

```bash
# 克隆项目
git clone https://github.com/gfchfjh/CSBJJWT.git
cd CSBJJWT

# 安装构建依赖
pip install pyinstaller colorama
npm install -g electron-builder
```

### 步骤2: 构建后端

```bash
cd backend

# 安装依赖
pip install -r requirements.txt

# 下载Chromium
playwright install chromium

# 使用PyInstaller打包
pyinstaller --clean --noconfirm ../build/build_backend.spec

# 输出: dist/backend/
cd ..
```

### 步骤3: 构建前端

```bash
cd frontend

# 安装依赖
npm install

# 构建Electron应用
npm run electron:build

# Windows构建
npm run electron:build -- --win

# macOS构建
npm run electron:build -- --mac

# Linux构建
npm run electron:build -- --linux

# 输出: dist/
cd ..
```

### 步骤4: 整合安装包

```bash
# 使用构建脚本整合
python3 build/build_all_enhanced.py

# 或使用Shell脚本
./build/build_all.sh  # Linux/macOS
build\build_all.bat   # Windows

# 最终输出: build/dist/
# - KookForwarder-Setup-1.14.0.exe
# - KookForwarder-1.14.0.dmg
# - KookForwarder-1.14.0.AppImage
```

---

## 🐳 构建Docker镜像

### 本地构建

```bash
# 构建镜像
docker build -t kook-forwarder:latest .

# 测试镜像
docker run -d -p 9527:9527 kook-forwarder:latest

# 测试健康检查
curl http://localhost:9527/health

# 如果成功，打标签
docker tag kook-forwarder:latest ghcr.io/gfchfjh/csbjjwt:latest
docker tag kook-forwarder:latest ghcr.io/gfchfjh/csbjjwt:v9.04.0
```

### 推送到GitHub Container Registry

```bash
# 1. 登录GHCR
echo $GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin

# 2. 推送镜像
docker push ghcr.io/gfchfjh/csbjjwt:latest
docker push ghcr.io/gfchfjh/csbjjwt:v9.04.0

# 3. 完成！
```

---

## 📦 构建配置详解

### PyInstaller配置 (`build_backend.spec`)

关键配置：

```python
# 打包所有依赖
hiddenimports=[
    'playwright',
    'redis',
    'cryptography',
    # ... 其他依赖
],

# 包含数据文件
datas=[
    ('redis', 'redis'),              # Redis二进制
    ('docs', 'docs'),                 # 文档
    ('.cache/ms-playwright', 'playwright'),  # Chromium
],

# 单文件模式
onefile=True,

# 无控制台窗口
console=False,
```

### Electron Builder配置 (`build/electron-builder.yml`)

关键配置：

```yaml
appId: com.kook.forwarder
productName: KOOK消息转发系统

# 打包文件
files:
  - "**/*"
  - "!**/.git"
  - "!**/node_modules"

# 额外资源（后端、Redis等）
extraResources:
  - from: "../dist/backend"
    to: "backend"
  - from: "../redis"
    to: "redis"

# Windows配置
win:
  target:
    - target: nsis
      arch: [x64]
  icon: build/icon.ico

# macOS配置
mac:
  target:
    - target: dmg
      arch: [x64, arm64]
  icon: build/icon.icns
  entitlements: build/entitlements.mac.plist

# Linux配置
linux:
  target:
    - target: AppImage
      arch: [x64]
  icon: build/icon.png
  category: Utility
```

---

## 🔐 代码签名

### Windows代码签名

```powershell
# 需要代码签名证书（.pfx文件）

# 设置环境变量
$env:CSC_LINK = "path/to/certificate.pfx"
$env:CSC_KEY_PASSWORD = "certificate_password"

# 构建（自动签名）
npm run electron:build -- --win
```

### macOS代码签名

```bash
# 需要Apple Developer证书

# 设置环境变量
export CSC_LINK="/path/to/certificate.p12"
export CSC_KEY_PASSWORD="certificate_password"
export APPLE_ID="your_apple_id@email.com"
export APPLE_ID_PASSWORD="app_specific_password"

# 构建（自动签名和公证）
npm run electron:build -- --mac
```

**注意**：
- macOS签名需要Apple Developer账号（$99/年）
- 公证（notarization）需要额外配置
- 可以跳过签名，但用户需要手动绕过安全检查

---

## 🤖 使用GitHub Actions自动构建

### 配置Secrets

在GitHub仓库设置中添加以下Secrets：

| Secret名称 | 说明 | 必需 |
|-----------|------|------|
| `GITHUB_TOKEN` | 自动提供 | ✅ |
| `MACOS_CERTIFICATE` | macOS签名证书（base64） | ❌ 可选 |
| `MACOS_CERTIFICATE_PASSWORD` | 证书密码 | ❌ 可选 |
| `WINDOWS_CERTIFICATE` | Windows签名证书（base64） | ❌ 可选 |
| `WINDOWS_CERTIFICATE_PASSWORD` | 证书密码 | ❌ 可选 |

### 触发构建

```bash
# 方法1: 创建tag（自动触发）
git tag v9.04.0
git push origin v9.04.0

# 方法2: 手动触发
# 访问: https://github.com/gfchfjh/CSBJJWT/actions
# 选择"Build and Release"
# 点击"Run workflow"

# 方法3: 使用脚本
./scripts/create-release.sh v9.04.0
```

### 监控构建进度

```bash
# 查看Actions状态
gh run list --workflow=build-and-release.yml

# 查看详细日志
gh run view --log
```

---

## 📋 构建检查清单

发布前请确认：

### 版本更新
- [ ] `backend/app/config.py` 中的版本号已更新
- [ ] `frontend/package.json` 中的版本号已更新
- [ ] `CHANGELOG.md` 已更新
- [ ] 文档中的版本号已更新

### 构建测试
- [ ] 后端构建成功
- [ ] 前端构建成功
- [ ] Windows安装包可用
- [ ] macOS安装包可用
- [ ] Linux安装包可用
- [ ] Docker镜像可用

### Release准备
- [ ] Release Notes已准备
- [ ] 安装包已测试
- [ ] 文档已更新
- [ ] 下载链接已验证

---

## 🔧 构建脚本说明

### build_all_enhanced.py

**功能**：
- 自动检查构建环境
- 构建后端（PyInstaller）
- 构建前端（Electron）
- 整合安装包
- 生成校验和

**使用**：
```bash
python3 build/build_all_enhanced.py
```

### build_all.sh / build_all.bat

**功能**：
- Shell版本的构建脚本
- 适合CI/CD环境
- 支持跨平台

**使用**：
```bash
# Linux/macOS
./build/build_all.sh

# Windows
build\build_all.bat
```

---

## 📤 发布到GitHub Releases

### 手动发布

```bash
# 1. 创建tag
git tag -a v9.04.0 -m "Release v9.04.0"
git push origin v9.04.0

# 2. 创建Release
gh release create v9.04.0 \
  --title "v9.04.0 - 功能完善版" \
  --notes-file release_notes.md \
  build/dist/KookForwarder-Setup-1.14.0.exe \
  build/dist/KookForwarder-1.14.0.dmg \
  build/dist/KookForwarder-1.14.0.AppImage

# 3. 完成！
```

### 使用脚本发布

```bash
# 使用提供的脚本
./scripts/create-release.sh v9.04.0

# 脚本会：
# 1. 创建并推送tag
# 2. 触发GitHub Actions
# 3. 自动构建和发布
```

---

## 🧪 构建后测试

### 1. Windows安装包测试

```powershell
# 在Windows虚拟机或测试机上
1. 双击 KookForwarder-Setup-*.exe
2. 按照向导安装
3. 启动应用
4. 验证所有功能
5. 卸载测试
```

### 2. macOS安装包测试

```bash
# 在macOS上
1. 打开 KookForwarder-*.dmg
2. 拖拽安装
3. 右键打开应用
4. 验证所有功能
5. 删除应用测试
```

### 3. Linux安装包测试

```bash
# 在Linux上
chmod +x KookForwarder-*.AppImage
./KookForwarder-*.AppImage

# 验证：
# 1. 应用正常启动
# 2. 所有功能可用
# 3. 无依赖错误
```

### 4. Docker镜像测试

```bash
# 拉取镜像
docker pull ghcr.io/gfchfjh/csbjjwt:latest

# 运行容器
docker run -d -p 9527:9527 ghcr.io/gfchfjh/csbjjwt:latest

# 健康检查
curl http://localhost:9527/health

# 查看日志
docker logs -f [container_id]

# 停止并删除
docker stop [container_id]
docker rm [container_id]
```

---

## 📊 构建时间和大小

### 预期构建时间

| 任务 | 本地构建 | GitHub Actions |
|------|---------|----------------|
| 后端打包 | 5-10分钟 | 3-5分钟 |
| 前端打包（Windows） | 5-8分钟 | 4-6分钟 |
| 前端打包（macOS） | 5-8分钟 | 4-6分钟 |
| 前端打包（Linux） | 3-5分钟 | 2-4分钟 |
| Docker镜像 | 3-5分钟 | 2-4分钟 |
| **总计** | 20-40分钟 | 15-25分钟 |

### 预期安装包大小

| 平台 | 大小 | 包含内容 |
|------|------|---------|
| Windows .exe | ~450MB | Python + Node.js + Chromium + Redis + 依赖 |
| macOS .dmg | ~480MB | 同上 + macOS特定库 |
| Linux .AppImage | ~420MB | 同上（精简版） |
| Docker镜像 | ~1.2GB | 基础镜像 + 所有运行时 |

---

## 🔍 构建问题排查

### 问题1: PyInstaller打包失败

**常见原因**：
- 缺少隐藏导入
- 数据文件路径错误
- 依赖版本冲突

**解决方法**：
```bash
# 1. 检查导入
pyinstaller --log-level DEBUG build_backend.spec

# 2. 添加缺失的隐藏导入
# 编辑 build_backend.spec
hiddenimports=[
    'missing_module',
]

# 3. 清理缓存重新构建
pyinstaller --clean --noconfirm build_backend.spec
```

### 问题2: Electron打包失败

**常见原因**：
- Node.js版本不兼容
- 依赖安装不完整
- 磁盘空间不足

**解决方法**：
```bash
# 1. 清理并重新安装依赖
cd frontend
rm -rf node_modules package-lock.json
npm install

# 2. 检查磁盘空间
df -h  # Linux/macOS
# 需要至少10GB可用空间

# 3. 使用调试模式
npm run electron:build -- --win --publish never
```

### 问题3: Chromium打包失败

**常见原因**：
- 浏览器未正确下载
- 路径配置错误

**解决方法**：
```bash
# 1. 手动安装Chromium
playwright install chromium --with-deps

# 2. 检查浏览器位置
playwright install --dry-run chromium

# 3. 复制到打包目录
cp -r ~/.cache/ms-playwright build/dist/playwright/
```

### 问题4: Docker构建失败

**常见原因**：
- 网络超时
- 依赖下载失败
- 基础镜像问题

**解决方法**：
```bash
# 1. 使用国内镜像源
docker build --build-arg PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple .

# 2. 增加构建超时
docker build --network host --build-arg BUILDKIT_PROGRESS=plain .

# 3. 分步构建（调试）
docker build --target builder .
```

---

## 🎯 发布检查清单

### 发布前（Pre-release）

- [ ] 所有单元测试通过
- [ ] 所有E2E测试通过
- [ ] 压力测试通过
- [ ] 代码质量检查通过
- [ ] 安全扫描通过
- [ ] 文档已更新
- [ ] CHANGELOG已更新
- [ ] 版本号已更新

### 构建阶段（Build）

- [ ] 后端构建成功（3个平台）
- [ ] 前端构建成功（3个平台）
- [ ] Docker镜像构建成功
- [ ] 所有构建产物已生成
- [ ] 校验和已计算

### 测试阶段（Test）

- [ ] Windows安装包测试通过
- [ ] macOS安装包测试通过
- [ ] Linux安装包测试通过
- [ ] Docker镜像测试通过
- [ ] 安装流程测试通过
- [ ] 卸载流程测试通过

### 发布阶段（Release）

- [ ] GitHub Release已创建
- [ ] Release Notes完整
- [ ] 所有安装包已上传
- [ ] 下载链接可用
- [ ] Docker镜像已推送
- [ ] 文档链接已更新
- [ ] README已更新

### 发布后（Post-release）

- [ ] 发布公告已发布
- [ ] 用户反馈已收集
- [ ] 紧急bug已修复
- [ ] 下载量已跟踪
- [ ] 问题已及时响应

---

## 📈 发布频率建议

| 版本类型 | 频率 | 说明 |
|---------|------|------|
| **Major版本** | 6-12个月 | 重大功能更新 |
| **Minor版本** | 1-2个月 | 新功能和改进 |
| **Patch版本** | 1-2周 | Bug修复 |
| **Hotfix** | 按需 | 紧急bug修复 |

---

## 🔄 版本号规范

遵循语义化版本（Semantic Versioning）：

```
v9.04.0
│ │  │
│ │  └─ PATCH版本（bug修复）
│ └──── MINOR版本（新功能，向后兼容）
└───── MAJOR版本（重大更新，可能不兼容）

示例：
v9.04.0 到 v9.04.0  Bug修复
v9.04.0 到 v9.04.0  新功能
v9.04.0 到 v10.0.0   重大更新
```

---

## 📝 Release Notes模板

```markdown
# v9.04.0 - [版本名称]

发布日期: 2025-10-23

- 新增xxx功能
- 支持xxx平台
- 优化xxx体验

## 🐛 Bug修复

- 修复xxx问题 (#123)
- 解决xxx崩溃 (#124)
- 改进xxx性能 (#125)

## 🔧 改进

- 优化xxx逻辑

## 📚 文档

- 新增xxx教程
- 更新xxx指南
- 完善xxx文档

## ⚠️ 破坏性变更

- 移除xxx功能（已废弃）
- 更改xxx配置格式（请参考迁移指南）

## 📥 下载

请根据您的系统选择：
- Windows: [下载.exe](链接)
- macOS: [下载.dmg](链接)
- Linux: [下载.AppImage](链接)

## 🐳 Docker

```bash
docker pull ghcr.io/gfchfjh/csbjjwt:v9.04.0
```

## 🙏 贡献者

感谢以下贡献者：
- @contributor1
- @contributor2

## 📖 完整更新日志

查看: [CHANGELOG.md](链接)
```

---

## 🎯 最佳实践

### 1. 版本发布流程

```
1. 功能开发 到 develop分支
2. 测试验证 到 develop分支
3. 合并到main 到 PR审核
4. 创建tag 到 触发构建
5. 等待构建 到 约15分钟
6. 验证Release 到 测试安装包
7. 发布公告 到 通知用户
```

### 2. 回滚策略

如果发现严重bug：

```bash
# 1. 删除有问题的Release
gh release delete v9.04.0

# 2. 删除tag
git tag -d v9.04.0
git push origin :refs/tags/v9.04.0

# 3. 修复bug

# 4. 重新发布
./scripts/create-release.sh v9.03.4
```

### 3. 热修复流程

```bash
# 1. 基于发布tag创建分支
git checkout -b hotfix/v9.04.0 v9.04.0

# 2. 修复bug
# ... 编辑代码 ...

# 3. 提交修复
git commit -am "Fix critical bug"

# 4. 创建新patch版本
git tag v9.03.4

# 5. 推送并发布
git push origin hotfix/v9.04.0 v9.03.4
```

---

## 💡 优化建议

### 1. 减小安装包体积

```

- 排除不必要的依赖
- 优化资源文件
- 使用增量更新（后续版本）
```

### 2. 加快构建速度

```
- 使用GitHub Actions缓存
- 并行构建多个平台
- 优化依赖安装
- 使用预构建的基础镜像
```

### 3. 提高成功率

```
- 增加错误重试机制
- 提供详细的错误信息
- 自动环境检查
- 智能问题诊断
```

---

## 📞 获取帮助

构建或发布遇到问题？

- 📖 查看 [构建日志](https://github.com/gfchfjh/CSBJJWT/actions)
- 🐛 提交 [Issue](https://github.com/gfchfjh/CSBJJWT/issues/new)
- 💬 加入 [讨论](https://github.com/gfchfjh/CSBJJWT/discussions)

---

<div align="center">

**完善的构建流程，保证每次发布的稳定性和可靠性！** 🚀

[返回主页](../README.md) | [一键安装指南](一键安装指南.md) | [开发指南](开发指南.md)

</div>
