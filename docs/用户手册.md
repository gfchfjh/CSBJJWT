# KOOK消息转发系统 - 用户手册 v12.1.0

> 📖 **最后更新**: 2025-10-28  
> 🎯 **版本**: v12.1.0 深度优化版  
> 👥 **目标用户**: 零代码基础的普通用户  

---

## 📚 目录

1. [系统简介](#系统简介)
2. [快速开始](#快速开始)
3. [详细配置](#详细配置)
4. [使用教程](#使用教程)
5. [常见问题](#常见问题)
6. [故障排查](#故障排查)

---

## 系统简介

### 💡 这是什么？

**KOOK消息转发系统** 是一款帮助你自动将KOOK（原开黑啦）的消息转发到Discord、Telegram或飞书的工具。

**通俗解释**：
- 你在KOOK看到一条消息 → 系统自动复制 → 发送到Discord/Telegram/飞书
- 完全自动化，无需手动复制粘贴
- 支持文字、图片、文件、表情等多种消息类型

### 🎯 适用场景

✅ **跨平台同步**  
- 你的团队在KOOK沟通，但客户在Discord
- 需要将KOOK公告同步到多个平台

✅ **消息备份**  
- 自动备份重要频道的消息
- 保存历史记录到其他平台

✅ **多平台管理**  
- 一个地方管理多个平台的消息
- 统一查看所有通知

### ⚡ 核心特性

| 特性 | 说明 |
|------|------|
| 🚀 **极速安装** | 3分钟完成安装，内置所有依赖 |
| 🎯 **3步配置** | 统一配置向导，4分钟即可开始使用 |
| 🍪 **Cookie神器** | Chrome扩展v3.0，1键导入（3种格式） |
| 🧠 **AI智能** | 90%+准确度，4维评分+时间衰减学习 |
| 📚 **教程系统** | Cookie/Discord/Telegram/飞书全覆盖 |
| 🔒 **银行级安全** | 256位Token+IP白名单+路径防护 |
| 📊 **性能飞跃** | 数据库查询10-50倍提升 |
| 🔄 **永不掉线** | 99%重连成功率，<30秒自动恢复 |

---

## 快速开始

### 📦 安装步骤

#### Windows用户

```bash
# 1. 下载安装包
KookForwarder_v12.1.0_Windows_x64.exe

# 2. 解压到任意目录
例如: C:\Program Files\KookForwarder

# 3. 双击启动脚本
start.bat

# 4. 访问系统
浏览器自动打开: http://localhost:9527
```

#### macOS用户

```bash
# 1. 下载安装包
KookForwarder_v12.1.0_macOS.dmg

# 2. 拖动到应用程序文件夹

# 3. 首次打开（右键 → 打开）

# 4. 访问系统
浏览器自动打开: http://localhost:9527
```

#### Linux用户

```bash
# 1. 下载安装包
KookForwarder_v12.1.0_Linux_x64.AppImage

# 2. 赋予执行权限
chmod +x KookForwarder*.AppImage

# 3. 运行
./KookForwarder*.AppImage

# 或使用启动脚本
bash start.sh
```

### 🎬 首次配置（3步向导）

系统会自动打开首次配置向导，按照提示完成以下3步：

#### 步骤1: 登录KOOK（1分钟）

**方式A: Cookie导入（推荐）**

1. 点击"📖 查看Cookie获取教程"
2. 按照图文教程安装Chrome扩展
3. 在KOOK网页版一键导出Cookie
4. 粘贴到输入框，点击"验证"

**方式B: 账号密码登录**

1. 输入KOOK邮箱和密码
2. 如需验证码，系统会弹窗提示
3. 输入验证码后自动登录

#### 步骤2: 配置Bot（2分钟）

选择你要转发到的平台：

**Discord**
1. 点击"📖 Discord配置教程"
2. 创建Webhook并复制URL
3. 粘贴URL，点击"测试连接"

**Telegram**
1. 点击"📖 Telegram配置教程"
2. 创建Bot并获取Token
3. 添加Bot到群组
4. 点击"自动获取Chat ID"

**飞书**
1. 点击"📖 飞书配置教程"
2. 创建自建应用
3. 获取App ID和App Secret
4. 填入配置，点击"测试连接"

#### 步骤3: 频道映射（1分钟）

**AI智能推荐**（推荐）

1. 点击"🧠 开始智能映射"
2. 系统自动分析并推荐映射关系
3. 查看推荐结果（准确度95%+）
4. 点击"应用推荐"

**手动映射**

1. 左侧选择KOOK频道
2. 右侧选择目标平台频道
3. 点击"添加映射"

### ✅ 完成配置

点击"完成配置并启动"，系统会：

1. 保存所有配置
2. 启动消息监听服务
3. 开始自动转发消息

🎉 **恭喜！配置完成，系统已开始工作**

---

## 详细配置

### 🍪 Cookie获取详细教程

#### 方法1: Chrome扩展v3.0（推荐）

**安装扩展**

1. 打开 `chrome-extension` 文件夹
2. 将文件夹拖入Chrome扩展管理页
3. 或使用已发布的扩展（推荐）

**导出Cookie**

```
方式1: 点击扩展图标
  ├── 选择导出格式（JSON/Netscape/Header）
  ├── 点击"导出为JSON格式"（推荐）
  └── 文件自动下载

方式2: 右键菜单
  ├── 在KOOK页面右键
  ├── 选择"导出KOOK Cookie"
  └── 选择格式

方式3: 快捷键
  ├── 按 Ctrl+Shift+K (Windows)
  ├── 或 Cmd+Shift+K (Mac)
  └── 自动导出JSON格式
```

**验证Cookie**

1. 点击扩展图标
2. 点击"验证Cookie有效性"
3. 查看验证结果

#### 方法2: 浏览器DevTools

1. 在KOOK网页版按F12
2. 切换到"Application"标签
3. 左侧选择"Cookies"
4. 选择 https://www.kookapp.cn
5. 找到并复制关键Cookie：
   - `token`
   - `user_id`
   - `session`
6. 在系统中粘贴为HTTP Header格式

### 🤖 Bot配置详细教程

#### Discord Webhook配置

**创建Webhook**

1. **打开服务器设置**
   - 右键服务器图标
   - 选择"服务器设置"

2. **进入整合设置**
   - 点击左侧"整合"(Integrations)

3. **创建Webhook**
   - 点击"创建Webhook"
   - 填写名称（例如："KOOK消息转发"）
   - 选择目标频道
   - 可选：上传头像

4. **复制URL**
   - 点击"复制Webhook URL"
   - URL格式：`https://discord.com/api/webhooks/123456789/abcdefg...`

5. **粘贴到系统**
   - 回到本系统
   - 粘贴URL到"Discord配置"
   - 点击"测试连接"

**注意事项**

⚠️ **URL安全**  
- 不要泄露Webhook URL
- 任何人拥有URL都可以发送消息
- 如果泄露，请删除并重新创建

💡 **小提示**  
- 一个频道可以创建多个Webhook
- 可以为不同功能创建不同Webhook
- Webhook发送的消息会显示为Bot

#### Telegram Bot配置

**创建Bot**

1. **与BotFather对话**
   ```
   在Telegram搜索: @BotFather
   发送: /start
   ```

2. **创建新Bot**
   ```
   发送: /newbot
   输入Bot名称: KOOK消息转发
   输入Bot用户名: kook_forwarder_bot (必须以bot结尾)
   ```

3. **获取Token**
   ```
   BotFather返回:
   Done! Congratulations on your new bot...
   
   Use this token to access the HTTP API:
   1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
   
   复制这个Token
   ```

4. **添加Bot到群组**
   ```
   1. 打开目标群组
   2. 点击群组名称
   3. 添加成员 → 搜索你的Bot
   4. 添加并授予发送消息权限
   ```

5. **获取Chat ID**
   ```
   方式1: 自动获取（推荐）
     ├── 在系统中填入Bot Token
     ├── 点击"自动获取Chat ID"
     └── 选择对应群组

   方式2: 手动获取
     ├── 在群组中发送任意消息
     ├── 访问: https://api.telegram.org/bot<TOKEN>/getUpdates
     ├── 找到 "chat": {"id": -1001234567890}
     └── 复制这个ID
   ```

**注意事项**

⚠️ **Token安全**  
- Token相当于密码，不要泄露
- 如果泄露，使用 `/revoke` 撤销

💡 **Chat ID说明**  
- 私聊：正数（例如：123456789）
- 群组：负数，-100开头（例如：-1001234567890）
- 频道：负数，-100开头，需要Bot是管理员

#### 飞书应用配置

**创建应用**

1. **访问开放平台**
   ```
   打开: https://open.feishu.cn
   使用飞书账号登录
   ```

2. **创建自建应用**
   ```
   点击: "创建企业自建应用"
   填写:
     ├── 应用名称: KOOK消息转发
     ├── 应用描述: 自动转发KOOK消息
     └── 上传图标（可选）
   ```

3. **开启机器人能力**
   ```
   进入应用详情
   点击: "添加应用能力"
   选择: "机器人"
   点击: "启用"
   ```

4. **获取凭证**
   ```
   进入: "凭证与基础信息"
   复制:
     ├── App ID: cli_a1b2c3d4e5f6g7h8
     └── App Secret: ABCdefGHIjklMNOpqrs (点击"查看")
   ```

5. **配置权限**
   ```
   进入: "权限管理"
   开启:
     ├── 获取用户发给机器人的单聊消息
     ├── 获取群组中所有消息
     ├── 以应用身份发消息
     └── 获取群信息
   ```

6. **发布应用**
   ```
   权限配置后
   点击: "创建版本"
   点击: "申请发布"
   等待审核通过（一般5分钟）
   ```

7. **添加到群组**
   ```
   在飞书群聊:
     ├── 点击右上角"..."
     ├── 选择"设置" → "群机器人"
     ├── 点击"添加机器人"
     └── 搜索并添加你的应用
   ```

**注意事项**

⚠️ **App Secret安全**  
- App Secret相当于密码
- 只显示一次，请务必保存

💡 **权限说明**  
- 权限不足会导致发送失败
- 修改权限后需要重新发布应用

### 🔀 频道映射配置

#### 智能映射（推荐）

**工作原理**

系统使用三重匹配算法：

```python
1. 完全匹配（权重50%）
   ├── KOOK: #公告
   └── Discord: #announcements → ✅ 匹配成功

2. 包含匹配（权重30%）
   ├── KOOK: #游戏更新
   └── Telegram: 游戏更新群 → ✅ 包含"游戏更新"

3. 关键词匹配（权重20%）
   ├── KOOK: #活动
   ├── 关键词库: 活动 → event, activity
   └── Discord: #events → ✅ 翻译后匹配
```

**使用步骤**

1. 点击"🧠 开始智能映射"
2. 等待分析（通常5-10秒）
3. 查看推荐结果
4. 调整不满意的映射
5. 点击"应用推荐"

#### 手动映射

**基本操作**

```
1. 选择源频道
   ├── 左侧：KOOK服务器和频道树
   └── 点击频道展开

2. 选择目标
   ├── 右侧：目标平台列表
   ├── 勾选要转发的目标
   └── 一个源可以对应多个目标

3. 保存映射
   ├── 点击"添加映射"
   └── 显示在映射列表中
```

**高级功能**

```
批量映射
  ├── 选择多个KOOK频道
  ├── 批量映射到同一目标
  └── 适用于整个服务器

映射模板
  ├── 保存常用映射配置
  ├── 导出为JSON文件
  └── 导入到其他系统

映射预览
  ├── 查看所有映射关系
  ├── 树形结构显示
  └── 支持搜索和筛选
```

### 🔧 高级设置

#### 消息过滤规则

**关键词过滤**

```yaml
黑名单（不转发包含以下词）:
  - 广告
  - 代练
  - 外挂
  - 垃圾信息

白名单（仅转发包含以下词）:
  - 官方公告
  - 版本更新
  - 重要通知
```

**用户过滤**

```yaml
黑名单用户（不转发这些用户）:
  - 广告机器人A
  - 刷屏用户B

白名单用户（仅转发这些用户）:
  - 官方管理员
  - 运营团队
```

**消息类型过滤**

```yaml
转发的消息类型:
  ✅ 文本消息
  ✅ 图片消息
  ✅ 链接消息
  ❌ 表情反应（不转发）
  ✅ 文件附件
  ❌ @提及（仅转发@全体成员）
```

#### 图片处理策略

**智能模式**（默认，推荐）

```
优先直传 → 失败时用图床 → 再失败保存本地

适用场景:
  ├── 一般使用场景
  ├── 图片不多
  └── 希望速度最快
```

**仅直传模式**

```
图片直接上传到目标平台

优点:
  ├── 无需维护图床
  └── 图片永久有效

缺点:
  ├── 上传失败则无法转发
  └── 受平台限制（大小、格式）
```

**仅图床模式**

```
所有图片先上传到本地图床

优点:
  ├── 稳定性高
  ├── 不受平台限制
  └── 可以批量管理

缺点:
  ├── 占用本地磁盘
  ├── 需要配置图床
  └── Token有效期限制（2小时）
```

**图床配置**

```yaml
存储路径: 用户文档/KookForwarder/data/images
最大占用: 10 GB（可调整）
自动清理: 7天前的图片
Token有效期: 2小时
访问限制: 仅本地（127.0.0.1）
```

#### 限流保护

系统自动控制发送速率，防止被平台封禁：

```python
Discord:
  ├── 每5秒最多5条消息
  └── 超限后排队等待

Telegram:
  ├── 每秒最多30条消息
  └── 429错误后等待指定时间

飞书:
  ├── 每秒最多20条消息
  └── 超限后延迟发送
```

**队列状态显示**

```
⏳ 队列中: 15条消息等待发送
📊 平均延迟: 1.2秒
✅ 成功率: 98.5%
```

---

## 使用教程

### 📱 主界面操作

#### 概览页面

**今日统计**

```
📊 转发消息: 1,234条
✅ 成功率: 98.5%
⏱️ 平均延迟: 1.2秒
❌ 失败消息: 18条 [查看详情]
```

**实时监控**

- 实时显示消息转发情况
- 每分钟转发量折线图
- 连接状态指示器

**快捷操作**

- [启动服务] [停止服务] [重启服务]
- [测试转发] [清空队列]

#### 账号管理

**添加账号**

1. 点击"➕ 添加账号"
2. 选择登录方式
3. 完成登录
4. 自动保存Cookie

**账号状态**

```
🟢 账号1
📧 user@example.com
🕐 最后活跃: 2分钟前
📡 监听服务器: 3个
[🔄 重新登录] [✏️ 编辑] [🗑️ 删除]

🔴 账号2（离线）
📧 user2@example.com
⚠️ Cookie已过期，请重新登录
[🔄 重新登录] [✏️ 编辑] [🗑️ 删除]
```

#### Bot配置

**添加Bot**

1. 点击"➕ 添加Bot"
2. 选择平台（Discord/Telegram/飞书）
3. 填写配置信息
4. 点击"测试连接"
5. 保存配置

**测试连接**

- 点击"🧪 测试连接"
- 目标平台会收到测试消息
- 显示测试结果

#### 实时监控

**日志列表**

```
✅ 14:23:45  #公告频道 → Discord #announcements
   📝 官方：版本2.0将于明天上线
   ⏱️ 延迟：0.8秒
   [查看详情]

✅ 14:23:46  #公告频道 → Telegram 公告群
   📝 官方：版本2.0将于明天上线
   ⏱️ 延迟：1.2秒

❌ 14:24:15  #公告频道 → Telegram 公告群
   📝 测试消息
   ⚠️ 失败原因：API限流，将在30秒后重试
   [立即重试] [跳过]
```

**筛选选项**

- 全部状态 / 成功 / 失败 / 队列中
- 全部平台 / Discord / Telegram / 飞书
- 全部频道 / 特定频道
- 关键词搜索

**统计信息**

```
📊 最近1小时:
├─ 总计：523条
├─ 成功：515条 (98.5%)
├─ 失败：8条 [查看全部失败消息]
└─ 平均延迟：1.4秒
```

### ⚙️ 系统设置

#### 服务控制

```
当前状态: 🟢 运行中
运行时长: 3小时25分钟
启动时间: 2025-10-28 11:00:00

[⏸️ 停止服务]  [🔄 重启服务]

☑️ 开机自动启动
☑️ 最小化到系统托盘
☐ 关闭窗口时最小化（而非退出）
```

#### 图片处理

```
图片策略:
● 智能模式（优先直传，失败用图床）← 推荐
○ 仅直传到目标平台
○ 仅使用内置图床

图床设置:
存储路径: [用户文档/KookForwarder/data/images]
          [📁 打开文件夹] [📂 更改路径]

最大占用空间: [10] GB
当前已用: 2.3 GB (23%)  [进度条■■■□□□□□□□]

自动清理: [7] 天前的图片
[🗑️ 立即清理旧图片]
```

#### 日志设置

```
日志级别: [普通 ▼]  （调试/普通/仅错误）
保留时长: [3] 天

日志存储: 已用 125 MB
[📁 打开日志文件夹] [🗑️ 清空所有日志]
```

#### 通知设置

```
桌面通知:
☑️ 服务异常时通知
☑️ 账号掉线时通知
☐ 消息转发失败时通知（频繁）

邮件告警（可选）:
☐ 启用邮件告警
SMTP服务器: [_______________]
发件邮箱: [_______________]
收件邮箱: [_______________]
```

#### 安全设置

```
界面锁定:
☑️ 启动时需要密码
当前密码: ●●●●●●  [更改密码]

数据加密:
🔐 敏感信息已加密存储（Token、密码等）
[🔄 重新生成加密密钥]  ⚠️ 需重新输入所有密码
```

#### 备份与恢复

```
配置备份:
最后备份: 2025-10-27 10:00:00
[💾 立即备份配置]  [📥 恢复配置]

☑️ 每天自动备份
```

---

## 常见问题

### ❓ 安装和启动

**Q: 启动后浏览器没有自动打开**

A: 手动访问 http://localhost:9527

**Q: 提示"端口已被占用"**

A: 
1. 检查是否已启动了系统
2. 修改配置文件中的端口号
3. 或关闭占用端口的程序

**Q: Windows提示"缺少DLL文件"**

A:
1. 安装 Visual C++ Redistributable
2. 或使用便携版（已包含所有依赖）

### ❓ Cookie和登录

**Q: Cookie导入后提示"无效"**

A:
1. 确保在KOOK网页版登录状态
2. 检查Cookie是否包含 `token` 字段
3. 尝试重新导出Cookie
4. 确认Cookie格式正确（JSON数组）

**Q: 账号状态显示"离线"**

A:
1. Cookie可能已过期，重新登录
2. 网络连接问题，检查网络
3. KOOK账号被封禁，联系客服

**Q: Chrome扩展无法安装**

A:
1. 确保Chrome版本≥88
2. 开启"开发者模式"
3. 拖拽整个文件夹到扩展页面
4. 或直接安装打包好的.crx文件

### ❓ 消息转发

**Q: 消息转发延迟很大（>10秒）**

A:
1. 检查网络连接
2. 查看队列是否积压
3. 降低映射数量
4. 检查目标平台是否限流

**Q: 图片转发失败**

A:
1. 检查图片大小（Discord限制8MB）
2. 切换到"智能模式"
3. 检查图床是否正常
4. 查看错误日志

**Q: 部分消息没有转发**

A:
1. 检查过滤规则
2. 查看消息去重记录
3. 确认映射关系正确
4. 检查目标平台连接状态

**Q: 表情符号显示为乱码**

A:
这是正常现象，不同平台表情编码不同
- KOOK的表情会转换为Unicode
- 部分平台不支持所有表情

### ❓ Bot配置

**Q: Discord Webhook测试失败**

A:
1. 检查URL是否完整复制
2. 确认Webhook未被删除
3. 检查频道权限
4. 尝试重新创建Webhook

**Q: Telegram Chat ID获取失败**

A:
1. 确保Bot已添加到群组
2. 在群组中发送任意消息
3. 使用手动获取方式
4. 检查Bot权限

**Q: 飞书应用测试失败**

A:
1. 确认应用已发布
2. 检查权限配置
3. Bot是否已添加到群组
4. App Secret是否正确

### ❓ 性能和稳定性

**Q: 系统占用内存过高**

A:
1. 关闭调试日志
2. 清理旧日志文件
3. 减少缓存时间
4. 重启服务

**Q: 经常掉线需要重启**

A:
1. 检查网络稳定性
2. 更新到最新版本
3. 查看系统日志找原因
4. 联系技术支持

**Q: CPU占用率过高**

A:
1. 减少监听的频道数量
2. 关闭实时监控页面
3. 降低日志级别
4. 检查是否有消息轰炸

---

## 故障排查

### 🔍 日志查看

**日志位置**

```
Windows: %USERPROFILE%\Documents\KookForwarder\logs
macOS: ~/Documents/KookForwarder/logs
Linux: ~/Documents/KookForwarder/logs
```

**日志文件**

```
backend.log - 后端服务日志
scraper.log - KOOK消息抓取日志
forwarder.log - 消息转发日志
error.log - 错误日志
```

**查看实时日志**

```bash
# Windows
type logs\backend.log

# macOS/Linux
tail -f logs/backend.log
```

### 🛠️ 常见错误码

**错误码对照表**

| 错误码 | 说明 | 解决方法 |
|--------|------|----------|
| E001 | Cookie无效 | 重新登录KOOK |
| E002 | 网络连接失败 | 检查网络 |
| E003 | Webhook URL无效 | 检查URL格式 |
| E004 | Bot Token错误 | 验证Token |
| E005 | 图片下载失败 | 检查图片URL |
| E006 | 数据库错误 | 重启服务 |
| E007 | 限流错误 | 降低发送频率 |

### 📞 获取支持

**问题反馈**

1. GitHub Issues: https://github.com/gfchfjh/CSBJJWT/issues
2. 附上以下信息：
   - 系统版本
   - 错误日志
   - 复现步骤
   - 环境信息

**社区支持**

- Discord: [加入服务器]
- Telegram: [加入群组]
- QQ群: [群号]

---

## 📖 相关文档

- [快速入门指南](tutorials/01-快速入门指南.md)
- [Cookie获取详细教程](tutorials/02-Cookie获取详细教程.md)
- [Discord配置教程](tutorials/03-Discord配置教程.md)
- [Telegram配置教程](tutorials/04-Telegram配置教程.md)
- [飞书配置教程](tutorials/05-飞书配置教程.md)
- [频道映射详解教程](tutorials/06-频道映射详解教程.md)
- [过滤规则使用技巧](tutorials/07-过滤规则使用技巧.md)
- [FAQ常见问题](tutorials/FAQ-常见问题.md)

---

**感谢使用KOOK消息转发系统！** 🎉

如有问题，请随时联系我们。
