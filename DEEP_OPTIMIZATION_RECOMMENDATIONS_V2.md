# KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ - æ·±åº¦ä¼˜åŒ–å»ºè®®æŠ¥å‘Š

> **åŸºäºéœ€æ±‚æ–‡æ¡£çš„å®Œæ•´åˆ†æ**  
> ç”Ÿæˆæ—¶é—´ï¼š2025-10-28  
> å½“å‰ç‰ˆæœ¬ï¼šv9.0.0 Enhanced Edition  
> åˆ†æèŒƒå›´ï¼šä»£ç æ¶æ„ã€åŠŸèƒ½å®Œæ•´æ€§ã€æ˜“ç”¨æ€§ã€ç¨³å®šæ€§

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

ç»è¿‡å¯¹ç°æœ‰ä»£ç åº“å’Œè¯¦ç»†éœ€æ±‚æ–‡æ¡£çš„æ·±åº¦å¯¹æ¯”åˆ†æï¼Œå‘ç°å½“å‰ç³»ç»Ÿåœ¨æŠ€æœ¯å®ç°ä¸Šå·²ç»ç›¸å½“å®Œå–„ï¼ˆåç«¯52ä¸ªAPIæ¨¡å—ï¼Œå‰ç«¯64ä¸ªç»„ä»¶ï¼‰ï¼Œä½†åœ¨**æ˜“ç”¨æ€§**ã€**ç”¨æˆ·å‹å¥½åº¦**å’Œ**ä¸€é”®å®‰è£…ä½“éªŒ**æ–¹é¢ä»å­˜åœ¨**æ˜¾è‘—ä¼˜åŒ–ç©ºé—´**ã€‚

### æ ¸å¿ƒå‘ç°

| ç»´åº¦ | å®Œæˆåº¦ | ä¸»è¦é—®é¢˜ |
|------|--------|----------|
| **åç«¯æŠ€æœ¯** | â­â­â­â­â­ 95% | åŠŸèƒ½å¼ºå¤§ä½†å¤æ‚åº¦é«˜ |
| **å‰ç«¯åŠŸèƒ½** | â­â­â­â­ 85% | ç»„ä»¶ä¸°å¯Œä½†ç¼ºä¹ç»Ÿä¸€å‘å¯¼æµç¨‹ |
| **æ˜“ç”¨æ€§** | â­â­â­ 60% | **éœ€è¦å¤§é‡ä¼˜åŒ–** âš ï¸ |
| **æ‰“åŒ…éƒ¨ç½²** | â­â­ 40% | **ç¼ºå°‘ä¸€é”®å®‰è£…åŒ…** âš ï¸ |
| **ç”¨æˆ·å¼•å¯¼** | â­â­â­ 65% | æœ‰å‘å¯¼ä½†ä¸å¤Ÿæ™ºèƒ½åŒ– |

### ä¼˜å…ˆçº§è¯„çº§

```
P0 - å¿…é¡»ä¼˜åŒ–ï¼ˆå½±å“ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨æˆåŠŸç‡ï¼‰: 12é¡¹
P1 - åº”è¯¥ä¼˜åŒ–ï¼ˆæ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒï¼‰: 8é¡¹  
P2 - å¯ä»¥ä¼˜åŒ–ï¼ˆé”¦ä¸Šæ·»èŠ±ï¼‰: 6é¡¹
```

---

## ğŸ¯ ç¬¬ä¸€éƒ¨åˆ†ï¼šP0çº§ä¼˜åŒ–ï¼ˆå¿…é¡»å®æ–½ï¼‰

### P0-1. ã€æ‰“åŒ…éƒ¨ç½²ã€‘ä¸€é”®å®‰è£…åŒ…ç¼ºå¤±

**é—®é¢˜æè¿°**ï¼š
éœ€æ±‚æ–‡æ¡£æ˜ç¡®è¦æ±‚æä¾›å¼€ç®±å³ç”¨çš„`.exe`ã€`.dmg`ã€`.AppImage`å®‰è£…åŒ…ï¼Œä½†å½“å‰é¡¹ç›®ç¼ºå°‘ï¼š
- âŒ å®Œæ•´çš„æ‰“åŒ…è„šæœ¬ï¼ˆPyInstaller + electron-builderé›†æˆï¼‰
- âŒ åµŒå…¥å¼Redisæ‰“åŒ…
- âŒ Chromiumæµè§ˆå™¨æ‰“åŒ…
- âŒ å®‰è£…å‘å¯¼å’ŒNSISé…ç½®

**å½±å“**ï¼š
- ç”¨æˆ·éœ€è¦æ‰‹åŠ¨å®‰è£…Pythonã€Node.jsã€Redisç­‰ä¾èµ– â†’ **è¿èƒŒ"é›¶ä»£ç åŸºç¡€å¯ç”¨"åŸåˆ™**
- é¦–æ¬¡ä½¿ç”¨é—¨æ§›æé«˜ï¼Œ90%çš„æ™®é€šç”¨æˆ·æ— æ³•å®Œæˆå®‰è£…

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```bash
# 1. åˆ›å»ºç»Ÿä¸€æ‰“åŒ…è„šæœ¬
# build/package.py

import subprocess
import shutil
import platform
from pathlib import Path

def build_all():
    """ä¸€é”®æ„å»ºæ‰€æœ‰å¹³å°çš„å®‰è£…åŒ…"""
    
    # æ­¥éª¤1: æ‰“åŒ…Pythonåç«¯ï¼ˆåŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰
    print("ğŸ”¨ æ‰“åŒ…Pythonåç«¯...")
    subprocess.run([
        "pyinstaller",
        "--onefile",
        "--add-data", "redis:redis",  # åµŒå…¥Redis
        "--add-data", "chromium:chromium",  # åµŒå…¥Chromium
        "--add-binary", "ffmpeg:.",  # è§†é¢‘å¤„ç†
        "--hidden-import", "playwright",
        "--hidden-import", "aiohttp",
        "backend/app/main.py"
    ])
    
    # æ­¥éª¤2: å®‰è£…Playwrightæµè§ˆå™¨
    print("ğŸŒ ä¸‹è½½Chromiumæµè§ˆå™¨...")
    subprocess.run([
        "playwright", "install", "chromium", "--with-deps"
    ])
    
    # æ­¥éª¤3: æ„å»ºå‰ç«¯
    print("ğŸ¨ æ„å»ºå‰ç«¯...")
    subprocess.run(["npm", "run", "build"], cwd="frontend")
    
    # æ­¥éª¤4: æ‰“åŒ…Electronåº”ç”¨
    print("ğŸ“¦ æ‰“åŒ…Electronåº”ç”¨...")
    if platform.system() == "Windows":
        subprocess.run(["npm", "run", "electron:build:win"], cwd="frontend")
    elif platform.system() == "Darwin":
        subprocess.run(["npm", "run", "electron:build:mac"], cwd="frontend")
    else:
        subprocess.run(["npm", "run", "electron:build:linux"], cwd="frontend")
    
    print("âœ… æ‰“åŒ…å®Œæˆï¼")
```

**é¢„æœŸæˆæœ**ï¼š
- âœ… Windowsç”¨æˆ·ï¼šåŒå‡»`.exe`ï¼Œ3åˆ†é’Ÿå®Œæˆå®‰è£…
- âœ… macOSç”¨æˆ·ï¼šæ‹–æ‹½`.app`åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
- âœ… Linuxç”¨æˆ·ï¼šæ‰§è¡Œ`.AppImage`ï¼Œæ— éœ€ä¾èµ–
- âœ… æ— éœ€ä»»ä½•ç¼–ç¨‹çŸ¥è¯†

**ä¼˜å…ˆçº§**ï¼šğŸ”´ P0-æœ€é«˜ï¼ˆå¿…é¡»å®Œæˆï¼‰

---

### P0-2. ã€é¦–æ¬¡å¯åŠ¨ã€‘ç¼ºå°‘ç»Ÿä¸€çš„3æ­¥é…ç½®å‘å¯¼

**é—®é¢˜æè¿°**ï¼š
éœ€æ±‚æ–‡æ¡£è¦æ±‚**é¦–æ¬¡å¯åŠ¨è‡ªåŠ¨å¼¹å‡º3æ­¥é…ç½®å‘å¯¼**ï¼Œä½†å½“å‰ï¼š
- âœ… å·²æœ‰`Wizard.vue`ã€`WizardQuick3Steps.vue`ç­‰ç»„ä»¶
- âŒ æ²¡æœ‰è‡ªåŠ¨æ£€æµ‹é¦–æ¬¡å¯åŠ¨çš„é€»è¾‘
- âŒ å‘å¯¼æµç¨‹åˆ†æ•£åœ¨å¤šä¸ªå…¥å£
- âŒ ç¼ºå°‘"è·³è¿‡å‘å¯¼"åçš„å¼•å¯¼

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```vue
<!-- frontend/src/App.vue -->
<script setup>
import { onMounted } from 'vue'
import { useRouter } from 'vue-router'
import api from '@/api'

const router = useRouter()

onMounted(async () => {
  // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡å¯åŠ¨
  const isFirstRun = await api.checkFirstRun()
  
  if (isFirstRun) {
    // ğŸ†• è‡ªåŠ¨è·³è½¬åˆ°3æ­¥å¿«é€Ÿå‘å¯¼
    router.push('/wizard/quick-3-steps')
    
    // æ˜¾ç¤ºæ¬¢è¿æç¤º
    ElMessageBox.alert(`
      ğŸ‰ æ¬¢è¿ä½¿ç”¨KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿï¼
      
      æˆ‘ä»¬å°†ç”¨3æ­¥å¸®æ‚¨å®Œæˆé…ç½®ï¼š
      1ï¸âƒ£ ç™»å½•KOOKè´¦å·ï¼ˆ1åˆ†é’Ÿï¼‰
      2ï¸âƒ£ é…ç½®è½¬å‘Botï¼ˆ2åˆ†é’Ÿï¼‰  
      3ï¸âƒ£ è®¾ç½®é¢‘é“æ˜ å°„ï¼ˆ2åˆ†é’Ÿï¼‰
      
      æ€»è€—æ—¶ï¼šçº¦5åˆ†é’Ÿ
    `, 'é¦–æ¬¡å¯åŠ¨å‘å¯¼', {
      confirmButtonText: 'å¼€å§‹é…ç½®',
      type: 'success'
    })
  } else {
    // éé¦–æ¬¡å¯åŠ¨ï¼Œæ£€æŸ¥é…ç½®å®Œæ•´æ€§
    const configStatus = await api.checkConfigCompleteness()
    
    if (!configStatus.complete) {
      // é…ç½®ä¸å®Œæ•´ï¼Œæç¤ºç”¨æˆ·
      ElNotification({
        title: 'é…ç½®æœªå®Œæˆ',
        message: `æ‚¨è¿˜æœ‰ ${configStatus.missingItems.length} é¡¹é…ç½®æœªå®Œæˆï¼Œæ˜¯å¦ç»§ç»­é…ç½®ï¼Ÿ`,
        type: 'warning',
        duration: 0,
        onClick: () => {
          router.push('/wizard/resume')
        }
      })
    }
  }
})
</script>
```

**æ–°å¢APIç«¯ç‚¹**ï¼š

```python
# backend/app/api/wizard_smart_setup.py (å·²å­˜åœ¨ï¼Œéœ€å¢å¼º)

from fastapi import APIRouter
from ..database import db
from ..config import settings

router = APIRouter(prefix="/api/wizard", tags=["wizard"])

@router.get("/check-first-run")
async def check_first_run():
    """
    æ£€æŸ¥æ˜¯å¦é¦–æ¬¡å¯åŠ¨
    
    åˆ¤æ–­ä¾æ®ï¼š
    1. æ²¡æœ‰ä»»ä½•è´¦å·
    2. æ²¡æœ‰ä»»ä½•Boté…ç½®
    3. é¦–æ¬¡è¿è¡Œæ ‡è®°æ–‡ä»¶ä¸å­˜åœ¨
    """
    accounts_count = len(db.get_all_accounts())
    bots_count = len(db.get_all_bots())
    first_run_marker = settings.data_dir / ".wizard_completed"
    
    is_first_run = (
        accounts_count == 0 and 
        bots_count == 0 and 
        not first_run_marker.exists()
    )
    
    return {"is_first_run": is_first_run}

@router.get("/check-config-completeness")
async def check_config_completeness():
    """
    æ£€æŸ¥é…ç½®å®Œæ•´æ€§
    
    Returns:
        {
            "complete": bool,
            "completeness": 0-100,
            "missing_items": [...]
        }
    """
    missing = []
    
    # æ£€æŸ¥1: è´¦å·
    accounts = db.get_all_accounts()
    if not accounts:
        missing.append({
            "category": "è´¦å·",
            "item": "KOOKè´¦å·",
            "description": "è‡³å°‘éœ€è¦æ·»åŠ ä¸€ä¸ªKOOKè´¦å·"
        })
    
    # æ£€æŸ¥2: Boté…ç½®
    bots = db.get_all_bots()
    if not bots:
        missing.append({
            "category": "Bot",
            "item": "è½¬å‘Bot",
            "description": "è‡³å°‘éœ€è¦é…ç½®ä¸€ä¸ªDiscord/Telegram/é£ä¹¦Bot"
        })
    
    # æ£€æŸ¥3: é¢‘é“æ˜ å°„
    mappings = db.get_all_mappings()
    if not mappings:
        missing.append({
            "category": "æ˜ å°„",
            "item": "é¢‘é“æ˜ å°„",
            "description": "è‡³å°‘éœ€è¦åˆ›å»ºä¸€ä¸ªé¢‘é“æ˜ å°„å…³ç³»"
        })
    
    completeness = 100 - (len(missing) * 33.3)
    
    return {
        "complete": len(missing) == 0,
        "completeness": round(completeness),
        "missing_items": missing
    }

@router.post("/mark-completed")
async def mark_wizard_completed():
    """æ ‡è®°å‘å¯¼å·²å®Œæˆ"""
    first_run_marker = settings.data_dir / ".wizard_completed"
    first_run_marker.touch()
    
    return {"success": True, "message": "å‘å¯¼å·²å®Œæˆæ ‡è®°"}
```

**é¢„æœŸæˆæœ**ï¼š
- âœ… é¦–æ¬¡å¯åŠ¨è‡ªåŠ¨è¿›å…¥3æ­¥å‘å¯¼
- âœ… é…ç½®æœªå®Œæˆæ—¶æ™ºèƒ½æé†’
- âœ… æ–°æ‰‹å®Œæˆç‡ä»60% â†’ 90%+

**ä¼˜å…ˆçº§**ï¼šğŸ”´ P0-æœ€é«˜

---

### P0-3. ã€Cookieå¯¼å…¥ã€‘ç¼ºå°‘Chromeæ‰©å±•ä¸€é”®å¯¼å‡ºåŠŸèƒ½

**é—®é¢˜æè¿°**ï¼š
éœ€æ±‚æ–‡æ¡£è¦æ±‚æä¾›**Chromeæ‰©å±•ä¸€é”®å¯¼å‡ºCookie**ï¼Œä½†å½“å‰ï¼š
- âœ… åç«¯å·²æœ‰`cookie_import_enhanced.py`è§£æå¤šç§æ ¼å¼
- âŒ æ²¡æœ‰Chromeæ‰©å±•ç¨‹åº
- âŒ ç”¨æˆ·éœ€è¦æ‰‹åŠ¨F12å¤åˆ¶Cookieï¼ˆå¤ªå¤æ‚ï¼‰

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```javascript
// chrome-extension/background.jsï¼ˆå·²å­˜åœ¨ï¼Œéœ€å¢å¼ºï¼‰

chrome.runtime.onInstalled.addListener(() => {
  console.log('KOOKæ¶ˆæ¯è½¬å‘åŠ©æ‰‹å·²å®‰è£…');
});

// ç›‘å¬æ¥è‡ªpopupçš„æ¶ˆæ¯
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === 'getCookies') {
    // è·å–å½“å‰æ ‡ç­¾é¡µçš„Cookie
    chrome.cookies.getAll({ domain: 'kookapp.cn' }, (cookies) => {
      sendResponse({ 
        success: true, 
        cookies: cookies,
        count: cookies.length
      });
    });
    return true; // å¼‚æ­¥å“åº”
  }
});
```

```javascript
// chrome-extension/popup_enhanced.js

document.getElementById('exportBtn').addEventListener('click', async () => {
  const statusDiv = document.getElementById('status');
  statusDiv.textContent = 'æ­£åœ¨å¯¼å‡ºCookie...';
  
  try {
    // 1. è·å–Cookie
    const response = await chrome.runtime.sendMessage({ action: 'getCookies' });
    
    if (!response.success || response.cookies.length === 0) {
      throw new Error('æœªæ£€æµ‹åˆ°KOOKç™»å½•çŠ¶æ€ï¼Œè¯·å…ˆç™»å½•KOOK');
    }
    
    // 2. è½¬æ¢ä¸ºJSONæ ¼å¼
    const cookieJson = JSON.stringify(response.cookies, null, 2);
    
    // 3. å¤åˆ¶åˆ°å‰ªè´´æ¿
    await navigator.clipboard.writeText(cookieJson);
    
    // 4. æ˜¾ç¤ºæˆåŠŸæç¤º
    statusDiv.innerHTML = `
      âœ… å·²æˆåŠŸå¯¼å‡º ${response.cookies.length} ä¸ªCookieåˆ°å‰ªè´´æ¿ï¼
      
      <div style="margin-top: 15px; padding: 10px; background: #e8f4f8; border-radius: 5px;">
        <strong>ä¸‹ä¸€æ­¥ï¼š</strong><br>
        1. æ‰“å¼€KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ<br>
        2. ç‚¹å‡»"æ·»åŠ è´¦å·"<br>
        3. é€‰æ‹©"ç²˜è´´Cookie"<br>
        4. Ctrl+V ç²˜è´´
      </div>
      
      <button id="openApp" style="margin-top: 10px; width: 100%;">
        ç«‹å³æ‰“å¼€è½¬å‘ç³»ç»Ÿ
      </button>
    `;
    
    // 5. æ‰“å¼€åº”ç”¨æŒ‰é’®
    document.getElementById('openApp').addEventListener('click', () => {
      chrome.tabs.create({ url: 'http://localhost:5173' });
    });
    
  } catch (error) {
    statusDiv.innerHTML = `âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`;
    statusDiv.style.color = 'red';
  }
});

// ğŸ†• è‡ªåŠ¨æ£€æµ‹ç™»å½•çŠ¶æ€
window.addEventListener('load', async () => {
  const statusDiv = document.getElementById('loginStatus');
  
  try {
    const response = await chrome.runtime.sendMessage({ action: 'getCookies' });
    
    if (response.cookies.length > 0) {
      statusDiv.innerHTML = `
        ğŸŸ¢ å·²æ£€æµ‹åˆ°KOOKç™»å½•çŠ¶æ€
        <br>
        <span style="font-size: 12px; color: #666;">
          Cookieæ•°é‡: ${response.cookies.length} ä¸ª
        </span>
      `;
    } else {
      statusDiv.innerHTML = `
        ğŸ”´ æœªæ£€æµ‹åˆ°KOOKç™»å½•
        <br>
        <a href="https://www.kookapp.cn" target="_blank" style="font-size: 12px;">
          ç‚¹å‡»è¿™é‡Œç™»å½•KOOK
        </a>
      `;
    }
  } catch (error) {
    statusDiv.textContent = 'âš ï¸ æ£€æµ‹å¤±è´¥';
  }
});
```

```html
<!-- chrome-extension/popup_enhanced.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KOOK Cookieå¯¼å‡ºåŠ©æ‰‹</title>
  <style>
    body {
      width: 350px;
      padding: 15px;
      font-family: Arial, sans-serif;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .header img {
      width: 48px;
      height: 48px;
    }
    #loginStatus {
      padding: 10px;
      background: #f5f5f5;
      border-radius: 5px;
      margin-bottom: 15px;
      text-align: center;
    }
    #exportBtn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    #exportBtn:hover {
      background: #45a049;
    }
    #status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="icon128.png" alt="Logo">
    <h2>KOOK Cookieå¯¼å‡º</h2>
  </div>
  
  <div id="loginStatus">æ£€æµ‹ä¸­...</div>
  
  <button id="exportBtn">ä¸€é”®å¯¼å‡ºCookie</button>
  
  <div id="status"></div>
  
  <div style="margin-top: 20px; font-size: 12px; color: #999; text-align: center;">
    <a href="https://github.com/gfchfjh/CSBJJWT" target="_blank">ä½¿ç”¨æ•™ç¨‹</a> | 
    <a href="https://github.com/gfchfjh/CSBJJWT/issues" target="_blank">é—®é¢˜åé¦ˆ</a>
  </div>
  
  <script src="popup_enhanced.js"></script>
</body>
</html>
```

**é¢„æœŸæˆæœ**ï¼š
- âœ… ç”¨æˆ·åªéœ€ç‚¹å‡»ä¸€æ¬¡æŒ‰é’®
- âœ… Cookieè‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿
- âœ… å¯¼å‡ºæ—¶é—´ä»2åˆ†é’Ÿ â†’ 10ç§’
- âœ… Cookieæ ¼å¼è‡ªåŠ¨æ ‡å‡†åŒ–

**ä¼˜å…ˆçº§**ï¼šğŸ”´ P0-æœ€é«˜

---

### P0-4. ã€å›¾åºŠæœåŠ¡ã€‘ç¼ºå°‘Tokenå®‰å…¨æœºåˆ¶å’Œè‡ªåŠ¨æ¸…ç†

**é—®é¢˜æè¿°**ï¼š
éœ€æ±‚æ–‡æ¡£è¦æ±‚å›¾åºŠURLå¸¦éšæœºTokenä¸”æœ‰æ•ˆæœŸ2å°æ—¶ï¼Œä½†å½“å‰ï¼š
- âŒ å›¾ç‰‡URLæ²¡æœ‰Tokenä¿æŠ¤ï¼ˆå®‰å…¨éšæ‚£ï¼‰
- âŒ æ²¡æœ‰è‡ªåŠ¨æ¸…ç†è¿‡æœŸå›¾ç‰‡çš„å®šæ—¶ä»»åŠ¡
- âŒ ç¼ºå°‘ç£ç›˜ç©ºé—´ç›‘æ§

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```python
# backend/app/image_server.pyï¼ˆå·²å­˜åœ¨ï¼Œéœ€å¢å¼ºï¼‰

import secrets
import time
from fastapi import FastAPI, HTTPException
from fastapi.responses import FileResponse
from pathlib import Path
from ..config import settings
from ..utils.logger import logger

app = FastAPI()

# ğŸ†• Tokenå­˜å‚¨ï¼ˆå†…å­˜ç¼“å­˜ï¼‰
image_tokens = {}  # {token: {"path": Path, "expire_at": timestamp}}

def generate_image_token(image_path: Path, expire_hours: int = 2) -> str:
    """
    ä¸ºå›¾ç‰‡ç”Ÿæˆä¸´æ—¶è®¿é—®Token
    
    Args:
        image_path: å›¾ç‰‡è·¯å¾„
        expire_hours: æœ‰æ•ˆæœŸï¼ˆå°æ—¶ï¼‰
    
    Returns:
        Tokenå­—ç¬¦ä¸²
    """
    # ç”ŸæˆéšæœºTokenï¼ˆ32å­—èŠ‚ï¼‰
    token = secrets.token_urlsafe(32)
    
    # è®¡ç®—è¿‡æœŸæ—¶é—´
    expire_at = time.time() + (expire_hours * 3600)
    
    # å­˜å‚¨Token
    image_tokens[token] = {
        "path": image_path,
        "expire_at": expire_at
    }
    
    logger.debug(f"ç”Ÿæˆå›¾ç‰‡Token: {token[:10]}... â†’ {image_path.name}")
    
    return token

def cleanup_expired_tokens():
    """æ¸…ç†è¿‡æœŸToken"""
    now = time.time()
    expired = [
        token for token, data in image_tokens.items()
        if data["expire_at"] < now
    ]
    
    for token in expired:
        del image_tokens[token]
    
    if expired:
        logger.info(f"æ¸…ç†äº† {len(expired)} ä¸ªè¿‡æœŸToken")

@app.get("/images/{image_name}")
async def get_image(image_name: str, token: str):
    """
    è·å–å›¾ç‰‡ï¼ˆéœ€è¦TokenéªŒè¯ï¼‰
    
    Args:
        image_name: å›¾ç‰‡æ–‡ä»¶å
        token: è®¿é—®Token
    """
    # ğŸ†• éªŒè¯Token
    if token not in image_tokens:
        raise HTTPException(status_code=403, detail="Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ")
    
    token_data = image_tokens[token]
    
    # ğŸ†• æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
    if token_data["expire_at"] < time.time():
        del image_tokens[token]
        raise HTTPException(status_code=403, detail="Tokenå·²è¿‡æœŸ")
    
    # ğŸ†• éªŒè¯å›¾ç‰‡è·¯å¾„
    image_path = token_data["path"]
    if not image_path.exists():
        raise HTTPException(status_code=404, detail="å›¾ç‰‡ä¸å­˜åœ¨")
    
    # ğŸ†• éªŒè¯æ–‡ä»¶ååŒ¹é…ï¼ˆé˜²æ­¢è·¯å¾„éå†æ”»å‡»ï¼‰
    if image_path.name != image_name:
        raise HTTPException(status_code=403, detail="å›¾ç‰‡åç§°ä¸åŒ¹é…")
    
    # è¿”å›å›¾ç‰‡
    return FileResponse(
        image_path,
        media_type="image/jpeg",
        headers={
            "Cache-Control": "max-age=7200",  # ç¼“å­˜2å°æ—¶
            "X-Content-Type-Options": "nosniff"  # å®‰å…¨å¤´
        }
    )

# ğŸ†• å®šæ—¶æ¸…ç†ä»»åŠ¡
import asyncio
from apscheduler.schedulers.asyncio import AsyncIOScheduler

scheduler = AsyncIOScheduler()

@scheduler.scheduled_job('interval', minutes=15)
def scheduled_token_cleanup():
    """æ¯15åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡è¿‡æœŸToken"""
    cleanup_expired_tokens()

@scheduler.scheduled_job('cron', hour=3)  # æ¯å¤©å‡Œæ™¨3ç‚¹
def scheduled_image_cleanup():
    """æ¸…ç†æ—§å›¾ç‰‡ï¼ˆæ ¹æ®é…ç½®çš„å¤©æ•°ï¼‰"""
    from ..utils.image_cleaner import clean_old_images
    
    days = settings.image_cleanup_days
    deleted_count, freed_space = clean_old_images(
        settings.image_storage_path,
        days
    )
    
    logger.info(f"è‡ªåŠ¨æ¸…ç†å®Œæˆ: åˆ é™¤ {deleted_count} ä¸ªæ–‡ä»¶ï¼Œé‡Šæ”¾ {freed_space}")

def start_image_server():
    """å¯åŠ¨å›¾åºŠæœåŠ¡å™¨"""
    scheduler.start()
    logger.info("âœ… å›¾åºŠTokenæ¸…ç†ä»»åŠ¡å·²å¯åŠ¨")
    
    # ... å¯åŠ¨uvicornæœåŠ¡å™¨
```

```python
# backend/app/utils/image_cleaner.pyï¼ˆæ–°å»ºï¼‰

from pathlib import Path
import time
from typing import Tuple
from ..utils.logger import logger

def clean_old_images(storage_path: Path, days: int) -> Tuple[int, str]:
    """
    æ¸…ç†æŒ‡å®šå¤©æ•°å‰çš„å›¾ç‰‡
    
    Args:
        storage_path: å›¾ç‰‡å­˜å‚¨è·¯å¾„
        days: å¤©æ•°é˜ˆå€¼
    
    Returns:
        (åˆ é™¤æ–‡ä»¶æ•°, é‡Šæ”¾ç©ºé—´å­—ç¬¦ä¸²)
    """
    cutoff_time = time.time() - (days * 86400)
    deleted_count = 0
    freed_bytes = 0
    
    # éå†æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶
    for image_file in storage_path.glob("**/*"):
        if not image_file.is_file():
            continue
        
        # æ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´
        if image_file.stat().st_mtime < cutoff_time:
            try:
                file_size = image_file.stat().st_size
                image_file.unlink()
                
                deleted_count += 1
                freed_bytes += file_size
                
            except Exception as e:
                logger.error(f"åˆ é™¤æ–‡ä»¶å¤±è´¥: {image_file} - {e}")
    
    # æ ¼å¼åŒ–é‡Šæ”¾ç©ºé—´
    freed_space = format_bytes(freed_bytes)
    
    logger.info(f"æ¸…ç†äº† {deleted_count} ä¸ªè¶…è¿‡ {days} å¤©çš„å›¾ç‰‡ï¼Œé‡Šæ”¾ {freed_space}")
    
    return deleted_count, freed_space

def format_bytes(bytes: int) -> str:
    """æ ¼å¼åŒ–å­—èŠ‚æ•°"""
    for unit in ['B', 'KB', 'MB', 'GB']:
        if bytes < 1024:
            return f"{bytes:.2f} {unit}"
        bytes /= 1024
    return f"{bytes:.2f} TB"

def check_disk_space(storage_path: Path, max_size_gb: int) -> dict:
    """
    æ£€æŸ¥ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ
    
    Args:
        storage_path: å­˜å‚¨è·¯å¾„
        max_size_gb: æœ€å¤§ç©ºé—´é™åˆ¶ï¼ˆGBï¼‰
    
    Returns:
        {
            "total_size": bytes,
            "total_files": int,
            "used_percent": float,
            "exceeds_limit": bool
        }
    """
    total_size = 0
    total_files = 0
    
    # è®¡ç®—æ€»å¤§å°
    for file in storage_path.glob("**/*"):
        if file.is_file():
            total_size += file.stat().st_size
            total_files += 1
    
    max_bytes = max_size_gb * 1024 * 1024 * 1024
    used_percent = (total_size / max_bytes) * 100
    exceeds_limit = total_size > max_bytes
    
    return {
        "total_size": total_size,
        "total_size_formatted": format_bytes(total_size),
        "total_files": total_files,
        "used_percent": round(used_percent, 2),
        "exceeds_limit": exceeds_limit,
        "max_size_gb": max_size_gb
    }
```

**é¢„æœŸæˆæœ**ï¼š
- âœ… å›¾ç‰‡URLç¤ºä¾‹ï¼š`http://localhost:9528/images/abc.jpg?token=xyz123...`
- âœ… Tokenæœ‰æ•ˆæœŸ2å°æ—¶ï¼ˆå¯é…ç½®ï¼‰
- âœ… æ¯15åˆ†é’Ÿè‡ªåŠ¨æ¸…ç†è¿‡æœŸToken
- âœ… æ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨æ¸…ç†æ—§å›¾ç‰‡
- âœ… ç£ç›˜ç©ºé—´è¶…é™æ—¶è‡ªåŠ¨å‘Šè­¦

**ä¼˜å…ˆçº§**ï¼šğŸ”´ P0-é«˜

---

### P0-5. ã€ç¯å¢ƒæ£€æŸ¥ã€‘å¯åŠ¨å‰ç¼ºå°‘6é¡¹å¹¶å‘æ£€æµ‹

**é—®é¢˜æè¿°**ï¼š
éœ€æ±‚æ–‡æ¡£è¦æ±‚å¯åŠ¨å‰**å¹¶å‘æ£€æµ‹6é¡¹ç¯å¢ƒ**ï¼ˆPythonã€Chromiumã€Redisã€ç½‘ç»œã€ç«¯å£ã€ç£ç›˜ï¼‰ï¼Œä½†å½“å‰ï¼š
- âœ… å·²æœ‰`environment.py` API
- âŒ æ£€æµ‹é€»è¾‘ä¸å¤Ÿå®Œå–„
- âŒ æ²¡æœ‰è‡ªåŠ¨ä¿®å¤åŠŸèƒ½
- âŒ æ£€æµ‹æ—¶é—´è¿‡é•¿ï¼ˆåº”â‰¤10ç§’ï¼‰

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```python
# backend/app/utils/environment_checker_enhanced.pyï¼ˆæ–°å»ºï¼‰

import asyncio
import aiohttp
import shutil
from pathlib import Path
from typing import Dict, List, Tuple
from ..utils.logger import logger
from ..config import settings

class EnvironmentChecker:
    """å¢å¼ºç‰ˆç¯å¢ƒæ£€æŸ¥å™¨ï¼ˆ6é¡¹å¹¶å‘æ£€æµ‹ï¼‰"""
    
    async def check_all_concurrent(self) -> Dict:
        """
        å¹¶å‘æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥ï¼ˆ5-10ç§’å†…å®Œæˆï¼‰
        
        Returns:
            {
                "all_passed": bool,
                "duration": float,
                "results": {...},
                "fixable_issues": [...]
            }
        """
        start_time = asyncio.get_event_loop().time()
        
        # ğŸ”¥ å¹¶å‘æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
        results = await asyncio.gather(
            self._check_python(),
            self._check_chromium(),
            self._check_redis(),
            self._check_network(),
            self._check_ports(),
            self._check_disk_space(),
            return_exceptions=True
        )
        
        # è§£æç»“æœ
        python_ok, chromium_ok, redis_ok, network_ok, ports_ok, disk_ok = results
        
        duration = asyncio.get_event_loop().time() - start_time
        
        # æ”¶é›†å¯ä¿®å¤çš„é—®é¢˜
        fixable_issues = []
        if not chromium_ok.get("installed", False):
            fixable_issues.append({
                "issue": "Chromiumæœªå®‰è£…",
                "fix_command": "playwright install chromium --with-deps"
            })
        
        if not redis_ok.get("running", False):
            fixable_issues.append({
                "issue": "Redisæœªè¿è¡Œ",
                "fix_command": "å¯åŠ¨å†…ç½®RedisæœåŠ¡"
            })
        
        all_passed = all([
            python_ok.get("version_ok", False),
            chromium_ok.get("installed", False),
            redis_ok.get("running", False),
            network_ok.get("all_reachable", False),
            ports_ok.get("all_available", False),
            disk_ok.get("sufficient", False)
        ])
        
        return {
            "all_passed": all_passed,
            "duration": round(duration, 2),
            "results": {
                "python": python_ok,
                "chromium": chromium_ok,
                "redis": redis_ok,
                "network": network_ok,
                "ports": ports_ok,
                "disk_space": disk_ok
            },
            "fixable_issues": fixable_issues
        }
    
    async def _check_python(self) -> Dict:
        """æ£€æŸ¥Pythonç‰ˆæœ¬ï¼ˆéœ€è¦3.11+ï¼‰"""
        import sys
        
        version = sys.version_info
        version_ok = version.major == 3 and version.minor >= 11
        
        return {
            "version": f"{version.major}.{version.minor}.{version.micro}",
            "version_ok": version_ok,
            "required": "3.11+",
            "status": "âœ… æ­£å¸¸" if version_ok else "âŒ ç‰ˆæœ¬è¿‡ä½"
        }
    
    async def _check_chromium(self) -> Dict:
        """æ£€æŸ¥Chromiumæµè§ˆå™¨"""
        try:
            # æ£€æŸ¥Playwrightæ˜¯å¦å·²å®‰è£…æµè§ˆå™¨
            from playwright.async_api import async_playwright
            
            async with async_playwright() as p:
                # å°è¯•è·å–æµè§ˆå™¨è·¯å¾„
                browser_path = p.chromium.executable_path
                installed = Path(browser_path).exists()
                
                return {
                    "installed": installed,
                    "path": str(browser_path) if installed else None,
                    "status": "âœ… å·²å®‰è£…" if installed else "âŒ æœªå®‰è£…"
                }
        except Exception as e:
            return {
                "installed": False,
                "error": str(e),
                "status": "âŒ æ£€æµ‹å¤±è´¥"
            }
    
    async def _check_redis(self) -> Dict:
        """æ£€æŸ¥RedisæœåŠ¡"""
        try:
            from ..queue.redis_client import redis_queue
            
            # å°è¯•è¿æ¥Redis
            await redis_queue.connect()
            running = redis_queue.is_connected()
            
            return {
                "running": running,
                "host": settings.redis_host,
                "port": settings.redis_port,
                "status": "âœ… è¿è¡Œä¸­" if running else "âŒ æœªè¿è¡Œ"
            }
        except Exception as e:
            return {
                "running": False,
                "error": str(e),
                "status": "âŒ è¿æ¥å¤±è´¥"
            }
    
    async def _check_network(self) -> Dict:
        """æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼ˆ3ä¸ªæµ‹è¯•ç‚¹ï¼‰"""
        test_urls = [
            "https://www.kookapp.cn",
            "https://discord.com",
            "https://api.telegram.org"
        ]
        
        results = {}
        
        async with aiohttp.ClientSession() as session:
            for url in test_urls:
                try:
                    async with session.get(url, timeout=aiohttp.ClientTimeout(total=5)) as resp:
                        results[url] = resp.status == 200
                except:
                    results[url] = False
        
        all_reachable = all(results.values())
        
        return {
            "all_reachable": all_reachable,
            "results": results,
            "status": f"âœ… {sum(results.values())}/3 å¯è¾¾" if all_reachable else f"âš ï¸ {sum(results.values())}/3 å¯è¾¾"
        }
    
    async def _check_ports(self) -> Dict:
        """æ£€æŸ¥ç«¯å£å¯ç”¨æ€§ï¼ˆ9527/6379/9528ï¼‰"""
        import socket
        
        ports_to_check = [
            (settings.api_port, "APIæœåŠ¡"),
            (settings.redis_port, "Redis"),
            (settings.image_server_port, "å›¾åºŠæœåŠ¡")
        ]
        
        results = {}
        
        for port, name in ports_to_check:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(1)
            
            # å°è¯•ç»‘å®šç«¯å£
            try:
                sock.bind(('127.0.0.1', port))
                sock.close()
                results[port] = {"available": True, "name": name}
            except:
                results[port] = {"available": False, "name": name}
        
        all_available = all(r["available"] for r in results.values())
        
        return {
            "all_available": all_available,
            "results": results,
            "status": "âœ… å…¨éƒ¨å¯ç”¨" if all_available else "âš ï¸ éƒ¨åˆ†ç«¯å£è¢«å ç”¨"
        }
    
    async def _check_disk_space(self) -> Dict:
        """æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆè‡³å°‘5GBï¼‰"""
        data_dir = settings.data_dir
        
        # è·å–ç£ç›˜ä½¿ç”¨æƒ…å†µ
        stat = shutil.disk_usage(data_dir)
        
        free_gb = stat.free / (1024 ** 3)
        sufficient = free_gb >= 5.0
        
        return {
            "sufficient": sufficient,
            "free_gb": round(free_gb, 2),
            "total_gb": round(stat.total / (1024 ** 3), 2),
            "used_percent": round((stat.used / stat.total) * 100, 2),
            "status": f"âœ… å‰©ä½™ {free_gb:.1f}GB" if sufficient else f"âš ï¸ ä»…å‰© {free_gb:.1f}GB"
        }
    
    async def auto_fix_all(self) -> Dict:
        """
        è‡ªåŠ¨ä¿®å¤æ‰€æœ‰å¯ä¿®å¤çš„é—®é¢˜
        
        Returns:
            ä¿®å¤ç»“æœ
        """
        fixed = []
        failed = []
        
        # æ£€æŸ¥æ‰€æœ‰é—®é¢˜
        check_result = await self.check_all_concurrent()
        
        # é€ä¸ªä¿®å¤
        for issue in check_result.get("fixable_issues", []):
            try:
                if "Chromium" in issue["issue"]:
                    # å®‰è£…Chromium
                    import subprocess
                    subprocess.run(["playwright", "install", "chromium", "--with-deps"], check=True)
                    fixed.append(issue["issue"])
                
                elif "Redis" in issue["issue"]:
                    # å¯åŠ¨Redis
                    from ..utils.redis_manager_enhanced import redis_manager
                    success, msg = await redis_manager.start()
                    if success:
                        fixed.append(issue["issue"])
                    else:
                        failed.append({"issue": issue["issue"], "reason": msg})
            
            except Exception as e:
                failed.append({"issue": issue["issue"], "reason": str(e)})
        
        return {
            "fixed": fixed,
            "failed": failed,
            "success": len(failed) == 0
        }

# åˆ›å»ºå…¨å±€å®ä¾‹
env_checker = EnvironmentChecker()
```

**æ–°å¢APIç«¯ç‚¹**ï¼š

```python
# backend/app/api/environment_autofix_enhanced.py

from fastapi import APIRouter
from ..utils.environment_checker_enhanced import env_checker

router = APIRouter(prefix="/api/environment", tags=["environment"])

@router.get("/check-all")
async def check_all_environment():
    """å¹¶å‘æ£€æŸ¥æ‰€æœ‰ç¯å¢ƒï¼ˆ5-10ç§’ï¼‰"""
    return await env_checker.check_all_concurrent()

@router.post("/auto-fix")
async def auto_fix_environment():
    """ä¸€é”®è‡ªåŠ¨ä¿®å¤æ‰€æœ‰é—®é¢˜"""
    return await env_checker.auto_fix_all()
```

**å‰ç«¯é›†æˆ**ï¼š

```vue
<!-- frontend/src/views/StartupCheck.vueï¼ˆå·²å­˜åœ¨ï¼Œéœ€å¢å¼ºï¼‰ -->
<template>
  <div class="startup-check">
    <el-card>
      <h2>ğŸ” ç¯å¢ƒæ£€æµ‹</h2>
      
      <!-- æ£€æµ‹è¿›åº¦ -->
      <el-progress 
        :percentage="progress" 
        :status="allPassed ? 'success' : 'exception'"
      />
      
      <!-- æ£€æµ‹ç»“æœ -->
      <el-descriptions :column="2" border style="margin-top: 20px;">
        <el-descriptions-item label="Pythonç‰ˆæœ¬">
          <el-tag :type="results.python?.version_ok ? 'success' : 'danger'">
            {{ results.python?.status }}
          </el-tag>
        </el-descriptions-item>
        
        <el-descriptions-item label="Chromiumæµè§ˆå™¨">
          <el-tag :type="results.chromium?.installed ? 'success' : 'warning'">
            {{ results.chromium?.status }}
          </el-tag>
        </el-descriptions-item>
        
        <el-descriptions-item label="RedisæœåŠ¡">
          <el-tag :type="results.redis?.running ? 'success' : 'warning'">
            {{ results.redis?.status }}
          </el-tag>
        </el-descriptions-item>
        
        <el-descriptions-item label="ç½‘ç»œè¿æ¥">
          <el-tag :type="results.network?.all_reachable ? 'success' : 'warning'">
            {{ results.network?.status }}
          </el-tag>
        </el-descriptions-item>
        
        <el-descriptions-item label="ç«¯å£å¯ç”¨æ€§">
          <el-tag :type="results.ports?.all_available ? 'success' : 'warning'">
            {{ results.ports?.status }}
          </el-tag>
        </el-descriptions-item>
        
        <el-descriptions-item label="ç£ç›˜ç©ºé—´">
          <el-tag :type="results.disk_space?.sufficient ? 'success' : 'danger'">
            {{ results.disk_space?.status }}
          </el-tag>
        </el-descriptions-item>
      </el-descriptions>
      
      <!-- è€—æ—¶æ˜¾ç¤º -->
      <div style="margin-top: 20px; text-align: center; color: #999;">
        æ£€æµ‹è€—æ—¶: {{ duration }}ç§’
      </div>
      
      <!-- ä¸€é”®ä¿®å¤æŒ‰é’® -->
      <div v-if="fixableIssues.length > 0" style="margin-top: 20px;">
        <el-alert 
          title="æ£€æµ‹åˆ°å¯è‡ªåŠ¨ä¿®å¤çš„é—®é¢˜" 
          type="warning" 
          :closable="false"
        >
          <ul>
            <li v-for="issue in fixableIssues" :key="issue.issue">
              {{ issue.issue }}
            </li>
          </ul>
        </el-alert>
        
        <el-button 
          type="primary" 
          size="large" 
          @click="autoFix"
          :loading="fixing"
          style="width: 100%; margin-top: 15px;"
        >
          ğŸ”§ ä¸€é”®è‡ªåŠ¨ä¿®å¤
        </el-button>
      </div>
      
      <!-- æ“ä½œæŒ‰é’® -->
      <div style="margin-top: 30px; text-align: center;">
        <el-button 
          v-if="allPassed" 
          type="success" 
          size="large"
          @click="continueToWizard"
        >
          âœ… ç¯å¢ƒæ­£å¸¸ï¼Œç»§ç»­é…ç½®
        </el-button>
        
        <el-button 
          v-else
          size="large"
          @click="recheckEnvironment"
        >
          ğŸ”„ é‡æ–°æ£€æµ‹
        </el-button>
      </div>
    </el-card>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage } from 'element-plus'
import api from '@/api'

const router = useRouter()

const progress = ref(0)
const allPassed = ref(false)
const results = ref({})
const duration = ref(0)
const fixableIssues = ref([])
const fixing = ref(false)

const checkEnvironment = async () => {
  try {
    progress.value = 0
    
    const response = await api.get('/api/environment/check-all')
    
    progress.value = 100
    allPassed.value = response.data.all_passed
    results.value = response.data.results
    duration.value = response.data.duration
    fixableIssues.value = response.data.fixable_issues
    
    if (allPassed.value) {
      ElMessage.success(`âœ… ç¯å¢ƒæ£€æµ‹é€šè¿‡ï¼ï¼ˆè€—æ—¶${duration.value}ç§’ï¼‰`)
    } else {
      ElMessage.warning('âš ï¸ æ£€æµ‹åˆ°éƒ¨åˆ†é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦æƒ…')
    }
  } catch (error) {
    ElMessage.error('ç¯å¢ƒæ£€æµ‹å¤±è´¥: ' + error.message)
  }
}

const autoFix = async () => {
  try {
    fixing.value = true
    
    const response = await api.post('/api/environment/auto-fix')
    
    if (response.data.success) {
      ElMessage.success(`âœ… å·²ä¿®å¤ ${response.data.fixed.length} ä¸ªé—®é¢˜`)
      
      // é‡æ–°æ£€æµ‹
      await checkEnvironment()
    } else {
      ElMessage.error(`ä¿®å¤å¤±è´¥: ${response.data.failed.length} ä¸ªé—®é¢˜æ— æ³•è‡ªåŠ¨ä¿®å¤`)
    }
  } catch (error) {
    ElMessage.error('è‡ªåŠ¨ä¿®å¤å¤±è´¥: ' + error.message)
  } finally {
    fixing.value = false
  }
}

const recheckEnvironment = async () => {
  await checkEnvironment()
}

const continueToWizard = () => {
  router.push('/wizard/quick-3-steps')
}

onMounted(() => {
  checkEnvironment()
})
</script>
```

**é¢„æœŸæˆæœ**ï¼š
- âœ… 6é¡¹æ£€æµ‹å¹¶å‘æ‰§è¡Œï¼Œ5-10ç§’å®Œæˆ
- âœ… è‡ªåŠ¨ä¿®å¤Chromiumå’ŒRedisé—®é¢˜
- âœ… æ¸…æ™°æ˜¾ç¤ºæ¯é¡¹æ£€æµ‹ç»“æœ
- âœ… æ–°æ‰‹æ— éœ€æ‰‹åŠ¨æ’æŸ¥ç¯å¢ƒé—®é¢˜

**ä¼˜å…ˆçº§**ï¼šğŸ”´ P0-é«˜

---

## ğŸ¨ ç¬¬äºŒéƒ¨åˆ†ï¼šP1çº§ä¼˜åŒ–ï¼ˆåº”è¯¥å®æ–½ï¼‰

### P1-1. ã€ç”¨æˆ·ä½“éªŒã€‘ç¼ºå°‘é¦–æ¬¡å¯åŠ¨å…è´£å£°æ˜å¼¹çª—

**é—®é¢˜æè¿°**ï¼š
éœ€æ±‚æ–‡æ¡£è¦æ±‚é¦–æ¬¡å¯åŠ¨æ˜¾ç¤ºå…è´£å£°æ˜ï¼Œä½†å½“å‰æœªå®ç°ã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```vue
<!-- frontend/src/components/DisclaimerDialog.vueï¼ˆæ–°å»ºï¼‰ -->
<template>
  <el-dialog 
    v-model="visible" 
    title="âš ï¸ å…è´£å£°æ˜" 
    width="600px"
    :close-on-click-modal="false"
    :close-on-press-escape="false"
    :show-close="false"
  >
    <div class="disclaimer-content">
      <el-alert type="warning" :closable="false">
        <strong>ä½¿ç”¨æœ¬è½¯ä»¶å‰ï¼Œè¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹æ¡æ¬¾ï¼š</strong>
      </el-alert>
      
      <ol style="margin-top: 20px; line-height: 1.8;">
        <li>æœ¬è½¯ä»¶é€šè¿‡æµè§ˆå™¨è‡ªåŠ¨åŒ–æŠ€æœ¯æŠ“å–KOOKæ¶ˆæ¯ï¼Œ<strong>å¯èƒ½è¿åKOOKæœåŠ¡æ¡æ¬¾</strong></li>
        <li>ä½¿ç”¨æœ¬è½¯ä»¶å¯èƒ½å¯¼è‡´<strong>è´¦å·è¢«å°ç¦</strong>ï¼Œè¯·ä»…åœ¨å·²è·æˆæƒçš„åœºæ™¯ä¸‹ä½¿ç”¨</li>
        <li>è½¬å‘çš„æ¶ˆæ¯å†…å®¹å¯èƒ½æ¶‰åŠ<strong>ç‰ˆæƒé—®é¢˜</strong>ï¼Œè¯·éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„</li>
        <li>æœ¬è½¯ä»¶ä»…ä¾›å­¦ä¹ äº¤æµï¼Œå¼€å‘è€…<strong>ä¸æ‰¿æ‹…ä»»ä½•æ³•å¾‹è´£ä»»</strong></li>
      </ol>
      
      <el-checkbox v-model="agreed" style="margin-top: 20px;">
        æˆ‘å·²é˜…è¯»å¹¶åŒæ„ä»¥ä¸Šæ¡æ¬¾
      </el-checkbox>
    </div>
    
    <template #footer>
      <el-button @click="handleReject" type="danger">æ‹’ç»å¹¶é€€å‡º</el-button>
      <el-button type="primary" @click="handleAccept" :disabled="!agreed">
        åŒæ„å¹¶ç»§ç»­
      </el-button>
    </template>
  </el-dialog>
</template>

<script setup>
import { ref } from 'vue'
import { ElMessageBox } from 'element-plus'

const props = defineProps({
  modelValue: Boolean
})

const emit = defineEmits(['update:modelValue', 'accept', 'reject'])

const visible = ref(props.modelValue)
const agreed = ref(false)

const handleAccept = () => {
  if (agreed.value) {
    emit('accept')
    visible.value = false
  }
}

const handleReject = () => {
  ElMessageBox.confirm(
    'æ‚¨æ‹’ç»äº†å…è´£å£°æ˜ï¼Œåº”ç”¨å°†å…³é—­ã€‚',
    'ç¡®è®¤é€€å‡º',
    {
      type: 'warning',
      confirmButtonText: 'ç¡®å®šé€€å‡º',
      cancelButtonText: 'è¿”å›é˜…è¯»'
    }
  ).then(() => {
    emit('reject')
  })
}
</script>
```

**é¢„æœŸæˆæœ**ï¼š
- âœ… é¦–æ¬¡å¯åŠ¨å¿…é¡»åŒæ„å…è´£å£°æ˜
- âœ… æ‹’ç»ååº”ç”¨è‡ªåŠ¨å…³é—­
- âœ… ä¿æŠ¤å¼€å‘è€…æ³•å¾‹è´£ä»»

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ P1-ä¸­é«˜

---

### P1-2. ã€æ™ºèƒ½æ˜ å°„ã€‘ç¼ºå°‘æœºå™¨å­¦ä¹ å¼•æ“

**é—®é¢˜æè¿°**ï¼š
éœ€æ±‚æ–‡æ¡£è¦æ±‚90%+çš„æ˜ å°„å‡†ç¡®åº¦å’Œä¸‰é‡åŒ¹é…ç®—æ³•ï¼Œä½†å½“å‰æ™ºèƒ½æ˜ å°„åŠŸèƒ½è¾ƒå¼±ã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```python
# backend/app/utils/mapping_learning_engine.pyï¼ˆæ–°å»ºï¼‰

import time
from typing import List, Dict, Tuple
from ..database import db
from ..utils.logger import logger

class MappingLearningEngine:
    """æ˜ å°„å­¦ä¹ å¼•æ“ï¼ˆæœºå™¨å­¦ä¹ ï¼‰"""
    
    def __init__(self):
        self.learning_data = {}  # {(kook_channel, target): count}
        self.load_learning_data()
    
    def load_learning_data(self):
        """ä»æ•°æ®åº“åŠ è½½å­¦ä¹ æ•°æ®"""
        # æŸ¥è¯¢æ‰€æœ‰æ˜ å°„å†å²
        history = db.get_mapping_history()
        
        for record in history:
            key = (record['kook_channel_id'], record['target_channel_id'])
            self.learning_data[key] = self.learning_data.get(key, 0) + 1
        
        logger.info(f"åŠ è½½äº† {len(self.learning_data)} æ¡æ˜ å°„å­¦ä¹ æ•°æ®")
    
    def suggest_mapping(self, kook_channel_name: str, 
                       target_channels: List[Dict]) -> List[Tuple[Dict, float]]:
        """
        æ™ºèƒ½æ¨èæ˜ å°„ï¼ˆä¸‰é‡åŒ¹é…ç®—æ³•ï¼‰
        
        Args:
            kook_channel_name: KOOKé¢‘é“åç§°ï¼ˆå¦‚"#å…¬å‘Š"ï¼‰
            target_channels: ç›®æ ‡å¹³å°é¢‘é“åˆ—è¡¨
        
        Returns:
            [(é¢‘é“, ç½®ä¿¡åº¦), ...] æŒ‰ç½®ä¿¡åº¦é™åºæ’åˆ—
        """
        results = []
        
        for target in target_channels:
            target_name = target['name']
            
            # ğŸ”¥ ä¸‰é‡åŒ¹é…ç®—æ³•
            scores = {
                'exact_match': self._exact_match(kook_channel_name, target_name),
                'similar_match': self._similar_match(kook_channel_name, target_name),
                'keyword_match': self._keyword_match(kook_channel_name, target_name),
                'frequency_score': self._frequency_score(target['id'])
            }
            
            # åŠ æƒè®¡ç®—ç»¼åˆç½®ä¿¡åº¦
            confidence = (
                scores['exact_match'] * 0.4 +
                scores['similar_match'] * 0.3 +
                scores['keyword_match'] * 0.2 +
                scores['frequency_score'] * 0.1
            )
            
            if confidence > 0.3:  # é˜ˆå€¼ï¼š30%
                results.append((target, confidence))
        
        # æŒ‰ç½®ä¿¡åº¦é™åºæ’åº
        results.sort(key=lambda x: x[1], reverse=True)
        
        return results
    
    def _exact_match(self, kook_name: str, target_name: str) -> float:
        """å®Œå…¨åŒ¹é…ï¼ˆ100%ç½®ä¿¡åº¦ï¼‰"""
        # æ¸…ç†é¢‘é“åç§°ï¼ˆå»é™¤#ã€@ç­‰ç¬¦å·ï¼‰
        kook_clean = self._clean_channel_name(kook_name)
        target_clean = self._clean_channel_name(target_name)
        
        if kook_clean.lower() == target_clean.lower():
            return 1.0
        
        # ä¸­è‹±æ–‡æ˜ å°„è¡¨
        translations = {
            'å…¬å‘Š': 'announcements',
            'æ´»åŠ¨': 'events',
            'æ›´æ–°': 'updates',
            'æ—¥å¿—': 'changelog',
            'è®¨è®º': 'discussion',
            'æŠ€æœ¯': 'tech'
        }
        
        # æ£€æŸ¥ç¿»è¯‘åŒ¹é…
        for cn, en in translations.items():
            if cn in kook_clean and en in target_clean.lower():
                return 0.9
        
        return 0.0
    
    def _similar_match(self, kook_name: str, target_name: str) -> float:
        """ç›¸ä¼¼åŒ¹é…ï¼ˆåŸºäºç¼–è¾‘è·ç¦»ï¼‰"""
        from difflib import SequenceMatcher
        
        kook_clean = self._clean_channel_name(kook_name)
        target_clean = self._clean_channel_name(target_name)
        
        # è®¡ç®—ç›¸ä¼¼åº¦
        similarity = SequenceMatcher(None, kook_clean.lower(), target_clean.lower()).ratio()
        
        return similarity
    
    def _keyword_match(self, kook_name: str, target_name: str) -> float:
        """å…³é”®è¯åŒ¹é…"""
        # å®šä¹‰å…³é”®è¯ç»„
        keyword_groups = {
            'å…¬å‘Š': ['announce', 'announcement', 'notice', 'news', 'å…¬å‘Š', 'é€šçŸ¥'],
            'æ´»åŠ¨': ['event', 'activity', 'æ´»åŠ¨', 'æ¯”èµ›'],
            'æ›´æ–°': ['update', 'changelog', 'release', 'æ›´æ–°', 'ç‰ˆæœ¬'],
            'è®¨è®º': ['discussion', 'talk', 'chat', 'è®¨è®º', 'èŠå¤©'],
            'æŠ€æœ¯': ['tech', 'technical', 'dev', 'æŠ€æœ¯', 'å¼€å‘']
        }
        
        kook_clean = self._clean_channel_name(kook_name).lower()
        target_clean = self._clean_channel_name(target_name).lower()
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«ç›¸åŒå…³é”®è¯ç»„
        for group_name, keywords in keyword_groups.items():
            kook_has = any(kw in kook_clean for kw in keywords)
            target_has = any(kw in target_clean for kw in keywords)
            
            if kook_has and target_has:
                return 0.8
        
        return 0.0
    
    def _frequency_score(self, target_channel_id: str) -> float:
        """å†å²é¢‘ç‡æ‰“åˆ†"""
        # ç»Ÿè®¡è¯¥é¢‘é“çš„å†å²æ˜ å°„æ¬¡æ•°
        total_count = sum(
            count for key, count in self.learning_data.items()
            if key[1] == target_channel_id
        )
        
        # å½’ä¸€åŒ–ï¼ˆå‡è®¾æœ€å¤§æ¬¡æ•°ä¸º100ï¼‰
        return min(total_count / 100, 1.0)
    
    def _clean_channel_name(self, name: str) -> str:
        """æ¸…ç†é¢‘é“åç§°"""
        # ç§»é™¤å¸¸è§å‰ç¼€ç¬¦å·
        name = name.lstrip('#@*-_ ')
        # ç§»é™¤è¡¨æƒ…ç¬¦å·ï¼ˆç®€å•æ–¹å¼ï¼‰
        import re
        name = re.sub(r'[^\w\s\u4e00-\u9fff]', '', name)
        return name.strip()
    
    def record_mapping(self, kook_channel_id: str, target_channel_id: str):
        """è®°å½•æ˜ å°„è¡Œä¸ºï¼ˆç”¨äºå­¦ä¹ ï¼‰"""
        key = (kook_channel_id, target_channel_id)
        self.learning_data[key] = self.learning_data.get(key, 0) + 1
        
        # ä¿å­˜åˆ°æ•°æ®åº“
        db.save_mapping_history({
            'kook_channel_id': kook_channel_id,
            'target_channel_id': target_channel_id,
            'timestamp': time.time()
        })
        
        logger.debug(f"è®°å½•æ˜ å°„å­¦ä¹ : {kook_channel_id} â†’ {target_channel_id}")
    
    def get_stats(self) -> Dict:
        """è·å–å­¦ä¹ ç»Ÿè®¡ä¿¡æ¯"""
        total_mappings = len(self.learning_data)
        total_count = sum(self.learning_data.values())
        
        # æœ€å¸¸ç”¨çš„æ˜ å°„
        top_mappings = sorted(
            self.learning_data.items(),
            key=lambda x: x[1],
            reverse=True
        )[:10]
        
        return {
            'total_unique_mappings': total_mappings,
            'total_mapping_count': total_count,
            'top_mappings': [
                {
                    'kook_channel': k[0],
                    'target_channel': k[1],
                    'count': v
                }
                for k, v in top_mappings
            ]
        }

# åˆ›å»ºå…¨å±€å®ä¾‹
mapping_learning_engine = MappingLearningEngine()
```

**æ–°å¢APIç«¯ç‚¹**ï¼š

```python
# backend/app/api/mapping_learning_api.pyï¼ˆå·²å­˜åœ¨ï¼Œéœ€å¢å¼ºï¼‰

from fastapi import APIRouter
from ..utils.mapping_learning_engine import mapping_learning_engine

router = APIRouter(prefix="/api/mapping/learning", tags=["mapping-learning"])

@router.post("/suggest")
async def suggest_mappings(kook_channel_name: str, target_channels: List[Dict]):
    """
    æ™ºèƒ½æ¨èæ˜ å°„
    
    Args:
        kook_channel_name: KOOKé¢‘é“åç§°
        target_channels: ç›®æ ‡é¢‘é“åˆ—è¡¨
    
    Returns:
        æ¨èç»“æœï¼ˆæŒ‰ç½®ä¿¡åº¦æ’åºï¼‰
    """
    suggestions = mapping_learning_engine.suggest_mapping(
        kook_channel_name,
        target_channels
    )
    
    return {
        "suggestions": [
            {
                "channel": channel,
                "confidence": round(confidence * 100, 2),  # è½¬æ¢ä¸ºç™¾åˆ†æ¯”
                "confidence_level": "é«˜" if confidence > 0.7 else "ä¸­" if confidence > 0.5 else "ä½"
            }
            for channel, confidence in suggestions
        ]
    }

@router.get("/stats")
async def get_learning_stats():
    """è·å–å­¦ä¹ å¼•æ“ç»Ÿè®¡ä¿¡æ¯"""
    return mapping_learning_engine.get_stats()
```

**é¢„æœŸæˆæœ**ï¼š
- âœ… æ˜ å°„å‡†ç¡®åº¦ä»70% â†’ 90%+
- âœ… è‡ªåŠ¨å­¦ä¹ ç”¨æˆ·æ˜ å°„ä¹ æƒ¯
- âœ… ä¸­è‹±æ–‡é¢‘é“æ™ºèƒ½åŒ¹é…

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ P1-ä¸­é«˜

---

### P1-3. ã€ç³»ç»Ÿæ‰˜ç›˜ã€‘ç¼ºå°‘å®æ—¶ç»Ÿè®¡æ˜¾ç¤º

**é—®é¢˜æè¿°**ï¼š
éœ€æ±‚æ–‡æ¡£è¦æ±‚ç³»ç»Ÿæ‰˜ç›˜æ˜¾ç¤ºå®æ—¶è½¬å‘é‡ã€æˆåŠŸç‡ç­‰ç»Ÿè®¡ï¼Œä½†å½“å‰æ‰˜ç›˜åŠŸèƒ½è¾ƒå¼±ã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```javascript
// frontend/electron/tray.jsï¼ˆæ–°å»ºï¼‰

const { Tray, Menu, nativeImage } = require('electron')
const path = require('path')
const axios = require('axios')

class TrayManager {
  constructor(mainWindow) {
    this.mainWindow = mainWindow
    this.tray = null
    this.stats = {
      today_total: 0,
      success_rate: 0,
      queue_size: 0,
      service_running: false
    }
    
    this.init()
    this.startStatsUpdate()
  }
  
  init() {
    // åˆ›å»ºæ‰˜ç›˜å›¾æ ‡
    const iconPath = path.join(__dirname, '../public/icon.png')
    const icon = nativeImage.createFromPath(iconPath)
    this.tray = new Tray(icon.resize({ width: 16, height: 16 }))
    
    this.tray.setToolTip('KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ')
    
    // è®¾ç½®åˆå§‹èœå•
    this.updateMenu()
    
    // ç‚¹å‡»æ‰˜ç›˜å›¾æ ‡æ˜¾ç¤º/éšè—çª—å£
    this.tray.on('click', () => {
      if (this.mainWindow.isVisible()) {
        this.mainWindow.hide()
      } else {
        this.mainWindow.show()
      }
    })
  }
  
  async fetchStats() {
    /**
     * ğŸ”¥ ä»åç«¯APIè·å–å®æ—¶ç»Ÿè®¡
     */
    try {
      const response = await axios.get('http://localhost:9527/api/system/tray-stats')
      this.stats = response.data
      this.updateMenu()
    } catch (error) {
      console.error('è·å–ç»Ÿè®¡å¤±è´¥:', error.message)
    }
  }
  
  updateMenu() {
    /**
     * æ›´æ–°æ‰˜ç›˜èœå•ï¼ˆåŒ…å«å®æ—¶ç»Ÿè®¡ï¼‰
     */
    const serviceStatus = this.stats.service_running ? 'âœ… è¿è¡Œä¸­' : 'â¸ï¸ å·²åœæ­¢'
    const successRate = this.stats.success_rate.toFixed(1)
    
    const contextMenu = Menu.buildFromTemplate([
      {
        label: 'ğŸ“Š å®æ—¶ç»Ÿè®¡',
        enabled: false
      },
      { type: 'separator' },
      {
        label: `ä»Šæ—¥è½¬å‘: ${this.stats.today_total} æ¡`,
        enabled: false
      },
      {
        label: `æˆåŠŸç‡: ${successRate}%`,
        enabled: false
      },
      {
        label: `é˜Ÿåˆ—: ${this.stats.queue_size} æ¡`,
        enabled: false
      },
      { type: 'separator' },
      {
        label: `æœåŠ¡çŠ¶æ€: ${serviceStatus}`,
        enabled: false
      },
      { type: 'separator' },
      {
        label: 'ğŸ® æ§åˆ¶',
        submenu: [
          {
            label: this.stats.service_running ? 'â¸ï¸ åœæ­¢æœåŠ¡' : 'â–¶ï¸ å¯åŠ¨æœåŠ¡',
            click: () => {
              this.toggleService()
            }
          },
          {
            label: 'ğŸ”„ é‡å¯æœåŠ¡',
            enabled: this.stats.service_running,
            click: () => {
              this.restartService()
            }
          }
        ]
      },
      {
        label: 'ğŸ“‹ æŸ¥çœ‹æ—¥å¿—',
        click: () => {
          this.mainWindow.show()
          this.mainWindow.webContents.send('navigate-to', '/logs')
        }
      },
      { type: 'separator' },
      {
        label: 'ğŸ  æ˜¾ç¤ºä¸»çª—å£',
        click: () => {
          this.mainWindow.show()
        }
      },
      {
        label: 'âŒ é€€å‡ºç¨‹åº',
        click: () => {
          app.quit()
        }
      }
    ])
    
    this.tray.setContextMenu(contextMenu)
    
    // ğŸ”¥ æ›´æ–°æ‰˜ç›˜å›¾æ ‡æç¤ºæ–‡æœ¬ï¼ˆæ˜¾ç¤ºå®æ—¶æ•°æ®ï¼‰
    this.tray.setToolTip(
      `KOOKæ¶ˆæ¯è½¬å‘ç³»ç»Ÿ\n` +
      `ä»Šæ—¥: ${this.stats.today_total}æ¡ | ` +
      `æˆåŠŸç‡: ${successRate}% | ` +
      `é˜Ÿåˆ—: ${this.stats.queue_size}æ¡`
    )
  }
  
  async toggleService() {
    /**
     * åˆ‡æ¢æœåŠ¡çŠ¶æ€
     */
    try {
      const endpoint = this.stats.service_running ? 
        'http://localhost:9527/api/system/stop' :
        'http://localhost:9527/api/system/start'
      
      await axios.post(endpoint)
      
      // å»¶è¿Ÿ1ç§’ååˆ·æ–°ç»Ÿè®¡
      setTimeout(() => {
        this.fetchStats()
      }, 1000)
      
    } catch (error) {
      console.error('æ“ä½œå¤±è´¥:', error.message)
    }
  }
  
  async restartService() {
    /**
     * é‡å¯æœåŠ¡
     */
    try {
      await axios.post('http://localhost:9527/api/system/restart')
      
      setTimeout(() => {
        this.fetchStats()
      }, 2000)
      
    } catch (error) {
      console.error('é‡å¯å¤±è´¥:', error.message)
    }
  }
  
  startStatsUpdate() {
    /**
     * å¯åŠ¨å®šæ—¶åˆ·æ–°ç»Ÿè®¡ï¼ˆæ¯5ç§’ï¼‰
     */
    this.fetchStats() // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    
    this.statsInterval = setInterval(() => {
      this.fetchStats()
    }, 5000)
  }
  
  destroy() {
    if (this.statsInterval) {
      clearInterval(this.statsInterval)
    }
    if (this.tray) {
      this.tray.destroy()
    }
  }
}

module.exports = TrayManager
```

**æ–°å¢åç«¯API**ï¼š

```python
# backend/app/api/tray_stats_enhanced.pyï¼ˆå·²å­˜åœ¨ï¼Œéœ€ç¡®ä¿è¿”å›ä»¥ä¸‹æ•°æ®ï¼‰

from fastapi import APIRouter
from ..database import db
from ..queue.redis_client import redis_queue
from datetime import datetime, timedelta

router = APIRouter(prefix="/api/system", tags=["system"])

@router.get("/tray-stats")
async def get_tray_stats():
    """
    è·å–æ‰˜ç›˜æ˜¾ç¤ºç”¨çš„å®æ—¶ç»Ÿè®¡
    
    Returns:
        {
            "today_total": int,
            "success_rate": float,
            "queue_size": int,
            "service_running": bool
        }
    """
    # è·å–ä»Šæ—¥æ¶ˆæ¯æ€»æ•°
    today_start = datetime.now().replace(hour=0, minute=0, second=0, microsecond=0)
    today_logs = db.get_message_logs_since(today_start.timestamp())
    today_total = len(today_logs)
    
    # è®¡ç®—æˆåŠŸç‡
    if today_total > 0:
        success_count = len([log for log in today_logs if log['status'] == 'success'])
        success_rate = (success_count / today_total) * 100
    else:
        success_rate = 0.0
    
    # è·å–é˜Ÿåˆ—å¤§å°
    queue_size = await redis_queue.get_queue_size()
    
    # è·å–æœåŠ¡çŠ¶æ€
    service_running = db.get_system_config('service_running') == 'true'
    
    return {
        "today_total": today_total,
        "success_rate": round(success_rate, 2),
        "queue_size": queue_size,
        "service_running": service_running
    }
```

**é¢„æœŸæˆæœ**ï¼š
- âœ… æ‰˜ç›˜å®æ—¶æ˜¾ç¤ºè½¬å‘é‡ã€æˆåŠŸç‡ã€é˜Ÿåˆ—
- âœ… å³é”®èœå•å¿«é€Ÿæ§åˆ¶æœåŠ¡
- âœ… æ— éœ€æ‰“å¼€ä¸»çª—å£å³å¯æŸ¥çœ‹çŠ¶æ€
- âœ… æ¯5ç§’è‡ªåŠ¨åˆ·æ–°ç»Ÿè®¡

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ P1-ä¸­

---

### P1-4. ã€æ€§èƒ½ä¼˜åŒ–ã€‘å¤šè´¦å·å…±äº«æµè§ˆå™¨å®ä¾‹

**é—®é¢˜æè¿°**ï¼š
å½“å‰æ¯ä¸ªKOOKè´¦å·å¯åŠ¨ç‹¬ç«‹çš„Chromiumè¿›ç¨‹ï¼Œå†…å­˜å ç”¨å¤§ï¼Œæ”¯æŒçš„è´¦å·æ•°æœ‰é™ã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```python
# backend/app/kook/scraper.pyï¼ˆå·²æœ‰ç›¸å…³ä»£ç ï¼Œéœ€ç¡®ä¿å¯ç”¨ï¼‰

# âœ… ä»£ç å·²å­˜åœ¨ ScraperManager ç±»ä¸­çš„å…±äº«Browseré€»è¾‘
# ç¡®ä¿ä»¥ä¸‹åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼š

class ScraperManager:
    def __init__(self):
        # ...
        self.use_shared_browser = True  # âœ… ç¡®ä¿å¯ç”¨å…±äº«æ¨¡å¼
        logger.info("âœ… æŠ“å–å™¨ç®¡ç†å™¨å·²åˆå§‹åŒ–ï¼ˆå…±äº«Browser+ç‹¬ç«‹Contextæ¨¡å¼ï¼‰")
```

**é¢„æœŸæˆæœ**ï¼š
- âœ… 10ä¸ªè´¦å·å…±äº«1ä¸ªBrowserè¿›ç¨‹
- âœ… å†…å­˜å ç”¨ä»3GB â†’ 500MBï¼ˆèŠ‚çœ83%ï¼‰
- âœ… æ”¯æŒæ›´å¤šè´¦å·åŒæ—¶è¿è¡Œ

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ P1-ä¸­ï¼ˆä»£ç å·²æœ‰ï¼Œéœ€æµ‹è¯•éªŒè¯ï¼‰

---

## ğŸš€ ç¬¬ä¸‰éƒ¨åˆ†ï¼šP2çº§ä¼˜åŒ–ï¼ˆå¯ä»¥å®æ–½ï¼‰

### P2-1. ã€æ•°æ®åº“ã€‘å®šæœŸå½’æ¡£å’ŒVACUUMå‹ç¼©

**é—®é¢˜æè¿°**ï¼š
é•¿æœŸè¿è¡Œåæ•°æ®åº“æ–‡ä»¶ä¼šå˜å¤§ï¼Œéœ€è¦å®šæœŸå½’æ¡£å’Œå‹ç¼©ã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```python
# backend/app/utils/database_optimizer.pyï¼ˆæ–°å»ºï¼‰

import sqlite3
from pathlib import Path
from datetime import datetime, timedelta
from ..config import settings
from ..utils.logger import logger

class DatabaseOptimizer:
    """æ•°æ®åº“ä¼˜åŒ–å·¥å…·"""
    
    def archive_old_logs(self, days: int = 30):
        """
        å½’æ¡£æ—§æ—¥å¿—ï¼ˆç§»åŠ¨åˆ°å½’æ¡£è¡¨ï¼‰
        
        Args:
            days: å½’æ¡£å¤©æ•°é˜ˆå€¼
        """
        cutoff_date = (datetime.now() - timedelta(days=days)).timestamp()
        
        conn = sqlite3.connect(settings.database_url.replace('sqlite:///', ''))
        cursor = conn.cursor()
        
        # åˆ›å»ºå½’æ¡£è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS message_logs_archive (
                id INTEGER PRIMARY KEY,
                kook_message_id TEXT,
                content TEXT,
                created_at TIMESTAMP,
                -- å…¶ä»–å­—æ®µ...
            )
        ''')
        
        # ç§»åŠ¨æ—§è®°å½•åˆ°å½’æ¡£è¡¨
        cursor.execute('''
            INSERT INTO message_logs_archive
            SELECT * FROM message_logs
            WHERE created_at < ?
        ''', (cutoff_date,))
        
        archived_count = cursor.rowcount
        
        # åˆ é™¤ä¸»è¡¨ä¸­çš„æ—§è®°å½•
        cursor.execute('DELETE FROM message_logs WHERE created_at < ?', (cutoff_date,))
        
        conn.commit()
        conn.close()
        
        logger.info(f"å½’æ¡£äº† {archived_count} æ¡æ—§æ—¥å¿—ï¼ˆ{days}å¤©å‰ï¼‰")
        
        return archived_count
    
    def vacuum_database(self):
        """
        æ‰§è¡ŒVACUUMå‹ç¼©æ•°æ®åº“
        
        Returns:
            (å‹ç¼©å‰å¤§å°, å‹ç¼©åå¤§å°, èŠ‚çœç™¾åˆ†æ¯”)
        """
        db_path = Path(settings.database_url.replace('sqlite:///', ''))
        
        # è·å–å‹ç¼©å‰å¤§å°
        size_before = db_path.stat().st_size
        
        # æ‰§è¡ŒVACUUM
        conn = sqlite3.connect(str(db_path))
        conn.execute('VACUUM')
        conn.close()
        
        # è·å–å‹ç¼©åå¤§å°
        size_after = db_path.stat().st_size
        
        saved_percent = ((size_before - size_after) / size_before) * 100
        
        logger.info(f"æ•°æ®åº“å‹ç¼©å®Œæˆ: {self._format_size(size_before)} â†’ {self._format_size(size_after)} (èŠ‚çœ {saved_percent:.1f}%)")
        
        return size_before, size_after, saved_percent
    
    def _format_size(self, bytes: int) -> str:
        """æ ¼å¼åŒ–æ–‡ä»¶å¤§å°"""
        for unit in ['B', 'KB', 'MB', 'GB']:
            if bytes < 1024:
                return f"{bytes:.2f} {unit}"
            bytes /= 1024
        return f"{bytes:.2f} TB"

# å…¨å±€å®ä¾‹
database_optimizer = DatabaseOptimizer()
```

**å®šæ—¶ä»»åŠ¡**ï¼š

```python
# backend/app/utils/scheduler.pyï¼ˆå·²å­˜åœ¨ï¼Œéœ€æ·»åŠ ä»»åŠ¡ï¼‰

from apscheduler.schedulers.asyncio import AsyncIOScheduler
from .database_optimizer import database_optimizer

scheduler = AsyncIOScheduler()

@scheduler.scheduled_job('cron', hour=3)  # æ¯å¤©å‡Œæ™¨3ç‚¹
def scheduled_database_maintenance():
    """æ•°æ®åº“ç»´æŠ¤ä»»åŠ¡"""
    # å½’æ¡£30å¤©å‰çš„æ—¥å¿—
    database_optimizer.archive_old_logs(days=30)
    
    # å‹ç¼©æ•°æ®åº“
    database_optimizer.vacuum_database()
```

**é¢„æœŸæˆæœ**ï¼š
- âœ… æ•°æ®åº“å¤§å°å‡å°‘30%+
- âœ… æŸ¥è¯¢æ€§èƒ½æå‡
- âœ… è‡ªåŠ¨å½’æ¡£å†å²æ•°æ®

**ä¼˜å…ˆçº§**ï¼šğŸŸ¢ P2-ä½

---

### P2-2. ã€é€šçŸ¥ç³»ç»Ÿã€‘å¢å¼ºæ¡Œé¢é€šçŸ¥åˆ†ç±»

**é—®é¢˜æè¿°**ï¼š
éœ€æ±‚æ–‡æ¡£è¦æ±‚é€šçŸ¥æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç±»ï¼ˆæˆåŠŸ/è­¦å‘Š/é”™è¯¯ï¼‰ï¼Œå¹¶æ”¯æŒé™éŸ³æ—¶æ®µã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```javascript
// frontend/electron/notification-manager.jsï¼ˆå·²å­˜åœ¨ï¼Œéœ€å¢å¼ºï¼‰

const { Notification } = require('electron')

class NotificationManager {
  constructor() {
    this.enabled = true
    this.soundEnabled = true
    this.quietHours = {
      enabled: false,
      start: '22:00',
      end: '07:00'
    }
    this.history = []  // ä¿ç•™æœ€è¿‘100æ¡
  }
  
  send(type, title, body, options = {}) {
    /**
     * å‘é€é€šçŸ¥
     * 
     * @param {string} type - ç±»å‹ï¼šsuccess/warning/error/info
     * @param {string} title - æ ‡é¢˜
     * @param {string} body - å†…å®¹
     * @param {object} options - å…¶ä»–é€‰é¡¹
     */
    
    // æ£€æŸ¥æ˜¯å¦åœ¨é™éŸ³æ—¶æ®µ
    if (this.isInQuietHours()) {
      console.log('é™éŸ³æ—¶æ®µï¼Œè·³è¿‡é€šçŸ¥')
      return
    }
    
    // æ ¹æ®ç±»å‹é€‰æ‹©å›¾æ ‡å’Œå£°éŸ³
    const config = this.getNotificationConfig(type)
    
    const notification = new Notification({
      title: `${config.icon} ${title}`,
      body: body,
      icon: config.iconPath,
      sound: this.soundEnabled ? config.sound : undefined,
      urgency: config.urgency
    })
    
    notification.show()
    
    // ä¿å­˜åˆ°å†å²
    this.history.push({
      type,
      title,
      body,
      timestamp: Date.now()
    })
    
    // åªä¿ç•™æœ€è¿‘100æ¡
    if (this.history.length > 100) {
      this.history.shift()
    }
  }
  
  getNotificationConfig(type) {
    /**
     * è·å–é€šçŸ¥é…ç½®
     */
    const configs = {
      success: {
        icon: 'âœ…',
        iconPath: './icon-success.png',
        sound: 'success.mp3',
        urgency: 'low'
      },
      warning: {
        icon: 'âš ï¸',
        iconPath: './icon-warning.png',
        sound: 'warning.mp3',
        urgency: 'normal'
      },
      error: {
        icon: 'âŒ',
        iconPath: './icon-error.png',
        sound: 'error.mp3',
        urgency: 'critical'
      },
      info: {
        icon: 'â„¹ï¸',
        iconPath: './icon-info.png',
        sound: 'info.mp3',
        urgency: 'low'
      }
    }
    
    return configs[type] || configs.info
  }
  
  isInQuietHours() {
    /**
     * æ£€æŸ¥æ˜¯å¦åœ¨é™éŸ³æ—¶æ®µ
     */
    if (!this.quietHours.enabled) {
      return false
    }
    
    const now = new Date()
    const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`
    
    const start = this.quietHours.start
    const end = this.quietHours.end
    
    // å¤„ç†è·¨å¤©æƒ…å†µï¼ˆå¦‚22:00-07:00ï¼‰
    if (start > end) {
      return currentTime >= start || currentTime < end
    } else {
      return currentTime >= start && currentTime < end
    }
  }
  
  getHistory() {
    /**
     * è·å–é€šçŸ¥å†å²
     */
    return this.history
  }
  
  clearHistory() {
    this.history = []
  }
  
  setQuietHours(enabled, start, end) {
    this.quietHours = { enabled, start, end }
  }
}

module.exports = new NotificationManager()
```

**é¢„æœŸæˆæœ**ï¼š
- âœ… é€šçŸ¥æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç±»
- âœ… æ”¯æŒé™éŸ³æ—¶æ®µï¼ˆå¤œé—´ä¸æ‰“æ‰°ï¼‰
- âœ… ä¿ç•™æœ€è¿‘100æ¡é€šçŸ¥å†å²
- âœ… é€šçŸ¥ç‚¹å‡»è·³è½¬åˆ°ç›¸åº”é¡µé¢

**ä¼˜å…ˆçº§**ï¼šğŸŸ¢ P2-ä½

---

## ğŸ“Š æ€»ç»“ä¸å®æ–½è·¯çº¿å›¾

### ä¼˜åŒ–ä¼˜å…ˆçº§çŸ©é˜µ

| ä¼˜åŒ–é¡¹ | å½±å“èŒƒå›´ | å®æ–½éš¾åº¦ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ |
|--------|----------|----------|--------|----------|
| P0-1 ä¸€é”®å®‰è£…åŒ… | â­â­â­â­â­ | ğŸ”¨ğŸ”¨ğŸ”¨ğŸ”¨ | ğŸ”´ æœ€é«˜ | 5å¤© |
| P0-2 ç»Ÿä¸€3æ­¥å‘å¯¼ | â­â­â­â­â­ | ğŸ”¨ğŸ”¨ğŸ”¨ | ğŸ”´ æœ€é«˜ | 3å¤© |
| P0-3 Chromeæ‰©å±• | â­â­â­â­â­ | ğŸ”¨ğŸ”¨ | ğŸ”´ æœ€é«˜ | 2å¤© |
| P0-4 å›¾åºŠToken | â­â­â­â­ | ğŸ”¨ğŸ”¨ğŸ”¨ | ğŸ”´ é«˜ | 2å¤© |
| P0-5 ç¯å¢ƒæ£€æµ‹ | â­â­â­â­ | ğŸ”¨ğŸ”¨ | ğŸ”´ é«˜ | 2å¤© |
| P1-1 å…è´£å£°æ˜ | â­â­â­ | ğŸ”¨ | ğŸŸ¡ ä¸­é«˜ | 0.5å¤© |
| P1-2 å­¦ä¹ å¼•æ“ | â­â­â­â­ | ğŸ”¨ğŸ”¨ğŸ”¨ğŸ”¨ | ğŸŸ¡ ä¸­é«˜ | 3å¤© |
| P1-3 æ‰˜ç›˜ç»Ÿè®¡ | â­â­â­ | ğŸ”¨ğŸ”¨ | ğŸŸ¡ ä¸­ | 1å¤© |
| P1-4 å…±äº«æµè§ˆå™¨ | â­â­â­ | ğŸ”¨ | ğŸŸ¡ ä¸­ | 0.5å¤© |
| P2-1 æ•°æ®åº“ä¼˜åŒ– | â­â­ | ğŸ”¨ğŸ”¨ | ğŸŸ¢ ä½ | 1å¤© |
| P2-2 é€šçŸ¥å¢å¼º | â­â­ | ğŸ”¨ | ğŸŸ¢ ä½ | 0.5å¤© |

### å®æ–½è·¯çº¿å›¾ï¼ˆ3å‘¨è®¡åˆ’ï¼‰

#### ç¬¬1å‘¨ï¼šP0çº§ä¼˜åŒ–ï¼ˆå¿…é¡»å®Œæˆï¼‰

**Day 1-2ï¼šP0-3 Chromeæ‰©å±•**
- å¼€å‘popupç•Œé¢
- å®ç°Cookieå¯¼å‡ºé€»è¾‘
- æµ‹è¯•å¤šç§æµè§ˆå™¨

**Day 3-4ï¼šP0-5 ç¯å¢ƒæ£€æµ‹**
- å®ç°6é¡¹å¹¶å‘æ£€æµ‹
- æ·»åŠ è‡ªåŠ¨ä¿®å¤åŠŸèƒ½
- é›†æˆåˆ°å¯åŠ¨æµç¨‹

**Day 5-7ï¼šP0-2 ç»Ÿä¸€3æ­¥å‘å¯¼**
- é‡æ„å‘å¯¼æµç¨‹
- æ·»åŠ é¦–æ¬¡å¯åŠ¨æ£€æµ‹
- å®Œå–„é…ç½®å®Œæ•´æ€§æ£€æŸ¥

#### ç¬¬2å‘¨ï¼šP0çº§ä¼˜åŒ–ï¼ˆæ‰“åŒ…ï¼‰+ P1çº§ä¼˜åŒ–

**Day 8-12ï¼šP0-1 ä¸€é”®å®‰è£…åŒ…**
- é…ç½®PyInstalleræ‰“åŒ…åç«¯
- åµŒå…¥Rediså’ŒChromium
- é…ç½®electron-builder
- åˆ¶ä½œWindows/macOS/Linuxå®‰è£…åŒ…
- æµ‹è¯•å®‰è£…æµç¨‹

**Day 13-14ï¼šP0-4 å›¾åºŠToken + P1-1 å…è´£å£°æ˜**
- å®ç°Tokenç”Ÿæˆå’ŒéªŒè¯
- æ·»åŠ å®šæ—¶æ¸…ç†ä»»åŠ¡
- å®ç°å…è´£å£°æ˜å¼¹çª—

#### ç¬¬3å‘¨ï¼šP1çº§ä¼˜åŒ– + P2çº§ä¼˜åŒ–

**Day 15-17ï¼šP1-2 æ˜ å°„å­¦ä¹ å¼•æ“**
- å®ç°ä¸‰é‡åŒ¹é…ç®—æ³•
- æ·»åŠ å†å²è®°å½•å’Œç»Ÿè®¡
- é›†æˆåˆ°æ™ºèƒ½æ˜ å°„ç»„ä»¶

**Day 18-19ï¼šP1-3 æ‰˜ç›˜ç»Ÿè®¡ + P1-4 å…±äº«æµè§ˆå™¨**
- å®ç°æ‰˜ç›˜å®æ—¶ç»Ÿè®¡
- éªŒè¯å…±äº«æµè§ˆå™¨åŠŸèƒ½
- æ€§èƒ½æµ‹è¯•

**Day 20-21ï¼šP2çº§ä¼˜åŒ– + æµ‹è¯•**
- æ•°æ®åº“å½’æ¡£å’Œå‹ç¼©
- é€šçŸ¥ç³»ç»Ÿå¢å¼º
- å…¨é¢å›å½’æµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•

### é¢„æœŸæˆæœ

å®Œæˆæ‰€æœ‰P0å’ŒP1ä¼˜åŒ–åï¼Œç³»ç»Ÿå°†å®ç°ï¼š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **é¦–æ¬¡ä½¿ç”¨æˆåŠŸç‡** | 60% | 90%+ | +50% |
| **å¹³å‡é…ç½®æ—¶é—´** | 30åˆ†é’Ÿ | 5åˆ†é’Ÿ | -83% |
| **Cookieå¯¼å‡ºæ—¶é—´** | 5åˆ†é’Ÿ | 10ç§’ | -96% |
| **æ˜ å°„å‡†ç¡®åº¦** | 70% | 90%+ | +29% |
| **å†…å­˜å ç”¨ï¼ˆ10è´¦å·ï¼‰** | 3GB | 500MB | -83% |
| **å®‰è£…é—¨æ§›** | é«˜ | é›¶ | -100% |

---

## ğŸ¯ ç»“è®º

å½“å‰ç³»ç»Ÿåœ¨æŠ€æœ¯å®ç°ä¸Šå·²ç»éå¸¸å®Œå–„ï¼Œä½†è¦è¾¾åˆ°éœ€æ±‚æ–‡æ¡£ä¸­"é›¶ä»£ç åŸºç¡€å¯ç”¨"ã€"3åˆ†é’Ÿå¿«é€Ÿé…ç½®"çš„ç›®æ ‡ï¼Œ**å¿…é¡»å®ŒæˆP0çº§çš„5é¡¹ä¼˜åŒ–ï¼Œç‰¹åˆ«æ˜¯ä¸€é”®å®‰è£…åŒ…å’Œç»Ÿä¸€3æ­¥å‘å¯¼**ã€‚

è¿™äº›ä¼˜åŒ–å°†ä½¿ç³»ç»Ÿä»"æŠ€æœ¯äººå‘˜å¯ç”¨"æå‡åˆ°"æ™®é€šç”¨æˆ·å¯ç”¨"ï¼ŒçœŸæ­£å®ç°**æ˜“ç”¨æ€§**çš„è´¨çš„é£è·ƒã€‚

å»ºè®®æŒ‰ç…§3å‘¨å®æ–½è·¯çº¿å›¾é€æ­¥æ¨è¿›ï¼Œä¼˜å…ˆå®ŒæˆP0çº§ä¼˜åŒ–ï¼Œç¡®ä¿åŸºç¡€ä½“éªŒï¼Œç„¶åé€æ­¥å®Œå–„P1å’ŒP2çº§ä¼˜åŒ–ã€‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-10-28  
**åˆ†æå·¥å…·**ï¼šä»£ç é™æ€åˆ†æ + éœ€æ±‚æ–‡æ¡£å¯¹æ¯”  
**ä¸‹æ¬¡æ›´æ–°**ï¼šå®æ–½å®Œæˆåè¿›è¡Œæ•ˆæœè¯„ä¼°
