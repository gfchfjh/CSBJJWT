# KOOK消息转发系统 - 开发者速查卡

**版本**: v1.7.2  
**更新**: 2025-10-19

---

## 🚀 快速命令

### 开发环境

```bash
# 安装依赖
./install.sh              # Linux/macOS一键安装
install.bat               # Windows一键安装

# 启动开发服务器
./start.sh                # 启动所有服务
cd frontend && npm run dev          # 仅前端
cd backend && python -m app.main    # 仅后端
```

### 测试

```bash
# 前端测试
cd frontend
npm run test              # 运行所有测试
npm run test:watch        # 监视模式
npm run test:coverage     # 覆盖率报告

# 后端测试
cd backend
pytest tests/ -v          # 详细输出
pytest tests/ --cov       # 覆盖率
```

### 代码质量

```bash
# 前端
cd frontend
npm run lint              # ESLint检查+修复
npm run format            # Prettier格式化

# 后端
cd backend
black app/                # Black格式化
flake8 app/               # 代码检查
```

### 构建

```bash
# 前端
cd frontend
npm run build             # 生产构建
npm run preview           # 预览构建结果

# Electron
npm run electron:build             # 所有平台
npm run electron:build:win         # 仅Windows
npm run electron:build:mac         # 仅macOS
npm run electron:build:linux       # 仅Linux
```

### 发布

```bash
# 自动化发布
./scripts/release.sh      # Linux/macOS
scripts\release.bat        # Windows

# 手动发布
git tag -a v1.7.0 -m "Release v1.7.0"
git push origin v1.7.0
```

---

## 📁 项目结构

```
CSBJJWT/
├── backend/              # Python后端
│   ├── app/
│   │   ├── kook/        # KOOK消息抓取
│   │   ├── queue/       # Redis消息队列
│   │   ├── forwarders/  # 平台转发器
│   │   ├── processors/  # 消息处理
│   │   ├── api/         # FastAPI路由
│   │   └── utils/       # 工具类
│   ├── tests/           # 测试文件
│   └── requirements.txt
│
├── frontend/             # Electron前端
│   ├── src/
│   │   ├── views/       # Vue页面（11个）
│   │   ├── components/  # 通用组件
│   │   ├── store/       # Pinia状态
│   │   ├── api/         # API调用
│   │   └── router/      # 路由配置
│   ├── electron/        # Electron主进程
│   └── package.json
│
├── docs/                # 文档（12篇）
│   ├── Cookie获取详细教程.md 🆕
│   ├── 完整用户手册.md
│   ├── 开发指南.md
│   └── 视频教程/ 🆕
│
├── scripts/             # 自动化脚本 🆕
│   ├── release.sh
│   └── release.bat
│
├── build/               # 打包配置
├── redis/               # 嵌入式Redis
└── README.md
```

---

## 🔧 技术栈

### 后端
- FastAPI 0.109 - Web框架
- Playwright 1.40 - 浏览器自动化
- Redis 5.0 - 消息队列
- SQLite - 数据存储
- discord-webhook - Discord转发
- python-telegram-bot 20.7 - Telegram转发
- lark-oapi 1.2 - 飞书转发

### 前端
- Electron 28 - 桌面应用框架
- Vue 3.4 - UI框架
- Element Plus 2.5 - UI组件库
- Pinia 2.1 - 状态管理
- ECharts 5.4 - 数据可视化
- Axios 1.6 - HTTP客户端

### 开发工具
- Vitest - 前端测试
- Pytest - 后端测试
- ESLint - 代码检查
- Prettier - 代码格式化

---

## 🔑 关键文件

| 文件 | 用途 |
|------|------|
| `backend/app/main.py` | 后端入口 |
| `backend/app/config.py` | 配置管理 |
| `backend/app/kook/scraper.py` | KOOK消息抓取 |
| `backend/app/queue/worker.py` | 消息处理Worker |
| `frontend/src/main.js` | 前端入口 |
| `frontend/src/views/Layout.vue` | 主布局 |
| `frontend/src/views/Wizard.vue` | 配置向导 |
| `frontend/src/views/Help.vue` | 帮助中心 🆕 |
| `scripts/release.sh` | 发布脚本 🆕 |

---

## 🌐 API端点

### 认证
- POST `/auth/login` - 登录
- POST `/auth/logout` - 登出
- GET `/auth/status` - 认证状态

### 账号管理
- GET `/api/accounts` - 获取账号列表
- POST `/api/accounts` - 添加账号
- PUT `/api/accounts/{id}` - 更新账号
- DELETE `/api/accounts/{id}` - 删除账号

### 机器人配置
- GET `/api/bots` - 获取Bot列表
- POST `/api/bots` - 添加Bot
- PUT `/api/bots/{id}` - 更新Bot
- DELETE `/api/bots/{id}` - 删除Bot
- POST `/api/bots/{id}/test` - 测试Bot

### 频道映射
- GET `/api/mappings` - 获取映射列表
- POST `/api/mappings` - 添加映射
- DELETE `/api/mappings/{id}` - 删除映射
- POST `/api/mappings/import` - 导入映射 🆕
- GET `/api/mappings/export` - 导出映射 🆕
- POST `/api/smart-mapping/suggest` - 智能映射建议

### 系统管理
- GET `/api/system/status` - 系统状态
- POST `/api/system/start` - 启动服务
- POST `/api/system/stop` - 停止服务
- POST `/api/system/restart` - 重启服务
- GET `/api/system/config` - 获取系统配置
- POST `/api/system/config` - 保存系统配置
- POST `/api/system/email/test` - 测试邮件 🆕

### 日志
- GET `/api/logs` - 获取日志列表
- DELETE `/api/logs` - 清空日志
- GET `/api/logs/export` - 导出日志

### 健康检查
- GET `/health` - 健康检查
- GET `/api/health/detailed` - 详细健康检查

### WebSocket
- WS `/ws` - WebSocket连接（实时日志推送）

---

## 🗄️ 数据库Schema

### accounts（账号表）
```sql
- id: INTEGER PRIMARY KEY
- email: TEXT
- password_encrypted: TEXT
- cookie: TEXT
- status: TEXT (online/offline)
- last_active: TIMESTAMP
- created_at: TIMESTAMP
```

### bot_configs（Bot配置表）
```sql
- id: INTEGER PRIMARY KEY
- platform: TEXT (discord/telegram/feishu)
- name: TEXT
- config: TEXT (JSON)
- status: TEXT
- created_at: TIMESTAMP
```

### channel_mappings（频道映射表）
```sql
- id: INTEGER PRIMARY KEY
- kook_server_id: TEXT
- kook_channel_id: TEXT
- kook_channel_name: TEXT
- target_platform: TEXT
- target_bot_id: INTEGER
- target_channel_id: TEXT
- enabled: INTEGER (0/1)
```

### message_logs（消息日志表）
```sql
- id: INTEGER PRIMARY KEY
- kook_message_id: TEXT UNIQUE
- kook_channel_id: TEXT
- content: TEXT
- message_type: TEXT
- sender_name: TEXT
- target_platform: TEXT
- target_channel: TEXT
- status: TEXT (success/failed/pending)
- error_message: TEXT
- latency_ms: INTEGER
- created_at: TIMESTAMP
```

---

## 🔐 环境变量

创建 `.env` 文件:

```env
# API服务
API_HOST=127.0.0.1
API_PORT=9527
API_TOKEN=your-secure-token-here

# Redis
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=

# 数据库
DATABASE_URL=sqlite:///~/Documents/KookForwarder/data/config.db

# 图床
IMAGE_SERVER_PORT=9528
IMAGE_MAX_SIZE_GB=10
IMAGE_CLEANUP_DAYS=7

# 日志
LOG_LEVEL=INFO
LOG_RETENTION_DAYS=3

# 验证码（可选）
CAPTCHA_2CAPTCHA_API_KEY=your-api-key

# 邮件告警（可选）
SMTP_HOST=smtp.gmail.com
SMTP_PORT=465
EMAIL_FROM=your-email@gmail.com
EMAIL_PASSWORD=your-app-password
EMAIL_TO=admin@example.com
```

---

## 🐛 调试技巧

### 后端调试

```python
# 启用调试模式
# backend/app/config.py
debug = True  # 启用详细日志

# 查看日志
tail -f ~/Documents/KookForwarder/data/logs/app.log

# 测试单个模块
cd backend
python -m app.kook.scraper  # 测试抓取器
```

### 前端调试

```javascript
// 启用Vue DevTools
// 在浏览器中安装Vue DevTools扩展

// 查看网络请求
// F12 → Network → 筛选XHR

// 查看控制台日志
import { logger } from '@/utils/logger'
logger.debug('调试信息:', data)
```

### Redis调试

```bash
# 连接Redis
redis-cli -p 6379

# 查看队列
LLEN message_queue
LRANGE message_queue 0 10

# 清空队列
DEL message_queue
```

---

## 📝 Git提交规范

### 提交类型

```
feat:     新功能
fix:      修复bug
docs:     文档更新
style:    代码格式（不影响功能）
refactor: 重构
test:     测试相关
chore:    构建/工具变更
perf:     性能优化
```

### 提交示例

```bash
git commit -m "feat: 添加帮助中心功能"
git commit -m "fix: 修复图片上传失败问题"
git commit -m "docs: 更新用户手册"
git commit -m "chore: 升级依赖版本"
```

---

## 🔗 有用链接

### 官方文档
- [FastAPI文档](https://fastapi.tiangolo.com/)
- [Vue 3文档](https://vuejs.org/)
- [Element Plus文档](https://element-plus.org/)
- [Electron文档](https://www.electronjs.org/)
- [Playwright文档](https://playwright.dev/)

### 本项目
- [GitHub仓库](https://github.com/gfchfjh/CSBJJWT)
- [Issues](https://github.com/gfchfjh/CSBJJWT/issues)
- [Releases](https://github.com/gfchfjh/CSBJJWT/releases)
- [文档目录](https://github.com/gfchfjh/CSBJJWT/tree/main/docs)

---

## 💡 常用代码片段

### 添加新的API端点

```python
# backend/app/api/example.py
from fastapi import APIRouter

router = APIRouter(prefix="/api/example", tags=["示例"])

@router.get("/")
async def get_examples():
    return {"message": "示例端点"}
```

```python
# backend/app/main.py
from .api import example
app.include_router(example.router)
```

### 添加新的Vue页面

```vue
<!-- frontend/src/views/Example.vue -->
<template>
  <div class="example-view">
    <el-card>
      <template #header>
        <span>示例页面</span>
      </template>
      <p>内容...</p>
    </el-card>
  </div>
</template>

<script setup>
import { ref } from 'vue'
const data = ref([])
</script>
```

```javascript
// frontend/src/router/index.js
import Example from '../views/Example.vue'

{
  path: '/example',
  name: 'Example',
  component: Example,
  meta: { title: '示例' }
}
```

### 添加消息处理逻辑

```python
# backend/app/processors/custom.py
async def process_custom_message(message: dict):
    # 自定义处理逻辑
    content = message.get('content')
    # ... 处理 ...
    return processed_content
```

---

## 🧪 测试示例

### 前端单元测试

```javascript
// frontend/src/__tests__/example.test.js
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import Example from '../views/Example.vue'

describe('Example组件', () => {
  it('应该渲染正确', () => {
    const wrapper = mount(Example)
    expect(wrapper.find('h1').text()).toBe('示例')
  })
})
```

### 后端单元测试

```python
# backend/tests/test_example.py
import pytest
from app.example import example_function

def test_example_function():
    result = example_function("test")
    assert result == "expected"
```

---

## 📊 性能监控

### 关键指标

- **消息延迟**: 平均<2秒
- **转发成功率**: >98%
- **内存占用**: <500MB
- **CPU占用**: <10%

### 监控命令

```bash
# 查看进程
ps aux | grep kook

# 查看内存
free -h

# 查看Redis状态
redis-cli info stats

# 查看日志
tail -f ~/Documents/KookForwarder/data/logs/app.log
```

---

## 🆘 故障排查

### 后端无法启动

```bash
# 1. 检查端口占用
lsof -i:9527
netstat -ano | findstr 9527  # Windows

# 2. 检查Redis
redis-cli ping

# 3. 查看日志
cat ~/Documents/KookForwarder/data/logs/app.log
```

### 前端无法连接后端

```bash
# 1. 检查后端是否运行
curl http://localhost:9527/health

# 2. 检查CORS配置
# backend/app/main.py - CORSMiddleware

# 3. 检查API Token
# frontend/src/api/index.js - X-API-Token header
```

### KOOK账号掉线

```bash
# 1. 重新获取Cookie
# 参考: docs/Cookie获取详细教程.md

# 2. 检查网络
ping www.kookapp.cn

# 3. 查看Playwright日志
# backend日志中搜索 "playwright" 或 "browser"
```

---

## 🎨 UI组件速查

### Element Plus常用组件

```vue
<!-- 按钮 -->
<el-button type="primary">主要按钮</el-button>
<el-button type="success">成功按钮</el-button>

<!-- 表单 -->
<el-form :model="form" label-width="120px">
  <el-form-item label="标签">
    <el-input v-model="form.field" />
  </el-form-item>
</el-form>

<!-- 表格 -->
<el-table :data="tableData" border>
  <el-table-column prop="name" label="名称" />
</el-table>

<!-- 对话框 -->
<el-dialog v-model="visible" title="标题">
  内容...
</el-dialog>

<!-- 消息提示 -->
<script>
import { ElMessage } from 'element-plus'
ElMessage.success('成功')
ElMessage.error('失败')
</script>
```

---

## 🔍 常用查询

### 查找特定代码

```bash
# 搜索TODO
rg "TODO|FIXME" --type py --type vue

# 搜索console.log
rg "console\.(log|error)" frontend/src

# 搜索API调用
rg "api\." frontend/src

# 搜索版本号
rg "version|版本" --type md
```

### 统计代码

```bash
# 代码行数
cloc backend/app frontend/src

# Git统计
git log --oneline | wc -l          # 提交数
git shortlog -sn                    # 贡献者统计
```

---

## 🚀 部署检查清单

发布前检查:

- [ ] 所有测试通过
- [ ] 版本号已更新
- [ ] CHANGELOG已创建
- [ ] 文档已更新
- [ ] 无TODO标记
- [ ] 无console.log（生产环境）
- [ ] Git已提交
- [ ] 标签已创建

发布后验证:

- [ ] GitHub Actions构建成功
- [ ] 安装包可下载
- [ ] 安装包可正常运行
- [ ] 文档链接正确
- [ ] Release Notes完整

---

## 📞 联系方式

- **GitHub**: https://github.com/gfchfjh/CSBJJWT
- **Issues**: https://github.com/gfchfjh/CSBJJWT/issues
- **Releases**: https://github.com/gfchfjh/CSBJJWT/releases

---

**最后更新**: 2025-10-19  
**维护状态**: ✅ 积极维护  
**版本**: v1.7.0
