# KOOK消息转发系统 - 快速启动指南

**版本**: v1.0 (完善版)  
**更新日期**: 2025-10-15

---

## 🚀 5分钟快速启动

### 第一步：克隆代码

```bash
cd /workspace
# 代码已在当前目录
```

### 第二步：启动后端

```bash
cd backend

# 首次运行：复制环境配置
cp .env.example .env

# 安装依赖
pip install -r requirements.txt

# 安装Playwright浏览器
playwright install chromium

# 启动后端服务
python -m app.main
```

**预期输出**:
```
启动 KOOK消息转发系统 v1.0.0
✅ Redis连接成功
✅ 消息处理Worker已启动
✅ 失败消息重试Worker已启动
✅ 图床服务器已启动: http://127.0.0.1:9528
INFO:     Uvicorn running on http://127.0.0.1:9527
```

### 第三步：启动前端

**新开终端窗口**:

```bash
cd frontend

# 安装依赖（首次）
npm install

# 启动开发服务器
npm run dev
```

**预期输出**:
```
VITE v5.0.0  ready in 500 ms

➜  Local:   http://localhost:5173/
➜  Network: use --host to expose
```

### 第四步：访问应用

打开浏览器访问: **http://localhost:5173**

---

## 🎯 首次配置向导

### 1. 欢迎页

点击"开始配置"

### 2. 添加KOOK账号

**方式一：Cookie导入（推荐）**
1. 浏览器打开 https://www.kookapp.cn
2. F12 → Application → Cookies
3. 复制所有Cookie
4. 粘贴到输入框

**方式二：账号密码**
1. 输入KOOK邮箱
2. 输入密码
3. 如需验证码，会自动弹窗

### 3. 配置机器人

**Discord**:
1. 进入Discord服务器设置
2. 集成 → Webhooks → 新建
3. 复制URL，粘贴到应用

**Telegram**:
1. 与 @BotFather 对话
2. /newbot 创建Bot
3. 复制Token
4. 添加Bot到群组
5. 填入配置

**飞书**:
1. 访问 https://open.feishu.cn
2. 创建自建应用
3. 获取App ID和Secret
4. 填入配置

### 4. 设置频道映射

1. 选择KOOK频道
2. 选择目标平台和Bot
3. 填入目标频道ID
4. 保存映射

### 5. 启动服务

点击右上角"启动服务"按钮！

---

## ✨ 新功能使用

### WebSocket实时推送

**自动启用**，无需配置。

**查看连接状态**:
1. 打开浏览器开发者工具
2. Network → WS
3. 应该看到3个WebSocket连接

### 验证码自动处理

**使用账号密码登录时自动触发**:
1. 添加账号 → 选择账号密码
2. 输入邮箱密码
3. 如需验证码，自动弹出对话框
4. 查看验证码图片
5. 输入验证码
6. 自动提交

### 失败消息自动重试

**自动运行**，无需配置。

**查看重试状态**:
1. 进入"日志"页面
2. 筛选"失败"状态
3. 观察重试次数

**配置重试参数** (backend/.env):
```ini
MESSAGE_RETRY_MAX=3          # 最多重试3次
MESSAGE_RETRY_INTERVAL=30    # 重试间隔30秒
```

### 配置备份恢复

**导出配置**:
1. 进入"设置"页面
2. 点击"备份配置"按钮
3. 下载JSON文件

**导入配置**:
1. 进入"设置"页面
2. 点击"导入配置"按钮
3. 选择JSON文件
4. 选择模式（合并/替换）
5. 确认导入

**API使用**:
```bash
# 导出
curl -X POST http://localhost:9527/api/backup/export -o backup.json

# 导入
curl -X POST http://localhost:9527/api/backup/import \
  -F "file=@backup.json" \
  -F "mode=merge"
```

### 数据可视化图表

**主页自动显示**:
- 📈 转发量趋势图（24小时）
- 🎯 成功率饼图
- 📊 平台分布柱状图
- ⏱️ 每分钟自动刷新

---

## ⚙️ 环境配置

### 编辑配置文件

```bash
cd backend
nano .env
```

### 常用配置项

```ini
# API服务端口
API_PORT=9527

# Redis配置
REDIS_HOST=127.0.0.1
REDIS_PORT=6379

# 图床配置
IMAGE_SERVER_PORT=9528
IMAGE_MAX_SIZE_GB=10
IMAGE_CLEANUP_DAYS=7

# 日志配置
LOG_LEVEL=INFO
LOG_RETENTION_DAYS=3

# 限流配置
DISCORD_RATE_LIMIT_CALLS=5
DISCORD_RATE_LIMIT_PERIOD=5

TELEGRAM_RATE_LIMIT_CALLS=30
TELEGRAM_RATE_LIMIT_PERIOD=1

FEISHU_RATE_LIMIT_CALLS=20
FEISHU_RATE_LIMIT_PERIOD=1

# 重试配置
MESSAGE_RETRY_MAX=3
MESSAGE_RETRY_INTERVAL=30
```

---

## 🐛 常见问题

### Q1: Redis连接失败？

**A**: 确保Redis已启动
```bash
# 检查Redis
redis-cli ping
# 应返回 PONG

# 如未安装
# macOS: brew install redis
# Ubuntu: sudo apt install redis-server
# Windows: 下载Redis for Windows
```

### Q2: Playwright浏览器下载失败？

**A**: 手动安装
```bash
cd backend
playwright install chromium --with-deps
```

### Q3: WebSocket连接不上？

**A**: 检查端口占用
```bash
# 查看9527端口
lsof -i :9527

# 修改端口（.env文件）
API_PORT=9528
```

### Q4: 前端npm install失败？

**A**: 使用国内镜像
```bash
npm config set registry https://registry.npmmirror.com
npm install
```

### Q5: 图表不显示？

**A**: 等待数据加载
- 需要至少转发一些消息
- 或者模拟数据显示（开发中）

---

## 📊 系统架构

```
┌─────────────────────────────────────────┐
│           前端 (Vue 3 + Element Plus)    │
│  http://localhost:5173                  │
│  - 用户界面                              │
│  - WebSocket客户端                       │
│  - ECharts图表                           │
└─────────────────┬───────────────────────┘
                  │ HTTP + WebSocket
┌─────────────────▼───────────────────────┐
│           后端 (FastAPI)                 │
│  http://localhost:9527                  │
│  - REST API                             │
│  - WebSocket服务                         │
│  - 消息处理Worker                        │
│  - 重试Worker                            │
└─────────────────┬───────────────────────┘
                  │
        ┌─────────┴─────────┐
        │                   │
┌───────▼────────┐  ┌──────▼──────┐
│     Redis       │  │   SQLite    │
│  消息队列        │  │  配置数据库   │
│  Port: 6379    │  │             │
└────────────────┘  └─────────────┘
```

---

## 🎨 界面预览

### 主界面
- 📊 今日统计（转发量、成功率、延迟、队列）
- ⚡ 快捷操作（管理账号、配置机器人、设置映射、查看日志）
- 📈 数据可视化图表
- 📋 系统状态

### 账号管理
- 👤 账号列表（状态、邮箱、活跃时间）
- ➕ 添加账号（Cookie/密码）
- ▶️ 启动/停止抓取器
- 🗑️ 删除账号

### 机器人配置
- 🤖 Discord/Telegram/飞书配置
- 🧪 测试连接
- 📝 配置列表

### 频道映射
- 🔀 KOOK频道 → 目标平台映射
- ✅ 启用/禁用映射
- 📤 测试发送

### 实时日志
- 📋 转发日志（实时推送）
- 🔍 筛选（状态、平台、频道）
- 📄 消息详情
- 📊 统计信息

### 系统设置
- 🚀 服务控制（启动/停止）
- 🖼️ 图床配置
- 📝 日志设置
- 💾 配置备份

---

## 🔐 安全建议

1. **修改默认端口**
   ```ini
   API_PORT=9527  # 改为其他端口
   ```

2. **限制访问**
   - 仅本地访问：127.0.0.1
   - 防火墙规则

3. **定期备份**
   - 每天自动备份
   - 保留多个版本

4. **日志监控**
   - 检查error日志
   - 关注异常活动

---

## 📞 获取帮助

**文档**:
- 代码完成度检查报告.md - 初始检查
- 代码完善总结报告.md - 详细说明
- 完成度更新报告.md - 前后对比
- TODO.md - 待办事项
- docs/用户手册.md - 完整手册

**日志位置**:
```
~/Documents/KookForwarder/data/logs/
```

**数据目录**:
```
~/Documents/KookForwarder/data/
├── config.db          # 配置数据库
├── images/            # 图片缓存
├── logs/              # 日志文件
├── backups/           # 配置备份
└── redis/             # Redis数据
```

---

## ✅ 启动检查清单

- [ ] Redis已启动
- [ ] Python依赖已安装
- [ ] Playwright浏览器已安装
- [ ] .env配置已创建
- [ ] 后端服务已启动（9527端口）
- [ ] 前端服务已启动（5173端口）
- [ ] 浏览器可访问 http://localhost:5173
- [ ] WebSocket连接正常（3个连接）
- [ ] 至少添加1个KOOK账号
- [ ] 至少配置1个目标平台Bot
- [ ] 至少设置1条频道映射

---

## 🎉 享受使用！

如有问题，请查看详细文档或提交Issue。

**祝使用愉快！** 🚀
