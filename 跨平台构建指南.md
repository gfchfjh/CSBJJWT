# KOOK消息转发系统 - 跨平台构建指南

本文档详细说明如何在不同操作系统上构建安装包。

---

## 📋 目录

1. [构建环境要求](#构建环境要求)
2. [Linux构建](#linux构建)
3. [Windows构建](#windows构建)
4. [macOS构建](#macos构建)
5. [使用GitHub Actions自动构建](#使用github-actions自动构建)
6. [故障排查](#故障排查)

---

## 构建环境要求

### 通用依赖

所有平台都需要：

| 工具 | 版本要求 | 用途 |
|------|---------|------|
| **Node.js** | 18.0+ | 前端构建 |
| **npm** | 8.0+ | 包管理器 |
| **Python** | 3.11+ | 后端打包 |
| **pip** | 最新 | Python包管理 |

### 平台特定依赖

| 平台 | 额外要求 |
|------|---------|
| **Linux** | - |
| **Windows** | Visual Studio Build Tools (可选) |
| **macOS** | Xcode Command Line Tools, 开发者证书 (签名用) |

---

## Linux构建

### ✅ 已成功构建

**构建命令**:
```bash
cd /workspace
python3 build_all_platforms.py --platform linux
```

**输出文件**:
- 文件名: `KOOK消息转发系统-16.0.0.AppImage`
- 位置: `/workspace/frontend/dist-electron/`
- 大小: 125 MB
- MD5: `91a35d06f0c2fcb037f46dc33bcdd2c7`

**使用方法**:
```bash
chmod +x KOOK消息转发系统-16.0.0.AppImage
./KOOK消息转发系统-16.0.0.AppImage
```

### 详细步骤

#### 1. 安装依赖
```bash
# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装Python依赖
pip3 install --user pyinstaller

# 进入项目目录
cd /workspace
```

#### 2. 安装项目依赖
```bash
# 前端依赖
cd frontend
npm install --legacy-peer-deps

# 后端依赖
cd ../backend
pip3 install -r requirements.txt
```

#### 3. 构建
```bash
cd /workspace
python3 build_all_platforms.py --platform linux
```

#### 4. 测试安装包
```bash
cd frontend/dist-electron
chmod +x KOOK消息转发系统-16.0.0.AppImage
./KOOK消息转发系统-16.0.0.AppImage
```

---

## Windows构建

### 方法一：在Windows系统上构建（推荐）

#### 环境准备

1. **安装Node.js**
   - 下载：https://nodejs.org/
   - 版本：18.x LTS 或更高
   - 安装路径：默认即可

2. **安装Python**
   - 下载：https://www.python.org/downloads/
   - 版本：3.11 或更高
   - ⚠️ 勾选"Add Python to PATH"

3. **安装Visual Studio Build Tools**（可选，用于native模块）
   - 下载：https://visualstudio.microsoft.com/downloads/
   - 选择"Desktop development with C++"工作负载

#### 构建步骤

```powershell
# 1. 克隆项目
git clone https://github.com/your-repo/CSBJJWT.git
cd CSBJJWT

# 2. 安装依赖
pip install pyinstaller
cd frontend
npm install --legacy-peer-deps

cd ../backend
pip install -r requirements.txt

# 3. 执行构建
cd ..
python build_all_platforms.py --platform windows
```

**预期输出**:
- `frontend/dist-electron/KOOK消息转发系统 Setup 16.0.0.exe` (NSIS安装程序)
- 文件大小: 约130-150 MB

#### 构建配置

**electron-builder配置** (`frontend/package.json`):
```json
{
  "build": {
    "win": {
      "target": ["nsis"],
      "icon": "../build/icon.ico",
      "artifactName": "${productName} Setup ${version}.${ext}"
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true,
      "shortcutName": "KOOK消息转发系统"
    }
  }
}
```

---

### 方法二：在Linux上跨平台构建（实验性）

⚠️ **限制**: 需要wine和X server，可能遇到签名问题

#### 环境准备

```bash
# 1. 安装wine（32位支持）
sudo dpkg --add-architecture i386
sudo apt-get update
sudo apt-get install wine wine32 wine64 xvfb

# 2. 配置虚拟显示
export DISPLAY=:99
Xvfb :99 -screen 0 1024x768x24 &
```

#### 构建命令

```bash
cd /workspace/frontend

# 使用xvfb-run避免wine GUI问题
xvfb-run npm run electron:build -- --win --x64
```

**注意**: 
- 生成的exe可能未签名，会触发Windows SmartScreen警告
- 需要在实际Windows系统上测试
- 不推荐生产环境使用

---

## macOS构建

### ⚠️ 必须在macOS系统上构建

Windows和Linux无法跨平台构建macOS应用（需要Xcode和代码签名）。

#### 环境准备（macOS）

1. **安装Xcode Command Line Tools**
```bash
xcode-select --install
```

2. **安装Node.js**
```bash
# 使用Homebrew
brew install node

# 或下载安装包
# https://nodejs.org/
```

3. **安装Python**
```bash
# 使用Homebrew
brew install python@3.11

# 或下载安装包
# https://www.python.org/downloads/
```

#### 构建步骤

```bash
# 1. 克隆项目
git clone https://github.com/your-repo/CSBJJWT.git
cd CSBJJWT

# 2. 安装依赖
pip3 install pyinstaller
cd frontend
npm install --legacy-peer-deps

cd ../backend
pip3 install -r requirements.txt

# 3. 执行构建
cd ..
python3 build_all_platforms.py --platform mac
```

**预期输出**:
- `frontend/dist-electron/KOOK消息转发系统-16.0.0.dmg` (磁盘映像)
- `frontend/dist-electron/KOOK消息转发系统-16.0.0.app` (应用程序包)
- 文件大小: 约120 MB

#### 代码签名（可选）

```bash
# 1. 获取开发者证书
# 访问 https://developer.apple.com/

# 2. 配置签名
# 在 package.json 中添加:
{
  "build": {
    "mac": {
      "identity": "Developer ID Application: Your Name (TEAM_ID)",
      "hardenedRuntime": true,
      "gatekeeperAssess": false,
      "entitlements": "../build/entitlements.mac.plist",
      "entitlementsInherit": "../build/entitlements.mac.plist"
    }
  }
}

# 3. 公证（Notarization）
export APPLEID="your@email.com"
export APPLEIDPASS="app-specific-password"
npm run electron:build -- --mac
```

---

## 使用GitHub Actions自动构建

### 推荐方案：多平台CI/CD

创建 `.github/workflows/build.yml`:

```yaml
name: Build All Platforms

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyinstaller
          cd frontend
          npm install --legacy-peer-deps
          cd ../backend
          pip install -r requirements.txt
      
      - name: Build Windows
        run: python build_all_platforms.py --platform windows
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: windows-installer
          path: frontend/dist-electron/*.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyinstaller
          cd frontend
          npm install --legacy-peer-deps
          cd ../backend
          pip install -r requirements.txt
      
      - name: Build macOS
        run: python3 build_all_platforms.py --platform mac
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: macos-installer
          path: frontend/dist-electron/*.dmg

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyinstaller
          cd frontend
          npm install --legacy-peer-deps
          cd ../backend
          pip install -r requirements.txt
      
      - name: Build Linux
        run: python3 build_all_platforms.py --platform linux
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: linux-installer
          path: frontend/dist-electron/*.AppImage

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            windows-installer/*
            macos-installer/*
            linux-installer/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 使用方法

1. **创建workflow文件**
   ```bash
   mkdir -p .github/workflows
   # 将上面的YAML内容保存到 .github/workflows/build.yml
   ```

2. **推送tag触发构建**
   ```bash
   git tag v16.0.0
   git push origin v16.0.0
   ```

3. **等待构建完成**
   - 访问GitHub仓库的"Actions"页面
   - 查看构建进度
   - 下载生成的安装包

**优点**:
- ✅ 真实平台环境
- ✅ 自动化构建
- ✅ 多平台并行
- ✅ 自动发布到Releases

---

## 故障排查

### 常见问题

#### 1. Windows构建在Linux上失败

**错误**: `wine32 is missing`

**原因**: 
- Linux上跨平台构建Windows需要wine
- wine需要X server和32位支持

**解决方案**:
- **推荐**: 在实际Windows系统上构建
- **或**: 使用GitHub Actions
- **或**: 构建便携版（zip格式）

#### 2. macOS构建失败

**错误**: `Cannot build for macOS on Linux`

**原因**: 
- macOS应用需要Xcode工具链
- 需要Apple开发者证书签名

**解决方案**:
- 必须在macOS系统上构建
- 或使用GitHub Actions的macOS runner

#### 3. 构建速度慢

**优化方法**:
```bash
# 使用npm ci替代npm install（更快）
npm ci --legacy-peer-deps

# 并行构建
npm run build -- --mode production --max-workers 4

# 跳过依赖安装（如已安装）
python3 build_all_platforms.py --platform linux --skip-deps
```

#### 4. 磁盘空间不足

**检查空间**:
```bash
df -h
du -sh frontend/node_modules
du -sh frontend/dist-electron
```

**清理缓存**:
```bash
# 清理npm缓存
npm cache clean --force

# 清理构建产物
rm -rf frontend/dist
rm -rf frontend/dist-electron
rm -rf backend/dist
rm -rf backend/build
```

---

## 当前构建状态

### ✅ 已完成

| 平台 | 文件 | 大小 | MD5 | 状态 |
|------|------|------|-----|------|
| **Linux** | KOOK消息转发系统-16.0.0.AppImage | 125 MB | 91a35d06f0c2fcb037f46dc33bcdd2c7 | ✅ 成功 |
| **Windows** | - | - | - | ⚠️ 需在Windows系统构建 |
| **macOS** | - | - | - | ⚠️ 需在macOS系统构建 |

---

## 推荐构建方案

### 方案一：使用GitHub Actions（最佳）

**优点**:
- ✅ 真实平台环境
- ✅ 自动化构建
- ✅ 免费（开源项目）
- ✅ 自动发布Release

**步骤**:
1. 将上述GitHub Actions配置添加到项目
2. 创建tag推送
3. 等待自动构建完成
4. 下载所有平台的安装包

### 方案二：手动在各平台构建

**Windows用户**:
1. 克隆项目到Windows系统
2. 运行 `python build_all_platforms.py --platform windows`
3. 获得 `.exe` 安装包

**macOS用户**:
1. 克隆项目到macOS系统
2. 运行 `python3 build_all_platforms.py --platform mac`
3. 获得 `.dmg` 安装包

**Linux用户**:
1. ✅ 已完成（当前系统）

### 方案三：Docker多平台构建（高级）

使用Docker + QEMU进行跨平台构建（需要较多配置）。

---

## 简化构建方案（便携版）

如果不需要安装程序，可以创建便携版本：

### Linux便携版
```bash
cd /workspace/frontend
npm run build
electron-builder --linux dir

# 输出: dist-electron/linux-unpacked/
# 压缩:
tar -czf KOOK-Forwarder-v16.0.0-Linux-Portable.tar.gz dist-electron/linux-unpacked/
```

### Windows便携版
```bash
# 在Windows系统上
npm run build
electron-builder --win dir

# 输出: dist-electron/win-unpacked/
# 压缩:
7z a KOOK-Forwarder-v16.0.0-Windows-Portable.zip dist-electron/win-unpacked/*
```

---

## 构建脚本使用

### 基本用法

```bash
# 构建当前平台
python3 build_all_platforms.py --platform current

# 构建Linux
python3 build_all_platforms.py --platform linux

# 构建Windows（需在Windows上）
python build_all_platforms.py --platform windows

# 构建macOS（需在macOS上）
python3 build_all_platforms.py --platform mac

# 尝试构建所有平台（当前平台能构建的）
python3 build_all_platforms.py --platform all

# 跳过依赖安装（加快构建）
python3 build_all_platforms.py --platform linux --skip-deps
```

### 高级用法

```bash
# 仅构建前端
cd frontend
npm run build

# 仅构建Electron
cd frontend
npm run electron:build -- --linux

# 仅构建后端
cd backend
pyinstaller ../build/pyinstaller.spec

# 自定义输出目录
electron-builder --linux --dir --out custom-output/
```

---

## 构建清单

### 构建前检查

- [ ] Node.js版本 >= 18.0
- [ ] Python版本 >= 3.11
- [ ] npm依赖已安装（`npm install --legacy-peer-deps`）
- [ ] Python依赖已安装（`pip install -r requirements.txt`）
- [ ] PyInstaller已安装（`pip install pyinstaller`）
- [ ] 磁盘空间 >= 5GB

### 构建后检查

- [ ] 安装包文件存在
- [ ] 文件大小合理（Linux: 120-130 MB）
- [ ] MD5校验和正确
- [ ] 可执行权限正确（Linux/macOS）
- [ ] 安装程序可以运行
- [ ] 应用启动正常
- [ ] 配置向导可用
- [ ] 核心功能正常

---

## 📦 快速构建命令

### 一键构建（Linux）

```bash
#!/bin/bash
# quick-build-linux.sh

set -e

echo "🚀 开始构建Linux版本..."

# 检查环境
command -v node >/dev/null 2>&1 || { echo "❌ Node.js未安装"; exit 1; }
command -v python3 >/dev/null 2>&1 || { echo "❌ Python3未安装"; exit 1; }

# 安装依赖
pip3 install --user pyinstaller

cd /workspace/frontend
npm install --legacy-peer-deps

cd /workspace/backend
pip3 install -r requirements.txt

# 构建
cd /workspace
python3 build_all_platforms.py --platform linux

echo "✅ 构建完成！"
echo "📦 安装包位置: /workspace/frontend/dist-electron/"
ls -lh /workspace/frontend/dist-electron/*.AppImage
```

### 一键构建（Windows PowerShell）

```powershell
# quick-build-windows.ps1

Write-Host "🚀 开始构建Windows版本..." -ForegroundColor Green

# 检查环境
if (-not (Get-Command node -ErrorAction SilentlyContinue)) {
    Write-Host "❌ Node.js未安装" -ForegroundColor Red
    exit 1
}

if (-not (Get-Command python -ErrorAction SilentlyContinue)) {
    Write-Host "❌ Python未安装" -ForegroundColor Red
    exit 1
}

# 安装依赖
pip install pyinstaller

Set-Location frontend
npm install --legacy-peer-deps

Set-Location ../backend
pip install -r requirements.txt

# 构建
Set-Location ..
python build_all_platforms.py --platform windows

Write-Host "✅ 构建完成！" -ForegroundColor Green
Write-Host "📦 安装包位置: frontend\dist-electron\" -ForegroundColor Cyan
Get-ChildItem frontend\dist-electron\*.exe
```

---

## 总结

### 已完成平台

- ✅ **Linux AppImage** - 125 MB, 可在所有主流Linux发行版运行

### 待构建平台

- ⚠️ **Windows .exe** - 需在Windows系统或GitHub Actions构建
- ⚠️ **macOS .dmg** - 必须在macOS系统构建

### 推荐方案

**最佳**: 使用GitHub Actions自动构建所有平台  
**备选**: 在各自平台上手动构建  
**当前**: Linux AppImage已可用

---

**文档更新**: 2025-10-31  
**脚本版本**: v2.0  
**支持平台**: Windows 10+, macOS 10.15+, Linux (主流发行版)
