# KOOK消息转发系统 - 新功能使用指南

**版本**: v1.1.0  
**更新日期**: 2025-10-17  

---

## 🎉 新功能概览

本次更新新增了以下重要功能：

1. **健康检查系统** - 实时监控各组件运行状态
2. **选择器配置管理** - 无需修改代码即可更新页面选择器
3. **自动更新检查** - 自动检测新版本并提供下载链接
4. **友好错误提示** - 清晰的错误信息和解决方案建议
5. **高级功能面板** - 统一管理所有高级功能

---

## 📋 目录

- [健康检查](#健康检查)
- [选择器配置](#选择器配置)
- [自动更新](#自动更新)
- [常见问题](#常见问题)

---

## 🏥 健康检查

### 功能说明
健康检查系统会定期检测以下组件的运行状态：
- Redis数据库连接
- 消息处理Worker
- KOOK抓取器
- 磁盘存储空间
- 所有Bot配置（Discord/Telegram/飞书）

### 如何使用

#### 方式1: 前端界面（推荐）

1. **访问健康检查面板**
   ```
   登录系统 → 侧边栏点击"高级功能" → 选择"健康检查"标签
   ```

2. **查看健康状态**
   - 🟢 绿色标签：组件运行正常
   - 🟡 黄色标签：有警告信息
   - 🔴 红色标签：组件异常

3. **手动执行检查**
   ```
   点击右上角"立即检查"按钮
   ```

4. **查看详细信息**
   - 各组件状态卡片会显示详细信息
   - 存储空间显示使用率和进度条
   - Bot列表显示每个Bot的健康状态

#### 方式2: API调用

```bash
# 执行健康检查
curl http://localhost:9527/api/health/check

# 查看最后检查结果
curl http://localhost:9527/api/health/status

# 检查单个Bot
curl -X POST http://localhost:9527/api/health/check-bot/1
```

### 配置选项

在`.env`文件或系统设置中配置：

```env
# 启用健康检查
HEALTH_CHECK_ENABLED=true

# 检查间隔（秒）
HEALTH_CHECK_INTERVAL=300  # 默认5分钟
```

### 异常告警

当检测到异常时，系统会：
1. 在健康检查面板显示红色状态
2. 记录详细日志到日志文件
3. （可选）发送邮件告警（需配置邮箱）

---

## 🎯 选择器配置

### 为什么需要选择器配置？

KOOK网页版会不定期更新页面结构，导致原有的选择器（CSS选择器）无法正常定位页面元素，从而无法获取服务器列表和频道列表。

通过选择器配置文件，您可以在不修改代码的情况下更新选择器，快速适应页面变化。

### 如何使用

#### 方式1: 前端界面（推荐新手）

1. **访问选择器配置面板**
   ```
   登录系统 → 侧边栏点击"高级功能" → 选择"选择器配置"标签
   ```

2. **查看当前配置**
   - 配置版本和最后更新时间
   - 配置文件路径
   - 各类别选择器列表

3. **添加新选择器**
   ```
   展开类别（如"服务器列表容器"）→ 点击"添加"按钮 → 输入选择器 → 确认
   ```

4. **删除选择器**
   ```
   点击选择器标签右侧的"×"按钮 → 确认删除
   ```

5. **导出配置**
   ```
   点击"导出配置"按钮 → 配置文件会下载到本地
   ```

6. **导入配置**
   ```
   点击"导入配置"按钮 → 选择格式（JSON/YAML）→ 粘贴配置内容 → 确认
   ```

#### 方式2: 直接编辑配置文件（推荐熟练用户）

1. **找到配置文件**
   ```
   Windows: C:\Users\[用户名]\Documents\KookForwarder\data\selectors.yaml
   macOS:   /Users/[用户名]/Documents/KookForwarder/data/selectors.yaml
   Linux:   /home/[用户名]/Documents/KookForwarder/data/selectors.yaml
   ```

2. **编辑配置文件**
   
   使用文本编辑器打开`selectors.yaml`：
   
   ```yaml
   version: "1.0"
   last_updated: "2025-10-17T00:00:00"
   
   # 服务器列表容器选择器
   server_container:
     - ".guild-list"                 # 原有选择器
     - "[class*='guild-list']"
     - ".new-guild-container"        # 新增选择器
   
   # 服务器项选择器
   server_item:
     - ".guild-item"
     - "[data-guild-id]"
     - ".updated-guild-element"      # 新增选择器
   
   # 更多类别...
   ```

3. **保存后自动生效**
   
   配置文件修改后会自动检测并重新加载，**无需重启服务**！

#### 方式3: API调用（推荐开发者）

```bash
# 添加选择器
curl -X POST http://localhost:9527/api/selectors/add \
  -H "Content-Type: application/json" \
  -d '{
    "category": "server_container",
    "selector": ".new-guild-list",
    "position": 0
  }'

# 删除选择器
curl -X POST http://localhost:9527/api/selectors/remove \
  -H "Content-Type: application/json" \
  -d '{
    "category": "server_container",
    "selector": ".old-selector"
  }'

# 重新加载配置
curl -X POST http://localhost:9527/api/selectors/reload
```

### 选择器类别说明

| 类别 | 说明 | 示例 |
|------|------|------|
| `server_container` | 服务器列表容器 | `.guild-list` |
| `server_item` | 单个服务器元素 | `.guild-item` |
| `server_name` | 服务器名称元素 | `.guild-name` |
| `channel_container` | 频道列表容器 | `.channel-list` |
| `channel_item` | 单个频道元素 | `.channel-item` |
| `channel_name` | 频道名称元素 | `.channel-name` |
| `login` | 登录表单相关 | 字典类型 |

### 测试选择器

修改选择器后，建议测试是否能正常获取服务器和频道：

1. **前往账号管理页面**
2. **点击"重新登录"或"测试连接"**
3. **检查是否能获取到服务器列表**

如果仍然无法获取，请尝试：
- 使用浏览器开发者工具（F12）检查KOOK页面结构
- 查找正确的CSS选择器
- 将新选择器添加到配置文件的**最前面**（优先级最高）

### ⚠️ 注意事项

1. **备份配置**: 修改前建议先导出备份
2. **谨慎删除**: 不要删除所有选择器，至少保留一个
3. **测试验证**: 修改后及时测试功能是否正常
4. **寻求帮助**: 如不确定如何修改，请查看GitHub Issues或联系支持

---

## 🔄 自动更新

### 功能说明

自动更新检查会定期检测GitHub Releases，当有新版本发布时会通知您，并提供下载链接。

### 如何使用

#### 方式1: 前端界面

1. **访问更新检查面板**
   ```
   登录系统 → 侧边栏点击"高级功能" → 选择"更新检查"标签
   ```

2. **手动检查更新**
   ```
   点击右上角"检查更新"按钮
   ```

3. **查看更新信息**
   - 当前版本 vs 最新版本对比
   - 发布日期
   - 更新内容（Markdown格式）
   - 分平台下载链接

4. **下载新版本**
   ```
   点击对应平台的按钮（Windows/macOS/Linux）
   ```

#### 方式2: API调用

```bash
# 检查更新
curl http://localhost:9527/api/updates/check

# 查看更新状态
curl http://localhost:9527/api/updates/status

# 获取最新版本信息
curl http://localhost:9527/api/updates/latest

# 获取指定平台下载链接
curl http://localhost:9527/api/updates/download/windows
```

### 配置选项

```env
# 启用自动更新检查
AUTO_UPDATE_ENABLED=true

# 检查间隔（秒）
AUTO_UPDATE_CHECK_INTERVAL=86400  # 默认24小时

# GitHub仓库
GITHUB_REPO=gfchfjh/CSBJJWT
```

### 更新流程

1. **接收更新通知**
   - 系统启动时检查一次
   - 之后每24小时检查一次
   - 或手动点击"检查更新"

2. **查看更新说明**
   - 阅读新版本的功能更新
   - 查看bug修复列表
   - 了解破坏性变更（如有）

3. **下载新版本**
   - 选择对应平台的下载链接
   - 下载安装包到本地

4. **安装更新**
   - 关闭当前程序
   - 运行新版本安装包
   - 按向导完成安装

5. **数据迁移**
   - 配置数据会自动保留
   - 图片缓存会自动保留
   - 无需重新配置

### ⚠️ 注意事项

1. **备份数据**: 更新前建议备份配置（高级功能 → 系统设置 → 备份与恢复）
2. **阅读说明**: 仔细阅读更新说明，了解变更内容
3. **测试功能**: 更新后测试关键功能是否正常

---

## ❓ 常见问题

### Q1: 健康检查显示组件异常怎么办？

**A**: 根据具体组件采取措施：

- **Redis异常**: 检查Redis服务是否启动，端口是否被占用
- **Worker异常**: 查看日志了解具体原因，尝试重启服务
- **抓取器异常**: 检查KOOK账号状态，Cookie是否有效
- **存储空间不足**: 清理旧文件或增加磁盘空间
- **Bot异常**: 检查Bot配置，使用"测试连接"功能验证

### Q2: 修改选择器后仍然无法获取服务器列表？

**A**: 尝试以下步骤：

1. **确认选择器正确**: 使用浏览器开发者工具验证选择器能定位到元素
2. **位置优先级**: 确保新选择器在配置文件中位于最前面
3. **重新加载**: 点击"重新加载"按钮或重启服务
4. **清除缓存**: 重新登录KOOK账号
5. **查看日志**: 检查日志文件了解详细错误信息

### Q3: 自动更新检查失败？

**A**: 可能原因：

- **网络问题**: 检查是否能访问GitHub
- **API限流**: GitHub API有访问频率限制，稍后重试
- **配置错误**: 检查`GITHUB_REPO`配置是否正确
- **防火墙**: 检查防火墙是否阻止了GitHub API访问

### Q4: 选择器配置文件在哪里？

**A**: 配置文件路径：

- Windows: `C:\Users\[用户名]\Documents\KookForwarder\data\selectors.yaml`
- macOS: `/Users/[用户名]/Documents/KookForwarder/data/selectors.yaml`
- Linux: `/home/[用户名]/Documents/KookForwarder/data/selectors.yaml`

也可以在"高级功能 → 选择器配置"面板查看完整路径。

### Q5: 如何恢复默认选择器配置？

**A**: 两种方式：

**方式1**: 删除配置文件，程序会自动重新生成默认配置
```bash
# 删除配置文件
rm ~/Documents/KookForwarder/data/selectors.yaml

# 重启程序，会自动生成默认配置
```

**方式2**: 从GitHub仓库下载默认配置文件
```bash
# 下载默认配置
curl -o ~/Documents/KookForwarder/data/selectors.yaml \
  https://raw.githubusercontent.com/gfchfjh/CSBJJWT/main/backend/app/utils/default_selectors.yaml
```

### Q6: 健康检查影响性能吗？

**A**: 几乎不影响：

- 默认每5分钟检查一次，频率很低
- 检查过程异步执行，不阻塞主服务
- 单次检查耗时通常在1-2秒内
- 可以通过配置调整检查间隔或完全禁用

### Q7: 可以只更新选择器而不重启程序吗？

**A**: 可以！这正是热更新的优势：

- 直接修改配置文件后，程序会自动检测并重新加载
- 或在前端界面点击"重新加载"按钮
- 或调用API: `POST /api/selectors/reload`
- **完全无需重启服务**

---

## 📞 获取帮助

如果遇到问题：

1. **查看文档**
   - 完整用户手册: `docs/完整用户手册.md`
   - 开发指南: `docs/开发指南.md`
   - 本使用指南

2. **查看日志**
   ```
   路径: ~/Documents/KookForwarder/data/logs/
   ```

3. **提交Issue**
   ```
   https://github.com/gfchfjh/CSBJJWT/issues
   ```

4. **查看示例配置**
   ```
   GitHub仓库 → backend/app/utils/ → selector_manager.py
   查看默认配置示例
   ```

---

## 🎓 进阶技巧

### 技巧1: 使用浏览器开发者工具找选择器

1. **打开KOOK网页版**
   ```
   访问: https://www.kookapp.cn/app
   按F12打开开发者工具
   ```

2. **选择元素**
   ```
   点击开发者工具左上角的"选择元素"按钮（或Ctrl+Shift+C）
   鼠标悬停到服务器或频道元素上
   ```

3. **复制选择器**
   ```
   在Elements面板中，右键点击选中的元素
   选择 Copy → Copy selector
   ```

4. **测试选择器**
   ```
   在Console面板中输入:
   document.querySelector('你的选择器')
   
   确认能正确返回元素
   ```

### 技巧2: 使用正则表达式匹配

如果KOOK使用动态生成的类名（如`guild-item-abc123`），可以使用属性选择器：

```yaml
server_item:
  - "[class*='guild-item']"  # 匹配包含guild-item的类名
  - "[class^='guild-']"       # 匹配以guild-开头的类名
  - "[class$='-item']"        # 匹配以-item结尾的类名
```

### 技巧3: 组合选择器

使用更精确的组合选择器：

```yaml
server_item:
  - "nav.guilds-sidebar .guild-item"    # 后代选择器
  - ".guild-list > .guild-item"         # 子选择器
  - ".guild-item.active"                # 类名组合
  - ".guild-item[data-id]"              # 属性存在
```

---

## 📝 更新日志

### v1.1.0 (2025-10-17)
- ✨ 新增健康检查系统
- ✨ 新增选择器配置管理
- ✨ 新增自动更新检查
- ✨ 新增友好错误提示
- ✨ 新增高级功能面板
- 🐛 修复已知问题
- 📝 完善文档

---

**祝您使用愉快！**

如有问题欢迎反馈: https://github.com/gfchfjh/CSBJJWT/issues
