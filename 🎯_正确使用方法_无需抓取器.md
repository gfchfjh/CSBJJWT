# 🎯 KOOK转发系统 - 正确使用方法（无需抓取器）

## 📌 核心理解

### 系统的两个独立部分

#### 1️⃣ Playwright抓取器（目前不可用）
```
作用：自动获取和更新Cookie
状态：❌ Python 3.12兼容性问题
影响：仅影响自动获取Cookie
```

#### 2️⃣ 消息转发核心（完全可用）
```
作用：监听KOOK消息并转发到其他平台
状态：✅ 100%可用
依赖：仅需要有效的Cookie
```

**重要**：即使抓取器状态显示"离线"，只要Cookie有效，消息转发功能就能正常工作！

---

## ✅ 正确的使用步骤（5步完成）

### 步骤1：更新Cookie（而不是启动抓取器）

**在前端界面操作：**

```
1. 打开账号管理页面
2. 找到您的账号卡片
3. ⚠️ 忽略"🔴 离线"状态
4. ⚠️ 不要点击"启动抓取器"按钮
5. ✅ 点击"更新Cookie"按钮（或编辑按钮）
6. 粘贴之前导出的Cookie JSON
7. 点击保存
```

**验证Cookie已更新：**

```powershell
cd C:\Users\tanzu\Desktop\CSBJJWT
venv\Scripts\Activate.ps1
python scripts\verify_cookie_storage.py
```

期望看到：
```
✅ Cookie状态: 已存储
✅ Cookie大小: 3916 字符
✅ 包含auth字段: 是
```

---

### 步骤2：配置Bot

**在前端界面 → Bot配置页面：**

```
1. 点击"添加Bot"
2. 选择平台（Discord/Telegram/飞书等）
3. 填写配置信息：
   - Discord: Webhook URL
   - Telegram: Bot Token + Chat ID
   - 飞书: Webhook URL
   - 钉钉: Webhook URL + Secret
4. 点击"测试连接"
5. 看到"✅ 连接成功"后，点击保存
```

**示例 - Discord配置：**
```
Bot类型: Discord
Webhook URL: https://discord.com/api/webhooks/xxx/yyy
名称: 我的Discord转发
```

---

### 步骤3：创建频道映射

**在前端界面 → 频道映射页面：**

```
1. 点击"添加映射"
2. 选择KOOK源频道
   - 如果列表为空，需要先在KOOK中加入服务器
3. 选择目标Bot（步骤2创建的）
4. 设置过滤规则（可选）：
   - 关键词过滤
   - 用户过滤
   - 消息类型过滤
5. 点击保存
```

**示例映射：**
```
源频道: KOOK服务器 > 综合频道
目标Bot: 我的Discord转发
过滤规则: 转发所有消息
```

---

### 步骤4：启动消息监听

**方法A：使用API（推荐）**

```powershell
# 在PowerShell中运行
cd C:\Users\tanzu\Desktop\CSBJJWT

# 启动账号的消息监听（注意：不是启动抓取器）
Invoke-WebRequest -Uri "http://localhost:9527/api/accounts/4/start_monitoring" -Method POST -ContentType "application/json"
```

**方法B：检查后端自动监听**

后端服务启动时会自动开始监听已配置的账号，您可以检查：

```powershell
# 查看后端日志
cd C:\Users\tanzu\Desktop\CSBJJWT\backend
Get-Content ..\logs\app.log -Tail 20
```

期望看到类似：
```
INFO: Started message monitoring for account 4
INFO: Listening to 1 servers
```

---

### 步骤5：发送测试消息

**测试流程：**

```
1. 在KOOK客户端中
2. 进入已映射的频道
3. 发送一条测试消息："测试消息转发"
4. 检查目标平台（Discord/Telegram等）
5. 应该能看到转发的消息
```

**如果没有收到消息，检查：**

```powershell
# 查看实时日志
cd C:\Users\tanzu\Desktop\CSBJJWT

# 在前端界面 → 实时日志页面查看
# 或使用命令行
Get-Content backend\logs\app.log -Wait -Tail 50
```

---

## 🔍 前端界面状态说明

### 账号管理页面的显示

```
🔴 离线                    ← ⚠️ 这是抓取器状态，忽略它
📧 邮箱：xxx@kook.com      ← ✅ 账号信息
📡 监听服务器：0 个        ← ⚠️ 这是抓取器相关，忽略它
🕐 最后活跃：0秒前         ← ⚠️ 这是抓取器相关，忽略它
📅 创建时间：2025-11-10    ← ✅ 账号创建时间

[启动抓取器] 按钮         ← ❌ 不要点击（目前不可用）
[更新Cookie] 按钮         ← ✅ 这是您需要的（每周点击一次）
[编辑] 按钮               ← ✅ 可以编辑账号信息
[删除] 按钮               ← ⚠️ 谨慎使用
```

### 您需要关注的状态

✅ **重要指标：**
- Cookie是否有效（使用脚本检查）
- Bot配置是否正确（连接测试通过）
- 频道映射是否创建
- 实时日志中是否有消息

❌ **可以忽略的指标：**
- 抓取器在线/离线状态
- 监听服务器数量（抓取器相关）
- 最后活跃时间（抓取器相关）

---

## 🎯 完整工作流程图

```
┌─────────────────────────────────────────────────┐
│  每周一次：更新Cookie                            │
│  ├─ 访问 kookapp.cn 登录                       │
│  ├─ 使用Cookie-Editor导出Cookie                │
│  └─ 在前端点击"更新Cookie"                      │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│  首次配置：设置Bot和映射                         │
│  ├─ 添加Bot（Discord/Telegram等）              │
│  ├─ 测试Bot连接                                │
│  └─ 创建频道映射                                │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│  自动运行：后端持续监听和转发                    │
│  ├─ 监听KOOK消息                               │
│  ├─ 根据映射规则过滤                           │
│  ├─ 格式化消息内容                             │
│  └─ 转发到目标平台                             │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│  监控：查看日志和统计                           │
│  ├─ 实时日志页面                               │
│  ├─ 概览页面统计数据                           │
│  └─ 系统健康检查脚本                           │
└─────────────────────────────────────────────────┘
```

---

## 💡 常见误解澄清

### 误解1："离线状态表示系统不工作"
```
❌ 错误理解：看到"🔴 离线"就认为整个系统停了
✅ 正确理解：这只是Playwright抓取器的状态
✅ 实际情况：消息转发功能独立运行，不受影响
```

### 误解2："必须启动抓取器才能转发消息"
```
❌ 错误理解：点击"启动抓取器"是系统运行的前提
✅ 正确理解：抓取器只用于自动获取Cookie
✅ 实际情况：手动更新Cookie后，转发功能直接可用
```

### 误解3："监听服务器数量为0表示没在监听"
```
❌ 错误理解：这个数字应该大于0
✅ 正确理解：这是抓取器监听的服务器数
✅ 实际情况：后端服务有独立的监听机制
```

---

## 🔧 故障排除

### 问题1：Cookie更新后仍然无法转发

**检查步骤：**

```powershell
# 1. 验证Cookie确实已保存
python scripts\verify_cookie_storage.py

# 2. 检查后端日志是否有错误
Get-Content backend\logs\app.log -Tail 50

# 3. 测试API是否响应
Invoke-WebRequest -Uri "http://localhost:9527/api/accounts" -Method GET

# 4. 重启后端服务
# 停止现有进程
Get-Process python | Where-Object {$_.Path -like "*CSBJJWT*"} | Stop-Process -Force

# 重新启动
cd backend
..\venv\Scripts\Activate.ps1
python -m uvicorn app.main:app --host 0.0.0.0 --port 9527
```

---

### 问题2：Bot配置测试失败

**Discord Webhook：**
```powershell
# 测试Webhook是否有效
Invoke-WebRequest -Uri "你的Webhook_URL" -Method POST -ContentType "application/json" -Body '{"content":"测试消息"}'
```

**Telegram Bot：**
```powershell
# 测试Bot Token
$token = "你的Bot_Token"
$chatId = "你的Chat_ID"
Invoke-WebRequest -Uri "https://api.telegram.org/bot$token/sendMessage" -Method POST -Body @{chat_id=$chatId; text="测试"} -ContentType "application/x-www-form-urlencoded"
```

---

### 问题3：消息没有转发

**诊断清单：**

```
□ Cookie是否有效？（不超过7天）
□ Bot配置是否正确？（测试连接通过）
□ 频道映射是否创建？（检查映射列表）
□ 过滤规则是否太严格？（尝试"转发所有消息"）
□ 后端服务是否运行？（检查端口9527）
□ 实时日志中有无错误？（查看日志页面）
```

**调试命令：**

```powershell
# 查看所有映射
Invoke-WebRequest -Uri "http://localhost:9527/api/channel-mappings" -Method GET

# 查看账号状态
Invoke-WebRequest -Uri "http://localhost:9527/api/accounts/4" -Method GET

# 手动触发一次消息检查
Invoke-WebRequest -Uri "http://localhost:9527/api/accounts/4/check_messages" -Method POST
```

---

## 📝 每周维护检查清单

### 每周日（5分钟）

```
□ 访问 kookapp.cn 并登录
□ 导出Cookie（Cookie-Editor扩展）
□ 更新Cookie到系统
□ 验证Cookie已保存（运行verify_cookie_storage.py）
□ 发送测试消息验证转发功能
```

### 每月（15分钟）

```
□ 运行完整系统检查
  venv\Scripts\Activate.ps1
  .\一键运行所有测试.bat

□ 查看系统统计
  - 前端 → 概览页面
  - 查看转发消息数量、成功率等

□ 备份数据库
  $source = "$env:USERPROFILE\Documents\KookForwarder\data\config.db"
  $backup = "$env:USERPROFILE\Documents\KookForwarder\data\backup\config_$(Get-Date -Format 'yyyy-MM-dd').db"
  Copy-Item $source $backup

□ 检查日志文件大小
  Get-ChildItem "$env:USERPROFILE\Documents\KookForwarder\data\logs" -Recurse | Measure-Object -Property Length -Sum
  # 如果超过100MB，考虑清理旧日志
```

---

## 🎊 总结

### 关键要点

1. **不需要抓取器**
   - 抓取器有兼容性问题，暂时不可用
   - 使用手动更新Cookie替代
   - 功能完全不受影响

2. **核心功能100%可用**
   - 消息转发
   - Bot管理
   - 频道映射
   - 实时监控

3. **简单的维护**
   - 每周更新一次Cookie（5分钟）
   - 系统其余时间自动运行
   - 无需人工干预

### 使用建议

✅ **做这些：**
- 定期更新Cookie
- 监控实时日志
- 检查转发统计
- 备份数据库

❌ **不要做这些：**
- 点击"启动抓取器"按钮
- 担心"离线"状态
- 频繁重启服务
- 修改核心代码

---

## 📞 需要帮助？

如果遇到问题，按以下顺序排查：

```
1. 查看实时日志页面
2. 运行系统检查脚本
3. 查看完整操作指导文档
4. 使用交互式控制台诊断
```

**文档位置：**
```
📘 完整指导: 🎯_CMD全程操作指导_解决所有问题.md
📗 快速开始: 📌_立即开始.txt
📙 使用演示: 🎬_使用演示_3分钟上手.txt
📕 本文档:   🎯_正确使用方法_无需抓取器.md
```

---

**最后更新**: 2025-11-11  
**适用版本**: KOOK转发系统 v2.0+  
**Python版本**: 3.12.7 (Windows)
