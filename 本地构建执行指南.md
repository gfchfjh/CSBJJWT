# 🚀 本地构建执行指南 - 完整步骤

**目标**: 在您的本地环境中生成预编译安装包  
**时间**: 约25分钟（5分钟准备 + 20分钟构建）  
**当前状态**: Cursor临时分支，需要合并到主分支

---

## 📋 当前状态

```
当前分支: cursor/bc-629b5925-089b-45ab-a3f2-7e89598ff102-6677
版本号: 1.13.2
工作树: 干净
最后提交: feat: Add release guide and automation script
```

---

## 🎯 执行步骤

### 第一步：切换到主分支（1分钟）

打开本地的Git仓库终端，执行：

```bash
# 1. 确认当前目录
pwd
# 应该在项目根目录

# 2. 查看当前分支
git branch --show-current

# 3. 拉取远程最新代码
git fetch origin

# 4. 切换到主分支（main或master）
# 如果是main分支：
git checkout main
git pull origin main

# 如果是master分支：
git checkout master
git pull origin master
```

**预期输出**：
```
Switched to branch 'main'
Your branch is up to date with 'origin/main'.
```

---

### 第二步：合并Cursor分支的更改（2分钟）

```bash
# 1. 查看Cursor分支的文件变更
git diff main cursor/bc-629b5925-089b-45ab-a3f2-7e89598ff102-6677 --stat

# 2. 如果变更合理，合并Cursor分支
git merge cursor/bc-629b5925-089b-45ab-a3f2-7e89598ff102-6677 --no-ff -m "feat: Add release automation and build guides

- Add release_package.sh for one-click release
- Add BUILD_RELEASE_GUIDE.md (3000+ words)
- Add complete build instructions
- Ready for v1.13.3 release"

# 3. 如果有冲突，解决冲突后：
# git add .
# git commit -m "Merge cursor branch"

# 4. 推送到远程主分支
git push origin main
```

**预期输出**：
```
Merge made by the 'ort' strategy.
 release_package.sh | 200 +++++++++++++++++++++++++++++
 BUILD_RELEASE_GUIDE.md | 300 +++++++++++++++++++++++++++++++++++++++++
 ... (其他文件)
```

---

### 第三步：确认发布脚本可执行（30秒）

```bash
# 1. 检查脚本是否存在
ls -lh release_package.sh

# 2. 赋予执行权限（如果需要）
chmod +x release_package.sh

# 3. 检查脚本语法（可选）
bash -n release_package.sh

# 4. 查看脚本帮助
head -20 release_package.sh
```

**预期输出**：
```
-rwxr-xr-x 1 user user 15K Oct 23 10:00 release_package.sh
```

---

### 第四步：执行发布脚本（30秒操作 + 20分钟等待）

```bash
# 运行发布脚本
./release_package.sh
```

**交互流程**：

#### 4.1 脚本启动
```
╔═══════════════════════════════════════════════════╗
║                                                   ║
║   KOOK消息转发系统 - 一键发布预编译安装包        ║
║                                                   ║
╚═══════════════════════════════════════════════════╝

▶ 1️⃣  检查Git仓库状态
✅ Git仓库检查通过

▶ 2️⃣  获取版本信息
ℹ️  当前版本: v1.13.2
```

#### 4.2 输入版本号
```
⚠️  请输入新版本号（格式：1.13.3），留空使用当前版本 v1.13.2:
新版本号: 
```

**您的操作**：输入 `1.13.3` 然后回车

**或者**：直接回车使用当前版本 `1.13.2`

#### 4.3 确认更新版本号
```
ℹ️  新版本: v1.13.3
是否更新 package.json 中的版本号？(Y/n): 
```

**您的操作**：输入 `y` 然后回车

#### 4.4 查看发布清单
```
═══════════════════════════════════════════════════
📋 发布前检查清单
═══════════════════════════════════════════════════

版本信息：
  版本号: v1.13.3
  当前分支: main
  最后提交: feat: Add release guide and automation script

构建内容：
  ✅ Windows 安装包 (.exe, ~450MB)
  ✅ macOS 安装包 (.dmg, ~480MB)
  ✅ Linux 安装包 (.AppImage, ~420MB)
  ✅ Docker 镜像 (ghcr.io/gfchfjh/csbjjwt:1.13.3)

构建方式：
  GitHub Actions 自动构建（需要15-20分钟）

发布位置：
  https://github.com/gfchfjh/CSBJJWT/releases/tag/v1.13.3

确认创建发布？(y/N): 
```

**您的操作**：输入 `y` 然后回车

#### 4.5 创建并推送Tag
```
▶ 4️⃣  创建Git Tag
✅ Tag v1.13.3 已创建

▶ 5️⃣  推送到GitHub
ℹ️  推送代码到远程仓库...
ℹ️  推送标签到远程仓库...
✅ 推送完成
```

#### 4.6 构建触发确认
```
═══════════════════════════════════════════════════
🚀 构建已触发
═══════════════════════════════════════════════════

✅ Git Tag v1.13.3 已成功推送到GitHub！

GitHub Actions 将自动执行以下任务：
  1️⃣  构建 Python 后端（3个平台）
  2️⃣  构建 Electron 应用（Windows/macOS/Linux）
  3️⃣  构建 Docker 镜像
  4️⃣  创建 GitHub Release
  5️⃣  上传所有安装包

⏱️  预计完成时间: 15-20 分钟

📍 查看构建进度：
  https://github.com/gfchfjh/CSBJJWT/actions

📦 发布页面（构建完成后可见）：
  https://github.com/gfchfjh/CSBJJWT/releases/tag/v1.13.3

是否在浏览器中打开GitHub Actions页面？(Y/n): 
```

**您的操作**：输入 `y` 然后回车（或直接回车）

浏览器会自动打开GitHub Actions页面。

---

### 第五步：监控构建进度（15-20分钟）

#### 5.1 在浏览器中查看

自动打开的页面：`https://github.com/gfchfjh/CSBJJWT/actions`

**查看内容**：
- 最新的 "Build and Release" 工作流
- 6个任务的运行状态

**任务列表**：
```
✅ build-backend (ubuntu-latest)    [5-8分钟]
✅ build-backend (windows-latest)   [5-8分钟]
✅ build-backend (macos-latest)     [5-8分钟]
✅ build-electron-windows          [3-5分钟]
✅ build-electron-macos            [4-6分钟]
✅ build-electron-linux            [3-5分钟]
✅ build-docker                    [5-8分钟]
✅ create-release                  [1-2分钟]
```

#### 5.2 命令行查看（可选）

使用GitHub CLI（如果已安装）：

```bash
# 安装GitHub CLI（如果没有）
# macOS: brew install gh
# Linux: sudo apt install gh
# Windows: winget install --id GitHub.cli

# 登录GitHub
gh auth login

# 查看最新工作流运行
gh run list --limit 5

# 查看特定运行的详情
gh run view --log

# 实时监控（每10秒刷新）
watch -n 10 'gh run list --limit 1'
```

---

### 第六步：验证构建结果（5分钟）

#### 6.1 等待构建完成

所有任务显示绿色对勾 ✅ 后，继续下一步。

#### 6.2 访问Release页面

```bash
# 在浏览器中打开
open https://github.com/gfchfjh/CSBJJWT/releases/tag/v1.13.3

# 或使用GitHub CLI
gh release view v1.13.3 --web
```

#### 6.3 检查安装包

**应该看到**：
```
📦 Assets (4)
├─ KookForwarder-Setup-1.13.3.exe        ~450 MB
├─ KookForwarder-1.13.3.dmg              ~480 MB
├─ KookForwarder-1.13.3.AppImage         ~420 MB
└─ Source code (zip)
└─ Source code (tar.gz)
```

#### 6.4 下载并测试

```bash
# 使用GitHub CLI下载所有资产
gh release download v1.13.3 -D ~/Downloads/kook-forwarder-v1.13.3

# 或手动从网页下载对应平台的安装包
```

**本地测试**：
1. 下载对应平台的安装包
2. 双击安装（Windows/macOS）或运行（Linux）
3. 完成配置向导
4. 测试基本功能

---

## 🔍 故障排查

### 问题1：脚本执行失败

**错误**：`permission denied`

**解决**：
```bash
chmod +x release_package.sh
./release_package.sh
```

### 问题2：Git推送被拒绝

**错误**：`! [rejected] v1.13.3 -> v1.13.3 (already exists)`

**解决**：
```bash
# 删除本地和远程Tag
git tag -d v1.13.3
git push origin :refs/tags/v1.13.3

# 重新运行脚本
./release_package.sh
```

### 问题3：GitHub Actions构建失败

**查看日志**：
```bash
# 使用GitHub CLI
gh run list --limit 1
gh run view --log

# 或在浏览器中查看
# https://github.com/gfchfjh/CSBJJWT/actions
```

**常见原因**：
- 依赖下载失败（重试）
- 磁盘空间不足（检查）
- 权限问题（检查Secrets）

**解决方法**：
1. 查看失败任务的日志
2. 修复问题
3. 删除Tag并重新发布

### 问题4：Docker镜像推送失败

**原因**：GITHUB_TOKEN权限不足

**解决**：
1. 访问 GitHub Settings → Developer settings → Personal access tokens
2. 创建新Token，勾选 `write:packages` 权限
3. 添加到仓库Secrets：`Settings → Secrets → Actions`
4. 重新触发工作流

---

## 📊 构建时间预估

| 阶段 | 任务 | 时间 | 状态 |
|------|------|------|------|
| **准备** | 切换分支、合并代码 | 3分钟 | ⏸️ 手动 |
| **触发** | 运行脚本、推送Tag | 2分钟 | ⏸️ 手动 |
| **后端构建** | 3个平台并行 | 5-8分钟 | 🤖 自动 |
| **前端构建** | 3个平台并行 | 3-6分钟 | 🤖 自动 |
| **Docker构建** | 多架构镜像 | 5-8分钟 | 🤖 自动 |
| **创建Release** | 上传资产 | 1-2分钟 | 🤖 自动 |
| **验证** | 下载、测试 | 5分钟 | ⏸️ 手动 |
| **总计** | - | **约25分钟** | - |

---

## 📝 完整命令清单（快速参考）

```bash
# ========== 第一步：准备 ==========
git checkout main
git pull origin main

# ========== 第二步：合并 ==========
git merge cursor/bc-629b5925-089b-45ab-a3f2-7e89598ff102-6677 --no-ff
git push origin main

# ========== 第三步：执行 ==========
chmod +x release_package.sh
./release_package.sh

# 交互输入：
# - 版本号: 1.13.3
# - 更新package.json: y
# - 确认发布: y
# - 打开浏览器: y

# ========== 第四步：监控 ==========
# 在浏览器中打开（自动）
# https://github.com/gfchfjh/CSBJJWT/actions

# ========== 第五步：验证 ==========
# 构建完成后访问：
# https://github.com/gfchfjh/CSBJJWT/releases/tag/v1.13.3

# 下载安装包测试
```

---

## 🎯 成功标志

构建成功的标志：

✅ **GitHub Actions**
- 所有6个任务显示绿色对勾
- 总耗时约15-20分钟
- 无错误或警告

✅ **GitHub Release**
- Release页面已创建
- 包含3个安装包文件
- 发布说明完整

✅ **Docker镜像**
- 镜像已推送到GHCR
- 可以使用 `docker pull` 拉取
- 标签正确（latest、1.13.3、1.13、1）

✅ **本地测试**
- 安装包可以正常安装
- 应用可以正常启动
- 基本功能正常工作

---

## 📚 相关文档

如需更多信息，查看：
- `BUILD_RELEASE_GUIDE.md` - 详细构建指南
- `如何生成预编译安装包.md` - 快速指南
- `release_package.sh` - 发布脚本（带注释）

---

## 🎉 完成后

构建成功后，您可以：

1. **更新文档**
   ```bash
   # 更新README.md中的下载链接
   vi README.md
   # 修改版本号为v1.13.3
   
   git add README.md
   git commit -m "docs: update download links for v1.13.3"
   git push origin main
   ```

2. **公告发布**
   - 在GitHub Release中添加详细说明
   - 在社交媒体发布公告
   - 通知现有用户升级

3. **备份Release**
   ```bash
   # 下载所有资产到本地备份
   mkdir -p backups/v1.13.3
   gh release download v1.13.3 -D backups/v1.13.3
   ```

---

## 💡 提示

**最佳实践**：
- ✅ 在工作日白天发布（便于处理问题）
- ✅ 发布前充分测试
- ✅ 准备好回滚方案
- ✅ 及时沟通和文档更新

**避免**：
- ❌ 周五晚上或周末发布
- ❌ 未经测试就发布
- ❌ 发布后长时间不关注
- ❌ 忽略用户反馈

---

**祝您构建顺利！** 🚀

如有问题，请查看 `BUILD_RELEASE_GUIDE.md` 或提交Issue。

---

**文档版本**: v1.0  
**创建日期**: 2025-10-23  
**作者**: KOOK Forwarder Team
